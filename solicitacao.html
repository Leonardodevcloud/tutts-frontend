<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutts - Solicitar Corrida</title>
    <meta name="theme-color" content="#7c3aed">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèçÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        #mapa, #mapaAcompanhar { z-index: 1; }
        .leaflet-container { width: 100% !important; height: 100% !important; background: #e5e7eb; z-index: 1 !important; }
        .leaflet-pane { z-index: 1 !important; }
        .leaflet-top, .leaflet-bottom { z-index: 10 !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #93c5fd; border-radius: 3px; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-custom { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .map-container { position: relative; z-index: 1; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 100px; } }
        .slide-down { animation: slideDown 0.3s ease-out forwards; overflow: hidden; }
        .foto-modal { z-index: 9999 !important; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .marker-bounce { animation: bounce 0.5s ease-in-out; }
        .mapa-ajuste-modal { z-index: 9998 !important; }
        .mapa-ajuste-container .leaflet-container { z-index: 1 !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const API_URL = 'https://tutts-backend-production.up.railway.app';
        const SITE_URL = 'https://www.centraltutts.online';
        
        const Toast = ({ mensagem, tipo, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 4000); return () => clearTimeout(timer); }, []);
            const cores = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            return (<div className={`fixed top-4 right-4 ${cores[tipo]} text-white px-4 py-3 rounded-lg shadow-lg z-50 fade-in max-w-sm`}>{mensagem}</div>);
        };
        
        const TelaLogin = ({ onLogin, showToast }) => {
            const [email, setEmail] = useState('');
            const [senha, setSenha] = useState('');
            const [loading, setLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!email || !senha) { showToast('Preencha email e senha', 'error'); return; }
                setLoading(true);
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, senha }) });
                    const data = await resp.json();
                    if (resp.ok) { localStorage.setItem('solicitacao_token', data.token); localStorage.setItem('solicitacao_cliente', JSON.stringify(data.cliente)); showToast('Bem-vindo!', 'success'); onLogin(data.cliente, data.token); }
                    else { showToast(data.error || 'Erro', 'error'); }
                } catch (err) { showToast('Erro de conex√£o', 'error'); }
                setLoading(false);
            };
            
            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm">
                        {/* Logo */}
                        <div className="text-center mb-4">
                            <img 
                                src="https://github.com/Leonardodevcloud/tutts-frontend/blob/main/logotuttsoriginal.png?raw=true" 
                                alt="Tutts Logo" 
                                className="w-28 h-auto mx-auto mb-3 drop-shadow-lg rounded-2xl"
                            />
                            <h1 className="text-lg font-bold text-gray-700">Central de Solicita√ß√µes</h1>
                            <p className="text-xs text-gray-500">Fa√ßa login para continuar</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">üìß Email</label>
                                <input 
                                    type="email" 
                                    value={email} 
                                    onChange={(e) => setEmail(e.target.value)} 
                                    className="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition-all text-sm" 
                                    placeholder="seu@email.com" 
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">üîí Senha</label>
                                <input 
                                    type="password" 
                                    value={senha} 
                                    onChange={(e) => setSenha(e.target.value)} 
                                    className="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition-all text-sm" 
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={loading} 
                                className="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl disabled:opacity-50 transition-all shadow-lg hover:shadow-xl"
                            >
                                {loading ? '‚è≥ Entrando...' : 'üöÄ Entrar'}
                            </button>
                        </form>
                        
                        <div className="mt-4 text-center text-xs text-gray-400">
                            ¬© 2026 Tutts - Todos os direitos reservados
                        </div>
                    </div>
                </div>
            );
        };
        
        // Componente de Mapa reutiliz√°vel com controle de ciclo de vida
        const MapaLeaflet = ({ id, pontos, center = [-16.6869, -49.2648], zoom = 12, height = '400px', tipo = 'nova' }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersLayerRef = useRef(null);
            
            useEffect(() => {
                if (typeof L === 'undefined') return;
                const container = mapRef.current;
                if (!container) return;
                if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; }
                const map = L.map(container, { center: center, zoom: zoom, zoomControl: true });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' }).addTo(map);
                const markersLayer = L.layerGroup().addTo(map);
                mapInstanceRef.current = map;
                markersLayerRef.current = markersLayer;
                setTimeout(() => { if (mapInstanceRef.current) mapInstanceRef.current.invalidateSize(); }, 100);
                return () => { if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; } };
            }, [id]);
            
            useEffect(() => {
                const map = mapInstanceRef.current;
                const markersLayer = markersLayerRef.current;
                if (!map || !markersLayer || !pontos) return;
                markersLayer.clearLayers();
                const pontosValidos = pontos.filter(p => p.latitude && p.longitude);
                pontosValidos.forEach((p, idx) => {
                    let cor, icone;
                    if (tipo === 'acompanhar') {
                        if (p.status === 'finalizado') { cor = '#10b981'; icone = '‚úì'; }
                        else if (p.status === 'chegou' || p.status === 'coletado') { cor = '#3b82f6'; icone = 'üìç'; }
                        else if (idx === 0) { cor = '#f59e0b'; icone = 'üì¶'; }
                        else { cor = '#9ca3af'; icone = idx; }
                    } else {
                        if (idx === 0) { cor = '#f59e0b'; icone = 'üì¶'; }
                        else { cor = '#3b82f6'; icone = idx; }
                    }
                    const icon = L.divIcon({ className: '', html: `<div style="background:${cor};color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.3)">${icone}</div>`, iconSize: [32, 32], iconAnchor: [16, 16] });
                    const enderecoCompleto = p.endereco_completo || `${p.rua || ''}, ${p.numero || ''} - ${p.bairro || ''}`;
                    const tipoLabel = idx === 0 ? 'üì¶ COLETA' : `üìç ENTREGA ${idx}`;
                    L.marker([p.latitude, p.longitude], { icon }).bindPopup(`<strong>${tipoLabel}</strong><br/>${enderecoCompleto}`).addTo(markersLayer);
                });
                if (pontosValidos.length > 0) { const bounds = L.latLngBounds(pontosValidos.map(p => [p.latitude, p.longitude])); map.fitBounds(bounds, { padding: [50, 50] }); }
                setTimeout(() => map.invalidateSize(), 50);
            }, [pontos, tipo]);
            
            useEffect(() => {
                const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting && mapInstanceRef.current) setTimeout(() => mapInstanceRef.current.invalidateSize(), 100); }); }, { threshold: 0.1 });
                if (mapRef.current) observer.observe(mapRef.current);
                return () => observer.disconnect();
            }, []);
            
            return <div ref={mapRef} className="rounded-xl shadow-lg" style={{ height, minHeight: '300px', width: '100%' }} />;
        };
        
        // ============ NOVO: Componente de Mapa Ajust√°vel com marcador arrast√°vel ============
        const MapaAjustavel = ({ latitude, longitude, onPosicaoMudou, zoom = 17 }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markerRef = useRef(null);
            
            useEffect(() => {
                if (typeof L === 'undefined') return;
                const container = mapRef.current;
                if (!container) return;
                
                // Limpar mapa anterior se existir
                if (mapInstanceRef.current) {
                    mapInstanceRef.current.remove();
                    mapInstanceRef.current = null;
                }
                
                // Criar novo mapa
                const map = L.map(container, { 
                    center: [latitude, longitude], 
                    zoom: zoom, 
                    zoomControl: true 
                });
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                    maxZoom: 19, 
                    attribution: '¬© OpenStreetMap' 
                }).addTo(map);
                
                // Criar marcador arrast√°vel com √≠cone personalizado
                const icon = L.divIcon({ 
                    className: '', 
                    html: `
                        <div style="position:relative;">
                            <div style="background:#ef4444;color:#fff;width:40px;height:40px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:16px;border:3px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,0.4)">
                                <span style="transform:rotate(45deg);">üìç</span>
                            </div>
                            <div style="position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:8px;height:8px;background:#ef4444;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>
                        </div>
                    `, 
                    iconSize: [40, 48], 
                    iconAnchor: [20, 48] 
                });
                
                const marker = L.marker([latitude, longitude], { 
                    icon, 
                    draggable: true,
                    autoPan: true
                }).addTo(map);
                
                // Evento quando arrasta o marcador
                marker.on('dragend', function(e) {
                    const pos = e.target.getLatLng();
                    onPosicaoMudou(pos.lat, pos.lng);
                });
                
                // Evento de clique no mapa para reposicionar marcador
                map.on('click', function(e) {
                    marker.setLatLng(e.latlng);
                    onPosicaoMudou(e.latlng.lat, e.latlng.lng);
                });
                
                mapInstanceRef.current = map;
                markerRef.current = marker;
                
                setTimeout(() => {
                    if (mapInstanceRef.current) mapInstanceRef.current.invalidateSize();
                }, 100);
                
                return () => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                    }
                };
            }, []);
            
            // Atualizar posi√ß√£o do marcador quando latitude/longitude mudam externamente
            useEffect(() => {
                if (markerRef.current && mapInstanceRef.current) {
                    markerRef.current.setLatLng([latitude, longitude]);
                    mapInstanceRef.current.setView([latitude, longitude], mapInstanceRef.current.getZoom());
                }
            }, [latitude, longitude]);
            
            return (
                <div 
                    ref={mapRef} 
                    className="w-full h-full rounded-lg"
                    style={{ minHeight: '300px' }}
                />
            );
        };
        
        const Solicitacao = ({ cliente, token, onLogout, showToast }) => {
            const [abaAtiva, setAbaAtiva] = useState('nova');
            const [pontos, setPontos] = useState([]);
            const [termoBusca, setTermoBusca] = useState('');
            const [sugestoes, setSugestoes] = useState([]);
            const [buscando, setBuscando] = useState(false);
            const [loading, setLoading] = useState(false);
            const [historico, setHistorico] = useState([]);
            const [mostrarHistorico, setMostrarHistorico] = useState(false);
            const [abaMobile, setAbaMobile] = useState('form');
            const [pontoEditando, setPontoEditando] = useState(null);
            const [dadosPonto, setDadosPonto] = useState({ observacao: '', telefone: '', procurar_por: '', numero_nota: '', codigo_finalizar: '', complemento: '' });
            const [corridasAtivas, setCorridasAtivas] = useState([]);
            const [corridaSelecionada, setCorridaSelecionada] = useState(null);
            const [detalheCorrida, setDetalheCorrida] = useState(null);
            const [corridasConcluidas, setCorridasConcluidas] = useState([]);
            const [filtroConcluidas, setFiltroConcluidas] = useState('todas');
            const [corridaExpandida, setCorridaExpandida] = useState(null);
            const [detalhesCorridaExpandida, setDetalhesCorridaExpandida] = useState(null);
            const [sincronizando, setSincronizando] = useState(false);
            const [profissionais, setProfissionais] = useState([]);
            const [carregandoProfissionais, setCarregandoProfissionais] = useState(false);
            const [mapaKey, setMapaKey] = useState(0);
            
            // Estado para input de nota r√°pida ap√≥s adicionar ponto
            const [pontoRecemAdicionado, setPontoRecemAdicionado] = useState(null);
            const [notaRapida, setNotaRapida] = useState('');
            const notaInputRef = useRef(null);
            
            // Estado para modal de fotos
            const [fotoModal, setFotoModal] = useState({ aberto: false, fotos: [], indice: 0 });
            
            // Estado para endere√ßos salvos
            const [enderecosSalvos, setEnderecosSalvos] = useState([]);
            const [mostrarSalvos, setMostrarSalvos] = useState(false);
            const [modalSalvarEndereco, setModalSalvarEndereco] = useState({ aberto: false, ponto: null });
            const [apelidoSalvar, setApelidoSalvar] = useState('');
            const [complementoSalvar, setComplementoSalvar] = useState('');
            const [salvandoEndereco, setSalvandoEndereco] = useState(false);
            
            // ============ NOVO: Estados para modal de ajuste de mapa ============
            const [modalAjusteMapa, setModalAjusteMapa] = useState({
                aberto: false,
                sugestaoOriginal: null,  // Sugest√£o do Google que est√° sendo ajustada
                latitude: null,
                longitude: null,
                etapa: 'ajustar'  // 'ajustar' ou 'confirmar'
            });
            const [posicaoAjustada, setPosicaoAjustada] = useState({ lat: null, lng: null });
            const [enderecoAjustado, setEnderecoAjustado] = useState(null);
            const [buscandoEndereco, setBuscandoEndereco] = useState(false);
            
            const abrirFotoModal = (fotos, indice = 0) => {
                setFotoModal({ aberto: true, fotos, indice });
            };
            
            const fecharFotoModal = () => {
                setFotoModal({ aberto: false, fotos: [], indice: 0 });
            };
            
            const navegarFoto = (direcao) => {
                setFotoModal(prev => ({
                    ...prev,
                    indice: Math.max(0, Math.min(prev.fotos.length - 1, prev.indice + direcao))
                }));
            };
            
            const [config, setConfig] = useState({
                numero_pedido: '', centro_custo: cliente.centro_custo_padrao || '', usuario_solicitante: cliente.nome,
                data_retirada: '', hora_retirada: '', forma_pagamento: cliente.forma_pagamento_padrao || 'F',
                ponto_receber: '', retorno: false, obs_retorno: '', ordenar: true, 
                codigo_profissional: '',
                sem_profissional: false
            });
            
            useEffect(() => { if (abaAtiva === 'nova' || abaAtiva === 'acompanhar') setMapaKey(prev => prev + 1); }, [abaAtiva, corridaSelecionada]);
            useEffect(() => { carregarProfissionais(); }, []);
            
            // Foco no input de nota quando ponto √© adicionado
            useEffect(() => {
                if (pontoRecemAdicionado !== null && notaInputRef.current) {
                    notaInputRef.current.focus();
                }
            }, [pontoRecemAdicionado]);
            
            const carregarProfissionais = async () => {
                setCarregandoProfissionais(true);
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/profissionais`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (resp.ok) { const data = await resp.json(); setProfissionais(data.profissionais || []); }
                } catch (err) { console.error('Erro ao carregar profissionais:', err); }
                setCarregandoProfissionais(false);
            };
            
            useEffect(() => { 
                if (cliente.endereco_partida_padrao) setPontos([{ id: Date.now(), ...cliente.endereco_partida_padrao, isPartida: true }]); 
                carregarHistorico(); 
                carregarCorridasAtivas(); 
            }, []);
            
            useEffect(() => {
                if (abaAtiva !== 'acompanhar') return;
                const interval = setInterval(() => { carregarCorridasAtivas(); if (corridaSelecionada) carregarDetalheCorrida(corridaSelecionada); }, 10000);
                return () => clearInterval(interval);
            }, [abaAtiva, corridaSelecionada]);
            
            const carregarHistorico = async () => { try { const resp = await fetch(`${API_URL}/api/solicitacao/historico?limite=20`, { headers: { 'Authorization': `Bearer ${token}` } }); if (resp.ok) { const data = await resp.json(); setHistorico(data.solicitacoes || []); } } catch (err) {} };
            const carregarCorridasAtivas = async () => { try { const resp = await fetch(`${API_URL}/api/solicitacao/historico?limite=50`, { headers: { 'Authorization': `Bearer ${token}` } }); if (resp.ok) { const data = await resp.json(); setCorridasAtivas((data.solicitacoes || []).filter(s => ['enviado', 'aceito', 'em_andamento'].includes(s.status))); } } catch (err) {} };
            const carregarConcluidas = async () => { try { const resp = await fetch(`${API_URL}/api/solicitacao/historico?limite=100`, { headers: { 'Authorization': `Bearer ${token}` } }); if (resp.ok) { const data = await resp.json(); setCorridasConcluidas((data.solicitacoes || []).filter(s => ['finalizado', 'cancelado'].includes(s.status))); } } catch (err) {} };
            const carregarDetalheCorrida = async (id) => { 
                try { 
                    const resp = await fetch(`${API_URL}/api/solicitacao/corrida/${id}`, { headers: { 'Authorization': `Bearer ${token}` } }); 
                    if (resp.ok) {
                        const data = await resp.json();
                        setDetalheCorrida(data);
                        // Se a corrida foi finalizada ou cancelada, limpar sele√ß√£o e atualizar listas
                        if (['finalizado', 'cancelado'].includes(data.status)) {
                            showToast(data.status === 'finalizado' ? 'üèÅ Corrida finalizada!' : '‚ùå Corrida cancelada', 'info');
                            setCorridaSelecionada(null);
                            setDetalheCorrida(null);
                            carregarCorridasAtivas();
                            carregarConcluidas();
                        }
                    }
                } catch (err) {} 
            };
            const selecionarCorrida = (id) => { setCorridaSelecionada(id); carregarDetalheCorrida(id); };
            const copiarLinkRastreio = (os) => { navigator.clipboard.writeText(`${SITE_URL}/rastrear.html?os=${os}`).then(() => showToast('‚úÖ Link copiado!', 'success')); };
            const compartilharWhatsApp = (os) => { window.open(`https://wa.me/?text=${encodeURIComponent(`üèçÔ∏è Acompanhe sua entrega:\n${SITE_URL}/rastrear.html?os=${os}`)}`, '_blank'); };
            
            // Fun√ß√£o para expandir/colapsar corrida conclu√≠da
            const toggleExpandirCorrida = async (id) => {
                if (corridaExpandida === id) {
                    setCorridaExpandida(null);
                    setDetalhesCorridaExpandida(null);
                } else {
                    setCorridaExpandida(id);
                    setDetalhesCorridaExpandida(null);
                    try {
                        const resp = await fetch(`${API_URL}/api/solicitacao/corrida/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        if (resp.ok) {
                            const data = await resp.json();
                            setDetalhesCorridaExpandida(data);
                        }
                    } catch (err) {
                        console.error('Erro ao carregar detalhes:', err);
                    }
                }
            };
            
            const cancelarCorrida = async (id) => {
                if (!confirm('Tem certeza que deseja CANCELAR esta corrida?')) return;
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/corrida/${id}/cancelar`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await resp.json();
                    if (resp.ok) { showToast(data.cancelou_tutts ? '‚úÖ Corrida cancelada!' : '‚ùå Corrida marcada como cancelada', 'success'); carregarCorridasAtivas(); carregarConcluidas(); setCorridaSelecionada(null); setDetalheCorrida(null); }
                    else showToast(data.error || 'Erro ao cancelar', 'error');
                } catch (err) { showToast('Erro ao cancelar', 'error'); }
            };
            
            const sincronizarStatus = async () => {
                setSincronizando(true);
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/sincronizar`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await resp.json();
                    if (resp.ok) {
                        if (data.atualizadas > 0) { showToast(`üîÑ ${data.atualizadas} atualizada(s)`, 'success'); carregarCorridasAtivas(); carregarConcluidas(); if (corridaSelecionada) carregarDetalheCorrida(corridaSelecionada); }
                        else showToast('‚úÖ Tudo sincronizado!', 'info');
                    } else showToast(data.error || 'Erro', 'error');
                } catch (err) { showToast('Erro', 'error'); }
                setSincronizando(false);
            };
            
            const buscarEndereco = async () => {
                if (!termoBusca || termoBusca.length < 3) { showToast('Digite pelo menos 3 caracteres', 'warning'); return; }
                setBuscando(true);
                try { const resp = await fetch(`${API_URL}/api/geocode/google?endereco=${encodeURIComponent(termoBusca)}`); if (resp.ok) { const data = await resp.json(); if (data.results?.length > 0) setSugestoes(data.results); else showToast('Nenhum endere√ßo', 'warning'); } }
                catch (err) { showToast('Erro', 'error'); }
                setBuscando(false);
            };
            
            // ============ NOVO: Fun√ß√£o de geocodifica√ß√£o reversa ============
            const buscarEnderecoReverso = async (lat, lng) => {
                setBuscandoEndereco(true);
                try {
                    const resp = await fetch(`${API_URL}/api/geocode/google?endereco=${lat},${lng}`);
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data.results?.length > 0) {
                            setEnderecoAjustado(data.results[0]);
                            return data.results[0];
                        }
                    }
                    showToast('N√£o foi poss√≠vel obter o endere√ßo', 'warning');
                    return null;
                } catch (err) {
                    showToast('Erro ao buscar endere√ßo', 'error');
                    return null;
                } finally {
                    setBuscandoEndereco(false);
                }
            };
            
            // ============ NOVO: Abrir modal de ajuste de mapa ============
            const abrirModalAjusteMapa = (sugestao) => {
                setModalAjusteMapa({
                    aberto: true,
                    sugestaoOriginal: sugestao,
                    latitude: sugestao.latitude,
                    longitude: sugestao.longitude,
                    etapa: 'ajustar'
                });
                setPosicaoAjustada({ lat: sugestao.latitude, lng: sugestao.longitude });
                setEnderecoAjustado(null);
            };
            
            // ============ NOVO: Quando o usu√°rio arrasta o marcador ============
            const onPosicaoMudou = (lat, lng) => {
                setPosicaoAjustada({ lat, lng });
            };
            
            // ============ NOVO: Confirmar posi√ß√£o e buscar endere√ßo reverso ============
            const confirmarPosicaoMapa = async () => {
                const endereco = await buscarEnderecoReverso(posicaoAjustada.lat, posicaoAjustada.lng);
                if (endereco) {
                    setModalAjusteMapa(prev => ({ ...prev, etapa: 'confirmar' }));
                }
            };
            
            // ============ NOVO: Usar endere√ßo ajustado ============
            const usarEnderecoAjustado = () => {
                if (!enderecoAjustado) return;
                
                // Criar ponto com as coordenadas ajustadas
                const sug = enderecoAjustado;
                if (pontos.length >= 80) { showToast('M√°ximo 80 pontos', 'error'); return; }
                const comp = sug.componentes || [];
                const get = (t) => comp.find(c => c.types?.includes(t))?.long_name || '';
                const getS = (t) => comp.find(c => c.types?.includes(t))?.short_name || '';
                const novoId = Date.now();
                const novoPonto = { 
                    id: novoId, 
                    endereco_completo: sug.endereco || '', 
                    rua: get('route'), 
                    numero: get('street_number'), 
                    complemento: '',
                    bairro: get('sublocality_level_1') || get('sublocality'), 
                    cidade: get('administrative_area_level_2') || get('locality'), 
                    uf: getS('administrative_area_level_1'), 
                    cep: get('postal_code'), 
                    // Usar coordenadas ajustadas
                    latitude: posicaoAjustada.lat, 
                    longitude: posicaoAjustada.lng, 
                    observacao: '', 
                    telefone: '', 
                    procurar_por: '', 
                    numero_nota: '', 
                    codigo_finalizar: '',
                    ajustado_manualmente: true
                };
                const novosPontos = [...pontos, novoPonto];
                setPontos(novosPontos);
                setTermoBusca(''); 
                setSugestoes([]);
                
                // Fechar modal
                setModalAjusteMapa({ aberto: false, sugestaoOriginal: null, latitude: null, longitude: null, etapa: 'ajustar' });
                setEnderecoAjustado(null);
                setPosicaoAjustada({ lat: null, lng: null });
                
                // Se for ponto de entrega (n√£o o primeiro), mostrar input de nota
                if (novosPontos.length > 1) {
                    setPontoRecemAdicionado(novoId);
                    setNotaRapida('');
                }
                
                showToast('‚úÖ Endere√ßo ajustado adicionado!', 'success');
            };
            
            // ============ NOVO: Voltar para ajustar novamente ============
            const voltarParaAjustar = () => {
                setModalAjusteMapa(prev => ({ ...prev, etapa: 'ajustar' }));
                setEnderecoAjustado(null);
            };
            
            // ============ NOVO: Fechar modal de ajuste ============
            const fecharModalAjusteMapa = () => {
                setModalAjusteMapa({ aberto: false, sugestaoOriginal: null, latitude: null, longitude: null, etapa: 'ajustar' });
                setEnderecoAjustado(null);
                setPosicaoAjustada({ lat: null, lng: null });
            };
            
            // Buscar endere√ßos salvos
            const buscarEnderecosSalvos = async (termo = '') => {
                try {
                    const url = termo ? `${API_URL}/api/solicitacao/enderecos-salvos/buscar?q=${encodeURIComponent(termo)}` : `${API_URL}/api/solicitacao/enderecos-salvos/buscar`;
                    const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (resp.ok) {
                        const data = await resp.json();
                        setEnderecosSalvos(data);
                        setMostrarSalvos(data.length > 0);
                    }
                } catch (err) {
                    console.error('Erro ao buscar salvos:', err);
                }
            };
            
            // Buscar salvos quando digita
            useEffect(() => {
                if (termoBusca.length >= 2) {
                    buscarEnderecosSalvos(termoBusca);
                } else if (termoBusca.length === 0) {
                    setMostrarSalvos(false);
                    setEnderecosSalvos([]);
                }
            }, [termoBusca]);
            
            // Adicionar ponto de endere√ßo salvo
            const adicionarPontoSalvo = async (endereco) => {
                if (pontos.length >= 80) { showToast('M√°ximo 80 pontos', 'error'); return; }
                
                const novoId = Date.now();
                const novoPonto = { 
                    id: novoId, 
                    endereco_completo: endereco.endereco_completo || `${endereco.rua}, ${endereco.numero} - ${endereco.bairro}, ${endereco.cidade}`,
                    rua: endereco.rua, 
                    numero: endereco.numero, 
                    complemento: endereco.complemento || '',
                    bairro: endereco.bairro, 
                    cidade: endereco.cidade, 
                    uf: endereco.uf, 
                    cep: endereco.cep, 
                    latitude: parseFloat(endereco.latitude), 
                    longitude: parseFloat(endereco.longitude), 
                    observacao: '', 
                    telefone: '', 
                    procurar_por: '', 
                    numero_nota: '', 
                    codigo_finalizar: '',
                    endereco_salvo_id: endereco.id,
                    apelido_salvo: endereco.apelido
                };
                
                const novosPontos = [...pontos, novoPonto];
                setPontos(novosPontos);
                setTermoBusca(''); 
                setSugestoes([]);
                setMostrarSalvos(false);
                setEnderecosSalvos([]);
                
                // Incrementar uso
                try {
                    await fetch(`${API_URL}/api/solicitacao/enderecos-salvos/${endereco.id}/usar`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } catch (err) {}
                
                // Se for ponto de entrega, mostrar input de nota
                if (novosPontos.length > 1) {
                    setPontoRecemAdicionado(novoId);
                    setNotaRapida('');
                }
                
                showToast(`‚úÖ "${endereco.apelido}" adicionado`, 'success');
            };
            
            // Salvar endere√ßo
            const salvarEndereco = async () => {
                if (!apelidoSalvar.trim()) { showToast('Digite um apelido', 'warning'); return; }
                if (!modalSalvarEndereco.ponto) return;
                
                setSalvandoEndereco(true);
                const p = modalSalvarEndereco.ponto;
                
                // Tentar extrair cidade do endere√ßo completo se n√£o tiver
                let cidade = p.cidade;
                if (!cidade && p.endereco_completo) {
                    // Formato t√≠pico: "Rua X, 123 - Bairro, Cidade - UF, CEP"
                    const partes = p.endereco_completo.split(',');
                    if (partes.length >= 3) {
                        // Tentar pegar a cidade (geralmente ap√≥s o bairro)
                        const cidadeUF = partes[partes.length - 2]?.trim();
                        if (cidadeUF) {
                            cidade = cidadeUF.split('-')[0]?.trim() || cidadeUF;
                        }
                    }
                }
                
                // Usar o complemento editado no modal ou o original do ponto
                const complementoFinal = complementoSalvar || p.complemento || '';
                
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/enderecos-salvos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({
                            apelido: apelidoSalvar.trim(),
                            rua: p.rua,
                            numero: p.numero,
                            complemento: complementoFinal,
                            bairro: p.bairro,
                            cidade: cidade || 'N√£o informada',
                            uf: p.uf,
                            cep: p.cep,
                            latitude: p.latitude,
                            longitude: p.longitude,
                            endereco_completo: p.endereco_completo
                        })
                    });
                    
                    const data = await resp.json();
                    if (resp.ok) {
                        showToast(`üíæ "${apelidoSalvar}" salvo!`, 'success');
                        setModalSalvarEndereco({ aberto: false, ponto: null });
                        setApelidoSalvar('');
                        setComplementoSalvar('');
                        // Atualizar o complemento no ponto atual tamb√©m
                        if (complementoFinal && complementoFinal !== p.complemento) {
                            setPontos(prev => prev.map(ponto => 
                                ponto.id === p.id ? { ...ponto, complemento: complementoFinal } : ponto
                            ));
                        }
                    } else {
                        showToast(data.error || 'Erro ao salvar', 'error');
                    }
                } catch (err) {
                    showToast('Erro ao salvar', 'error');
                }
                setSalvandoEndereco(false);
            };
            
            const adicionarPonto = (sug) => {
                if (pontos.length >= 80) { showToast('M√°ximo 80 pontos', 'error'); return; }
                const comp = sug.componentes || [];
                const get = (t) => comp.find(c => c.types?.includes(t))?.long_name || '';
                const getS = (t) => comp.find(c => c.types?.includes(t))?.short_name || '';
                const novoId = Date.now();
                const novoPonto = { 
                    id: novoId, 
                    endereco_completo: sug.endereco || '', 
                    rua: get('route'), 
                    numero: get('street_number'), 
                    complemento: '',
                    bairro: get('sublocality_level_1') || get('sublocality'), 
                    cidade: get('administrative_area_level_2') || get('locality'), 
                    uf: getS('administrative_area_level_1'), 
                    cep: get('postal_code'), 
                    latitude: sug.latitude, 
                    longitude: sug.longitude, 
                    observacao: '', 
                    telefone: '', 
                    procurar_por: '', 
                    numero_nota: '', 
                    codigo_finalizar: '' 
                };
                const novosPontos = [...pontos, novoPonto];
                setPontos(novosPontos);
                setTermoBusca(''); 
                setSugestoes([]);
                
                // Se for ponto de entrega (n√£o o primeiro), mostrar input de nota
                if (novosPontos.length > 1) {
                    setPontoRecemAdicionado(novoId);
                    setNotaRapida('');
                }
                
                showToast('‚úÖ Adicionado', 'success');
            };
            
            // Salvar nota r√°pida
            const salvarNotaRapida = () => {
                if (pontoRecemAdicionado && notaRapida.trim()) {
                    setPontos(prev => prev.map(p => 
                        p.id === pontoRecemAdicionado 
                            ? { ...p, numero_nota: notaRapida.trim() } 
                            : p
                    ));
                    showToast('üè∑Ô∏è Nota adicionada!', 'success');
                }
                setPontoRecemAdicionado(null);
                setNotaRapida('');
            };
            
            // Pular nota r√°pida
            const pularNotaRapida = () => {
                setPontoRecemAdicionado(null);
                setNotaRapida('');
            };
            
            const removerPonto = (id) => {
                setPontos(pontos.filter(p => p.id !== id));
                if (pontoRecemAdicionado === id) {
                    setPontoRecemAdicionado(null);
                    setNotaRapida('');
                }
            };
            
            const moverPonto = (idx, dir) => { const lista = [...pontos]; const n = idx + dir; if (n >= 0 && n < lista.length) { [lista[idx], lista[n]] = [lista[n], lista[idx]]; setPontos(lista); } };
            
            const abrirEdicaoPonto = (idx) => { 
                const p = pontos[idx]; 
                setDadosPonto({ 
                    observacao: p.observacao || '', 
                    telefone: p.telefone || '', 
                    procurar_por: p.procurar_por || '', 
                    numero_nota: p.numero_nota || '', 
                    codigo_finalizar: p.codigo_finalizar || '',
                    complemento: p.complemento || ''
                }); 
                setPontoEditando(idx);
                // Fechar input de nota r√°pida se estiver aberto
                setPontoRecemAdicionado(null);
                setNotaRapida('');
            };
            
            const salvarEdicaoPonto = () => { const n = [...pontos]; n[pontoEditando] = { ...n[pontoEditando], ...dadosPonto }; setPontos(n); setPontoEditando(null); showToast('‚úÖ Salvo', 'success'); };
            const salvarPartidaPadrao = async () => { if (pontos.length === 0) return; try { await fetch(`${API_URL}/api/solicitacao/configuracoes`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ endereco_partida_padrao: pontos[0] }) }); showToast('‚úÖ Salvo!', 'success'); } catch {} };
            const limpar = () => { if (cliente.endereco_partida_padrao) setPontos([{ id: Date.now(), ...cliente.endereco_partida_padrao, isPartida: true }]); else setPontos([]); setSugestoes([]); setTermoBusca(''); setPontoRecemAdicionado(null); setNotaRapida(''); };
            
            const enviarSolicitacao = async () => {
                if (pontos.length < 2) { showToast('M√≠nimo 2 pontos', 'error'); return; }
                if (config.ordenar && pontos.length > 20) { showToast('Ordena√ß√£o: m√°x 20 pts', 'warning'); return; }
                
                // Fechar input de nota r√°pida antes de enviar
                if (pontoRecemAdicionado && notaRapida.trim()) {
                    setPontos(prev => prev.map(p => p.id === pontoRecemAdicionado ? { ...p, numero_nota: notaRapida.trim() } : p));
                }
                setPontoRecemAdicionado(null);
                setNotaRapida('');
                
                setLoading(true);
                try {
                    const dataRet = config.data_retirada && config.hora_retirada ? `${config.data_retirada} ${config.hora_retirada}:00` : '';
                    
                    // Buscar dados do profissional selecionado
                    const profSelecionado = config.codigo_profissional ? profissionais.find(p => p.codigo === config.codigo_profissional) : null;
                    
                    const payload = { 
                        numero_pedido: config.numero_pedido, 
                        centro_custo: config.centro_custo, 
                        usuario_solicitante: config.usuario_solicitante, 
                        data_retirada: dataRet, 
                        forma_pagamento: config.forma_pagamento, 
                        ponto_receber: config.ponto_receber ? parseInt(config.ponto_receber) : null, 
                        retorno: config.retorno, 
                        obs_retorno: config.obs_retorno, 
                        ordenar: config.ordenar, 
                        codigo_profissional: config.codigo_profissional,
                        // Dados do profissional selecionado
                        profissional_nome: profSelecionado?.nome || null,
                        profissional_foto: profSelecionado?.foto || null,
                        pontos: pontos.map(p => ({
                            endereco_completo: p.endereco_completo,
                            rua: p.rua,
                            numero: p.numero,
                            complemento: p.complemento,
                            bairro: p.bairro,
                            cidade: p.cidade,
                            uf: p.uf,
                            cep: p.cep,
                            latitude: p.latitude,
                            longitude: p.longitude,
                            observacao: p.observacao,
                            telefone: p.telefone,
                            procurar_por: p.procurar_por,
                            numero_nota: p.numero_nota,
                            codigo_finalizar: p.codigo_finalizar
                        }))
                    };
                    
                    const resp = await fetch(`${API_URL}/api/solicitacao/criar`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
                    const data = await resp.json();
                    if (resp.ok) { showToast(`üöÄ Corrida #${data.os || data.id} criada!`, 'success'); limpar(); carregarCorridasAtivas(); }
                    else showToast(data.error || 'Erro', 'error');
                } catch (err) { showToast('Erro ao criar', 'error'); }
                setLoading(false);
            };
            
            const statusCores = { enviado: 'bg-yellow-100 text-yellow-800', aceito: 'bg-blue-100 text-blue-800', em_andamento: 'bg-green-100 text-green-800', finalizado: 'bg-gray-100 text-gray-600', cancelado: 'bg-red-100 text-red-800' };
            const statusIcons = { enviado: 'üì§', aceito: '‚úÖ', em_andamento: 'üèçÔ∏è', finalizado: 'üèÅ', cancelado: '‚ùå' };
            const statusNomes = { enviado: 'Enviado', aceito: 'Aceito', em_andamento: 'Em andamento', finalizado: 'Finalizado', cancelado: 'Cancelado' };
            
            const formatarData = (d) => { if (!d) return '‚Äî'; return new Date(d).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }); };
            const contarPontos = (corrida) => { const total = corrida.total_pontos || 0; return { coletas: 1, entregas: Math.max(0, total - 1) }; };
            
            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Header fixo */}
                    <header className="bg-gradient-to-r from-blue-900 to-blue-800 text-white px-4 py-3 sticky top-0 z-30 shadow-lg">
                        <div className="max-w-7xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <img src="https://github.com/Leonardodevcloud/tutts-frontend/blob/main/logotuttsoriginal.png?raw=true" alt="Logo" className="w-10 h-10 rounded-xl" />
                                <div>
                                    <h1 className="font-bold text-lg">Tutts</h1>
                                    <p className="text-xs text-blue-200 truncate max-w-[150px]">{cliente.nome}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setMostrarHistorico(true)} className="p-2 bg-white/10 rounded-lg hover:bg-white/20" title="Hist√≥rico">üìã</button>
                                <button onClick={onLogout} className="p-2 bg-red-500/20 rounded-lg hover:bg-red-500/30" title="Sair">üö™</button>
                            </div>
                        </div>
                    </header>
                    
                    {/* Abas */}
                    <div className="bg-white border-b sticky top-[68px] z-20">
                        <div className="max-w-7xl mx-auto flex">
                            <button onClick={() => { setAbaAtiva('nova'); setAbaMobile('form'); }} className={`flex-1 py-3 text-sm font-medium border-b-2 transition-all ${abaAtiva === 'nova' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>üìù Nova</button>
                            <button onClick={() => { setAbaAtiva('acompanhar'); carregarCorridasAtivas(); }} className={`flex-1 py-3 text-sm font-medium border-b-2 transition-all relative ${abaAtiva === 'acompanhar' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>üèçÔ∏è Acompanhar{corridasAtivas.length > 0 && <span className="absolute -top-1 right-4 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">{corridasAtivas.length}</span>}</button>
                            <button onClick={() => { setAbaAtiva('concluidas'); carregarConcluidas(); }} className={`flex-1 py-3 text-sm font-medium border-b-2 transition-all ${abaAtiva === 'concluidas' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>‚úÖ Conclu√≠das</button>
                        </div>
                    </div>
                    
                    {/* ========== ABA NOVA SOLICITA√á√ÉO ========== */}
                    {abaAtiva === 'nova' && (
                        <>
                            {/* Switcher Mobile */}
                            <div className="md:hidden flex bg-gray-200 m-2 rounded-lg p-1">
                                <button onClick={() => setAbaMobile('form')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${abaMobile === 'form' ? 'bg-white shadow' : ''}`}>üìù Formul√°rio</button>
                                <button onClick={() => setAbaMobile('mapa')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${abaMobile === 'mapa' ? 'bg-white shadow' : ''}`}>üó∫Ô∏è Mapa</button>
                            </div>
                            
                            <div className="max-w-7xl mx-auto p-2 md:p-4">
                                <div className="flex flex-col md:flex-row gap-4">
                                    {/* Formul√°rio */}
                                    <div className={`${abaMobile === 'form' ? 'block' : 'hidden'} md:block w-full md:w-96 space-y-3`}>
                                        {/* PONTO DE PARTIDA */}
                                        <div className="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl shadow p-3 border border-amber-200">
                                            <div className="flex items-center justify-between mb-2">
                                                <span className="text-sm font-bold text-amber-800">üì¶ PONTO DE PARTIDA</span>
                                                {pontos.length > 0 && <button onClick={salvarPartidaPadrao} className="text-xs text-amber-600 hover:text-amber-800">üíæ Salvar padr√£o</button>}
                                            </div>
                                            {pontos.length === 0 ? (
                                                <div>
                                                    <div className="flex gap-2">
                                                        <input type="text" value={termoBusca} onChange={(e) => setTermoBusca(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && buscarEndereco()} className="flex-1 px-3 py-2 border border-amber-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-amber-400" placeholder="Digite o endere√ßo de partida..." />
                                                        <button onClick={buscarEndereco} disabled={buscando} className="px-3 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm font-medium">{buscando ? '...' : 'üîç'}</button>
                                                    </div>
                                                    {/* Endere√ßos salvos */}
                                                    {mostrarSalvos && enderecosSalvos.length > 0 && (
                                                        <div className="mt-2 bg-amber-50 border border-amber-200 rounded-lg max-h-40 overflow-y-auto">
                                                            <div className="px-2 py-1 text-xs font-medium text-amber-700 border-b border-amber-200 bg-amber-100">üíæ Endere√ßos salvos</div>
                                                            {enderecosSalvos.map((e, i) => (
                                                                <div key={i} onClick={() => adicionarPontoSalvo(e)} className="p-2 hover:bg-amber-100 cursor-pointer text-xs border-b border-amber-100">
                                                                    <div className="font-medium text-amber-800">‚≠ê {e.apelido}</div>
                                                                    <div className="text-gray-600 truncate">{e.endereco_completo || `${e.rua}, ${e.numero} - ${e.bairro}, ${e.cidade}`}{e.complemento && ` (${e.complemento})`}</div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {/* Sugest√µes do Google com bot√£o de ajustar */}
                                                    {sugestoes.length > 0 && (
                                                        <div className="mt-2 bg-white border border-amber-200 rounded-lg max-h-48 overflow-y-auto">
                                                            {sugestoes.map((s, i) => (
                                                                <div key={i} className="p-2 hover:bg-amber-50 border-b flex items-center gap-2">
                                                                    <div className="flex-1 cursor-pointer" onClick={() => adicionarPonto(s)}>
                                                                        <div className="text-xs">üìç {s.endereco}</div>
                                                                    </div>
                                                                    <button 
                                                                        onClick={(e) => { e.stopPropagation(); abrirModalAjusteMapa(s); }}
                                                                        className="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium whitespace-nowrap"
                                                                        title="Ajustar posi√ß√£o no mapa"
                                                                    >
                                                                        üéØ Ajustar
                                                                    </button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            ) : (
                                                <div className="bg-white rounded-lg p-2 border border-amber-200">
                                                    <div className="flex items-center gap-2">
                                                        <span className="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center text-white text-sm font-bold">üì¶</span>
                                                        <div className="flex-1 min-w-0">
                                                            {pontos[0].apelido_salvo && <div className="text-xs text-amber-600 font-medium">‚≠ê {pontos[0].apelido_salvo}</div>}
                                                            <div className="text-xs font-medium truncate">{pontos[0].endereco_completo || `${pontos[0].rua}, ${pontos[0].numero}`}</div>
                                                            {pontos[0].complemento && <div className="text-xs text-amber-700">üè† {pontos[0].complemento}</div>}
                                                            {pontos[0].bairro && <div className="text-xs text-gray-500">{pontos[0].bairro}, {pontos[0].cidade}</div>}
                                                            {pontos[0].numero_nota && <div className="text-xs text-amber-600">üè∑Ô∏è {pontos[0].numero_nota}</div>}
                                                            {pontos[0].observacao && <div className="text-xs text-gray-500 truncate">üìù {pontos[0].observacao}</div>}
                                                            {pontos[0].ajustado_manualmente && <div className="text-xs text-green-600">üéØ Posi√ß√£o ajustada</div>}
                                                        </div>
                                                        <div className="flex gap-1">
                                                            {!pontos[0].endereco_salvo_id && (
                                                                <button onClick={() => { setModalSalvarEndereco({ aberto: true, ponto: pontos[0] }); setApelidoSalvar(''); setComplementoSalvar(pontos[0].complemento || ''); }} className="text-gray-400 hover:text-green-600 text-sm" title="Salvar endere√ßo">üíæ</button>
                                                            )}
                                                            <button onClick={() => abrirEdicaoPonto(0)} className="text-gray-400 hover:text-amber-600 text-sm">‚úèÔ∏è</button>
                                                            <button onClick={() => removerPonto(pontos[0].id)} className="text-gray-400 hover:text-red-600">‚úï</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* PONTOS DE ENTREGA */}
                                        <div className="bg-white rounded-xl shadow p-3">
                                            <div className="flex items-center justify-between mb-2">
                                                <span className="text-sm font-bold text-blue-800">üìç PONTOS DE ENTREGA ({Math.max(0, pontos.length - 1)}/79)</span>
                                                {pontos.length > 1 && <button onClick={() => setPontos(pontos.slice(0, 1))} className="text-xs text-red-500 hover:text-red-700">Limpar</button>}
                                            </div>
                                            {pontos.length > 0 && (
                                                <div className="mb-2">
                                                    <div className="flex gap-2">
                                                        <input type="text" value={termoBusca} onChange={(e) => setTermoBusca(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && buscarEndereco()} className="flex-1 px-3 py-2 border rounded-lg text-sm outline-none" placeholder="Digite apelido ou endere√ßo..." />
                                                        <button onClick={buscarEndereco} disabled={buscando} className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm" title="Buscar no Google">{buscando ? '...' : 'üîç'}</button>
                                                    </div>
                                                    {/* Endere√ßos salvos */}
                                                    {mostrarSalvos && enderecosSalvos.length > 0 && (
                                                        <div className="mt-2 bg-blue-50 border border-blue-200 rounded-lg max-h-40 overflow-y-auto">
                                                            <div className="px-2 py-1 text-xs font-medium text-blue-700 border-b border-blue-200 bg-blue-100">üíæ Endere√ßos salvos</div>
                                                            {enderecosSalvos.map((e, i) => (
                                                                <div key={i} onClick={() => adicionarPontoSalvo(e)} className="p-2 hover:bg-blue-100 cursor-pointer text-xs border-b border-blue-100">
                                                                    <div className="font-medium text-blue-800">‚≠ê {e.apelido}</div>
                                                                    <div className="text-gray-600 truncate">{e.endereco_completo || `${e.rua}, ${e.numero} - ${e.bairro}, ${e.cidade}`}{e.complemento && ` (${e.complemento})`}</div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {/* Sugest√µes do Google com bot√£o de ajustar */}
                                                    {sugestoes.length > 0 && (
                                                        <div className="mt-2 bg-white border rounded-lg max-h-48 overflow-y-auto">
                                                            {sugestoes.map((s, i) => (
                                                                <div key={i} className="p-2 hover:bg-blue-50 border-b flex items-center gap-2">
                                                                    <div className="flex-1 cursor-pointer" onClick={() => adicionarPonto(s)}>
                                                                        <div className="text-xs">üìç {s.endereco}</div>
                                                                    </div>
                                                                    <button 
                                                                        onClick={(e) => { e.stopPropagation(); abrirModalAjusteMapa(s); }}
                                                                        className="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium whitespace-nowrap"
                                                                        title="Ajustar posi√ß√£o no mapa"
                                                                    >
                                                                        üéØ Ajustar
                                                                    </button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            <div className="space-y-2 max-h-64 overflow-y-auto">
                                                {pontos.length <= 1 ? (
                                                    <div className="text-center py-6 text-gray-400"><div className="text-3xl mb-2">üìç</div><div className="text-sm">Adicione pontos de entrega</div></div>
                                                ) : (
                                                    pontos.slice(1).map((p, idx) => {
                                                        const realIdx = idx + 1;
                                                        return (
                                                            <div key={p.id}>
                                                                <div className="bg-blue-50 rounded-lg p-2 border border-blue-100">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="w-7 h-7 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs font-bold">{realIdx}</span>
                                                                        <div className="flex-1 min-w-0">
                                                                            {p.apelido_salvo && <div className="text-xs text-blue-600 font-medium">‚≠ê {p.apelido_salvo}</div>}
                                                                            <div className="text-xs font-medium truncate">{p.endereco_completo || `${p.rua}, ${p.numero}`}</div>
                                                                            {p.complemento && <div className="text-xs text-blue-700">üè† {p.complemento}</div>}
                                                                            {p.bairro && <div className="text-xs text-gray-500">{p.bairro}</div>}
                                                                            {p.numero_nota && <div className="text-xs text-blue-600">üè∑Ô∏è {p.numero_nota}</div>}
                                                                            {p.observacao && <div className="text-xs text-gray-500 truncate">üìù {p.observacao}</div>}
                                                                            {p.ajustado_manualmente && <div className="text-xs text-green-600">üéØ Posi√ß√£o ajustada</div>}
                                                                        </div>
                                                                        <div className="flex flex-col gap-1">
                                                                            <div className="flex gap-1">
                                                                                <button onClick={() => moverPonto(realIdx, -1)} disabled={realIdx <= 1} className="text-gray-400 hover:text-gray-600 text-sm disabled:opacity-30">‚Üë</button>
                                                                                <button onClick={() => moverPonto(realIdx, 1)} disabled={realIdx >= pontos.length - 1} className="text-gray-400 hover:text-gray-600 text-sm disabled:opacity-30">‚Üì</button>
                                                                            </div>
                                                                            <div className="flex gap-1">
                                                                                {!p.endereco_salvo_id && (
                                                                                    <button onClick={() => { setModalSalvarEndereco({ aberto: true, ponto: p }); setApelidoSalvar(''); setComplementoSalvar(p.complemento || ''); }} className="text-gray-400 hover:text-green-600 text-xs" title="Salvar">üíæ</button>
                                                                                )}
                                                                                <button onClick={() => abrirEdicaoPonto(realIdx)} className="text-gray-400 hover:text-blue-600 text-xs">‚úèÔ∏è</button>
                                                                                <button onClick={() => removerPonto(p.id)} className="text-gray-400 hover:text-red-600 text-xs">‚úï</button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                {/* Input de nota r√°pida */}
                                                                {pontoRecemAdicionado === p.id && (
                                                                    <div className="mt-1 p-2 bg-yellow-50 border border-yellow-200 rounded-lg slide-down">
                                                                        <div className="flex items-center gap-2">
                                                                            <span className="text-xs text-yellow-700">üè∑Ô∏è</span>
                                                                            <input 
                                                                                ref={notaInputRef}
                                                                                type="text" 
                                                                                value={notaRapida} 
                                                                                onChange={(e) => setNotaRapida(e.target.value)}
                                                                                onKeyPress={(e) => e.key === 'Enter' && salvarNotaRapida()}
                                                                                className="flex-1 px-2 py-1 border border-yellow-300 rounded text-xs outline-none focus:ring-1 focus:ring-yellow-400"
                                                                                placeholder="N¬∫ nota (opcional)"
                                                                                autoFocus
                                                                            />
                                                                            <button onClick={salvarNotaRapida} className="px-2 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-xs font-medium">‚úì</button>
                                                                            <button onClick={pularNotaRapida} className="px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-600 rounded text-xs">Pular</button>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* Configura√ß√µes */}
                                        <div className="bg-white rounded-xl shadow p-3">
                                            <div className="text-sm font-bold text-gray-700 mb-2">‚öôÔ∏è CONFIGURA√á√ïES</div>
                                            <div className="grid grid-cols-2 gap-2 text-xs">
                                                <div><label className="block text-gray-500 mb-1">N¬∫ Pedido</label><input type="text" value={config.numero_pedido} onChange={(e) => setConfig({...config, numero_pedido: e.target.value})} className="w-full px-2 py-1.5 border rounded text-xs" placeholder="Opcional" /></div>
                                                <div><label className="block text-gray-500 mb-1">Centro Custo</label><input type="text" value={config.centro_custo} onChange={(e) => setConfig({...config, centro_custo: e.target.value})} className="w-full px-2 py-1.5 border rounded text-xs" /></div>
                                                <div><label className="block text-gray-500 mb-1">Solicitante</label><input type="text" value={config.usuario_solicitante} onChange={(e) => setConfig({...config, usuario_solicitante: e.target.value})} className="w-full px-2 py-1.5 border rounded text-xs" /></div>
                                                <div><label className="block text-gray-500 mb-1">Pagamento</label><select value={config.forma_pagamento} onChange={(e) => setConfig({...config, forma_pagamento: e.target.value})} className="w-full px-2 py-1.5 border rounded text-xs"><option value="F">Faturado</option><option value="C">Cart√£o</option><option value="D">Dinheiro</option><option value="P">Pix</option></select></div>
                                                <div><label className="block text-gray-500 mb-1">Data Ret.</label><input type="date" value={config.data_retirada} onChange={(e) => setConfig({...config, data_retirada: e.target.value})} className="w-full px-2 py-1.5 border rounded text-xs" /></div>
                                                <div><label className="block text-gray-500 mb-1">Hora Ret.</label><input type="time" value={config.hora_retirada} onChange={(e) => setConfig({...config, hora_retirada: e.target.value})} className="w-full px-2 py-1.5 border rounded text-xs" /></div>
                                                <div className="col-span-2">
                                                    <label className="block text-gray-500 mb-1">üèçÔ∏è Profissional</label>
                                                    <select 
                                                        value={config.codigo_profissional} 
                                                        onChange={(e) => setConfig({...config, codigo_profissional: e.target.value})} 
                                                        className={`w-full px-2 py-1.5 border rounded text-xs ${config.codigo_profissional ? 'border-green-500 bg-green-50' : ''}`}
                                                        disabled={carregandoProfissionais}
                                                    >
                                                        <option value="">üé≤ Qualquer dispon√≠vel</option>
                                                        {profissionais.map(p => (
                                                            <option key={p.codigo} value={p.codigo}>
                                                                {p.nome} ({p.codigo})
                                                            </option>
                                                        ))}
                                                    </select>
                                                    {config.codigo_profissional && (
                                                        <div className="mt-1 text-xs text-green-600 font-medium">
                                                            ‚úÖ Corrida ser√° direcionada para: {profissionais.find(p => p.codigo === config.codigo_profissional)?.nome}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex flex-wrap gap-3 mt-3">
                                                <label className="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" checked={config.ordenar} onChange={(e) => setConfig({...config, ordenar: e.target.checked})} className="w-4 h-4" />üó∫Ô∏è Ordenar rota</label>
                                                <label className="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" checked={config.retorno} onChange={(e) => setConfig({...config, retorno: e.target.checked})} className="w-4 h-4" />‚Ü©Ô∏è Retorno</label>
                                            </div>
                                        </div>
                                        
                                        {/* Bot√£o Enviar */}
                                        <button onClick={enviarSolicitacao} disabled={loading || pontos.length < 2} className={`w-full py-3 text-white rounded-xl font-bold text-sm shadow-lg disabled:opacity-50 ${config.codigo_profissional ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'}`}>
                                            {loading ? '‚è≥ Enviando...' : `üöÄ Solicitar Corrida (${pontos.length} pts)`}
                                        </button>
                                    </div>
                                    
                                    {/* Mapa */}
                                    <div className={`${abaMobile === 'mapa' ? 'block' : 'hidden'} md:block flex-1`}>
                                        <MapaLeaflet key={`nova-${mapaKey}`} id="mapa-nova" pontos={pontos} height="calc(100vh - 200px)" tipo="nova" />
                                    </div>
                                </div>
                            </div>
                        </>
                    )}
                    
                    {/* ========== ABA ACOMPANHAR ========== */}
                    {abaAtiva === 'acompanhar' && (
                        <div className="max-w-7xl mx-auto p-2 md:p-4">
                            <div className="flex flex-col md:flex-row gap-4">
                                <div className="w-full md:w-80 space-y-3">
                                    <div className="bg-white rounded-xl shadow p-3">
                                        <div className="flex items-center justify-between mb-3">
                                            <span className="text-sm font-bold text-gray-700">üèçÔ∏è Corridas Ativas ({corridasAtivas.length})</span>
                                            <button onClick={sincronizarStatus} disabled={sincronizando} className="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded font-medium disabled:opacity-50">{sincronizando ? '‚è≥...' : 'üîÑ Sync'}</button>
                                        </div>
                                        {corridasAtivas.length === 0 ? (
                                            <div className="text-center py-8 text-gray-400"><div className="text-4xl mb-2">üì≠</div><div className="text-sm">Nenhuma corrida ativa</div></div>
                                        ) : (
                                            <div className="space-y-2 max-h-[calc(100vh-280px)] overflow-y-auto">
                                                {corridasAtivas.map(c => {
                                                    const { coletas, entregas } = contarPontos(c);
                                                    // Buscar notas dos pontos (se dispon√≠vel)
                                                    const notas = c.notas_pontos || [];
                                                    // Verificar se tem ponto de retorno
                                                    const temRetorno = c.pontos?.some(p => p.is_retorno || p.tipo_ponto === 'retorno') || 
                                                                       (c.dados_pontos && JSON.parse(typeof c.dados_pontos === 'string' ? c.dados_pontos : JSON.stringify(c.dados_pontos || []))?.some(p => p.is_retorno));
                                                    return (
                                                        <div key={c.id} onClick={() => selecionarCorrida(c.id)} className={`p-3 rounded-lg border-2 cursor-pointer transition-all ${temRetorno ? 'border-orange-400 bg-orange-50' : corridaSelecionada === c.id ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-gray-200 hover:border-gray-300 hover:shadow'}`}>
                                                            <div className="flex items-center justify-between mb-2">
                                                                <div className="flex items-center gap-2 min-w-0 flex-1">
                                                                    {c.profissional_foto ? <img src={c.profissional_foto} className="w-8 h-8 rounded-full object-cover border-2 border-gray-200" /> : <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-sm">üèçÔ∏è</div>}
                                                                    <span className="font-medium text-sm text-gray-800 truncate">{c.profissional_nome || 'Aguardando...'}</span>
                                                                </div>
                                                                <span className="text-xs font-bold text-gray-600 whitespace-nowrap">OS #{c.tutts_os_numero || c.id}</span>
                                                            </div>
                                                            <div className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${statusCores[c.status]}`}><span>{statusIcons[c.status]}</span><span>{statusNomes[c.status]}</span></div>
                                                            {/* Alerta de retorno */}
                                                            {temRetorno && (
                                                                <div className="mt-2 group relative">
                                                                    <div className="flex items-center gap-1 px-2 py-1 bg-orange-100 border border-orange-300 rounded text-xs text-orange-700 font-medium">
                                                                        <span>‚ö†Ô∏è</span>
                                                                        <span>Aten√ß√£o: Corrida com retorno</span>
                                                                    </div>
                                                                    <div className="absolute bottom-full left-0 mb-1 hidden group-hover:block z-50">
                                                                        <div className="bg-gray-900 text-white text-xs rounded py-2 px-3 whitespace-nowrap shadow-lg">
                                                                            Caso o retorno seja indevido, solicite o<br/>cancelamento ao suporte Tutts.
                                                                        </div>
                                                                        <div className="w-2 h-2 bg-gray-900 transform rotate-45 absolute left-4 -bottom-1"></div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            <div className="flex items-center justify-between mt-2 text-xs text-gray-500">
                                                                <span>üì¶ {coletas} ‚Üí üìç {entregas}</span>
                                                                {c.tutts_valor && <span className="font-bold text-green-600">R$ {parseFloat(c.tutts_valor).toFixed(2)}</span>}
                                                            </div>
                                                            {/* Notas das entregas */}
                                                            {notas.length > 0 && (
                                                                <div className="mt-2 pt-2 border-t border-gray-200">
                                                                    <div className="flex flex-wrap gap-1">
                                                                        {notas.slice(0, 3).map((nota, idx) => (
                                                                            <span key={idx} className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">üè∑Ô∏è {nota}</span>
                                                                        ))}
                                                                        {notas.length > 3 && <span className="text-xs text-gray-400">+{notas.length - 3}</span>}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Detalhes da corrida selecionada */}
                                <div className="flex-1">
                                    {corridaSelecionada && detalheCorrida ? (
                                        <div className="bg-white rounded-xl shadow overflow-hidden">
                                            <div className="bg-blue-900 text-white px-4 py-3 flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    {detalheCorrida.profissional_foto ? <img src={detalheCorrida.profissional_foto} className="w-10 h-10 rounded-full object-cover border-2 border-white" /> : <div className="w-10 h-10 rounded-full bg-blue-700 flex items-center justify-center text-lg">üèçÔ∏è</div>}
                                                    <div>
                                                        <div className="font-bold">{detalheCorrida.profissional_nome || 'Aguardando profissional...'}</div>
                                                        <div className="text-sm text-blue-200">OS #{detalheCorrida.tutts_os_numero || detalheCorrida.id}</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    {detalheCorrida.tutts_os_numero && (
                                                        <>
                                                            <button onClick={() => copiarLinkRastreio(detalheCorrida.tutts_os_numero)} className="p-2 bg-white/10 rounded-lg hover:bg-white/20" title="Copiar link">üìã</button>
                                                            <button onClick={() => compartilharWhatsApp(detalheCorrida.tutts_os_numero)} className="p-2 bg-green-500/20 rounded-lg hover:bg-green-500/30" title="WhatsApp">üí¨</button>
                                                        </>
                                                    )}
                                                    {['enviado', 'aceito'].includes(detalheCorrida.status) && (
                                                        <button onClick={() => cancelarCorrida(detalheCorrida.id)} className="p-2 bg-red-500/20 rounded-lg hover:bg-red-500/30 text-red-200" title="Cancelar">‚ùå</button>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            <div className="p-4">
                                                <div className="flex items-center gap-2 mb-4">
                                                    <span className={`px-3 py-1 rounded-full text-sm font-medium ${statusCores[detalheCorrida.status]}`}>{statusIcons[detalheCorrida.status]} {statusNomes[detalheCorrida.status]}</span>
                                                    {detalheCorrida.tutts_valor && <span className="text-lg font-bold text-green-600">R$ {parseFloat(detalheCorrida.tutts_valor).toFixed(2)}</span>}
                                                </div>
                                                
                                                {/* Mapa da corrida */}
                                                <div className="h-64 mb-4 rounded-lg overflow-hidden">
                                                    <MapaLeaflet key={`acomp-${corridaSelecionada}-${mapaKey}`} id={`mapa-acompanhar-${corridaSelecionada}`} pontos={detalheCorrida.pontos || []} height="100%" tipo="acompanhar" />
                                                </div>
                                                
                                                {/* Lista de pontos */}
                                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                                    {(detalheCorrida.pontos || []).map((p, idx) => (
                                                        <div key={idx} className={`p-3 rounded-lg border ${p.status === 'finalizado' ? 'bg-green-50 border-green-200' : p.status === 'chegou' || p.status === 'coletado' ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200'}`}>
                                                            <div className="flex items-center gap-2">
                                                                <span className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold ${idx === 0 ? 'bg-amber-500' : p.status === 'finalizado' ? 'bg-green-500' : 'bg-blue-500'}`}>{idx === 0 ? 'üì¶' : p.status === 'finalizado' ? '‚úì' : idx}</span>
                                                                <div className="flex-1 min-w-0">
                                                                    <div className="text-sm font-medium truncate">{p.endereco_completo || `${p.rua}, ${p.numero}`}</div>
                                                                    {p.bairro && <div className="text-xs text-gray-500">{p.bairro}</div>}
                                                                    {p.numero_nota && <div className="text-xs text-blue-600 font-medium">üè∑Ô∏è {p.numero_nota}</div>}
                                                                    {p.observacao && <div className="text-xs text-gray-500">üìù {p.observacao}</div>}
                                                                </div>
                                                                {p.status && <span className={`text-xs px-2 py-1 rounded ${p.status === 'finalizado' ? 'bg-green-100 text-green-700' : p.status === 'chegou' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}`}>{p.status === 'finalizado' ? '‚úÖ Entregue' : p.status === 'chegou' ? 'üìç Chegou' : p.status === 'coletado' ? 'üì¶ Coletado' : '‚è≥ Pendente'}</span>}
                                                            </div>
                                                            
                                                            {/* Fotos do ponto */}
                                                            {p.fotos && p.fotos.length > 0 && (
                                                                <div className="mt-2 pt-2 border-t border-gray-200">
                                                                    <div className="flex gap-2 overflow-x-auto">
                                                                        {p.fotos.map((foto, fotoIdx) => (
                                                                            <img 
                                                                                key={fotoIdx} 
                                                                                src={typeof foto === 'string' ? foto : foto.url || foto.link} 
                                                                                className="w-16 h-16 rounded object-cover cursor-pointer hover:opacity-80 transition-opacity flex-shrink-0" 
                                                                                onClick={() => abrirFotoModal(p.fotos, fotoIdx)}
                                                                                alt={`Foto ${fotoIdx + 1}`}
                                                                            />
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="bg-white rounded-xl shadow p-8 text-center text-gray-400">
                                            <div className="text-6xl mb-4">üó∫Ô∏è</div>
                                            <div className="text-lg">Selecione uma corrida para ver detalhes</div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* ========== ABA CONCLU√çDAS ========== */}
                    {abaAtiva === 'concluidas' && (
                        <div className="max-w-4xl mx-auto p-2 md:p-4">
                            <div className="bg-white rounded-xl shadow">
                                <div className="p-3 border-b flex items-center justify-between">
                                    <span className="font-bold text-gray-700">‚úÖ Corridas Conclu√≠das ({corridasConcluidas.length})</span>
                                    <select value={filtroConcluidas} onChange={(e) => setFiltroConcluidas(e.target.value)} className="text-sm border rounded px-2 py-1">
                                        <option value="todas">Todas</option>
                                        <option value="finalizado">Finalizadas</option>
                                        <option value="cancelado">Canceladas</option>
                                    </select>
                                </div>
                                <div className="divide-y max-h-[calc(100vh-250px)] overflow-y-auto">
                                    {corridasConcluidas.filter(c => filtroConcluidas === 'todas' || c.status === filtroConcluidas).length === 0 ? (
                                        <div className="p-8 text-center text-gray-400"><div className="text-4xl mb-2">üì≠</div><div>Nenhuma corrida</div></div>
                                    ) : (
                                        corridasConcluidas.filter(c => filtroConcluidas === 'todas' || c.status === filtroConcluidas).map(c => {
                                            const { coletas, entregas } = contarPontos(c);
                                            const isExpandida = corridaExpandida === c.id;
                                            return (
                                                <div key={c.id} className="hover:bg-gray-50">
                                                    <div className="p-3 cursor-pointer" onClick={() => toggleExpandirCorrida(c.id)}>
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex items-center gap-3">
                                                                {c.profissional_foto ? <img src={c.profissional_foto} className="w-10 h-10 rounded-full object-cover" /> : <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">üèçÔ∏è</div>}
                                                                <div>
                                                                    <div className="font-medium text-sm">{c.profissional_nome || 'Sem profissional'}</div>
                                                                    <div className="text-xs text-gray-500">{formatarData(c.criado_em)} ‚Ä¢ OS #{c.tutts_os_numero || c.id}</div>
                                                                </div>
                                                            </div>
                                                            <div className="text-right flex items-center gap-3">
                                                                <div>
                                                                    <span className={`px-2 py-1 rounded text-xs font-medium ${statusCores[c.status]}`}>{statusIcons[c.status]} {statusNomes[c.status]}</span>
                                                                    <div className="text-xs text-gray-500 mt-1">üì¶ {coletas} ‚Üí üìç {entregas}</div>
                                                                    {c.tutts_valor && <div className="text-sm font-bold text-green-600">R$ {parseFloat(c.tutts_valor).toFixed(2)}</div>}
                                                                </div>
                                                                <span className={`text-gray-400 transition-transform ${isExpandida ? 'rotate-180' : ''}`}>‚ñº</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Detalhes expandidos */}
                                                    {isExpandida && (
                                                        <div className="px-3 pb-3 border-t bg-gray-50">
                                                            {!detalhesCorridaExpandida ? (
                                                                <div className="py-4 text-center text-gray-400">
                                                                    <span className="animate-pulse">Carregando detalhes...</span>
                                                                </div>
                                                            ) : (
                                                                <div className="pt-3 space-y-2">
                                                                    {/* A√ß√µes */}
                                                                    <div className="flex gap-2 mb-3">
                                                                        {c.tutts_os_numero && (
                                                                            <>
                                                                                <button onClick={(e) => { e.stopPropagation(); copiarLinkRastreio(c.tutts_os_numero); }} className="px-3 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium">üìã Copiar link</button>
                                                                                <button onClick={(e) => { e.stopPropagation(); compartilharWhatsApp(c.tutts_os_numero); }} className="px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-700 rounded text-xs font-medium">üí¨ WhatsApp</button>
                                                                            </>
                                                                        )}
                                                                    </div>
                                                                    
                                                                    {/* Lista de pontos */}
                                                                    {(detalhesCorridaExpandida.pontos || []).map((p, idx) => (
                                                                        <div key={idx} className={`p-2 rounded border ${p.status === 'finalizado' ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'}`}>
                                                                            <div className="flex items-center gap-2">
                                                                                <span className={`w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold ${idx === 0 ? 'bg-amber-500' : 'bg-blue-500'}`}>{idx === 0 ? 'üì¶' : idx}</span>
                                                                                <div className="flex-1 min-w-0">
                                                                                    <div className="text-xs font-medium truncate">{p.endereco_completo || `${p.rua}, ${p.numero}`}</div>
                                                                                    {p.numero_nota && <div className="text-xs text-blue-600">üè∑Ô∏è {p.numero_nota}</div>}
                                                                                </div>
                                                                                {p.status === 'finalizado' && <span className="text-green-500">‚úÖ</span>}
                                                                            </div>
                                                                            
                                                                            {/* Fotos do ponto */}
                                                                            {p.fotos && p.fotos.length > 0 && (
                                                                                <div className="mt-2 flex gap-2 overflow-x-auto">
                                                                                    {p.fotos.map((foto, fotoIdx) => (
                                                                                        <img 
                                                                                            key={fotoIdx} 
                                                                                            src={typeof foto === 'string' ? foto : foto.url || foto.link} 
                                                                                            className="w-12 h-12 rounded object-cover cursor-pointer hover:opacity-80 flex-shrink-0" 
                                                                                            onClick={(e) => { e.stopPropagation(); abrirFotoModal(p.fotos, fotoIdx); }}
                                                                                            alt={`Foto ${fotoIdx + 1}`}
                                                                                        />
                                                                                    ))}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal editar ponto */}
                    {pontoEditando !== null && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setPontoEditando(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                                <div className="bg-blue-900 text-white px-4 py-3 rounded-t-xl flex items-center justify-between"><span className="font-bold">‚úèÔ∏è Editar Ponto</span><button onClick={() => setPontoEditando(null)} className="text-white/70 hover:text-white">‚úï</button></div>
                                <div className="p-4 space-y-3">
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">üè† Complemento</label><input type="text" value={dadosPonto.complemento} onChange={(e) => setDadosPonto({...dadosPonto, complemento: e.target.value})} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Apt, Bloco, Sala..." /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">üè∑Ô∏è N¬∫ Nota</label><input type="text" value={dadosPonto.numero_nota} onChange={(e) => setDadosPonto({...dadosPonto, numero_nota: e.target.value})} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="N√∫mero da nota fiscal" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">üìù Observa√ß√£o</label><textarea value={dadosPonto.observacao} onChange={(e) => setDadosPonto({...dadosPonto, observacao: e.target.value})} className="w-full px-3 py-2 border rounded-lg text-sm" rows="2" placeholder="Instru√ß√µes especiais..." /></textarea></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">üìû Telefone</label><input type="tel" value={dadosPonto.telefone} onChange={(e) => setDadosPonto({...dadosPonto, telefone: e.target.value})} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="(62) 99999-9999" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">üë§ Procurar por</label><input type="text" value={dadosPonto.procurar_por} onChange={(e) => setDadosPonto({...dadosPonto, procurar_por: e.target.value})} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Nome do destinat√°rio" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">üîë C√≥digo finalizar</label><input type="text" value={dadosPonto.codigo_finalizar} onChange={(e) => setDadosPonto({...dadosPonto, codigo_finalizar: e.target.value})} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="C√≥digo para finaliza√ß√£o" /></div>
                                </div>
                                <div className="p-4 border-t flex gap-2"><button onClick={() => setPontoEditando(null)} className="flex-1 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">Cancelar</button><button onClick={salvarEdicaoPonto} className="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">üíæ Salvar</button></div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal salvar endere√ßo */}
                    {modalSalvarEndereco.aberto && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setModalSalvarEndereco({ aberto: false, ponto: null })}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                                <div className="bg-green-600 text-white px-4 py-3 rounded-t-xl flex items-center justify-between">
                                    <span className="font-bold">üíæ Salvar Endere√ßo</span>
                                    <button onClick={() => setModalSalvarEndereco({ aberto: false, ponto: null })} className="text-white/70 hover:text-white">‚úï</button>
                                </div>
                                <div className="p-4 space-y-3">
                                    <div className="bg-gray-50 p-2 rounded text-xs text-gray-600">
                                        üìç {modalSalvarEndereco.ponto?.endereco_completo || `${modalSalvarEndereco.ponto?.rua}, ${modalSalvarEndereco.ponto?.numero}`}
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">‚≠ê Apelido *</label>
                                        <input 
                                            type="text" 
                                            value={apelidoSalvar} 
                                            onChange={(e) => setApelidoSalvar(e.target.value)} 
                                            className="w-full px-3 py-2 border rounded-lg text-sm" 
                                            placeholder="Ex: Loja Centro, Cliente Jo√£o..."
                                            autoFocus
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">üè† Complemento</label>
                                        <input 
                                            type="text" 
                                            value={complementoSalvar} 
                                            onChange={(e) => setComplementoSalvar(e.target.value)} 
                                            className="w-full px-3 py-2 border rounded-lg text-sm" 
                                            placeholder="Apt, Bloco, Sala..."
                                        />
                                    </div>
                                </div>
                                <div className="p-4 border-t flex gap-2">
                                    <button onClick={() => setModalSalvarEndereco({ aberto: false, ponto: null })} className="flex-1 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium text-sm">Cancelar</button>
                                    <button onClick={salvarEndereco} disabled={salvandoEndereco || !apelidoSalvar.trim()} className="flex-1 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm disabled:opacity-50">
                                        {salvandoEndereco ? '‚è≥ Salvando...' : 'üíæ Salvar'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* ============ NOVO: Modal de Ajuste de Mapa ============ */}
                    {modalAjusteMapa.aberto && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center mapa-ajuste-modal p-2 md:p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[95vh] overflow-hidden flex flex-col">
                                {/* Header */}
                                <div className="bg-blue-900 text-white px-4 py-3 flex items-center justify-between flex-shrink-0">
                                    <div className="flex items-center gap-2">
                                        <span className="text-xl">üéØ</span>
                                        <div>
                                            <span className="font-bold">Ajustar Posi√ß√£o no Mapa</span>
                                            <div className="text-xs text-blue-200">
                                                {modalAjusteMapa.etapa === 'ajustar' 
                                                    ? 'Arraste o pino ou clique no mapa' 
                                                    : 'Confirme o endere√ßo'}
                                            </div>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={fecharModalAjusteMapa} 
                                        className="text-white/70 hover:text-white text-xl"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                                
                                {/* Conte√∫do */}
                                <div className="flex-1 overflow-hidden flex flex-col">
                                    {modalAjusteMapa.etapa === 'ajustar' ? (
                                        <>
                                            {/* Endere√ßo original */}
                                            <div className="px-4 py-2 bg-gray-50 border-b flex-shrink-0">
                                                <div className="text-xs text-gray-500">Endere√ßo buscado:</div>
                                                <div className="text-sm font-medium text-gray-700 truncate">
                                                    üìç {modalAjusteMapa.sugestaoOriginal?.endereco}
                                                </div>
                                            </div>
                                            
                                            {/* Instru√ß√µes */}
                                            <div className="px-4 py-2 bg-blue-50 border-b flex-shrink-0">
                                                <div className="flex items-center gap-2 text-sm text-blue-700">
                                                    <span className="text-lg">üëÜ</span>
                                                    <div>
                                                        <strong>Arraste o pino vermelho</strong> para a posi√ß√£o exata ou <strong>clique no mapa</strong> para reposicionar
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Mapa */}
                                            <div className="flex-1 min-h-[300px] mapa-ajuste-container">
                                                <MapaAjustavel 
                                                    latitude={posicaoAjustada.lat || modalAjusteMapa.latitude}
                                                    longitude={posicaoAjustada.lng || modalAjusteMapa.longitude}
                                                    onPosicaoMudou={onPosicaoMudou}
                                                    zoom={17}
                                                />
                                            </div>
                                            
                                            {/* Coordenadas atuais */}
                                            <div className="px-4 py-2 bg-gray-50 border-t flex-shrink-0">
                                                <div className="flex items-center justify-between text-xs text-gray-500">
                                                    <span>Coordenadas:</span>
                                                    <span className="font-mono">
                                                        {posicaoAjustada.lat?.toFixed(6)}, {posicaoAjustada.lng?.toFixed(6)}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            {/* Bot√µes */}
                                            <div className="p-4 border-t flex gap-2 flex-shrink-0">
                                                <button 
                                                    onClick={fecharModalAjusteMapa} 
                                                    className="flex-1 py-2.5 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium text-sm"
                                                >
                                                    Cancelar
                                                </button>
                                                <button 
                                                    onClick={confirmarPosicaoMapa} 
                                                    disabled={buscandoEndereco}
                                                    className="flex-1 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm disabled:opacity-50"
                                                >
                                                    {buscandoEndereco ? '‚è≥ Buscando...' : '‚úì Confirmar Posi√ß√£o'}
                                                </button>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            {/* Etapa de confirma√ß√£o do endere√ßo */}
                                            <div className="p-4 space-y-4 overflow-y-auto">
                                                {/* Endere√ßo original */}
                                                <div className="bg-gray-50 rounded-lg p-3">
                                                    <div className="text-xs text-gray-500 mb-1">Endere√ßo original buscado:</div>
                                                    <div className="text-sm text-gray-600">
                                                        üìç {modalAjusteMapa.sugestaoOriginal?.endereco}
                                                    </div>
                                                </div>
                                                
                                                {/* Seta de mudan√ßa */}
                                                <div className="flex justify-center">
                                                    <div className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xl">
                                                        ‚Üì
                                                    </div>
                                                </div>
                                                
                                                {/* Novo endere√ßo */}
                                                <div className="bg-green-50 rounded-lg p-3 border-2 border-green-200">
                                                    <div className="text-xs text-green-600 mb-1 font-medium">‚úÖ Novo endere√ßo (posi√ß√£o ajustada):</div>
                                                    <div className="text-sm font-medium text-gray-800">
                                                        üéØ {enderecoAjustado?.endereco}
                                                    </div>
                                                    <div className="mt-2 text-xs text-gray-500 font-mono">
                                                        Coordenadas: {posicaoAjustada.lat?.toFixed(6)}, {posicaoAjustada.lng?.toFixed(6)}
                                                    </div>
                                                </div>
                                                
                                                {/* Compara√ß√£o visual */}
                                                {enderecoAjustado && (
                                                    <div className="bg-blue-50 rounded-lg p-3">
                                                        <div className="text-xs text-blue-600 mb-2 font-medium">üìã Detalhes do endere√ßo:</div>
                                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                                            {enderecoAjustado.componentes?.find(c => c.types?.includes('route')) && (
                                                                <div>
                                                                    <span className="text-gray-500">Rua:</span>
                                                                    <span className="ml-1 font-medium">{enderecoAjustado.componentes.find(c => c.types?.includes('route'))?.long_name}</span>
                                                                </div>
                                                            )}
                                                            {enderecoAjustado.componentes?.find(c => c.types?.includes('street_number')) && (
                                                                <div>
                                                                    <span className="text-gray-500">N√∫mero:</span>
                                                                    <span className="ml-1 font-medium">{enderecoAjustado.componentes.find(c => c.types?.includes('street_number'))?.long_name}</span>
                                                                </div>
                                                            )}
                                                            {enderecoAjustado.componentes?.find(c => c.types?.includes('sublocality_level_1') || c.types?.includes('sublocality')) && (
                                                                <div>
                                                                    <span className="text-gray-500">Bairro:</span>
                                                                    <span className="ml-1 font-medium">{enderecoAjustado.componentes.find(c => c.types?.includes('sublocality_level_1') || c.types?.includes('sublocality'))?.long_name}</span>
                                                                </div>
                                                            )}
                                                            {enderecoAjustado.componentes?.find(c => c.types?.includes('administrative_area_level_2') || c.types?.includes('locality')) && (
                                                                <div>
                                                                    <span className="text-gray-500">Cidade:</span>
                                                                    <span className="ml-1 font-medium">{enderecoAjustado.componentes.find(c => c.types?.includes('administrative_area_level_2') || c.types?.includes('locality'))?.long_name}</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* Bot√µes */}
                                            <div className="p-4 border-t flex gap-2 flex-shrink-0">
                                                <button 
                                                    onClick={voltarParaAjustar} 
                                                    className="flex-1 py-2.5 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium text-sm flex items-center justify-center gap-1"
                                                >
                                                    ‚Ü©Ô∏è Ajustar novamente
                                                </button>
                                                <button 
                                                    onClick={usarEnderecoAjustado} 
                                                    className="flex-1 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm flex items-center justify-center gap-1"
                                                >
                                                    ‚úì Usar este endere√ßo
                                                </button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal hist√≥rico */}
                    {mostrarHistorico && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setMostrarHistorico(false)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[80vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="bg-blue-900 text-white px-4 py-3 flex items-center justify-between"><span className="font-bold">üìã Hist√≥rico</span><button onClick={() => setMostrarHistorico(false)} className="text-white/70 hover:text-white">‚úï</button></div>
                                <div className="p-4 overflow-y-auto max-h-[65vh]">
                                    {historico.length === 0 ? <p className="text-center text-gray-500 py-8">Nenhuma solicita√ß√£o</p> : (
                                        <div className="space-y-2">
                                            {historico.map(h => (
                                                <div key={h.id} className="p-3 border rounded-lg hover:bg-gray-50">
                                                    <div className="flex items-center justify-between">
                                                        <div>
                                                            <div className="flex items-center gap-2">
                                                                <span className={`px-2 py-0.5 rounded text-xs font-medium ${statusCores[h.status]}`}>{statusIcons[h.status]} {statusNomes[h.status]}</span>
                                                                {h.tutts_os_numero && <span className="text-sm font-medium">OS #{h.tutts_os_numero}</span>}
                                                            </div>
                                                            <div className="text-xs text-gray-500 mt-1">{formatarData(h.criado_em)} ‚Ä¢ {h.total_pontos} pts{h.profissional_nome && ` ‚Ä¢ üèçÔ∏è ${h.profissional_nome}`}</div>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            {h.tutts_valor && <div className="text-sm font-bold text-green-600">R$ {parseFloat(h.tutts_valor).toFixed(2)}</div>}
                                                            {h.tutts_os_numero && <button onClick={() => copiarLinkRastreio(h.tutts_os_numero)} className="text-xs text-blue-600 hover:text-blue-800">üìã</button>}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal de fotos com zoom */}
                    {fotoModal.aberto && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center foto-modal" onClick={fecharFotoModal}>
                            <div className="relative w-full h-full flex items-center justify-center p-4" onClick={e => e.stopPropagation()}>
                                {/* Bot√£o fechar */}
                                <button onClick={fecharFotoModal} className="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 z-10">‚úï</button>
                                
                                {/* Contador */}
                                <div className="absolute top-4 left-4 text-white text-sm bg-black/50 px-3 py-1 rounded-full">
                                    {fotoModal.indice + 1} / {fotoModal.fotos.length}
                                </div>
                                
                                {/* Bot√£o anterior */}
                                {fotoModal.indice > 0 && (
                                    <button onClick={() => navegarFoto(-1)} className="absolute left-4 text-white text-5xl hover:text-gray-300">‚Äπ</button>
                                )}
                                
                                {/* Imagem */}
                                <img 
                                    src={typeof fotoModal.fotos[fotoModal.indice] === 'string' ? fotoModal.fotos[fotoModal.indice] : fotoModal.fotos[fotoModal.indice]?.url || fotoModal.fotos[fotoModal.indice]?.link}
                                    className="max-w-full max-h-full object-contain rounded-lg shadow-2xl"
                                    alt={`Foto ${fotoModal.indice + 1}`}
                                    onClick={e => e.stopPropagation()}
                                />
                                
                                {/* Bot√£o pr√≥ximo */}
                                {fotoModal.indice < fotoModal.fotos.length - 1 && (
                                    <button onClick={() => navegarFoto(1)} className="absolute right-4 text-white text-5xl hover:text-gray-300">‚Ä∫</button>
                                )}
                                
                                {/* Thumbnails */}
                                {fotoModal.fotos.length > 1 && (
                                    <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2">
                                        {fotoModal.fotos.map((foto, idx) => (
                                            <button 
                                                key={idx} 
                                                onClick={() => setFotoModal(prev => ({ ...prev, indice: idx }))}
                                                className={`w-12 h-12 rounded overflow-hidden border-2 ${idx === fotoModal.indice ? 'border-white' : 'border-transparent opacity-60 hover:opacity-100'}`}
                                            >
                                                <img 
                                                    src={typeof foto === 'string' ? foto : foto?.url || foto?.link} 
                                                    className="w-full h-full object-cover"
                                                    alt={`Thumb ${idx + 1}`}
                                                />
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        const App = () => {
            const [cliente, setCliente] = useState(null);
            const [token, setToken] = useState(null);
            const [toast, setToast] = useState(null);
            const [verificando, setVerificando] = useState(true);
            const showToast = (msg, tipo = 'info') => setToast({ mensagem: msg, tipo });
            
            useEffect(() => {
                const verificar = async () => {
                    const t = localStorage.getItem('solicitacao_token');
                    const c = localStorage.getItem('solicitacao_cliente');
                    if (t && c) { try { const r = await fetch(`${API_URL}/api/solicitacao/verificar`, { headers: { 'Authorization': `Bearer ${t}` } }); if (r.ok) { const d = await r.json(); setToken(t); setCliente(d.cliente); } else { localStorage.removeItem('solicitacao_token'); localStorage.removeItem('solicitacao_cliente'); } } catch {} }
                    setVerificando(false);
                };
                verificar();
            }, []);
            
            if (verificando) return <div className="min-h-screen bg-blue-100 flex items-center justify-center"><div className="text-center"><div className="text-4xl mb-4">üèçÔ∏è</div><p>Carregando...</p></div></div>;
            return (<>{toast && <Toast mensagem={toast.mensagem} tipo={toast.tipo} onClose={() => setToast(null)} />}{cliente && token ? <Solicitacao cliente={cliente} token={token} onLogout={() => { localStorage.removeItem('solicitacao_token'); localStorage.removeItem('solicitacao_cliente'); setCliente(null); setToken(null); }} showToast={showToast} /> : <TelaLogin onLogin={(c, t) => { setCliente(c); setToken(t); }} showToast={showToast} />}</>);
        };
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
