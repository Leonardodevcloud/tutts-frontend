-- =====================================================
-- SISTEMA DE SOLICITAÇÃO DE CORRIDAS - TUTTS
-- Integração com API Tutts para solicitar serviços
-- =====================================================

-- Tabela de clientes (cada cliente tem suas credenciais Tutts)
CREATE TABLE IF NOT EXISTS clientes_solicitacao (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    senha_hash VARCHAR(255) NOT NULL,
    telefone VARCHAR(20),
    empresa VARCHAR(255),
    
    -- Credenciais da API Tutts
    tutts_token VARCHAR(255) NOT NULL,
    tutts_cod_cliente VARCHAR(100) NOT NULL,
    
    -- Configurações padrão
    centro_custo_padrao VARCHAR(255),
    forma_pagamento_padrao VARCHAR(1) DEFAULT 'F', -- D=Dinheiro, C=Cartão, F=Faturar
    endereco_partida_padrao JSONB, -- {rua, numero, bairro, cidade, uf, cep, lat, lng}
    
    -- Controle
    ativo BOOLEAN DEFAULT TRUE,
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ultimo_acesso TIMESTAMP,
    criado_por INTEGER, -- ID do admin que criou
    observacoes TEXT
);

CREATE INDEX IF NOT EXISTS idx_clientes_solicitacao_email ON clientes_solicitacao(email);
CREATE INDEX IF NOT EXISTS idx_clientes_solicitacao_ativo ON clientes_solicitacao(ativo);

-- Tabela de solicitações (histórico de corridas)
CREATE TABLE IF NOT EXISTS solicitacoes_corrida (
    id SERIAL PRIMARY KEY,
    cliente_id INTEGER NOT NULL REFERENCES clientes_solicitacao(id) ON DELETE CASCADE,
    
    -- Dados da solicitação
    numero_pedido VARCHAR(100),
    centro_custo VARCHAR(255),
    usuario_solicitante VARCHAR(255),
    data_retirada TIMESTAMP,
    forma_pagamento VARCHAR(1), -- D, C, F
    ponto_receber INTEGER,
    retorno BOOLEAN DEFAULT FALSE,
    obs_retorno TEXT,
    ordenar BOOLEAN DEFAULT FALSE,
    codigo_profissional VARCHAR(100),
    
    -- Valores
    valor_rota_profissional DECIMAL(10,2),
    valor_rota_servico DECIMAL(10,2),
    
    -- Resposta da API Tutts
    tutts_os_numero VARCHAR(50), -- Número da OS retornado
    tutts_distancia DECIMAL(10,2),
    tutts_duracao VARCHAR(20),
    tutts_valor DECIMAL(10,2),
    tutts_url_rastreamento TEXT,
    
    -- Status
    status VARCHAR(50) DEFAULT 'enviado', -- enviado, aceito, em_andamento, finalizado, cancelado, erro
    status_codigo DECIMAL(3,2), -- 0, 0.5, 0.75, 1, 2
    status_atualizado_em TIMESTAMP,
    
    -- Dados do profissional (preenchido via webhook)
    profissional_nome VARCHAR(255),
    profissional_email VARCHAR(255),
    profissional_telefone VARCHAR(20),
    profissional_foto TEXT,
    profissional_placa VARCHAR(20),
    profissional_veiculo VARCHAR(100),
    profissional_cor_veiculo VARCHAR(50),
    
    -- Controle
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    atualizado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    erro_mensagem TEXT
);

CREATE INDEX IF NOT EXISTS idx_solicitacoes_corrida_cliente ON solicitacoes_corrida(cliente_id);
CREATE INDEX IF NOT EXISTS idx_solicitacoes_corrida_status ON solicitacoes_corrida(status);
CREATE INDEX IF NOT EXISTS idx_solicitacoes_corrida_criado ON solicitacoes_corrida(criado_em DESC);
CREATE INDEX IF NOT EXISTS idx_solicitacoes_corrida_os ON solicitacoes_corrida(tutts_os_numero);

-- Tabela de pontos de cada solicitação
CREATE TABLE IF NOT EXISTS solicitacoes_pontos (
    id SERIAL PRIMARY KEY,
    solicitacao_id INTEGER NOT NULL REFERENCES solicitacoes_corrida(id) ON DELETE CASCADE,
    ordem INTEGER NOT NULL, -- 1, 2, 3...
    
    -- Endereço
    rua VARCHAR(255) NOT NULL,
    numero VARCHAR(20),
    complemento VARCHAR(255),
    bairro VARCHAR(255),
    cidade VARCHAR(255) NOT NULL,
    uf VARCHAR(2) NOT NULL,
    cep VARCHAR(10),
    latitude DECIMAL(10,7),
    longitude DECIMAL(10,7),
    
    -- Informações adicionais
    observacao TEXT,
    telefone VARCHAR(20),
    procurar_por VARCHAR(255),
    numero_nota VARCHAR(100),
    codigo_finalizar VARCHAR(100),
    
    -- Status do ponto (atualizado via webhook)
    status VARCHAR(50), -- pendente, chegou, coletado, finalizado
    status_atualizado_em TIMESTAMP,
    data_chegada TIMESTAMP,
    data_coletado TIMESTAMP,
    data_finalizado TIMESTAMP,
    motivo_finalizacao VARCHAR(255),
    motivo_descricao TEXT,
    tempo_espera DECIMAL(10,2),
    
    -- Fotos/Assinatura
    fotos JSONB, -- Array de URLs
    assinatura JSONB -- {link, nome, documento}
);

CREATE INDEX IF NOT EXISTS idx_solicitacoes_pontos_solicitacao ON solicitacoes_pontos(solicitacao_id);
CREATE INDEX IF NOT EXISTS idx_solicitacoes_pontos_ordem ON solicitacoes_pontos(solicitacao_id, ordem);

-- Tabela de endereços favoritos dos clientes
CREATE TABLE IF NOT EXISTS solicitacao_favoritos (
    id SERIAL PRIMARY KEY,
    cliente_id INTEGER NOT NULL REFERENCES clientes_solicitacao(id) ON DELETE CASCADE,
    
    -- Endereço
    apelido VARCHAR(100),
    rua VARCHAR(255) NOT NULL,
    numero VARCHAR(20),
    complemento VARCHAR(255),
    bairro VARCHAR(255),
    cidade VARCHAR(255),
    uf VARCHAR(2),
    cep VARCHAR(10),
    latitude DECIMAL(10,7),
    longitude DECIMAL(10,7),
    
    -- Informações padrão
    telefone_padrao VARCHAR(20),
    procurar_por_padrao VARCHAR(255),
    observacao_padrao TEXT,
    
    -- Controle
    vezes_usado INTEGER DEFAULT 1,
    ultimo_uso TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_solicitacao_favoritos_cliente ON solicitacao_favoritos(cliente_id);

-- Tabela de log de webhooks recebidos
CREATE TABLE IF NOT EXISTS solicitacao_webhooks_log (
    id SERIAL PRIMARY KEY,
    tutts_os_numero VARCHAR(50),
    payload JSONB NOT NULL,
    processado BOOLEAN DEFAULT FALSE,
    erro TEXT,
    recebido_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_webhooks_log_os ON solicitacao_webhooks_log(tutts_os_numero);
CREATE INDEX IF NOT EXISTS idx_webhooks_log_recebido ON solicitacao_webhooks_log(recebido_em DESC);

-- =====================================================
-- COMENTÁRIOS
-- =====================================================
COMMENT ON TABLE clientes_solicitacao IS 'Clientes que podem solicitar corridas via integração Tutts';
COMMENT ON TABLE solicitacoes_corrida IS 'Histórico de todas as corridas solicitadas';
COMMENT ON TABLE solicitacoes_pontos IS 'Pontos/endereços de cada corrida';
COMMENT ON TABLE solicitacao_favoritos IS 'Endereços favoritos salvos pelos clientes';
COMMENT ON TABLE solicitacao_webhooks_log IS 'Log de todos os webhooks recebidos da API Tutts';
