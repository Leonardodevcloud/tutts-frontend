<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutts - Solicitar Corrida</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèçÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3b82f6 100%); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        #mapa { z-index: 1; }
        .leaflet-container { width: 100% !important; height: 100% !important; background: #e5e7eb; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #93c5fd; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #60a5fa; }
        @media (max-width: 768px) {
            #mapa { min-height: calc(100vh - 200px) !important; height: calc(100vh - 200px) !important; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const API_URL = 'https://tutts-backend-production.up.railway.app';
        
        // Toast Component
        const Toast = ({ mensagem, tipo, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, []);
            
            const cores = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            
            return (
                <div className={`fixed top-4 right-4 ${cores[tipo]} text-white px-4 py-3 rounded-lg shadow-lg z-50 fade-in max-w-sm`}>
                    {mensagem}
                </div>
            );
        };
        
        // Tela de Login
        const TelaLogin = ({ onLogin, showToast }) => {
            const [email, setEmail] = useState('');
            const [senha, setSenha] = useState('');
            const [loading, setLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!email || !senha) { showToast('Preencha email e senha', 'error'); return; }
                
                setLoading(true);
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, senha })
                    });
                    const data = await resp.json();
                    
                    if (resp.ok) {
                        localStorage.setItem('solicitacao_token', data.token);
                        localStorage.setItem('solicitacao_cliente', JSON.stringify(data.cliente));
                        showToast('Bem-vindo, ' + data.cliente.nome + '!', 'success');
                        onLogin(data.cliente, data.token);
                    } else {
                        showToast(data.error || 'Erro ao fazer login', 'error');
                    }
                } catch (err) {
                    showToast('Erro de conex√£o', 'error');
                }
                setLoading(false);
            };
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div className="text-center mb-6">
                            <div className="text-6xl mb-4">üèçÔ∏è</div>
                            <h1 className="text-2xl font-bold text-gray-800">Solicitar Corrida</h1>
                            <p className="text-gray-500 text-sm">Sistema de entregas Tutts</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="seu@email.com" />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">Senha</label>
                                <input type="password" value={senha} onChange={(e) => setSenha(e.target.value)}
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                            </div>
                            <button type="submit" disabled={loading}
                                className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg disabled:opacity-50">
                                {loading ? 'Entrando...' : 'Entrar'}
                            </button>
                        </form>
                        
                        <p className="mt-6 text-center text-gray-500 text-sm border-t pt-4">
                            N√£o tem acesso? Entre em contato com o administrador.
                        </p>
                    </div>
                </div>
            );
        };
        
        // Componente Principal
        const Solicitacao = ({ cliente, token, onLogout, showToast }) => {
            // Estado separado para partida e entregas
            const [pontoPartida, setPontoPartida] = useState(null);
            const [pontosEntrega, setPontosEntrega] = useState([]);
            
            // Estados de busca
            const [termoBuscaPartida, setTermoBuscaPartida] = useState('');
            const [termoBuscaEntrega, setTermoBuscaEntrega] = useState('');
            const [sugestoesPartida, setSugestoesPartida] = useState([]);
            const [sugestoesEntrega, setSugestoesEntrega] = useState([]);
            const [buscandoPartida, setBuscandoPartida] = useState(false);
            const [buscandoEntrega, setBuscandoEntrega] = useState(false);
            
            // Outros estados
            const [loading, setLoading] = useState(false);
            const [mapa, setMapa] = useState(null);
            const [markersLayer, setMarkersLayer] = useState(null);
            const [historico, setHistorico] = useState([]);
            const [mostrarHistorico, setMostrarHistorico] = useState(false);
            const [abaMobile, setAbaMobile] = useState('form');
            const [pontoEditando, setPontoEditando] = useState(null);
            const [editandoPartida, setEditandoPartida] = useState(false);
            const [dadosPonto, setDadosPonto] = useState({ observacao: '', telefone: '', procurar_por: '', numero_nota: '', codigo_finalizar: '' });
            const [modoTeste, setModoTeste] = useState(false);
            
            const [config, setConfig] = useState({
                numero_pedido: '', centro_custo: cliente.centro_custo_padrao || '', usuario_solicitante: cliente.nome,
                data_retirada: '', hora_retirada: '', forma_pagamento: cliente.forma_pagamento_padrao || 'F',
                ponto_receber: '', retorno: false, obs_retorno: '', ordenar: true, codigo_profissional: ''
            });
            
            // Inicializar mapa
            useEffect(() => {
                if (typeof L !== 'undefined' && !mapa) {
                    const container = document.getElementById('mapa');
                    if (container) {
                        const mapInstance = L.map('mapa', { zoomControl: true }).setView([-16.6869, -49.2648], 12);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap', maxZoom: 19 }).addTo(mapInstance);
                        setMapa(mapInstance);
                        setMarkersLayer(L.layerGroup().addTo(mapInstance));
                        setTimeout(() => mapInstance.invalidateSize(), 100);
                        window.addEventListener('resize', () => mapInstance.invalidateSize());
                    }
                }
            }, []);
            
            // Carregar partida padr√£o
            useEffect(() => {
                if (cliente.endereco_partida_padrao) {
                    setPontoPartida({ id: Date.now(), ...cliente.endereco_partida_padrao });
                }
                carregarHistorico();
            }, []);
            
            // Atualizar mapa quando pontos mudam
            useEffect(() => {
                if (mapa && markersLayer) {
                    markersLayer.clearLayers();
                    
                    // Adicionar partida
                    if (pontoPartida && pontoPartida.latitude) {
                        const iconPartida = L.divIcon({
                            className: '',
                            html: `<div style="background:#10b981;color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.4)">üö©</div>`,
                            iconSize: [32, 32], iconAnchor: [16, 16]
                        });
                        L.marker([pontoPartida.latitude, pontoPartida.longitude], { icon: iconPartida })
                            .addTo(markersLayer)
                            .bindPopup(`<b>PARTIDA</b><br>${pontoPartida.endereco_completo || pontoPartida.rua}`);
                    }
                    
                    // Adicionar entregas
                    pontosEntrega.forEach((p, idx) => {
                        if (p.latitude && p.longitude) {
                            const icon = L.divIcon({
                                className: '',
                                html: `<div style="background:#3b82f6;color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.3)">${idx + 1}</div>`,
                                iconSize: [28, 28], iconAnchor: [14, 14]
                            });
                            L.marker([p.latitude, p.longitude], { icon })
                                .addTo(markersLayer)
                                .bindPopup(`<b>Entrega ${idx + 1}</b><br>${p.endereco_completo || p.rua}`);
                        }
                    });
                    
                    // Ajustar bounds
                    const todosPontos = [pontoPartida, ...pontosEntrega].filter(p => p && p.latitude);
                    if (todosPontos.length > 0) {
                        const bounds = L.latLngBounds(todosPontos.map(p => [p.latitude, p.longitude]));
                        mapa.fitBounds(bounds, { padding: [50, 50] });
                    }
                }
            }, [pontoPartida, pontosEntrega, mapa, markersLayer]);
            
            const carregarHistorico = async () => {
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/historico?limite=20`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (resp.ok) { const data = await resp.json(); setHistorico(data.solicitacoes || []); }
                } catch (err) { console.error('Erro ao carregar hist√≥rico:', err); }
            };
            
            // Fun√ß√£o de busca gen√©rica
            const buscarEndereco = async (termo, setBuscando, setSugestoes) => {
                if (!termo || termo.length < 3) { showToast('Digite pelo menos 3 caracteres', 'warning'); return; }
                setBuscando(true);
                try {
                    const resp = await fetch(`${API_URL}/api/geocode/google?endereco=${encodeURIComponent(termo)}`);
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data.results && data.results.length > 0) { setSugestoes(data.results); }
                        else { showToast('Nenhum endere√ßo encontrado', 'warning'); }
                    }
                } catch (err) { showToast('Erro ao buscar endere√ßo', 'error'); }
                setBuscando(false);
            };
            
            // Fun√ß√£o para criar objeto de ponto a partir da sugest√£o
            const criarPonto = (sug) => {
                const componentes = sug.componentes || [];
                const getComponente = (tipo) => {
                    const comp = componentes.find(c => c.types && c.types.includes(tipo));
                    return comp ? comp.long_name : '';
                };
                const getComponenteShort = (tipo) => {
                    const comp = componentes.find(c => c.types && c.types.includes(tipo));
                    return comp ? comp.short_name : '';
                };
                
                let rua = getComponente('route') || '';
                let numero = getComponente('street_number') || '';
                let bairro = getComponente('sublocality_level_1') || getComponente('sublocality') || getComponente('neighborhood') || '';
                let cidade = getComponente('administrative_area_level_2') || getComponente('locality') || '';
                let uf = getComponenteShort('administrative_area_level_1') || '';
                let cep = getComponente('postal_code') || '';
                
                const enderecoCompleto = sug.endereco || '';
                
                // Fallback se n√£o tiver componentes
                if (!rua && enderecoCompleto) {
                    const partes = enderecoCompleto.split(',').map(p => p.trim());
                    if (partes.length >= 1) {
                        const ruaNumero = partes[0];
                        const matchNumero = ruaNumero.match(/(\d+)/);
                        rua = ruaNumero.replace(/,?\s*\d+.*$/, '').trim();
                        if (matchNumero && !numero) numero = matchNumero[1];
                    }
                }
                
                return {
                    id: Date.now() + Math.random(),
                    endereco_completo: enderecoCompleto,
                    rua, numero, bairro, cidade, uf, cep,
                    latitude: sug.latitude,
                    longitude: sug.longitude,
                    observacao: '', telefone: '', procurar_por: '', numero_nota: '', codigo_finalizar: ''
                };
            };
            
            // Adicionar ponto de partida
            const adicionarPartida = (sug) => {
                const ponto = criarPonto(sug);
                setPontoPartida(ponto);
                setTermoBuscaPartida('');
                setSugestoesPartida([]);
                showToast('‚úÖ Ponto de partida definido', 'success');
            };
            
            // Adicionar ponto de entrega
            const adicionarEntrega = (sug) => {
                if (pontosEntrega.length >= 79) { showToast('M√°ximo 79 pontos de entrega', 'error'); return; }
                const ponto = criarPonto(sug);
                setPontosEntrega([...pontosEntrega, ponto]);
                setTermoBuscaEntrega('');
                setSugestoesEntrega([]);
                showToast('‚úÖ Ponto de entrega adicionado', 'success');
            };
            
            const removerEntrega = (id) => setPontosEntrega(pontosEntrega.filter(p => p.id !== id));
            
            const moverEntrega = (idx, dir) => {
                const lista = [...pontosEntrega];
                const novoIdx = idx + dir;
                if (novoIdx < 0 || novoIdx >= lista.length) return;
                [lista[idx], lista[novoIdx]] = [lista[novoIdx], lista[idx]];
                setPontosEntrega(lista);
            };
            
            const abrirEdicaoPonto = (idx, isPartida = false) => {
                const p = isPartida ? pontoPartida : pontosEntrega[idx];
                setDadosPonto({
                    observacao: p.observacao || '',
                    telefone: p.telefone || '',
                    procurar_por: p.procurar_por || '',
                    numero_nota: p.numero_nota || '',
                    codigo_finalizar: p.codigo_finalizar || ''
                });
                setEditandoPartida(isPartida);
                setPontoEditando(isPartida ? 0 : idx);
            };
            
            const salvarEdicaoPonto = () => {
                if (editandoPartida) {
                    setPontoPartida({ ...pontoPartida, ...dadosPonto });
                } else {
                    const novosPontos = [...pontosEntrega];
                    novosPontos[pontoEditando] = { ...novosPontos[pontoEditando], ...dadosPonto };
                    setPontosEntrega(novosPontos);
                }
                setPontoEditando(null);
                setEditandoPartida(false);
                showToast('‚úÖ Ponto atualizado', 'success');
            };
            
            // Salvar partida como padr√£o
            const salvarPartidaPadrao = async () => {
                if (!pontoPartida) { showToast('Defina um ponto de partida primeiro', 'warning'); return; }
                try {
                    await fetch(`${API_URL}/api/solicitacao/configuracoes`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({
                            endereco_partida_padrao: {
                                rua: pontoPartida.rua,
                                numero: pontoPartida.numero,
                                bairro: pontoPartida.bairro,
                                cidade: pontoPartida.cidade,
                                uf: pontoPartida.uf,
                                cep: pontoPartida.cep,
                                latitude: pontoPartida.latitude,
                                longitude: pontoPartida.longitude,
                                endereco_completo: pontoPartida.endereco_completo
                            }
                        })
                    });
                    showToast('‚≠ê Partida padr√£o salva!', 'success');
                } catch (err) { showToast('Erro ao salvar', 'error'); }
            };
            
            // Enviar solicita√ß√£o
            const enviarSolicitacao = async () => {
                if (!pontoPartida) { showToast('Defina o ponto de partida', 'error'); return; }
                if (pontosEntrega.length < 1) { showToast('Adicione pelo menos 1 ponto de entrega', 'error'); return; }
                
                setLoading(true);
                try {
                    const dataRetirada = config.data_retirada && config.hora_retirada ? `${config.data_retirada} ${config.hora_retirada}:00` : '';
                    
                    // Montar array de pontos: partida + entregas
                    const todosPontos = [pontoPartida, ...pontosEntrega];
                    
                    const payload = {
                        numero_pedido: config.numero_pedido,
                        centro_custo: config.centro_custo,
                        usuario_solicitante: config.usuario_solicitante,
                        data_retirada: dataRetirada,
                        forma_pagamento: config.forma_pagamento,
                        ponto_receber: config.ponto_receber ? parseInt(config.ponto_receber) : null,
                        retorno: config.retorno,
                        obs_retorno: config.obs_retorno,
                        ordenar: config.ordenar,
                        codigo_profissional: config.codigo_profissional,
                        sem_profissional: modoTeste,
                        pontos: todosPontos.map(p => ({
                            rua: p.rua || '',
                            numero: p.numero || '',
                            complemento: p.complemento || '',
                            bairro: p.bairro || '',
                            cidade: p.cidade || '',
                            uf: p.uf || '',
                            cep: p.cep || '',
                            latitude: p.latitude,
                            longitude: p.longitude,
                            observacao: p.observacao || '',
                            telefone: p.telefone || '',
                            procurar_por: p.procurar_por || '',
                            numero_nota: p.numero_nota || '',
                            codigo_finalizar: p.codigo_finalizar || '',
                            endereco_completo: p.endereco_completo || ''
                        }))
                    };
                    
                    console.log('üì§ Enviando payload:', JSON.stringify(payload, null, 2));
                    
                    const resp = await fetch(`${API_URL}/api/solicitacao/corrida`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(payload)
                    });
                    const data = await resp.json();
                    
                    console.log('üì• Resposta:', data);
                    
                    if (resp.ok) {
                        showToast(`‚úÖ Corrida solicitada! OS: ${data.os_numero}${modoTeste ? ' (TESTE)' : ''}`, 'success');
                        // Limpar entregas mas manter partida
                        setPontosEntrega([]);
                        setConfig(prev => ({ ...prev, numero_pedido: '', obs_retorno: '' }));
                        carregarHistorico();
                    } else {
                        showToast(data.error || 'Erro ao solicitar corrida', 'error');
                    }
                } catch (err) {
                    showToast('Erro ao enviar solicita√ß√£o', 'error');
                }
                setLoading(false);
            };
            
            const limpar = () => {
                setPontosEntrega([]);
                setSugestoesPartida([]);
                setSugestoesEntrega([]);
                setTermoBuscaPartida('');
                setTermoBuscaEntrega('');
            };
            
            const statusCores = { 'enviado': 'bg-yellow-100 text-yellow-800', 'aceito': 'bg-blue-100 text-blue-800', 'em_andamento': 'bg-purple-100 text-purple-800', 'finalizado': 'bg-green-100 text-green-800', 'cancelado': 'bg-red-100 text-red-800', 'erro': 'bg-red-100 text-red-800' };
            const statusNomes = { 'enviado': 'üì§ Enviado', 'aceito': '‚úÖ Aceito', 'em_andamento': 'üèçÔ∏è Em andamento', 'finalizado': 'üèÅ Finalizado', 'cancelado': '‚ùå Cancelado', 'erro': '‚ö†Ô∏è Erro' };
            
            const totalPontos = (pontoPartida ? 1 : 0) + pontosEntrega.length;
            
            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Header */}
                    <header className="bg-blue-900 text-white px-3 md:px-4 py-2 md:py-3 shadow-lg">
                        <div className="max-w-7xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2 md:gap-3">
                                <span className="text-xl md:text-2xl">üèçÔ∏è</span>
                                <div>
                                    <h1 className="font-bold text-sm md:text-lg">Solicitar Corrida</h1>
                                    <p className="text-blue-300 text-xs hidden md:block">Ol√°, {cliente.nome}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setMostrarHistorico(true)} className="px-2 md:px-3 py-1 md:py-1.5 bg-white/10 hover:bg-white/20 rounded text-xs md:text-sm">
                                    üìã <span className="hidden md:inline">Hist√≥rico</span>
                                </button>
                                <button onClick={onLogout} className="px-2 md:px-3 py-1 md:py-1.5 bg-red-500/20 hover:bg-red-500/30 rounded text-xs md:text-sm">üö™</button>
                            </div>
                        </div>
                    </header>
                    
                    {/* Abas Mobile */}
                    <div className="md:hidden flex border-b bg-white">
                        <button onClick={() => setAbaMobile('form')} className={`flex-1 py-3 text-sm font-medium ${abaMobile === 'form' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-500'}`}>üìù Formul√°rio</button>
                        <button onClick={() => { setAbaMobile('mapa'); setTimeout(() => mapa?.invalidateSize(), 100); }} className={`flex-1 py-3 text-sm font-medium ${abaMobile === 'mapa' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-500'}`}>üó∫Ô∏è Mapa ({totalPontos})</button>
                    </div>
                    
                    <div className="max-w-7xl mx-auto p-2 md:p-4">
                        <div className="flex flex-col md:flex-row gap-4">
                            {/* Painel Formul√°rio */}
                            <div className={`${abaMobile === 'form' ? 'block' : 'hidden'} md:block w-full md:w-[450px] space-y-3`}>
                                
                                {/* ========== PONTO DE PARTIDA ========== */}
                                <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl shadow border-2 border-green-200 p-3">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-bold text-green-800">üü¢ PONTO DE PARTIDA</span>
                                        {pontoPartida && (
                                            <button onClick={salvarPartidaPadrao} className="text-xs text-green-600 hover:text-green-800 font-medium">
                                                ‚≠ê Tornar Padr√£o
                                            </button>
                                        )}
                                    </div>
                                    
                                    {!pontoPartida ? (
                                        <div>
                                            <div className="flex gap-2">
                                                <input
                                                    type="text"
                                                    value={termoBuscaPartida}
                                                    onChange={(e) => setTermoBuscaPartida(e.target.value)}
                                                    onKeyDown={(e) => e.key === 'Enter' && buscarEndereco(termoBuscaPartida, setBuscandoPartida, setSugestoesPartida)}
                                                    placeholder="Buscar endere√ßo de partida..."
                                                    className="flex-1 px-3 py-2 border border-green-300 rounded-lg text-sm focus:outline-none focus:border-green-500 bg-white"
                                                />
                                                <button
                                                    onClick={() => buscarEndereco(termoBuscaPartida, setBuscandoPartida, setSugestoesPartida)}
                                                    disabled={buscandoPartida}
                                                    className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 disabled:opacity-50"
                                                >
                                                    {buscandoPartida ? '...' : 'üîç'}
                                                </button>
                                            </div>
                                            {sugestoesPartida.length > 0 && (
                                                <div className="mt-2 bg-white border border-green-200 rounded-lg shadow max-h-40 overflow-y-auto">
                                                    {sugestoesPartida.map((sug, idx) => (
                                                        <div key={idx} onClick={() => adicionarPartida(sug)} className="px-3 py-2 hover:bg-green-50 cursor-pointer text-sm border-b last:border-b-0">
                                                            üìç {sug.endereco}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="bg-white rounded-lg p-3 border border-green-200">
                                            <div className="flex items-center gap-2">
                                                <span className="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white text-sm font-bold">üö©</span>
                                                <div className="flex-1 min-w-0">
                                                    <div className="text-sm font-medium text-gray-800 truncate">{pontoPartida.endereco_completo || `${pontoPartida.rua}, ${pontoPartida.numero}`}</div>
                                                    {pontoPartida.observacao && <div className="text-xs text-gray-500 truncate">üìù {pontoPartida.observacao}</div>}
                                                </div>
                                                <div className="flex gap-1">
                                                    <button onClick={() => abrirEdicaoPonto(0, true)} className="text-gray-400 hover:text-green-600 text-sm">‚úèÔ∏è</button>
                                                    <button onClick={() => setPontoPartida(null)} className="text-gray-400 hover:text-red-600">‚úï</button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* ========== PONTOS DE ENTREGA ========== */}
                                <div className="bg-white rounded-xl shadow p-3">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-bold text-blue-800">üì¶ PONTOS DE ENTREGA ({pontosEntrega.length}/79)</span>
                                        {pontosEntrega.length > 0 && (
                                            <button onClick={limpar} className="text-xs text-red-500 hover:text-red-700">Limpar</button>
                                        )}
                                    </div>
                                    
                                    {/* Busca de entrega */}
                                    <div className="mb-3">
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                value={termoBuscaEntrega}
                                                onChange={(e) => setTermoBuscaEntrega(e.target.value)}
                                                onKeyDown={(e) => e.key === 'Enter' && buscarEndereco(termoBuscaEntrega, setBuscandoEntrega, setSugestoesEntrega)}
                                                placeholder="Buscar endere√ßo de entrega..."
                                                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-blue-500"
                                            />
                                            <button
                                                onClick={() => buscarEndereco(termoBuscaEntrega, setBuscandoEntrega, setSugestoesEntrega)}
                                                disabled={buscandoEntrega}
                                                className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50"
                                            >
                                                {buscandoEntrega ? '...' : 'üîç'}
                                            </button>
                                        </div>
                                        {sugestoesEntrega.length > 0 && (
                                            <div className="mt-2 bg-white border rounded-lg shadow max-h-40 overflow-y-auto">
                                                {sugestoesEntrega.map((sug, idx) => (
                                                    <div key={idx} onClick={() => adicionarEntrega(sug)} className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b last:border-b-0">
                                                        üìç {sug.endereco}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Lista de entregas */}
                                    <div className="space-y-2 max-h-48 overflow-y-auto">
                                        {pontosEntrega.length === 0 ? (
                                            <div className="text-center py-4 text-gray-400 text-sm">Adicione pontos de entrega</div>
                                        ) : pontosEntrega.map((p, idx) => (
                                            <div key={p.id} className="p-2 rounded-lg border bg-blue-50 border-blue-200">
                                                <div className="flex items-center gap-2">
                                                    <span className="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs font-bold">{idx + 1}</span>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-xs font-medium text-gray-800 truncate">{p.endereco_completo || `${p.rua}, ${p.numero}`}</div>
                                                        {p.observacao && <div className="text-xs text-gray-500 truncate">üìù {p.observacao}</div>}
                                                    </div>
                                                    <div className="flex gap-1">
                                                        <button onClick={() => abrirEdicaoPonto(idx, false)} className="text-gray-400 hover:text-blue-600 text-sm">‚úèÔ∏è</button>
                                                        {idx > 0 && <button onClick={() => moverEntrega(idx, -1)} className="text-gray-400 hover:text-blue-600">‚ñ≤</button>}
                                                        {idx < pontosEntrega.length - 1 && <button onClick={() => moverEntrega(idx, 1)} className="text-gray-400 hover:text-blue-600">‚ñº</button>}
                                                        <button onClick={() => removerEntrega(p.id)} className="text-gray-400 hover:text-red-600">‚úï</button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Configura√ß√µes */}
                                <div className="bg-white rounded-xl shadow p-3">
                                    <div className="text-sm font-bold text-gray-700 mb-3">‚öôÔ∏è Configura√ß√µes</div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-xs text-gray-600">N¬∫ Pedido</label>
                                            <input type="text" value={config.numero_pedido} onChange={(e) => setConfig({...config, numero_pedido: e.target.value})} className="w-full px-2 py-1.5 border rounded text-sm" placeholder="Opcional" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">Centro de Custo</label>
                                            <input type="text" value={config.centro_custo} onChange={(e) => setConfig({...config, centro_custo: e.target.value})} className="w-full px-2 py-1.5 border rounded text-sm" placeholder="Opcional" />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2 mt-2">
                                        <div>
                                            <label className="text-xs text-gray-600">Data Retirada</label>
                                            <input type="date" value={config.data_retirada} onChange={(e) => setConfig({...config, data_retirada: e.target.value})} className="w-full px-2 py-1.5 border rounded text-sm" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">Hora</label>
                                            <input type="time" value={config.hora_retirada} onChange={(e) => setConfig({...config, hora_retirada: e.target.value})} className="w-full px-2 py-1.5 border rounded text-sm" />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2 mt-2">
                                        <div>
                                            <label className="text-xs text-gray-600">Pagamento</label>
                                            <select value={config.forma_pagamento} onChange={(e) => setConfig({...config, forma_pagamento: e.target.value})} className="w-full px-2 py-1.5 border rounded text-sm">
                                                <option value="F">A Faturar</option>
                                                <option value="D">Dinheiro</option>
                                                <option value="C">Cart√£o</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">Receber no ponto</label>
                                            <input type="number" value={config.ponto_receber} onChange={(e) => setConfig({...config, ponto_receber: e.target.value})} className="w-full px-2 py-1.5 border rounded text-sm" placeholder="Ex: 2" min="1" />
                                        </div>
                                    </div>
                                    <div className="flex flex-wrap gap-4 mt-3">
                                        <label className="flex items-center gap-2 text-sm cursor-pointer">
                                            <input type="checkbox" checked={config.ordenar} onChange={(e) => setConfig({...config, ordenar: e.target.checked})} className="w-4 h-4" />
                                            <span>üîÄ Ordenar automaticamente</span>
                                        </label>
                                        <label className="flex items-center gap-2 text-sm cursor-pointer">
                                            <input type="checkbox" checked={config.retorno} onChange={(e) => setConfig({...config, retorno: e.target.checked})} className="w-4 h-4" />
                                            <span>‚Ü©Ô∏è Retornar ao in√≠cio</span>
                                        </label>
                                    </div>
                                    {config.retorno && (
                                        <div className="mt-2">
                                            <input type="text" value={config.obs_retorno} onChange={(e) => setConfig({...config, obs_retorno: e.target.value})} className="w-full px-2 py-1.5 border rounded text-sm" placeholder="Observa√ß√£o do retorno..." />
                                        </div>
                                    )}
                                    
                                    {/* Modo Teste */}
                                    <div className="mt-3 pt-3 border-t">
                                        <label className="flex items-center gap-2 text-sm cursor-pointer">
                                            <input type="checkbox" checked={modoTeste} onChange={(e) => setModoTeste(e.target.checked)} className="w-4 h-4" />
                                            <span className="text-orange-600 font-medium">üß™ Modo Teste (n√£o dispara para motoboy)</span>
                                        </label>
                                    </div>
                                </div>
                                
                                {/* Bot√£o Enviar */}
                                <button
                                    onClick={enviarSolicitacao}
                                    disabled={loading || !pontoPartida || pontosEntrega.length < 1}
                                    className={`w-full py-3 ${modoTeste ? 'bg-gradient-to-r from-orange-500 to-orange-600' : 'bg-gradient-to-r from-blue-600 to-blue-700'} text-white rounded-xl font-bold text-sm hover:opacity-90 disabled:opacity-50 shadow-lg`}
                                >
                                    {loading ? '‚è≥ Enviando...' : `üöÄ Solicitar Corrida (${totalPontos} pontos)${modoTeste ? ' - TESTE' : ''}`}
                                </button>
                            </div>
                            
                            {/* Mapa */}
                            <div className={`${abaMobile === 'mapa' ? 'block' : 'hidden'} md:block flex-1`}>
                                <div id="mapa" className="rounded-xl shadow-lg" style={{ height: 'calc(100vh - 160px)', minHeight: '400px' }}></div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Modal Editar Ponto */}
                    {pontoEditando !== null && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => { setPontoEditando(null); setEditandoPartida(false); }}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-4" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-4">
                                    <span className="font-bold text-gray-800">‚úèÔ∏è Editar {editandoPartida ? 'Partida' : `Entrega ${pontoEditando + 1}`}</span>
                                    <button onClick={() => { setPontoEditando(null); setEditandoPartida(false); }} className="text-gray-400 hover:text-gray-600">‚úï</button>
                                </div>
                                <div className="space-y-3">
                                    <div>
                                        <label className="text-xs text-gray-600">Observa√ß√£o</label>
                                        <textarea value={dadosPonto.observacao} onChange={(e) => setDadosPonto({...dadosPonto, observacao: e.target.value})} className="w-full px-3 py-2 border rounded text-sm" rows="2" placeholder="Ex: Apartamento 304" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs text-gray-600">Telefone</label>
                                            <input type="text" value={dadosPonto.telefone} onChange={(e) => setDadosPonto({...dadosPonto, telefone: e.target.value})} className="w-full px-3 py-2 border rounded text-sm" placeholder="(00) 00000-0000" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">Procurar por</label>
                                            <input type="text" value={dadosPonto.procurar_por} onChange={(e) => setDadosPonto({...dadosPonto, procurar_por: e.target.value})} className="w-full px-3 py-2 border rounded text-sm" placeholder="Nome do contato" />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs text-gray-600">N¬∫ Nota Fiscal</label>
                                            <input type="text" value={dadosPonto.numero_nota} onChange={(e) => setDadosPonto({...dadosPonto, numero_nota: e.target.value})} className="w-full px-3 py-2 border rounded text-sm" placeholder="Ex: 12345" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">C√≥digo Finalizar</label>
                                            <input type="text" value={dadosPonto.codigo_finalizar} onChange={(e) => setDadosPonto({...dadosPonto, codigo_finalizar: e.target.value})} className="w-full px-3 py-2 border rounded text-sm" placeholder="4 d√≠gitos" maxLength="4" />
                                        </div>
                                    </div>
                                </div>
                                <button onClick={salvarEdicaoPonto} className="w-full mt-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                                    üíæ Salvar
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal Hist√≥rico */}
                    {mostrarHistorico && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setMostrarHistorico(false)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between p-4 border-b">
                                    <span className="font-bold text-gray-800">üìã Hist√≥rico de Solicita√ß√µes</span>
                                    <button onClick={() => setMostrarHistorico(false)} className="text-gray-400 hover:text-gray-600">‚úï</button>
                                </div>
                                <div className="p-4 overflow-y-auto max-h-[60vh]">
                                    {historico.length === 0 ? (
                                        <div className="text-center py-8 text-gray-400">Nenhuma solicita√ß√£o encontrada</div>
                                    ) : historico.map((sol, idx) => (
                                        <div key={idx} className="p-3 border rounded-lg mb-2 hover:bg-gray-50">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <span className="font-bold text-gray-800">OS: {sol.tutts_os_numero || '-'}</span>
                                                    <span className={`ml-2 px-2 py-0.5 rounded text-xs ${statusCores[sol.status] || 'bg-gray-100'}`}>
                                                        {statusNomes[sol.status] || sol.status}
                                                    </span>
                                                </div>
                                                <span className="text-xs text-gray-500">{new Date(sol.criado_em).toLocaleString('pt-BR')}</span>
                                            </div>
                                            {sol.tutts_distancia && (
                                                <div className="text-xs text-gray-500 mt-1">
                                                    üìè {sol.tutts_distancia} km ‚Ä¢ ‚è±Ô∏è {sol.tutts_duracao} ‚Ä¢ üí∞ R$ {sol.tutts_valor}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // App Principal
        const App = () => {
            const [cliente, setCliente] = useState(null);
            const [token, setToken] = useState(null);
            const [toast, setToast] = useState(null);
            
            const showToast = (mensagem, tipo = 'info') => setToast({ mensagem, tipo });
            
            useEffect(() => {
                const savedToken = localStorage.getItem('solicitacao_token');
                const savedCliente = localStorage.getItem('solicitacao_cliente');
                if (savedToken && savedCliente) {
                    setToken(savedToken);
                    setCliente(JSON.parse(savedCliente));
                }
            }, []);
            
            const handleLogin = (clienteData, tokenData) => {
                setCliente(clienteData);
                setToken(tokenData);
            };
            
            const handleLogout = () => {
                localStorage.removeItem('solicitacao_token');
                localStorage.removeItem('solicitacao_cliente');
                setCliente(null);
                setToken(null);
            };
            
            if (!cliente || !token) {
                return (
                    <>
                        {toast && <Toast mensagem={toast.mensagem} tipo={toast.tipo} onClose={() => setToast(null)} />}
                        <TelaLogin onLogin={handleLogin} showToast={showToast} />
                    </>
                );
            }
            
            return (
                <>
                    {toast && <Toast mensagem={toast.mensagem} tipo={toast.tipo} onClose={() => setToast(null)} />}
                    <Solicitacao cliente={cliente} token={token} onLogout={handleLogout} showToast={showToast} />
                </>
            );
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
