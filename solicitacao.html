<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutts - Solicitar Corrida</title>
    <meta name="theme-color" content="#7c3aed">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèçÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        #mapa, #mapaAcompanhar { z-index: 1; }
        .leaflet-container { width: 100% !important; height: 100% !important; background: #e5e7eb; z-index: 1 !important; }
        .leaflet-pane { z-index: 1 !important; }
        .leaflet-top, .leaflet-bottom { z-index: 10 !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #93c5fd; border-radius: 3px; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-custom { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .map-container { position: relative; z-index: 1; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 100px; } }
        .slide-down { animation: slideDown 0.3s ease-out forwards; overflow: hidden; }
        .foto-modal { z-index: 9999 !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const API_URL = 'https://tutts-backend-production.up.railway.app';
        const SITE_URL = 'https://www.centraltutts.online';
        
        const Toast = ({ mensagem, tipo, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 4000); return () => clearTimeout(timer); }, []);
            const cores = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            return (<div className={`fixed top-4 right-4 ${cores[tipo]} text-white px-4 py-3 rounded-lg shadow-lg z-50 fade-in max-w-sm`}>{mensagem}</div>);
        };
        
        const TelaLogin = ({ onLogin, showToast }) => {
            const [email, setEmail] = useState('');
            const [senha, setSenha] = useState('');
            const [loading, setLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!email || !senha) { showToast('Preencha email e senha', 'error'); return; }
                setLoading(true);
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, senha }) });
                    const data = await resp.json();
                    if (resp.ok) { localStorage.setItem('solicitacao_token', data.token); localStorage.setItem('solicitacao_cliente', JSON.stringify(data.cliente)); showToast('Bem-vindo!', 'success'); onLogin(data.cliente, data.token); }
                    else { showToast(data.error || 'Erro', 'error'); }
                } catch (err) { showToast('Erro de conex√£o', 'error'); }
                setLoading(false);
            };
            
            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm">
                        {/* Logo */}
                        <div className="text-center mb-4">
                            <img 
                                src="https://github.com/Leonardodevcloud/tutts-frontend/blob/main/logotuttsoriginal.png?raw=true" 
                                alt="Tutts Logo" 
                                className="w-28 h-auto mx-auto mb-3 drop-shadow-lg rounded-2xl"
                            />
                            <h1 className="text-lg font-bold text-gray-700">Central de Solicita√ß√µes</h1>
                            <p className="text-xs text-gray-500">Fa√ßa login para continuar</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">üìß Email</label>
                                <input 
                                    type="email" 
                                    value={email} 
                                    onChange={(e) => setEmail(e.target.value)} 
                                    className="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition-all text-sm" 
                                    placeholder="seu@email.com" 
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">üîí Senha</label>
                                <input 
                                    type="password" 
                                    value={senha} 
                                    onChange={(e) => setSenha(e.target.value)} 
                                    className="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition-all text-sm" 
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={loading} 
                                className="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl disabled:opacity-50 transition-all shadow-lg hover:shadow-xl"
                            >
                                {loading ? '‚è≥ Entrando...' : 'üöÄ Entrar'}
                            </button>
                        </form>
                        
                        <div className="mt-4 text-center text-xs text-gray-400">
                            ¬© 2026 Tutts - Todos os direitos reservados
                        </div>
                    </div>
                </div>
            );
        };
        
        // Componente de Mapa reutiliz√°vel com controle de ciclo de vida
        const MapaLeaflet = ({ id, pontos, center = [-16.6869, -49.2648], zoom = 12, height = '400px', tipo = 'nova' }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersLayerRef = useRef(null);
            
            useEffect(() => {
                if (typeof L === 'undefined') return;
                const container = mapRef.current;
                if (!container) return;
                if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; }
                const map = L.map(container, { center: center, zoom: zoom, zoomControl: true });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' }).addTo(map);
                const markersLayer = L.layerGroup().addTo(map);
                mapInstanceRef.current = map;
                markersLayerRef.current = markersLayer;
                setTimeout(() => { if (mapInstanceRef.current) mapInstanceRef.current.invalidateSize(); }, 100);
                return () => { if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; } };
            }, [id]);
            
            useEffect(() => {
                const map = mapInstanceRef.current;
                const markersLayer = markersLayerRef.current;
                if (!map || !markersLayer || !pontos) return;
                markersLayer.clearLayers();
                const pontosValidos = pontos.filter(p => p.latitude && p.longitude);
                pontosValidos.forEach((p, idx) => {
                    let cor, icone;
                    if (tipo === 'acompanhar') {
                        if (p.status === 'finalizado') { cor = '#10b981'; icone = '‚úì'; }
                        else if (p.status === 'chegou' || p.status === 'coletado') { cor = '#3b82f6'; icone = 'üìç'; }
                        else if (idx === 0) { cor = '#f59e0b'; icone = 'üì¶'; }
                        else { cor = '#9ca3af'; icone = idx; }
                    } else {
                        if (idx === 0) { cor = '#f59e0b'; icone = 'üì¶'; }
                        else { cor = '#3b82f6'; icone = idx; }
                    }
                    const icon = L.divIcon({ className: '', html: `<div style="background:${cor};color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.3)">${icone}</div>`, iconSize: [32, 32], iconAnchor: [16, 16] });
                    const enderecoCompleto = p.endereco_completo || `${p.rua || ''}, ${p.numero || ''} - ${p.bairro || ''}`;
                    const tipoLabel = idx === 0 ? 'üì¶ COLETA' : `üìç ENTREGA ${idx}`;
                    L.marker([p.latitude, p.longitude], { icon }).bindPopup(`<strong>${tipoLabel}</strong><br/>${enderecoCompleto}`).addTo(markersLayer);
                });
                if (pontosValidos.length > 0) { const bounds = L.latLngBounds(pontosValidos.map(p => [p.latitude, p.longitude])); map.fitBounds(bounds, { padding: [50, 50] }); }
                setTimeout(() => map.invalidateSize(), 50);
            }, [pontos, tipo]);
            
            useEffect(() => {
                const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting && mapInstanceRef.current) setTimeout(() => mapInstanceRef.current.invalidateSize(), 100); }); }, { threshold: 0.1 });
                if (mapRef.current) observer.observe(mapRef.current);
                return () => observer.disconnect();
            }, []);
            
            return <div ref={mapRef} className="rounded-xl shadow-lg" style={{ height, minHeight: '300px', width: '100%' }} />;
        };
        
        // ============ NOVO: Componente de Mapa Ajust√°vel com marcador arrast√°vel ============
        const MapaAjustavel = ({ latitude, longitude, onPosicaoMudou, zoom = 17 }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markerRef = useRef(null);
            
            useEffect(() => {
                if (typeof L === 'undefined') return;
                const container = mapRef.current;
                if (!container) return;
                
                if (mapInstanceRef.current) {
                    mapInstanceRef.current.remove();
                    mapInstanceRef.current = null;
                }
                
                const map = L.map(container, { 
                    center: [latitude, longitude], 
                    zoom: zoom, 
                    zoomControl: true 
                });
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                    maxZoom: 19, 
                    attribution: '¬© OpenStreetMap' 
                }).addTo(map);
                
                const icon = L.divIcon({ 
                    className: '', 
                    html: `<div style="position:relative;"><div style="background:#ef4444;color:#fff;width:40px;height:40px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:16px;border:3px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,0.4)"><span style="transform:rotate(45deg);">üìç</span></div></div>`, 
                    iconSize: [40, 48], 
                    iconAnchor: [20, 48] 
                });
                
                const marker = L.marker([latitude, longitude], { 
                    icon, 
                    draggable: true,
                    autoPan: true
                }).addTo(map);
                
                marker.on('dragend', function(e) {
                    const pos = e.target.getLatLng();
                    onPosicaoMudou(pos.lat, pos.lng);
                });
                
                map.on('click', function(e) {
                    marker.setLatLng(e.latlng);
                    onPosicaoMudou(e.latlng.lat, e.latlng.lng);
                });
                
                mapInstanceRef.current = map;
                markerRef.current = marker;
                
                setTimeout(() => {
                    if (mapInstanceRef.current) mapInstanceRef.current.invalidateSize();
                }, 100);
                
                return () => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                    }
                };
            }, []);
            
            useEffect(() => {
                if (markerRef.current && mapInstanceRef.current) {
                    markerRef.current.setLatLng([latitude, longitude]);
                    mapInstanceRef.current.setView([latitude, longitude], mapInstanceRef.current.getZoom());
                }
            }, [latitude, longitude]);
            
            return <div ref={mapRef} className="w-full h-full rounded-lg" style={{ minHeight: '300px' }} />;
        };
        
        const Solicitacao = ({ cliente, token, onLogout, showToast }) => {
            const [abaAtiva, setAbaAtiva] = useState('nova');
            const [pontos, setPontos] = useState([]);
            const [termoBusca, setTermoBusca] = useState('');
            const [sugestoes, setSugestoes] = useState([]);
            const [buscando, setBuscando] = useState(false);
            const [loading, setLoading] = useState(false);
            const [historico, setHistorico] = useState([]);
            const [mostrarHistorico, setMostrarHistorico] = useState(false);
            const [abaMobile, setAbaMobile] = useState('form');
            const [pontoEditando, setPontoEditando] = useState(null);
            const [dadosPonto, setDadosPonto] = useState({ observacao: '', telefone: '', procurar_por: '', numero_nota: '', codigo_finalizar: '', complemento: '' });
            const [corridasAtivas, setCorridasAtivas] = useState([]);
            const [corridaSelecionada, setCorridaSelecionada] = useState(null);
            const [detalheCorrida, setDetalheCorrida] = useState(null);
            const [corridasConcluidas, setCorridasConcluidas] = useState([]);
            const [filtroConcluidas, setFiltroConcluidas] = useState('todas');
            const [corridaExpandida, setCorridaExpandida] = useState(null);
            const [detalhesCorridaExpandida, setDetalhesCorridaExpandida] = useState(null);
            const [sincronizando, setSincronizando] = useState(false);
            const [sincronizandoHistorico, setSincronizandoHistorico] = useState(false);
            const [profissionais, setProfissionais] = useState([]);
            const [carregandoProfissionais, setCarregandoProfissionais] = useState(false);
            const [mapaKey, setMapaKey] = useState(0);
            
            // Estado para input de nota r√°pida ap√≥s adicionar ponto
            const [pontoRecemAdicionado, setPontoRecemAdicionado] = useState(null);
            const [notaRapida, setNotaRapida] = useState('');
            const notaInputRef = useRef(null);
            
            // Estado para modal de fotos
            const [fotoModal, setFotoModal] = useState({ aberto: false, fotos: [], indice: 0 });
            
            // Estado para endere√ßos salvos
            const [enderecosSalvos, setEnderecosSalvos] = useState([]);
            const [mostrarSalvos, setMostrarSalvos] = useState(false);
            const [modalSalvarEndereco, setModalSalvarEndereco] = useState({ aberto: false, ponto: null });
            const [apelidoSalvar, setApelidoSalvar] = useState('');
            const [complementoSalvar, setComplementoSalvar] = useState('');
            const [salvandoEndereco, setSalvandoEndereco] = useState(false);
            
            // ============ NOVO: Estados para modal de ajuste de mapa ============
            const [modalAjusteMapa, setModalAjusteMapa] = useState({
                aberto: false,
                sugestaoOriginal: null,
                latitude: null,
                longitude: null,
                etapa: 'ajustar'
            });
            const [posicaoAjustada, setPosicaoAjustada] = useState({ lat: null, lng: null });
            const [enderecoAjustado, setEnderecoAjustado] = useState(null);
            const [buscandoEnderecoReverso, setBuscandoEnderecoReverso] = useState(false);
            
            const abrirFotoModal = (fotos, indice = 0) => {
                setFotoModal({ aberto: true, fotos, indice });
            };
            
            const fecharFotoModal = () => {
                setFotoModal({ aberto: false, fotos: [], indice: 0 });
            };
            
            const navegarFoto = (direcao) => {
                setFotoModal(prev => ({
                    ...prev,
                    indice: Math.max(0, Math.min(prev.fotos.length - 1, prev.indice + direcao))
                }));
            };
            
            const [config, setConfig] = useState({
                numero_pedido: '', centro_custo: cliente.centro_custo_padrao || '', usuario_solicitante: cliente.nome,
                data_retirada: '', hora_retirada: '', forma_pagamento: cliente.forma_pagamento_padrao || 'F',
                ponto_receber: '', retorno: false, obs_retorno: '', ordenar: true, 
                codigo_profissional: '',
                sem_profissional: false
            });
            
            useEffect(() => { if (abaAtiva === 'nova' || abaAtiva === 'acompanhar') setMapaKey(prev => prev + 1); }, [abaAtiva, corridaSelecionada]);
            useEffect(() => { carregarProfissionais(); }, []);
            
            // Foco no input de nota quando ponto √© adicionado
            useEffect(() => {
                if (pontoRecemAdicionado !== null && notaInputRef.current) {
                    notaInputRef.current.focus();
                }
            }, [pontoRecemAdicionado]);
            
            const carregarProfissionais = async () => {
                setCarregandoProfissionais(true);
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/profissionais`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (resp.ok) { const data = await resp.json(); setProfissionais(data.profissionais || []); }
                } catch (err) { console.error('Erro ao carregar profissionais:', err); }
                setCarregandoProfissionais(false);
            };
            
            useEffect(() => { 
                if (cliente.endereco_partida_padrao) setPontos([{ id: Date.now(), ...cliente.endereco_partida_padrao, isPartida: true }]); 
                carregarHistorico(); 
                carregarCorridasAtivas(); 
            }, []);
            
            useEffect(() => {
                if (abaAtiva !== 'acompanhar') return;
                const interval = setInterval(() => { carregarCorridasAtivas(); if (corridaSelecionada) carregarDetalheCorrida(corridaSelecionada); }, 10000);
                return () => clearInterval(interval);
            }, [abaAtiva, corridaSelecionada]);
            
            const carregarHistorico = async () => { try { const resp = await fetch(`${API_URL}/api/solicitacao/historico?limite=20`, { headers: { 'Authorization': `Bearer ${token}` } }); if (resp.ok) { const data = await resp.json(); setHistorico(data.solicitacoes || []); } } catch (err) {} };
            const carregarCorridasAtivas = async () => { try { const resp = await fetch(`${API_URL}/api/solicitacao/historico?limite=50`, { headers: { 'Authorization': `Bearer ${token}` } }); if (resp.ok) { const data = await resp.json(); setCorridasAtivas((data.solicitacoes || []).filter(s => ['enviado', 'aceito', 'em_andamento'].includes(s.status))); } } catch (err) {} };
            const carregarConcluidas = async () => { try { const resp = await fetch(`${API_URL}/api/solicitacao/historico?limite=100`, { headers: { 'Authorization': `Bearer ${token}` } }); if (resp.ok) { const data = await resp.json(); setCorridasConcluidas((data.solicitacoes || []).filter(s => ['finalizado', 'cancelado'].includes(s.status))); } } catch (err) {} };
            
            // Fun√ß√£o para sincronizar hist√≥rico (recuperar dados de corridas antigas)
            const sincronizarHistorico = async () => {
                if (sincronizandoHistorico) return;
                setSincronizandoHistorico(true);
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/sincronizar-historico`, {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ limite: 50, apenasIncompletas: true })
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        alert(`‚úÖ Sincroniza√ß√£o conclu√≠da!\n\n${data.atualizadas} corridas atualizadas de ${data.total_verificadas} verificadas.`);
                        // Recarregar a lista
                        carregarConcluidas();
                    } else {
                        const err = await resp.json();
                        alert('‚ùå Erro: ' + (err.error || 'Falha na sincroniza√ß√£o'));
                    }
                } catch (err) {
                    alert('‚ùå Erro de conex√£o');
                } finally {
                    setSincronizandoHistorico(false);
                }
            };
            const carregarDetalheCorrida = async (id) => { 
                try { 
                    const resp = await fetch(`${API_URL}/api/solicitacao/corrida/${id}`, { headers: { 'Authorization': `Bearer ${token}` } }); 
                    if (resp.ok) {
                        const data = await resp.json();
                        setDetalheCorrida(data);
                        // Se a corrida foi finalizada ou cancelada, limpar sele√ß√£o e atualizar listas
                        if (['finalizado', 'cancelado'].includes(data.status)) {
                            showToast(data.status === 'finalizado' ? 'üèÅ Corrida finalizada!' : '‚ùå Corrida cancelada', 'info');
                            setCorridaSelecionada(null);
                            setDetalheCorrida(null);
                            carregarCorridasAtivas();
                            carregarConcluidas();
                        }
                    }
                } catch (err) {} 
            };
            const selecionarCorrida = (id) => { setCorridaSelecionada(id); carregarDetalheCorrida(id); };
            const copiarLinkRastreio = (os) => { navigator.clipboard.writeText(`${SITE_URL}/rastrear.html?os=${os}`).then(() => showToast('‚úÖ Link copiado!', 'success')); };
            const compartilharWhatsApp = (os) => { window.open(`https://wa.me/?text=${encodeURIComponent(`üèçÔ∏è Acompanhe sua entrega:\n${SITE_URL}/rastrear.html?os=${os}`)}`, '_blank'); };
            
            // Fun√ß√£o para expandir/colapsar corrida conclu√≠da
            const toggleExpandirCorrida = async (id) => {
                if (corridaExpandida === id) {
                    setCorridaExpandida(null);
                    setDetalhesCorridaExpandida(null);
                } else {
                    setCorridaExpandida(id);
                    setDetalhesCorridaExpandida(null);
                    try {
                        const resp = await fetch(`${API_URL}/api/solicitacao/corrida/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        if (resp.ok) {
                            const data = await resp.json();
                            setDetalhesCorridaExpandida(data);
                        }
                    } catch (err) {
                        console.error('Erro ao carregar detalhes:', err);
                    }
                }
            };
            
            const cancelarCorrida = async (id) => {
                if (!confirm('Tem certeza que deseja CANCELAR esta corrida?')) return;
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/corrida/${id}/cancelar`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await resp.json();
                    if (resp.ok) { showToast(data.cancelou_tutts ? '‚úÖ Corrida cancelada!' : '‚ùå Corrida marcada como cancelada', 'success'); carregarCorridasAtivas(); carregarConcluidas(); setCorridaSelecionada(null); setDetalheCorrida(null); }
                    else showToast(data.error || 'Erro ao cancelar', 'error');
                } catch (err) { showToast('Erro ao cancelar', 'error'); }
            };
            
            const sincronizarStatus = async () => {
                setSincronizando(true);
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/sincronizar`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await resp.json();
                    if (resp.ok) {
                        if (data.atualizadas > 0) { showToast(`üîÑ ${data.atualizadas} atualizada(s)`, 'success'); carregarCorridasAtivas(); carregarConcluidas(); if (corridaSelecionada) carregarDetalheCorrida(corridaSelecionada); }
                        else showToast('‚úÖ Tudo sincronizado!', 'info');
                    } else showToast(data.error || 'Erro', 'error');
                } catch (err) { showToast('Erro', 'error'); }
                setSincronizando(false);
            };
            
            const buscarEndereco = async () => {
                if (!termoBusca || termoBusca.length < 3) { showToast('Digite pelo menos 3 caracteres', 'warning'); return; }
                setBuscando(true);
                try { const resp = await fetch(`${API_URL}/api/geocode/google?endereco=${encodeURIComponent(termoBusca)}`); if (resp.ok) { const data = await resp.json(); if (data.results?.length > 0) setSugestoes(data.results); else showToast('Nenhum endere√ßo', 'warning'); } }
                catch (err) { showToast('Erro', 'error'); }
                setBuscando(false);
            };
            
            // ============ NOVO: Fun√ß√µes para ajuste de mapa ============
            const buscarEnderecoReverso = async (lat, lng) => {
                setBuscandoEnderecoReverso(true);
                try {
                    const resp = await fetch(`${API_URL}/api/geocode/google?endereco=${lat},${lng}`);
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data.results?.length > 0) {
                            setEnderecoAjustado(data.results[0]);
                            return data.results[0];
                        }
                    }
                    showToast('N√£o foi poss√≠vel obter o endere√ßo', 'warning');
                    return null;
                } catch (err) {
                    showToast('Erro ao buscar endere√ßo', 'error');
                    return null;
                } finally {
                    setBuscandoEnderecoReverso(false);
                }
            };
            
            const abrirModalAjusteMapa = (sugestao) => {
                setModalAjusteMapa({
                    aberto: true,
                    sugestaoOriginal: sugestao,
                    latitude: sugestao.latitude,
                    longitude: sugestao.longitude,
                    etapa: 'ajustar'
                });
                setPosicaoAjustada({ lat: sugestao.latitude, lng: sugestao.longitude });
                setEnderecoAjustado(null);
            };
            
            const onPosicaoMudou = (lat, lng) => {
                setPosicaoAjustada({ lat, lng });
            };
            
            const confirmarPosicaoMapa = async () => {
                const endereco = await buscarEnderecoReverso(posicaoAjustada.lat, posicaoAjustada.lng);
                if (endereco) {
                    setModalAjusteMapa(prev => ({ ...prev, etapa: 'confirmar' }));
                }
            };
            
            const usarEnderecoAjustado = () => {
                if (!enderecoAjustado) return;
                
                const sug = enderecoAjustado;
                if (pontos.length >= 80) { showToast('M√°ximo 80 pontos', 'error'); return; }
                const comp = sug.componentes || [];
                const get = (t) => comp.find(c => c.types?.includes(t))?.long_name || '';
                const getS = (t) => comp.find(c => c.types?.includes(t))?.short_name || '';
                const novoId = Date.now();
                const novoPonto = { 
                    id: novoId, 
                    endereco_completo: sug.endereco || '', 
                    rua: get('route'), 
                    numero: get('street_number'), 
                    complemento: '',
                    bairro: get('sublocality_level_1') || get('sublocality'), 
                    cidade: get('administrative_area_level_2') || get('locality'), 
                    uf: getS('administrative_area_level_1'), 
                    cep: get('postal_code'), 
                    latitude: posicaoAjustada.lat, 
                    longitude: posicaoAjustada.lng, 
                    observacao: '', 
                    telefone: '', 
                    procurar_por: '', 
                    numero_nota: '', 
                    codigo_finalizar: '',
                    ajustado_manualmente: true
                };
                const novosPontos = [...pontos, novoPonto];
                setPontos(novosPontos);
                setTermoBusca(''); 
                setSugestoes([]);
                
                fecharModalAjusteMapa();
                
                if (novosPontos.length > 1) {
                    setPontoRecemAdicionado(novoId);
                    setNotaRapida('');
                }
                
                showToast('‚úÖ Endere√ßo ajustado adicionado!', 'success');
            };
            
            const voltarParaAjustar = () => {
                setModalAjusteMapa(prev => ({ ...prev, etapa: 'ajustar' }));
                setEnderecoAjustado(null);
            };
            
            const fecharModalAjusteMapa = () => {
                setModalAjusteMapa({ aberto: false, sugestaoOriginal: null, latitude: null, longitude: null, etapa: 'ajustar' });
                setEnderecoAjustado(null);
                setPosicaoAjustada({ lat: null, lng: null });
            };
            
            // Buscar endere√ßos salvos
            const buscarEnderecosSalvos = async (termo = '') => {
                try {
                    const url = termo ? `${API_URL}/api/solicitacao/enderecos-salvos/buscar?q=${encodeURIComponent(termo)}` : `${API_URL}/api/solicitacao/enderecos-salvos/buscar`;
                    const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (resp.ok) {
                        const data = await resp.json();
                        setEnderecosSalvos(data);
                        setMostrarSalvos(data.length > 0);
                    }
                } catch (err) {
                    console.error('Erro ao buscar salvos:', err);
                }
            };
            
            // Buscar salvos quando digita
            useEffect(() => {
                if (termoBusca.length >= 2) {
                    buscarEnderecosSalvos(termoBusca);
                } else if (termoBusca.length === 0) {
                    setMostrarSalvos(false);
                    setEnderecosSalvos([]);
                }
            }, [termoBusca]);
            
            // Adicionar ponto de endere√ßo salvo
            const adicionarPontoSalvo = async (endereco) => {
                if (pontos.length >= 80) { showToast('M√°ximo 80 pontos', 'error'); return; }
                
                const novoId = Date.now();
                const novoPonto = { 
                    id: novoId, 
                    endereco_completo: endereco.endereco_completo || `${endereco.rua}, ${endereco.numero} - ${endereco.bairro}, ${endereco.cidade}`,
                    rua: endereco.rua, 
                    numero: endereco.numero, 
                    complemento: endereco.complemento || '',
                    bairro: endereco.bairro, 
                    cidade: endereco.cidade, 
                    uf: endereco.uf, 
                    cep: endereco.cep, 
                    latitude: parseFloat(endereco.latitude), 
                    longitude: parseFloat(endereco.longitude), 
                    observacao: '', 
                    telefone: '', 
                    procurar_por: '', 
                    numero_nota: '', 
                    codigo_finalizar: '',
                    endereco_salvo_id: endereco.id,
                    apelido_salvo: endereco.apelido
                };
                
                const novosPontos = [...pontos, novoPonto];
                setPontos(novosPontos);
                setTermoBusca(''); 
                setSugestoes([]);
                setMostrarSalvos(false);
                setEnderecosSalvos([]);
                
                // Incrementar uso
                try {
                    await fetch(`${API_URL}/api/solicitacao/enderecos-salvos/${endereco.id}/usar`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } catch (err) {}
                
                // Se for ponto de entrega, mostrar input de nota
                if (novosPontos.length > 1) {
                    setPontoRecemAdicionado(novoId);
                    setNotaRapida('');
                }
                
                showToast(`‚úÖ "${endereco.apelido}" adicionado`, 'success');
            };
            
            // Salvar endere√ßo
            const salvarEndereco = async () => {
                if (!apelidoSalvar.trim()) { showToast('Digite um apelido', 'warning'); return; }
                if (!modalSalvarEndereco.ponto) return;
                
                setSalvandoEndereco(true);
                const p = modalSalvarEndereco.ponto;
                
                // Tentar extrair cidade do endere√ßo completo se n√£o tiver
                let cidade = p.cidade;
                if (!cidade && p.endereco_completo) {
                    // Formato t√≠pico: "Rua X, 123 - Bairro, Cidade - UF, CEP"
                    const partes = p.endereco_completo.split(',');
                    if (partes.length >= 3) {
                        // Tentar pegar a cidade (geralmente ap√≥s o bairro)
                        const cidadeUF = partes[partes.length - 2]?.trim();
                        if (cidadeUF) {
                            cidade = cidadeUF.split('-')[0]?.trim() || cidadeUF;
                        }
                    }
                }
                
                // Usar o complemento editado no modal ou o original do ponto
                const complementoFinal = complementoSalvar || p.complemento || '';
                
                try {
                    const resp = await fetch(`${API_URL}/api/solicitacao/enderecos-salvos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({
                            apelido: apelidoSalvar.trim(),
                            rua: p.rua,
                            numero: p.numero,
                            complemento: complementoFinal,
                            bairro: p.bairro,
                            cidade: cidade || 'N√£o informada',
                            uf: p.uf,
                            cep: p.cep,
                            latitude: p.latitude,
                            longitude: p.longitude,
                            endereco_completo: p.endereco_completo
                        })
                    });
                    
                    const data = await resp.json();
                    if (resp.ok) {
                        showToast(`üíæ "${apelidoSalvar}" salvo!`, 'success');
                        setModalSalvarEndereco({ aberto: false, ponto: null });
                        setApelidoSalvar('');
                        setComplementoSalvar('');
                        // Atualizar o complemento no ponto atual tamb√©m
                        if (complementoFinal && complementoFinal !== p.complemento) {
                            setPontos(prev => prev.map(ponto => 
                                ponto.id === p.id ? { ...ponto, complemento: complementoFinal } : ponto
                            ));
                        }
                    } else {
                        showToast(data.error || 'Erro ao salvar', 'error');
                    }
                } catch (err) {
                    showToast('Erro ao salvar', 'error');
                }
                setSalvandoEndereco(false);
            };
            
            const adicionarPonto = (sug) => {
                if (pontos.length >= 80) { showToast('M√°ximo 80 pontos', 'error'); return; }
                const comp = sug.componentes || [];
                const get = (t) => comp.find(c => c.types?.includes(t))?.long_name || '';
                const getS = (t) => comp.find(c => c.types?.includes(t))?.short_name || '';
                const novoId = Date.now();
                const novoPonto = { 
                    id: novoId, 
                    endereco_completo: sug.endereco || '', 
                    rua: get('route'), 
                    numero: get('street_number'), 
                    complemento: '',
                    bairro: get('sublocality_level_1') || get('sublocality'), 
                    cidade: get('administrative_area_level_2') || get('locality'), 
                    uf: getS('administrative_area_level_1'), 
                    cep: get('postal_code'), 
                    latitude: sug.latitude, 
                    longitude: sug.longitude, 
                    observacao: '', 
                    telefone: '', 
                    procurar_por: '', 
                    numero_nota: '', 
                    codigo_finalizar: '' 
                };
                const novosPontos = [...pontos, novoPonto];
                setPontos(novosPontos);
                setTermoBusca(''); 
                setSugestoes([]);
                
                // Se for ponto de entrega (n√£o o primeiro), mostrar input de nota
                if (novosPontos.length > 1) {
                    setPontoRecemAdicionado(novoId);
                    setNotaRapida('');
                }
                
                showToast('‚úÖ Adicionado', 'success');
            };
            
            // Salvar nota r√°pida
            const salvarNotaRapida = () => {
                if (pontoRecemAdicionado && notaRapida.trim()) {
                    setPontos(prev => prev.map(p => 
                        p.id === pontoRecemAdicionado 
                            ? { ...p, numero_nota: notaRapida.trim() } 
                            : p
                    ));
                    showToast('üè∑Ô∏è Nota adicionada!', 'success');
                }
                setPontoRecemAdicionado(null);
                setNotaRapida('');
            };
            
            // Pular nota r√°pida
            const pularNotaRapida = () => {
                setPontoRecemAdicionado(null);
                setNotaRapida('');
            };
            
            const removerPonto = (id) => {
                setPontos(pontos.filter(p => p.id !== id));
                if (pontoRecemAdicionado === id) {
                    setPontoRecemAdicionado(null);
                    setNotaRapida('');
                }
            };
            
            const moverPonto = (idx, dir) => { const lista = [...pontos]; const n = idx + dir; if (n >= 0 && n < lista.length) { [lista[idx], lista[n]] = [lista[n], lista[idx]]; setPontos(lista); } };
            
            const abrirEdicaoPonto = (idx) => { 
                const p = pontos[idx]; 
                setDadosPonto({ 
                    observacao: p.observacao || '', 
                    telefone: p.telefone || '', 
                    procurar_por: p.procurar_por || '', 
                    numero_nota: p.numero_nota || '', 
                    codigo_finalizar: p.codigo_finalizar || '',
                    complemento: p.complemento || ''
                }); 
                setPontoEditando(idx);
                // Fechar input de nota r√°pida se estiver aberto
                setPontoRecemAdicionado(null);
                setNotaRapida('');
            };
            
            const salvarEdicaoPonto = () => { const n = [...pontos]; n[pontoEditando] = { ...n[pontoEditando], ...dadosPonto }; setPontos(n); setPontoEditando(null); showToast('‚úÖ Salvo', 'success'); };
            const salvarPartidaPadrao = async () => { if (pontos.length === 0) return; try { await fetch(`${API_URL}/api/solicitacao/configuracoes`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ endereco_partida_padrao: pontos[0] }) }); showToast('‚úÖ Salvo!', 'success'); } catch {} };
            const limpar = () => { if (cliente.endereco_partida_padrao) setPontos([{ id: Date.now(), ...cliente.endereco_partida_padrao, isPartida: true }]); else setPontos([]); setSugestoes([]); setTermoBusca(''); setPontoRecemAdicionado(null); setNotaRapida(''); };
            
            const enviarSolicitacao = async () => {
                if (pontos.length < 2) { showToast('M√≠nimo 2 pontos', 'error'); return; }
                if (config.ordenar && pontos.length > 20) { showToast('Ordena√ß√£o: m√°x 20 pts', 'warning'); return; }
                
                // Fechar input de nota r√°pida antes de enviar
                if (pontoRecemAdicionado && notaRapida.trim()) {
                    setPontos(prev => prev.map(p => p.id === pontoRecemAdicionado ? { ...p, numero_nota: notaRapida.trim() } : p));
                }
                setPontoRecemAdicionado(null);
                setNotaRapida('');
                
                setLoading(true);
                try {
                    const dataRet = config.data_retirada && config.hora_retirada ? `${config.data_retirada} ${config.hora_retirada}:00` : '';
                    
                    // Buscar dados do profissional selecionado
                    const profSelecionado = config.codigo_profissional ? profissionais.find(p => p.codigo === config.codigo_profissional) : null;
                    
                    const payload = { 
                        numero_pedido: config.numero_pedido, 
                        centro_custo: config.centro_custo, 
                        usuario_solicitante: config.usuario_solicitante, 
                        data_retirada: dataRet, 
                        forma_pagamento: config.forma_pagamento, 
                        ponto_receber: config.ponto_receber ? parseInt(config.ponto_receber) : null, 
                        retorno: config.retorno, 
                        obs_retorno: config.obs_retorno, 
                        ordenar: config.ordenar, 
                        codigo_profissional: config.codigo_profissional,
                        // Dados do profissional selecionado
                        profissional_nome: profSelecionado?.nome || null,
                        profissional_foto: profSelecionado?.foto || null,
                        profissional_telefone: profSelecionado?.telefone || null,
                        profissional_placa: profSelecionado?.placa || null,
                        sem_profissional: config.sem_profissional, 
                        pontos: pontos.map(p => ({ 
                            rua: p.rua || '', 
                            numero: p.numero || '', 
                            complemento: p.complemento || '', 
                            bairro: p.bairro || '', 
                            cidade: p.cidade || '', 
                            uf: p.uf || '', 
                            cep: p.cep || '', 
                            latitude: p.latitude, 
                            longitude: p.longitude, 
                            observacao: p.observacao || '', 
                            telefone: p.telefone || '', 
                            procurar_por: p.procurar_por || '', 
                            numero_nota: p.numero_nota || '', 
                            codigo_finalizar: p.codigo_finalizar || '', 
                            endereco_completo: p.endereco_completo || '' 
                        })) 
                    };
                    const resp = await fetch(`${API_URL}/api/solicitacao/corrida`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
                    const data = await resp.json();
                    if (resp.ok) { 
                        const motoboy = config.codigo_profissional ? profissionais.find(p => p.codigo === config.codigo_profissional)?.nome : null; 
                        showToast(`‚úÖ OS: ${data.os_numero}${motoboy ? ` ‚Üí ${motoboy}` : ''}${data.modo_teste ? ' (TESTE)' : ''}`, 'success'); 
                        limpar(); 
                        setConfig(prev => ({ ...prev, codigo_profissional: '' })); 
                        carregarHistorico(); 
                        carregarCorridasAtivas(); 
                    }
                    else showToast(data.error || 'Erro', 'error');
                } catch { showToast('Erro', 'error'); }
                setLoading(false);
            };
            
            // Mapeamentos de status
            const statusCores = { enviado: 'bg-yellow-100 text-yellow-800 border-yellow-300', aceito: 'bg-blue-100 text-blue-800 border-blue-300', em_andamento: 'bg-purple-100 text-purple-800 border-purple-300', finalizado: 'bg-green-100 text-green-800 border-green-300', cancelado: 'bg-red-100 text-red-800 border-red-300', erro: 'bg-red-100 text-red-800 border-red-300' };
            const statusNomes = { enviado: 'Aguardando', aceito: 'Aceito', em_andamento: 'Em Andamento', finalizado: 'Finalizado', cancelado: 'Cancelado', erro: 'Erro' };
            const statusIcons = { enviado: '‚è≥', aceito: '‚úÖ', em_andamento: 'üèçÔ∏è', finalizado: 'üèÅ', cancelado: '‚ùå', erro: '‚ö†Ô∏è' };
            const statusPontoCores = { pendente: 'bg-gray-50 border-gray-200', chegou: 'bg-blue-50 border-blue-300', coletado: 'bg-yellow-50 border-yellow-300', finalizado: 'bg-green-50 border-green-300' };
            const statusPontoNomes = { pendente: 'Pendente', chegou: 'Chegou', coletado: 'Coletado', finalizado: 'Finalizado' };
            const statusPontoIcons = { pendente: '‚ö™', chegou: 'üîµ', coletado: 'üü°', finalizado: '‚úÖ' };
            
            const formatarData = (d) => d ? new Date(d).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
            const formatarHora = (d) => d ? new Date(d).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
            const contarPontos = (corrida) => { const total = corrida.total_pontos || 0; return { coletas: 1, entregas: Math.max(0, total - 1) }; };
            
            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-blue-900 text-white px-3 py-2 shadow-lg">
                        <div className="max-w-7xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <span className="text-xl">üèçÔ∏è</span>
                                <div>
                                    <h1 className="font-bold text-sm md:text-lg">Central Tutts</h1>
                                    <p className="text-xs text-blue-200 hidden md:block">{cliente.empresa || cliente.nome}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setMostrarHistorico(true)} className="text-xs bg-blue-800 hover:bg-blue-700 px-2 py-1 rounded">üìã Hist√≥rico</button>
                                <button onClick={onLogout} className="text-xs bg-red-600 hover:bg-red-700 px-2 py-1 rounded">Sair</button>
                            </div>
                        </div>
                    </header>
                    
                    {/* Abas */}
                    <div className="bg-white shadow border-b">
                        <div className="max-w-7xl mx-auto flex">
                            <button onClick={() => { setAbaAtiva('nova'); setCorridaSelecionada(null); }} className={`flex-1 md:flex-none px-4 py-3 text-sm font-medium border-b-2 ${abaAtiva === 'nova' ? 'text-blue-600 border-blue-600 bg-blue-50' : 'text-gray-500 border-transparent'}`}>üìù Nova</button>
                            <button onClick={() => { setAbaAtiva('acompanhar'); carregarCorridasAtivas(); }} className={`flex-1 md:flex-none px-4 py-3 text-sm font-medium border-b-2 flex items-center justify-center gap-2 ${abaAtiva === 'acompanhar' ? 'text-blue-600 border-blue-600 bg-blue-50' : 'text-gray-500 border-transparent'}`}>
                                üó∫Ô∏è Ativas {corridasAtivas.length > 0 && <span className="bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full">{corridasAtivas.length}</span>}
                            </button>
                            <button onClick={() => { setAbaAtiva('concluidas'); carregarConcluidas(); }} className={`flex-1 md:flex-none px-4 py-3 text-sm font-medium border-b-2 ${abaAtiva === 'concluidas' ? 'text-green-600 border-green-600 bg-green-50' : 'text-gray-500 border-transparent'}`}>‚úÖ Conclu√≠das</button>
                        </div>
                    </div>
                    
                    {/* ========== ABA NOVA SOLICITA√á√ÉO ========== */}
                    {abaAtiva === 'nova' && (
                        <>
                            <div className="md:hidden flex bg-white shadow">
                                <button onClick={() => setAbaMobile('form')} className={`flex-1 py-2 text-sm ${abaMobile === 'form' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>üìù Form</button>
                                <button onClick={() => setAbaMobile('mapa')} className={`flex-1 py-2 text-sm ${abaMobile === 'mapa' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>üó∫Ô∏è Mapa</button>
                            </div>
                            <div className="max-w-7xl mx-auto p-2 md:p-4">
                                <div className="flex flex-col md:flex-row gap-4">
                                    <div className={`${abaMobile === 'form' ? 'block' : 'hidden'} md:block w-full md:w-96 space-y-3`}>
                                        {/* PONTO DE COLETA */}
                                        <div className="bg-gradient-to-r from-amber-50 to-yellow-50 rounded-xl shadow border-2 border-amber-300 p-3">
                                            <div className="flex items-center justify-between mb-2">
                                                <span className="text-sm font-bold text-amber-800">üì¶ PONTO DE COLETA</span>
                                                {pontos.length > 0 && pontos[0] && <button onClick={salvarPartidaPadrao} className="text-xs text-amber-600 hover:text-amber-800 font-medium">‚≠ê Padr√£o</button>}
                                            </div>
                                            {pontos.length === 0 || !pontos[0] ? (
                                                <div>
                                                    <div className="flex gap-2">
                                                        <input type="text" value={termoBusca} onChange={(e) => setTermoBusca(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && buscarEndereco()} className="flex-1 px-3 py-2 border border-amber-300 rounded-lg text-sm outline-none bg-white" placeholder="Digite apelido ou endere√ßo..." />
                                                        <button onClick={buscarEndereco} disabled={buscando} className="px-3 py-2 bg-amber-500 text-white rounded-lg text-sm" title="Buscar no Google">{buscando ? '...' : 'üîç'}</button>
                                                    </div>
                                                    {/* Endere√ßos salvos */}
                                                    {mostrarSalvos && enderecosSalvos.length > 0 && (
                                                        <div className="mt-2 bg-amber-50 border border-amber-200 rounded-lg max-h-40 overflow-y-auto">
                                                            <div className="px-2 py-1 text-xs font-medium text-amber-700 border-b border-amber-200 bg-amber-100">üíæ Endere√ßos salvos</div>
                                                            {enderecosSalvos.map((e, i) => (
                                                                <div key={i} onClick={() => adicionarPontoSalvo(e)} className="p-2 hover:bg-amber-100 cursor-pointer text-xs border-b border-amber-100">
                                                                    <div className="font-medium text-amber-800">‚≠ê {e.apelido}</div>
                                                                    <div className="text-gray-600 truncate">{e.endereco_completo || `${e.rua}, ${e.numero} - ${e.bairro}, ${e.cidade}`}{e.complemento && ` (${e.complemento})`}</div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {/* Sugest√µes do Google */}
                                                    {sugestoes.length > 0 && <div className="mt-2 bg-white border border-amber-200 rounded-lg max-h-48 overflow-y-auto">{sugestoes.map((s, i) => <div key={i} className="p-2 hover:bg-amber-50 border-b flex items-center gap-2"><div className="flex-1 cursor-pointer" onClick={() => adicionarPonto(s)}><span className="text-xs">üìç {s.endereco}</span></div><button onClick={(e) => { e.stopPropagation(); abrirModalAjusteMapa(s); }} className="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium whitespace-nowrap" title="Ajustar posi√ß√£o no mapa">üéØ</button></div>)}</div>}
                                                </div>
                                            ) : (
                                                <div className="bg-white rounded-lg p-2 border border-amber-200">
                                                    <div className="flex items-center gap-2">
                                                        <span className="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center text-white text-sm font-bold">üì¶</span>
                                                        <div className="flex-1 min-w-0">
                                                            {pontos[0].apelido_salvo && <div className="text-xs text-amber-600 font-medium">‚≠ê {pontos[0].apelido_salvo}</div>}
                                                            <div className="text-xs font-medium truncate">{pontos[0].endereco_completo || `${pontos[0].rua}, ${pontos[0].numero}`}</div>
                                                            {pontos[0].complemento && <div className="text-xs text-amber-700">üè† {pontos[0].complemento}</div>}
                                                            {pontos[0].bairro && <div className="text-xs text-gray-500">{pontos[0].bairro}, {pontos[0].cidade}</div>}
                                                            {pontos[0].numero_nota && <div className="text-xs text-amber-600">üè∑Ô∏è {pontos[0].numero_nota}</div>}
                                                            {pontos[0].observacao && <div className="text-xs text-gray-500 truncate">üìù {pontos[0].observacao}</div>}
                                                            {pontos[0].ajustado_manualmente && <div className="text-xs text-green-600">üéØ Posi√ß√£o ajustada</div>}
                                                        </div>
                                                        <div className="flex gap-1">
                                                            {!pontos[0].endereco_salvo_id && (
                                                                <button onClick={() => { setModalSalvarEndereco({ aberto: true, ponto: pontos[0] }); setApelidoSalvar(''); setComplementoSalvar(pontos[0].complemento || ''); }} className="text-gray-400 hover:text-green-600 text-sm" title="Salvar endere√ßo">üíæ</button>
                                                            )}
                                                            <button onClick={() => abrirEdicaoPonto(0)} className="text-gray-400 hover:text-amber-600 text-sm">‚úèÔ∏è</button>
                                                            <button onClick={() => removerPonto(pontos[0].id)} className="text-gray-400 hover:text-red-600">‚úï</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* PONTOS DE ENTREGA */}
                                        <div className="bg-white rounded-xl shadow p-3">
                                            <div className="flex items-center justify-between mb-2">
                                                <span className="text-sm font-bold text-blue-800">üìç PONTOS DE ENTREGA ({Math.max(0, pontos.length - 1)}/79)</span>
                                                {pontos.length > 1 && <button onClick={() => setPontos(pontos.slice(0, 1))} className="text-xs text-red-500 hover:text-red-700">Limpar</button>}
                                            </div>
                                            {pontos.length > 0 && (
                                                <div className="mb-2">
                                                    <div className="flex gap-2">
                                                        <input type="text" value={termoBusca} onChange={(e) => setTermoBusca(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && buscarEndereco()} className="flex-1 px-3 py-2 border rounded-lg text-sm outline-none" placeholder="Digite apelido ou endere√ßo..." />
                                                        <button onClick={buscarEndereco} disabled={buscando} className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm" title="Buscar no Google">{buscando ? '...' : 'üîç'}</button>
                                                    </div>
                                                    {/* Endere√ßos salvos */}
                                                    {mostrarSalvos && enderecosSalvos.length > 0 && (
                                                        <div className="mt-2 bg-blue-50 border border-blue-200 rounded-lg max-h-40 overflow-y-auto">
                                                            <div className="px-2 py-1 text-xs font-medium text-blue-700 border-b border-blue-200 bg-blue-100">üíæ Endere√ßos salvos</div>
                                                            {enderecosSalvos.map((e, i) => (
                                                                <div key={i} onClick={() => adicionarPontoSalvo(e)} className="p-2 hover:bg-blue-100 cursor-pointer text-xs border-b border-blue-100">
                                                                    <div className="font-medium text-blue-800">‚≠ê {e.apelido}</div>
                                                                    <div className="text-gray-600 truncate">{e.endereco_completo || `${e.rua}, ${e.numero} - ${e.bairro}, ${e.cidade}`}{e.complemento && ` (${e.complemento})`}</div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {/* Sugest√µes do Google */}
                                                    {sugestoes.length > 0 && <div className="mt-2 bg-white border rounded-lg max-h-48 overflow-y-auto">{sugestoes.map((s, i) => <div key={i} className="p-2 hover:bg-blue-50 border-b flex items-center gap-2"><div className="flex-1 cursor-pointer" onClick={() => adicionarPonto(s)}><span className="text-xs">üìç {s.endereco}</span></div><button onClick={(e) => { e.stopPropagation(); abrirModalAjusteMapa(s); }} className="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs font-medium whitespace-nowrap" title="Ajustar posi√ß√£o no mapa">üéØ</button></div>)}</div>}
                                                </div>
                                            )}
                                            <div className="space-y-2 max-h-64 overflow-y-auto">
                                                {pontos.length <= 1 ? (
                                                    <div className="text-center py-4 text-gray-400 text-sm">{pontos.length === 0 ? 'Defina a coleta primeiro' : 'Adicione pontos de entrega'}</div>
                                                ) : pontos.slice(1).map((p, idx) => (
                                                    <div key={p.id}>
                                                        <div className={`p-2 rounded-lg border ${pontoRecemAdicionado === p.id ? 'bg-green-50 border-green-300' : 'bg-blue-50 border-blue-200'}`}>
                                                            <div className="flex items-center gap-2">
                                                                <span className="w-7 h-7 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs font-bold">{idx + 1}</span>
                                                                <div className="flex-1 min-w-0">
                                                                    {p.apelido_salvo && <div className="text-xs text-blue-600 font-medium">‚≠ê {p.apelido_salvo}</div>}
                                                                    <div className="text-xs font-medium truncate">{p.endereco_completo || `${p.rua}, ${p.numero}`}</div>
                                                                    {p.complemento && <div className="text-xs text-blue-700">üè† {p.complemento}</div>}
                                                                    {p.bairro && <div className="text-xs text-gray-500 truncate">{p.bairro}</div>}
                                                                    {p.numero_nota && <div className="text-xs text-green-600 font-medium">üè∑Ô∏è Nota: {p.numero_nota}</div>}
                                                                    {p.observacao && <div className="text-xs text-blue-600 truncate">üìù {p.observacao}</div>}
                                                                    {p.ajustado_manualmente && <div className="text-xs text-green-600">üéØ Posi√ß√£o ajustada</div>}
                                                                </div>
                                                                <div className="flex gap-1">
                                                                    {!p.endereco_salvo_id && (
                                                                        <button onClick={(e) => { e.stopPropagation(); setModalSalvarEndereco({ aberto: true, ponto: p }); setApelidoSalvar(''); setComplementoSalvar(p.complemento || ''); }} className="text-gray-400 hover:text-green-600 text-sm" title="Salvar endere√ßo">üíæ</button>
                                                                    )}
                                                                    <button onClick={() => abrirEdicaoPonto(idx + 1)} className="text-gray-400 hover:text-blue-600 text-sm">‚úèÔ∏è</button>
                                                                    {idx > 0 && <button onClick={() => moverPonto(idx + 1, -1)} className="text-gray-400">‚ñ≤</button>}
                                                                    {idx < pontos.length - 2 && <button onClick={() => moverPonto(idx + 1, 1)} className="text-gray-400">‚ñº</button>}
                                                                    <button onClick={() => removerPonto(p.id)} className="text-gray-400 hover:text-red-600">‚úï</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Input de nota r√°pida - aparece logo ap√≥s adicionar o ponto */}
                                                        {pontoRecemAdicionado === p.id && (
                                                            <div className="slide-down mt-2 p-2 bg-green-50 border border-green-200 rounded-lg">
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-xs text-green-700">üè∑Ô∏è</span>
                                                                    <input 
                                                                        ref={notaInputRef}
                                                                        type="text" 
                                                                        value={notaRapida} 
                                                                        onChange={(e) => setNotaRapida(e.target.value)}
                                                                        onKeyPress={(e) => { if (e.key === 'Enter') salvarNotaRapida(); }}
                                                                        className="flex-1 px-2 py-1 border border-green-300 rounded text-xs outline-none focus:ring-1 focus:ring-green-400" 
                                                                        placeholder="N¬∫ Nota/Pedido (opcional)"
                                                                    />
                                                                    <button onClick={salvarNotaRapida} className="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">‚úì</button>
                                                                    <button onClick={pularNotaRapida} className="px-2 py-1 text-gray-500 hover:text-gray-700 text-xs">Pular</button>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        {/* Configura√ß√µes */}
                                        <div className="bg-white rounded-xl shadow p-3">
                                            <div className="text-sm font-bold text-gray-700 mb-2">‚öôÔ∏è Configura√ß√µes</div>
                                            <div>
                                                <label className="text-xs text-gray-600">üèçÔ∏è Motoboy Espec√≠fico</label>
                                                <select value={config.codigo_profissional} onChange={(e) => setConfig({...config, codigo_profissional: e.target.value})} className={`w-full px-2 py-1.5 border rounded text-sm ${config.codigo_profissional ? 'border-green-400 bg-green-50' : ''}`} disabled={carregandoProfissionais || profissionais.length === 0}>
                                                    <option value="">{carregandoProfissionais ? '‚è≥ Carregando...' : profissionais.length === 0 ? '‚ùå Nenhum dispon√≠vel' : 'üîÑ Disparar para todos'}</option>
                                                    {profissionais.map(p => (<option key={p.codigo} value={p.codigo}>{p.nome}</option>))}
                                                </select>
                                                {config.codigo_profissional && <div className="text-xs text-green-600 mt-1">‚úÖ Corrida para: {profissionais.find(p => p.codigo === config.codigo_profissional)?.nome}</div>}
                                            </div>
                                            <div className="flex flex-wrap gap-4 mt-3">
                                                <label className="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" checked={config.ordenar} onChange={(e) => setConfig({...config, ordenar: e.target.checked})} className="w-4 h-4" />üîÄ Ordenar rota</label>
                                                <label className="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" checked={config.retorno} onChange={(e) => setConfig({...config, retorno: e.target.checked})} className="w-4 h-4" />‚Ü©Ô∏è Retorno</label>
                                            </div>
                                        </div>
                                        
                                        {/* Bot√£o Enviar */}
                                        <button onClick={enviarSolicitacao} disabled={loading || pontos.length < 2} className={`w-full py-3 text-white rounded-xl font-bold text-sm shadow-lg disabled:opacity-50 ${config.codigo_profissional ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'}`}>
                                            {loading ? '‚è≥ Enviando...' : `üöÄ Solicitar Corrida (${pontos.length} pts)`}
                                        </button>
                                    </div>
                                    
                                    {/* Mapa */}
                                    <div className={`${abaMobile === 'mapa' ? 'block' : 'hidden'} md:block flex-1`}>
                                        <MapaLeaflet key={`nova-${mapaKey}`} id="mapa-nova" pontos={pontos} height="calc(100vh - 200px)" tipo="nova" />
                                    </div>
                                </div>
                            </div>
                        </>
                    )}
                    
                    {/* ========== ABA ACOMPANHAR ========== */}
                    {abaAtiva === 'acompanhar' && (
                        <div className="max-w-7xl mx-auto p-2 md:p-4">
                            <div className="flex flex-col md:flex-row gap-4">
                                <div className="w-full md:w-80 space-y-3">
                                    <div className="bg-white rounded-xl shadow p-3">
                                        <div className="flex items-center justify-between mb-3">
                                            <span className="text-sm font-bold text-gray-700">üèçÔ∏è Corridas Ativas ({corridasAtivas.length})</span>
                                            <button onClick={sincronizarStatus} disabled={sincronizando} className="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded font-medium disabled:opacity-50">{sincronizando ? '‚è≥...' : 'üîÑ Sync'}</button>
                                        </div>
                                        {corridasAtivas.length === 0 ? (
                                            <div className="text-center py-8 text-gray-400"><div className="text-4xl mb-2">üì≠</div><div className="text-sm">Nenhuma corrida ativa</div></div>
                                        ) : (
                                            <div className="space-y-2 max-h-[calc(100vh-280px)] overflow-y-auto">
                                                {corridasAtivas.map(c => {
                                                    const { coletas, entregas } = contarPontos(c);
                                                    // Buscar notas dos pontos (se dispon√≠vel)
                                                    const notas = c.notas_pontos || [];
                                                    // Verificar se tem ponto de retorno
                                                    const temRetorno = c.pontos?.some(p => p.is_retorno || p.tipo_ponto === 'retorno') || 
                                                                       (c.dados_pontos && JSON.parse(typeof c.dados_pontos === 'string' ? c.dados_pontos : JSON.stringify(c.dados_pontos || []))?.some(p => p.is_retorno));
                                                    return (
                                                        <div key={c.id} onClick={() => selecionarCorrida(c.id)} className={`p-3 rounded-lg border-2 cursor-pointer transition-all ${temRetorno ? 'border-orange-400 bg-orange-50' : corridaSelecionada === c.id ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-gray-200 hover:border-gray-300 hover:shadow'}`}>
                                                            <div className="flex items-center justify-between mb-2">
                                                                <div className="flex items-center gap-2 min-w-0 flex-1">
                                                                    {c.profissional_foto ? <img src={c.profissional_foto} className="w-8 h-8 rounded-full object-cover border-2 border-gray-200" /> : <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-sm">üèçÔ∏è</div>}
                                                                    <span className="font-medium text-sm text-gray-800 truncate">{c.profissional_nome || 'Aguardando...'}</span>
                                                                </div>
                                                                <span className="text-xs font-bold text-gray-600 whitespace-nowrap">OS #{c.tutts_os_numero || c.id}</span>
                                                            </div>
                                                            <div className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${statusCores[c.status]}`}><span>{statusIcons[c.status]}</span><span>{statusNomes[c.status]}</span></div>
                                                            {/* Alerta de retorno */}
                                                            {temRetorno && (
                                                                <div className="mt-2 group relative">
                                                                    <div className="flex items-center gap-1 px-2 py-1 bg-orange-100 border border-orange-300 rounded text-xs text-orange-700 font-medium">
                                                                        <span>‚ö†Ô∏è</span>
                                                                        <span>Aten√ß√£o: Corrida com retorno</span>
                                                                    </div>
                                                                    <div className="absolute bottom-full left-0 mb-1 hidden group-hover:block z-50">
                                                                        <div className="bg-gray-900 text-white text-xs rounded py-2 px-3 whitespace-nowrap shadow-lg">
                                                                            Caso o retorno seja indevido, solicite o<br/>cancelamento ao suporte Tutts.
                                                                        </div>
                                                                        <div className="w-2 h-2 bg-gray-900 transform rotate-45 absolute left-4 -bottom-1"></div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            <div className="flex items-center justify-between mt-2 text-xs text-gray-500">
                                                                <span>üì¶ {coletas} ‚Üí üìç {entregas}</span>
                                                                {c.tutts_valor && <span className="font-bold text-green-600">R$ {parseFloat(c.tutts_valor).toFixed(2)}</span>}
                                                            </div>
                                                            {c.primeiro_numero_nota && <div className="mt-2 text-xs text-green-600 font-medium">üè∑Ô∏è {c.primeiro_numero_nota}</div>}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="flex-1">
                                    {!corridaSelecionada ? (
                                        <div className="bg-white rounded-xl shadow p-8 text-center text-gray-400"><div className="text-6xl mb-4">üëà</div><div>Selecione uma corrida para ver detalhes</div></div>
                                    ) : !detalheCorrida ? (
                                        <div className="bg-white rounded-xl shadow p-8 text-center"><div className="text-2xl animate-pulse">‚è≥</div><div className="text-gray-500 mt-2">Carregando...</div></div>
                                    ) : (
                                        <div className="space-y-3">
                                            {/* Card compacto: OS + Profissional + Telefone + Nota + A√ß√µes */}
                                            <div className={`p-3 rounded-xl border ${statusCores[detalheCorrida.status]}`}>
                                                <div className="flex items-center gap-3">
                                                    {/* Foto */}
                                                    {detalheCorrida.profissional_foto ? (
                                                        <img src={detalheCorrida.profissional_foto} className="w-12 h-12 rounded-full object-cover border-2 border-white shadow flex-shrink-0" />
                                                    ) : (
                                                        <div className="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0 text-lg">üèçÔ∏è</div>
                                                    )}
                                                    
                                                    {/* Info */}
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex items-center gap-2 flex-wrap">
                                                            <span className="font-bold text-sm">OS #{detalheCorrida.tutts_os_numero || detalheCorrida.id}</span>
                                                            <span className={`text-xs px-2 py-0.5 rounded-full ${statusCores[detalheCorrida.status]}`}>{statusIcons[detalheCorrida.status]} {statusNomes[detalheCorrida.status]}</span>
                                                        </div>
                                                        <div className="text-sm font-medium text-gray-800 truncate">{detalheCorrida.profissional_nome || 'Aguardando profissional...'}</div>
                                                        <div className="flex items-center gap-3 text-xs text-gray-600 mt-1">
                                                            {detalheCorrida.profissional_telefone && (
                                                                <a href={`tel:${detalheCorrida.profissional_telefone}`} className="flex items-center gap-1 text-blue-600 hover:text-blue-800">
                                                                    üìû {detalheCorrida.profissional_telefone}
                                                                </a>
                                                            )}
                                                            {detalheCorrida.pontos?.[1]?.numero_nota && (
                                                                <span className="text-green-600">üè∑Ô∏è {detalheCorrida.pontos[1].numero_nota}</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Bot√µes de a√ß√£o no canto direito */}
                                                    <div className="flex flex-col gap-1 flex-shrink-0">
                                                        {detalheCorrida.tutts_url_rastreamento && (
                                                            <a href={detalheCorrida.tutts_url_rastreamento} target="_blank" className="px-2 py-1 bg-gray-700 text-white rounded text-xs hover:bg-gray-800 text-center">
                                                                üó∫Ô∏è Rastrear
                                                            </a>
                                                        )}
                                                        {!['finalizado', 'cancelado'].includes(detalheCorrida.status) && (
                                                            <button onClick={() => cancelarCorrida(detalheCorrida.id)} className="px-2 py-1 bg-red-100 text-red-600 rounded text-xs hover:bg-red-200">
                                                                ‚úï Cancelar
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                                {/* Alerta de retorno no detalhe */}
                                                {detalheCorrida.pontos?.some(p => p.is_retorno || p.tipo_ponto === 'retorno') && (
                                                    <div className="mt-2 group relative inline-block">
                                                        <div className="flex items-center gap-2 px-3 py-2 bg-orange-100 border border-orange-300 rounded-lg text-sm text-orange-700 font-medium cursor-help">
                                                            <span className="text-lg">‚ö†Ô∏è</span>
                                                            <span>Aten√ß√£o: Corrida com retorno</span>
                                                        </div>
                                                        <div className="absolute bottom-full left-0 mb-2 hidden group-hover:block z-50">
                                                            <div className="bg-gray-900 text-white text-xs rounded py-2 px-3 whitespace-nowrap shadow-lg">
                                                                Caso o retorno seja indevido, solicite o<br/>cancelamento ao suporte Tutts.
                                                            </div>
                                                            <div className="w-2 h-2 bg-gray-900 transform rotate-45 absolute left-4 -bottom-1"></div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* M√©tricas compactas */}
                                            <div className="grid grid-cols-4 gap-2">
                                                <div className="bg-white p-2 rounded-lg shadow text-center">
                                                    <div className="text-sm font-bold text-blue-600">{detalheCorrida.tutts_distancia || '-'} km</div>
                                                    <div className="text-xs text-gray-400">Dist.</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg shadow text-center">
                                                    <div className="text-sm font-bold text-blue-600">{detalheCorrida.tutts_duracao || '-'}</div>
                                                    <div className="text-xs text-gray-400">Tempo</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg shadow text-center">
                                                    <div className="text-sm font-bold text-green-600">{detalheCorrida.tutts_valor ? `R$ ${parseFloat(detalheCorrida.tutts_valor).toFixed(0)}` : '-'}</div>
                                                    <div className="text-xs text-gray-400">Valor</div>
                                                </div>
                                                <div className="bg-white p-2 rounded-lg shadow text-center">
                                                    <div className="text-sm font-bold text-purple-600">{detalheCorrida.pontos?.length || 0}</div>
                                                    <div className="text-xs text-gray-400">Pontos</div>
                                                </div>
                                            </div>
                                            
                                            <div className="flex flex-col md:flex-row gap-4">
                                                <div className="w-full md:w-80 bg-white p-4 rounded-xl shadow">
                                                    <div className="text-sm font-bold text-gray-700 mb-3">üìç Pontos da Rota</div>
                                                    <div className="space-y-3 max-h-80 overflow-y-auto">
                                                        {detalheCorrida.pontos?.map((p, idx) => {
                                                            const isColeta = idx === 0;
                                                            const status = p.status || 'pendente';
                                                            // Montar endere√ßo completo de forma inteligente
                                                            const partes = [p.rua, p.numero, p.bairro, p.cidade, p.uf].filter(x => x && x.trim());
                                                            const enderecoMontado = partes.length > 0 ? partes.join(', ') : null;
                                                            const enderecoFinal = p.endereco_completo || enderecoMontado || 'Endere√ßo n√£o informado';
                                                            
                                                            // Normalizar fotos para array
                                                            let fotosArray = [];
                                                            try {
                                                                if (typeof p.fotos === 'string' && p.fotos !== '' && p.fotos !== '[]') {
                                                                    fotosArray = JSON.parse(p.fotos);
                                                                } else if (Array.isArray(p.fotos)) {
                                                                    fotosArray = p.fotos;
                                                                }
                                                            } catch { fotosArray = []; }
                                                            
                                                            // Verificar se √© ponto de retorno
                                                            const isRetorno = p.is_retorno || p.tipo_ponto === 'retorno';
                                                            
                                                            // Cores espec√≠ficas para retorno
                                                            const corBorda = isRetorno ? 'border-orange-300 bg-orange-50' : statusPontoCores[status];
                                                            const corIcone = isRetorno ? 'bg-orange-500' : (status === 'finalizado' ? 'bg-green-500' : status === 'chegou' || status === 'coletado' ? 'bg-blue-500' : isColeta ? 'bg-amber-500' : 'bg-gray-400');
                                                            
                                                            return (
                                                                <div key={idx} className={`p-3 rounded-lg border-2 ${corBorda}`}>
                                                                    <div className="flex items-start gap-2">
                                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0 ${corIcone}`}>
                                                                            {isRetorno ? '‚Ü©Ô∏è' : (status === 'finalizado' ? '‚úì' : isColeta ? 'üì¶' : idx)}
                                                                        </div>
                                                                        <div className="flex-1 min-w-0">
                                                                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                                                <span className={`text-xs font-bold ${isRetorno ? 'text-orange-700' : isColeta ? 'text-amber-700' : 'text-blue-700'}`}>
                                                                                    {isRetorno ? '‚Ü©Ô∏è RETORNO' : isColeta ? 'üì¶ COLETA' : `üìç ENTREGA ${idx}`}
                                                                                </span>
                                                                                <span className={`text-xs px-1.5 py-0.5 rounded ${isRetorno ? 'bg-orange-100 text-orange-700' : statusPontoCores[status]}`}>
                                                                                    {statusPontoIcons[status]} {statusPontoNomes[status]}
                                                                                </span>
                                                                                {isRetorno && p.ponto_retorno_de && (
                                                                                    <span className="text-xs text-orange-600">(do ponto {p.ponto_retorno_de})</span>
                                                                                )}
                                                                            </div>
                                                                            <div className="text-xs text-gray-700 leading-relaxed">{enderecoFinal}</div>
                                                                            
                                                                            {/* Hor√°rio de finaliza√ß√£o - para coleta */}
                                                                            {isColeta && p.data_finalizado && (
                                                                                <div className="mt-1 text-xs text-green-600">‚úÖ Coletado: {formatarHora(p.data_finalizado)}</div>
                                                                            )}
                                                                            
                                                                            {/* N√∫mero da nota - s√≥ para entregas (n√£o retorno) */}
                                                                            {!isColeta && !isRetorno && p.numero_nota && <div className="text-xs text-green-600 mt-1 font-medium">üè∑Ô∏è Nota: {p.numero_nota}</div>}
                                                                            
                                                                            {/* Hor√°rios - para entregas e retornos */}
                                                                            {!isColeta && (p.data_chegada || p.data_finalizado || p.data_coletado) && (
                                                                                <div className="mt-2 pt-2 border-t border-gray-200 text-xs space-y-1">
                                                                                    {p.data_chegada && <div className="text-blue-600">üîµ Chegou: {formatarHora(p.data_chegada)}</div>}
                                                                                    {p.data_coletado && <div className="text-yellow-600">üü° Coletou: {formatarHora(p.data_coletado)}</div>}
                                                                                    {p.data_finalizado && <div className="text-green-600">‚úÖ Finalizado: {formatarHora(p.data_finalizado)}</div>}
                                                                                </div>
                                                                            )}
                                                                            
                                                                            {/* Motivo de finaliza√ß√£o - para entregas e retornos */}
                                                                            {!isColeta && p.motivo_finalizacao && (
                                                                                <div className={`mt-2 text-xs px-2 py-1 rounded ${
                                                                                    p.motivo_finalizacao.toLowerCase() === 'sucesso' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                                                                                }`}>
                                                                                    {p.motivo_finalizacao.toLowerCase() === 'sucesso' ? '‚úÖ' : '‚ö†Ô∏è'} {p.motivo_descricao || p.motivo_finalizacao}
                                                                                </div>
                                                                            )}
                                                                            
                                                                            {/* Fotos de protocolo - para entregas e retornos */}
                                                                            {!isColeta && fotosArray.length > 0 && (
                                                                                <div className="mt-2 text-xs">
                                                                                    <span className="text-blue-600 font-medium">üì∏ {fotosArray.length} foto(s):</span>
                                                                                    <div className="flex flex-wrap gap-1 mt-1">
                                                                                        {fotosArray.map((foto, fotoIdx) => (
                                                                                            <button 
                                                                                                key={fotoIdx}
                                                                                                onClick={() => abrirFotoModal(fotosArray, fotoIdx)}
                                                                                                className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                                                                                            >
                                                                                                Ver {fotoIdx + 1}
                                                                                            </button>
                                                                                        ))}
                                                                                    </div>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                                <div className="flex-1"><MapaLeaflet key={`acompanhar-${mapaKey}-${corridaSelecionada}`} id={`mapa-acompanhar-${corridaSelecionada}`} pontos={detalheCorrida.pontos} height="350px" tipo="acompanhar" /></div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* ========== ABA CONCLU√çDAS ========== */}
                    {abaAtiva === 'concluidas' && (
                        <div className="max-w-7xl mx-auto p-2 md:p-4">
                            <div className="bg-white rounded-xl shadow p-4">
                                <div className="flex items-center justify-between mb-4 flex-wrap gap-2">
                                    <h2 className="text-lg font-bold text-gray-800">‚úÖ Corridas Conclu√≠das</h2>
                                    <div className="flex gap-2 flex-wrap">
                                        <button 
                                            onClick={sincronizarHistorico} 
                                            disabled={sincronizandoHistorico}
                                            className={`px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 ${sincronizandoHistorico ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}`}
                                        >
                                            {sincronizandoHistorico ? (
                                                <><span className="animate-spin">‚è≥</span> Sincronizando...</>
                                            ) : (
                                                <>üîÑ Recuperar Dados</>
                                            )}
                                        </button>
                                        <select value={filtroConcluidas} onChange={(e) => setFiltroConcluidas(e.target.value)} className="px-3 py-1.5 border rounded-lg text-sm">
                                            <option value="todas">Todas</option>
                                            <option value="finalizadas">‚úÖ Finalizadas</option>
                                            <option value="canceladas">‚ùå Canceladas</option>
                                        </select>
                                        <button onClick={carregarConcluidas} className="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">üîÑ Atualizar</button>
                                    </div>
                                </div>
                                {corridasConcluidas.filter(c => filtroConcluidas === 'todas' || (filtroConcluidas === 'finalizadas' && c.status === 'finalizado') || (filtroConcluidas === 'canceladas' && c.status === 'cancelado')).length === 0 ? (
                                    <div className="text-center py-12 text-gray-400"><div className="text-5xl mb-3">üì≠</div><div>Nenhuma corrida {filtroConcluidas !== 'todas' ? filtroConcluidas : 'conclu√≠da'}</div></div>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-50"><tr><th className="px-2 py-2 text-center font-medium text-gray-600 w-10"></th><th className="px-2 py-2 text-center font-medium text-gray-600 w-12">Foto</th><th className="px-3 py-2 text-left font-medium text-gray-600">OS</th><th className="px-3 py-2 text-left font-medium text-gray-600">Nota</th><th className="px-3 py-2 text-left font-medium text-gray-600">Status</th><th className="px-3 py-2 text-left font-medium text-gray-600">Data</th><th className="px-3 py-2 text-left font-medium text-gray-600">Profissional</th><th className="px-3 py-2 text-center font-medium text-gray-600">Pontos</th><th className="px-3 py-2 text-left font-medium text-gray-600">Dist√¢ncia</th></tr></thead>
                                            <tbody className="divide-y">
                                                {corridasConcluidas.filter(c => filtroConcluidas === 'todas' || (filtroConcluidas === 'finalizadas' && c.status === 'finalizado') || (filtroConcluidas === 'canceladas' && c.status === 'cancelado')).map(c => {
                                                    // Verificar se tem retorno e extrair primeira nota
                                                    let temRetorno = false;
                                                    let primeiraNotaFiscal = null;
                                                    try {
                                                        const dadosPontos = c.dados_pontos ? (typeof c.dados_pontos === 'string' ? JSON.parse(c.dados_pontos) : c.dados_pontos) : [];
                                                        temRetorno = dadosPontos?.some(p => p.is_retorno || p.tipo_ponto === 'retorno');
                                                        // Pegar primeira nota fiscal (do primeiro ponto de entrega, √≠ndice 1+)
                                                        const pontosEntrega = dadosPontos?.slice(1) || [];
                                                        const pontoComNota = pontosEntrega.find(p => p.numero_nota && p.numero_nota.trim() !== '');
                                                        primeiraNotaFiscal = pontoComNota?.numero_nota || null;
                                                    } catch(e) {}
                                                    
                                                    return (
                                                        <React.Fragment key={c.id}>
                                                            <tr className={`hover:bg-gray-50 cursor-pointer ${temRetorno ? 'bg-orange-50 border-l-4 border-l-orange-400' : ''}`} onClick={() => toggleExpandirCorrida(c.id)}>
                                                                <td className="px-2 py-3 text-center">
                                                                    <div className={`w-7 h-7 rounded-lg flex items-center justify-center text-sm font-bold transition-all duration-200 ${corridaExpandida === c.id ? 'bg-blue-500 text-white shadow-md rotate-90' : 'bg-gradient-to-br from-gray-100 to-gray-200 text-gray-600 hover:from-blue-100 hover:to-blue-200 hover:text-blue-600 shadow'}`}>
                                                                        <span className={`transition-transform duration-200 ${corridaExpandida === c.id ? 'rotate-45' : ''}`}>+</span>
                                                                    </div>
                                                                </td>
                                                                <td className="px-2 py-3 text-center">
                                                                    {c.profissional_foto ? (
                                                                        <img src={c.profissional_foto} className="w-8 h-8 rounded-full object-cover border border-gray-200 mx-auto" alt="" />
                                                                    ) : (
                                                                        <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mx-auto text-sm">üèçÔ∏è</div>
                                                                    )}
                                                                </td>
                                                                <td className="px-3 py-3 font-medium">
                                                                    #{c.tutts_os_numero || c.id}
                                                                    {temRetorno && <span className="ml-2 text-orange-500" title="Corrida com retorno">‚ö†Ô∏è</span>}
                                                                </td>
                                                                <td className="px-3 py-3">
                                                                    {primeiraNotaFiscal ? (
                                                                        <span className="text-green-600 font-medium">üè∑Ô∏è {primeiraNotaFiscal}</span>
                                                                    ) : (
                                                                        <span className="text-gray-400">-</span>
                                                                    )}
                                                                </td>
                                                                <td className="px-3 py-3"><span className={`px-2 py-1 rounded-full text-xs font-medium ${c.status === 'finalizado' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{c.status === 'finalizado' ? '‚úÖ Finalizada' : '‚ùå Cancelada'}</span></td>
                                                                <td className="px-3 py-3 text-gray-600">{new Date(c.criado_em).toLocaleDateString('pt-BR')} {new Date(c.criado_em).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</td>
                                                                <td className="px-3 py-3">{c.profissional_nome || <span className="text-gray-400">-</span>}</td>
                                                                <td className="px-3 py-3 text-center">{c.total_pontos || '-'}</td>
                                                                <td className="px-3 py-3">{c.tutts_distancia ? `${c.tutts_distancia} km` : '-'}</td>
                                                            </tr>
                                                            {/* Linha expandida com detalhes */}
                                                            {corridaExpandida === c.id && (
                                                                <tr>
                                                                    <td colSpan="9" className="px-4 py-4 bg-gray-50">
                                                                        {!detalhesCorridaExpandida ? (
                                                                            <div className="text-center py-4"><span className="animate-pulse">‚è≥ Carregando detalhes...</span></div>
                                                                        ) : (
                                                                            <div className="space-y-4">
                                                                                {/* Cabe√ßalho com foto do profissional e info */}
                                                                                <div className="flex items-start gap-4 p-3 bg-white rounded-lg border">
                                                                                    {detalhesCorridaExpandida.profissional_foto ? (
                                                                                        <img src={detalhesCorridaExpandida.profissional_foto} className="w-16 h-16 rounded-full object-cover border-2 border-gray-200" />
                                                                                    ) : (
                                                                                        <div className="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-2xl">üèçÔ∏è</div>
                                                                                    )}
                                                                                    <div className="flex-1">
                                                                                        <div className="font-bold text-gray-800">{detalhesCorridaExpandida.profissional_nome || 'Sem profissional'}</div>
                                                                                        {detalhesCorridaExpandida.profissional_telefone && <div className="text-sm text-gray-600">üìû {detalhesCorridaExpandida.profissional_telefone}</div>}
                                                                                        <div className="flex gap-4 mt-2 text-xs text-gray-500">
                                                                                            <span>üìè {detalhesCorridaExpandida.tutts_distancia || '-'} km</span>
                                                                                            <span>üìç {detalhesCorridaExpandida.pontos?.length || 0} pontos</span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                
                                                                                {/* Alerta de retorno */}
                                                                                {detalhesCorridaExpandida.pontos?.some(p => p.is_retorno || p.tipo_ponto === 'retorno') && (
                                                                                    <div className="flex items-center gap-2 px-4 py-3 bg-orange-100 border border-orange-300 rounded-lg text-orange-700">
                                                                                        <span className="text-xl">‚ö†Ô∏è</span>
                                                                                        <div>
                                                                                            <div className="font-bold">Aten√ß√£o: Corrida com retorno</div>
                                                                                            <div className="text-sm">Caso o retorno seja indevido, solicite o cancelamento ao suporte Tutts.</div>
                                                                                        </div>
                                                                                    </div>
                                                                                )}
                                                                                
                                                                                {/* Lista de pontos */}
                                                                                <div className="space-y-2">
                                                                                    <div className="font-medium text-gray-700">üìç Pontos da corrida:</div>
                                                                                    {detalhesCorridaExpandida.pontos?.map((p, idx) => {
                                                                                        const isColeta = idx === 0;
                                                                                        const isRetorno = p.is_retorno || p.tipo_ponto === 'retorno';
                                                                                        
                                                                                        // Normalizar fotos
                                                                                        let fotosArray = [];
                                                                                        try {
                                                                                            if (typeof p.fotos === 'string' && p.fotos !== '' && p.fotos !== '[]') {
                                                                                                fotosArray = JSON.parse(p.fotos);
                                                                                            } else if (Array.isArray(p.fotos)) {
                                                                                                fotosArray = p.fotos;
                                                                                            }
                                                                                        } catch { fotosArray = []; }
                                                                                        
                                                                                        const endereco = p.endereco_completo || [p.rua, p.numero, p.bairro, p.cidade].filter(Boolean).join(', ') || 'Endere√ßo n√£o informado';
                                                                                        
                                                                                        return (
                                                                                            <div key={idx} className={`p-3 rounded-lg border-2 ${isRetorno ? 'border-orange-300 bg-orange-50' : isColeta ? 'border-amber-200 bg-amber-50' : 'border-gray-200 bg-white'}`}>
                                                                                                <div className="flex items-start gap-3">
                                                                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0 ${isRetorno ? 'bg-orange-500' : isColeta ? 'bg-amber-500' : 'bg-blue-500'}`}>
                                                                                                        {isRetorno ? '‚Ü©Ô∏è' : isColeta ? 'üì¶' : idx}
                                                                                                    </div>
                                                                                                    <div className="flex-1">
                                                                                                        <div className="flex items-center gap-2 flex-wrap">
                                                                                                            <span className={`text-xs font-bold ${isRetorno ? 'text-orange-700' : isColeta ? 'text-amber-700' : 'text-blue-700'}`}>
                                                                                                                {isRetorno ? '‚Ü©Ô∏è RETORNO' : isColeta ? 'üì¶ COLETA' : `üìç ENTREGA ${idx}`}
                                                                                                            </span>
                                                                                                            {isRetorno && p.ponto_retorno_de && (
                                                                                                                <span className="text-xs text-orange-600">(do ponto {p.ponto_retorno_de})</span>
                                                                                                            )}
                                                                                                            {p.numero_nota && <span className="text-xs text-green-600">üè∑Ô∏è {p.numero_nota}</span>}
                                                                                                        </div>
                                                                                                        <div className="text-sm text-gray-700 mt-1">{endereco}</div>
                                                                                                        
                                                                                                        {/* Observa√ß√£o */}
                                                                                                        {p.observacao && (
                                                                                                            <div className="mt-2 text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded">
                                                                                                                üí¨ {p.observacao}
                                                                                                            </div>
                                                                                                        )}
                                                                                                        
                                                                                                        {/* Motivo de finaliza√ß√£o */}
                                                                                                        {p.motivo_finalizacao && (
                                                                                                            <div className={`mt-2 text-xs px-2 py-1 rounded ${p.motivo_finalizacao.toLowerCase() === 'sucesso' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                                                                                {p.motivo_finalizacao.toLowerCase() === 'sucesso' ? '‚úÖ' : '‚ö†Ô∏è'} {p.motivo_descricao || p.motivo_finalizacao}
                                                                                                            </div>
                                                                                                        )}
                                                                                                        
                                                                                                        {/* Fotos de protocolo */}
                                                                                                        {fotosArray.length > 0 && (
                                                                                                            <div className="mt-2">
                                                                                                                <div className="text-xs text-gray-500 mb-1">üì∏ Fotos de protocolo:</div>
                                                                                                                <div className="flex gap-2 flex-wrap">
                                                                                                                    {fotosArray.map((foto, fIdx) => (
                                                                                                                        <img 
                                                                                                                            key={fIdx} 
                                                                                                                            src={foto} 
                                                                                                                            className="w-16 h-16 object-cover rounded cursor-pointer hover:opacity-80 border"
                                                                                                                            onClick={(e) => { e.stopPropagation(); abrirFotoModal(fotosArray, fIdx); }}
                                                                                                                        />
                                                                                                                    ))}
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        )}
                                                                                                        
                                                                                                        {/* Hor√°rios */}
                                                                                                        {(p.data_chegada || p.data_coletado || p.data_finalizado) && (
                                                                                                            <div className="mt-2 pt-2 border-t border-gray-200">
                                                                                                                <div className="text-xs text-gray-500 mb-1">‚è±Ô∏è Hor√°rios:</div>
                                                                                                                <div className="flex flex-wrap gap-3 text-xs">
                                                                                                                    {p.data_chegada && <span className="text-blue-600">üîµ Chegou: {new Date(p.data_chegada).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</span>}
                                                                                                                    {p.data_coletado && <span className="text-yellow-600">üü° Coletou: {new Date(p.data_coletado).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</span>}
                                                                                                                    {p.data_finalizado && <span className="text-green-600">‚úÖ Finalizado: {new Date(p.data_finalizado).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</span>}
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        )}
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        );
                                                                                    })}
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                    </td>
                                                                </tr>
                                                            )}
                                                        </React.Fragment>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                                {corridasConcluidas.length > 0 && (
                                    <div className="mt-4 pt-4 border-t grid grid-cols-3 gap-4">
                                        <div className="bg-green-50 p-3 rounded-lg text-center"><div className="text-2xl font-bold text-green-600">{corridasConcluidas.filter(c => c.status === 'finalizado').length}</div><div className="text-xs text-gray-600">Finalizadas</div></div>
                                        <div className="bg-red-50 p-3 rounded-lg text-center"><div className="text-2xl font-bold text-red-600">{corridasConcluidas.filter(c => c.status === 'cancelado').length}</div><div className="text-xs text-gray-600">Canceladas</div></div>
                                        <div className="bg-blue-50 p-3 rounded-lg text-center"><div className="text-2xl font-bold text-blue-600">{corridasConcluidas.filter(c => c.status === 'finalizado').reduce((acc, c) => acc + parseFloat(c.tutts_distancia || 0), 0).toFixed(1)} km</div><div className="text-xs text-gray-600">Total Dist√¢ncia</div></div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {/* Modal salvar endere√ßo */}
                    {modalSalvarEndereco.aberto && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => { setModalSalvarEndereco({ aberto: false, ponto: null }); setComplementoSalvar(''); }}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-4" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-4">
                                    <span className="font-bold text-green-700">üíæ Salvar Endere√ßo</span>
                                    <button onClick={() => { setModalSalvarEndereco({ aberto: false, ponto: null }); setComplementoSalvar(''); }} className="text-gray-400 hover:text-gray-600">‚úï</button>
                                </div>
                                
                                {/* Preview do endere√ßo */}
                                <div className="bg-gray-50 p-3 rounded-lg mb-4 text-sm">
                                    <div className="font-medium text-gray-700">{modalSalvarEndereco.ponto?.endereco_completo || `${modalSalvarEndereco.ponto?.rua}, ${modalSalvarEndereco.ponto?.numero}`}</div>
                                    {modalSalvarEndereco.ponto?.bairro && <div className="text-xs text-gray-500">{modalSalvarEndereco.ponto?.bairro}, {modalSalvarEndereco.ponto?.cidade}</div>}
                                </div>
                                
                                {/* Input do complemento */}
                                <div className="mb-3">
                                    <label className="text-xs text-gray-600 font-medium">üè† Complemento (opcional)</label>
                                    <input 
                                        type="text" 
                                        value={complementoSalvar} 
                                        onChange={(e) => setComplementoSalvar(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mt-1 focus:ring-2 focus:ring-green-400 outline-none" 
                                        placeholder="Quadra, Lote, Apto, Bloco..."
                                    />
                                </div>
                                
                                {/* Input do apelido */}
                                <div className="mb-4">
                                    <label className="text-xs text-gray-600 font-medium">‚≠ê Apelido (para buscar depois)</label>
                                    <input 
                                        type="text" 
                                        value={apelidoSalvar} 
                                        onChange={(e) => setApelidoSalvar(e.target.value)}
                                        onKeyPress={(e) => { if (e.key === 'Enter') salvarEndereco(); }}
                                        className="w-full px-3 py-2 border border-green-300 rounded-lg text-sm mt-1 focus:ring-2 focus:ring-green-400 outline-none" 
                                        placeholder="Ex: Loja Centro, CD Principal, Cliente X..."
                                        autoFocus
                                    />
                                    <div className="text-xs text-gray-400 mt-1">üí° Use um nome f√°cil de lembrar</div>
                                </div>
                                
                                <div className="flex gap-2">
                                    <button onClick={() => { setModalSalvarEndereco({ aberto: false, ponto: null }); setComplementoSalvar(''); }} className="flex-1 py-2 border rounded-lg text-sm hover:bg-gray-50">Cancelar</button>
                                    <button onClick={salvarEndereco} disabled={salvandoEndereco || !apelidoSalvar.trim()} className="flex-1 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 disabled:opacity-50">
                                        {salvandoEndereco ? '...' : 'üíæ Salvar'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal edi√ß√£o de ponto */}
                    {pontoEditando !== null && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setPontoEditando(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-4" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-4">
                                    <span className="font-bold">‚úèÔ∏è Editar Ponto {pontoEditando + 1}</span>
                                    <button onClick={() => setPontoEditando(null)} className="text-gray-400 hover:text-gray-600">‚úï</button>
                                </div>
                                <div className="space-y-3">
                                    {/* Campo N√∫mero Nota - Destaque */}
                                    <div className="bg-green-50 p-3 rounded-lg border border-green-200">
                                        <label className="text-xs text-green-700 font-medium">üè∑Ô∏è N√∫mero da Nota/Pedido</label>
                                        <input 
                                            type="text" 
                                            value={dadosPonto.numero_nota} 
                                            onChange={(e) => setDadosPonto({...dadosPonto, numero_nota: e.target.value})} 
                                            className="w-full px-3 py-2 border border-green-300 rounded text-sm mt-1 focus:ring-2 focus:ring-green-400 outline-none" 
                                            placeholder="Ex: NF-12345, PED-0001..."
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="text-xs text-gray-600">üìù Observa√ß√£o</label>
                                        <textarea value={dadosPonto.observacao} onChange={(e) => setDadosPonto({...dadosPonto, observacao: e.target.value})} className="w-full px-3 py-2 border rounded text-sm" rows="2" placeholder="Instru√ß√µes para o motoboy..." />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-600">üè† Complemento</label>
                                        <input type="text" value={dadosPonto.complemento} onChange={(e) => setDadosPonto({...dadosPonto, complemento: e.target.value})} className="w-full px-3 py-2 border rounded text-sm" placeholder="Quadra, Lote, Apto, Bloco..." />
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs text-gray-600">üìû Telefone</label>
                                            <input type="text" value={dadosPonto.telefone} onChange={(e) => setDadosPonto({...dadosPonto, telefone: e.target.value})} className="w-full px-3 py-2 border rounded text-sm" placeholder="(62) 99999-9999" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">üë§ Procurar por</label>
                                            <input type="text" value={dadosPonto.procurar_por} onChange={(e) => setDadosPonto({...dadosPonto, procurar_por: e.target.value})} className="w-full px-3 py-2 border rounded text-sm" placeholder="Nome do respons√°vel" />
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setPontoEditando(null)} className="flex-1 py-2 border rounded-lg text-sm hover:bg-gray-50">Cancelar</button>
                                    <button onClick={salvarEdicaoPonto} className="flex-1 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">üíæ Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* ============ NOVO: Modal de Ajuste de Mapa ============ */}
                    {modalAjusteMapa.aberto && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-2 md:p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[95vh] overflow-hidden flex flex-col">
                                <div className="bg-blue-900 text-white px-4 py-3 flex items-center justify-between flex-shrink-0">
                                    <div className="flex items-center gap-2">
                                        <span className="text-xl">üéØ</span>
                                        <div>
                                            <span className="font-bold">Ajustar Posi√ß√£o no Mapa</span>
                                            <div className="text-xs text-blue-200">{modalAjusteMapa.etapa === 'ajustar' ? 'Arraste o pino ou clique no mapa' : 'Confirme o endere√ßo'}</div>
                                        </div>
                                    </div>
                                    <button onClick={fecharModalAjusteMapa} className="text-white/70 hover:text-white text-xl">‚úï</button>
                                </div>
                                
                                <div className="flex-1 overflow-hidden flex flex-col">
                                    {modalAjusteMapa.etapa === 'ajustar' ? (
                                        <>
                                            <div className="px-4 py-2 bg-gray-50 border-b flex-shrink-0">
                                                <div className="text-xs text-gray-500">Endere√ßo buscado:</div>
                                                <div className="text-sm font-medium text-gray-700 truncate">üìç {modalAjusteMapa.sugestaoOriginal?.endereco}</div>
                                            </div>
                                            
                                            <div className="px-4 py-2 bg-blue-50 border-b flex-shrink-0">
                                                <div className="flex items-center gap-2 text-sm text-blue-700">
                                                    <span className="text-lg">üëÜ</span>
                                                    <div><strong>Arraste o pino vermelho</strong> para a posi√ß√£o exata ou <strong>clique no mapa</strong></div>
                                                </div>
                                            </div>
                                            
                                            <div className="flex-1 min-h-[300px]">
                                                <MapaAjustavel 
                                                    latitude={posicaoAjustada.lat || modalAjusteMapa.latitude}
                                                    longitude={posicaoAjustada.lng || modalAjusteMapa.longitude}
                                                    onPosicaoMudou={onPosicaoMudou}
                                                    zoom={17}
                                                />
                                            </div>
                                            
                                            <div className="px-4 py-2 bg-gray-50 border-t flex-shrink-0">
                                                <div className="flex items-center justify-between text-xs text-gray-500">
                                                    <span>Coordenadas:</span>
                                                    <span className="font-mono">{posicaoAjustada.lat?.toFixed(6)}, {posicaoAjustada.lng?.toFixed(6)}</span>
                                                </div>
                                            </div>
                                            
                                            <div className="p-4 border-t flex gap-2 flex-shrink-0">
                                                <button onClick={fecharModalAjusteMapa} className="flex-1 py-2.5 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium text-sm">Cancelar</button>
                                                <button onClick={confirmarPosicaoMapa} disabled={buscandoEnderecoReverso} className="flex-1 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm disabled:opacity-50">{buscandoEnderecoReverso ? '‚è≥ Buscando...' : '‚úì Confirmar Posi√ß√£o'}</button>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div className="p-4 space-y-4 overflow-y-auto">
                                                <div className="bg-gray-50 rounded-lg p-3">
                                                    <div className="text-xs text-gray-500 mb-1">Endere√ßo original buscado:</div>
                                                    <div className="text-sm text-gray-600">üìç {modalAjusteMapa.sugestaoOriginal?.endereco}</div>
                                                </div>
                                                
                                                <div className="flex justify-center"><div className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xl">‚Üì</div></div>
                                                
                                                <div className="bg-green-50 rounded-lg p-3 border-2 border-green-200">
                                                    <div className="text-xs text-green-600 mb-1 font-medium">‚úÖ Novo endere√ßo (posi√ß√£o ajustada):</div>
                                                    <div className="text-sm font-medium text-gray-800">üéØ {enderecoAjustado?.endereco}</div>
                                                    <div className="mt-2 text-xs text-gray-500 font-mono">Coordenadas: {posicaoAjustada.lat?.toFixed(6)}, {posicaoAjustada.lng?.toFixed(6)}</div>
                                                </div>
                                                
                                                {enderecoAjustado && (
                                                    <div className="bg-blue-50 rounded-lg p-3">
                                                        <div className="text-xs text-blue-600 mb-2 font-medium">üìã Detalhes:</div>
                                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                                            {enderecoAjustado.componentes?.find(c => c.types?.includes('route')) && <div><span className="text-gray-500">Rua:</span> <span className="font-medium">{enderecoAjustado.componentes.find(c => c.types?.includes('route'))?.long_name}</span></div>}
                                                            {enderecoAjustado.componentes?.find(c => c.types?.includes('street_number')) && <div><span className="text-gray-500">N¬∫:</span> <span className="font-medium">{enderecoAjustado.componentes.find(c => c.types?.includes('street_number'))?.long_name}</span></div>}
                                                            {enderecoAjustado.componentes?.find(c => c.types?.includes('sublocality_level_1') || c.types?.includes('sublocality')) && <div><span className="text-gray-500">Bairro:</span> <span className="font-medium">{enderecoAjustado.componentes.find(c => c.types?.includes('sublocality_level_1') || c.types?.includes('sublocality'))?.long_name}</span></div>}
                                                            {enderecoAjustado.componentes?.find(c => c.types?.includes('administrative_area_level_2') || c.types?.includes('locality')) && <div><span className="text-gray-500">Cidade:</span> <span className="font-medium">{enderecoAjustado.componentes.find(c => c.types?.includes('administrative_area_level_2') || c.types?.includes('locality'))?.long_name}</span></div>}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <div className="p-4 border-t flex gap-2 flex-shrink-0">
                                                <button onClick={voltarParaAjustar} className="flex-1 py-2.5 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium text-sm">‚Ü©Ô∏è Ajustar</button>
                                                <button onClick={usarEnderecoAjustado} className="flex-1 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm">‚úì Usar</button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal hist√≥rico */}
                    {mostrarHistorico && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setMostrarHistorico(false)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[80vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="bg-blue-900 text-white px-4 py-3 flex items-center justify-between"><span className="font-bold">üìã Hist√≥rico</span><button onClick={() => setMostrarHistorico(false)} className="text-white/70 hover:text-white">‚úï</button></div>
                                <div className="p-4 overflow-y-auto max-h-[65vh]">
                                    {historico.length === 0 ? <p className="text-center text-gray-500 py-8">Nenhuma solicita√ß√£o</p> : (
                                        <div className="space-y-2">
                                            {historico.map(h => (
                                                <div key={h.id} className="p-3 border rounded-lg hover:bg-gray-50">
                                                    <div className="flex items-center justify-between">
                                                        <div>
                                                            <div className="flex items-center gap-2">
                                                                <span className={`px-2 py-0.5 rounded text-xs font-medium ${statusCores[h.status]}`}>{statusIcons[h.status]} {statusNomes[h.status]}</span>
                                                                {h.tutts_os_numero && <span className="text-sm font-medium">OS #{h.tutts_os_numero}</span>}
                                                            </div>
                                                            <div className="text-xs text-gray-500 mt-1">{formatarData(h.criado_em)} ‚Ä¢ {h.total_pontos} pts{h.profissional_nome && ` ‚Ä¢ üèçÔ∏è ${h.profissional_nome}`}</div>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            {h.tutts_valor && <div className="text-sm font-bold text-green-600">R$ {parseFloat(h.tutts_valor).toFixed(2)}</div>}
                                                            {h.tutts_os_numero && <button onClick={() => copiarLinkRastreio(h.tutts_os_numero)} className="text-xs text-blue-600 hover:text-blue-800">üìã</button>}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal de fotos com zoom */}
                    {fotoModal.aberto && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center foto-modal" onClick={fecharFotoModal}>
                            <div className="relative w-full h-full flex items-center justify-center p-4" onClick={e => e.stopPropagation()}>
                                {/* Bot√£o fechar */}
                                <button onClick={fecharFotoModal} className="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 z-10">‚úï</button>
                                
                                {/* Contador */}
                                <div className="absolute top-4 left-4 text-white text-sm bg-black/50 px-3 py-1 rounded-full">
                                    {fotoModal.indice + 1} / {fotoModal.fotos.length}
                                </div>
                                
                                {/* Bot√£o anterior */}
                                {fotoModal.indice > 0 && (
                                    <button onClick={() => navegarFoto(-1)} className="absolute left-4 text-white text-5xl hover:text-gray-300">‚Äπ</button>
                                )}
                                
                                {/* Imagem */}
                                <img 
                                    src={typeof fotoModal.fotos[fotoModal.indice] === 'string' ? fotoModal.fotos[fotoModal.indice] : fotoModal.fotos[fotoModal.indice]?.url || fotoModal.fotos[fotoModal.indice]?.link}
                                    className="max-w-full max-h-full object-contain rounded-lg shadow-2xl"
                                    alt={`Foto ${fotoModal.indice + 1}`}
                                    onClick={e => e.stopPropagation()}
                                />
                                
                                {/* Bot√£o pr√≥ximo */}
                                {fotoModal.indice < fotoModal.fotos.length - 1 && (
                                    <button onClick={() => navegarFoto(1)} className="absolute right-4 text-white text-5xl hover:text-gray-300">‚Ä∫</button>
                                )}
                                
                                {/* Thumbnails */}
                                {fotoModal.fotos.length > 1 && (
                                    <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2">
                                        {fotoModal.fotos.map((foto, idx) => (
                                            <button 
                                                key={idx} 
                                                onClick={() => setFotoModal(prev => ({ ...prev, indice: idx }))}
                                                className={`w-12 h-12 rounded overflow-hidden border-2 ${idx === fotoModal.indice ? 'border-white' : 'border-transparent opacity-60 hover:opacity-100'}`}
                                            >
                                                <img 
                                                    src={typeof foto === 'string' ? foto : foto?.url || foto?.link} 
                                                    className="w-full h-full object-cover"
                                                    alt={`Thumb ${idx + 1}`}
                                                />
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        const App = () => {
            const [cliente, setCliente] = useState(null);
            const [token, setToken] = useState(null);
            const [toast, setToast] = useState(null);
            const [verificando, setVerificando] = useState(true);
            const showToast = (msg, tipo = 'info') => setToast({ mensagem: msg, tipo });
            
            useEffect(() => {
                const verificar = async () => {
                    const t = localStorage.getItem('solicitacao_token');
                    const c = localStorage.getItem('solicitacao_cliente');
                    if (t && c) { try { const r = await fetch(`${API_URL}/api/solicitacao/verificar`, { headers: { 'Authorization': `Bearer ${t}` } }); if (r.ok) { const d = await r.json(); setToken(t); setCliente(d.cliente); } else { localStorage.removeItem('solicitacao_token'); localStorage.removeItem('solicitacao_cliente'); } } catch {} }
                    setVerificando(false);
                };
                verificar();
            }, []);
            
            if (verificando) return <div className="min-h-screen bg-blue-100 flex items-center justify-center"><div className="text-center"><div className="text-4xl mb-4">üèçÔ∏è</div><p>Carregando...</p></div></div>;
            return (<>{toast && <Toast mensagem={toast.mensagem} tipo={toast.tipo} onClose={() => setToast(null)} />}{cliente && token ? <Solicitacao cliente={cliente} token={token} onLogout={() => { localStorage.removeItem('solicitacao_token'); localStorage.removeItem('solicitacao_cliente'); setCliente(null); setToken(null); }} showToast={showToast} /> : <TelaLogin onLogin={(c, t) => { setCliente(c); setToken(t); }} showToast={showToast} />}</>);
        };
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
