<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutts Roteirizador</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e1b4b 0%, #4c1d95 50%, #7c3aed 100%); }
        .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // ==================== CONFIGURA√á√ÉO ====================
        const API_URL = 'https://tutts-backend-production.up.railway.app';
        const ORS_API_KEY = '5b3ce3597851110001cf62489923ef7b12aa4be8a1f63a02f94ed073';
        
        // ==================== COMPONENTE TOAST ====================
        const Toast = ({ mensagem, tipo, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, []);
            
            const cores = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            return (
                <div className={`fixed top-4 right-4 ${cores[tipo]} text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in`}>
                    {mensagem}
                </div>
            );
        };
        
        // ==================== TELA DE LOGIN ====================
        const TelaLogin = ({ onLogin, showToast }) => {
            const [email, setEmail] = useState('');
            const [senha, setSenha] = useState('');
            const [loading, setLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!email || !senha) {
                    showToast('Preencha email e senha', 'error');
                    return;
                }
                
                setLoading(true);
                try {
                    const resp = await fetch(`${API_URL}/api/roteirizador/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, senha })
                    });
                    
                    const data = await resp.json();
                    
                    if (resp.ok) {
                        localStorage.setItem('roteirizador_token', data.token);
                        localStorage.setItem('roteirizador_usuario', JSON.stringify(data.usuario));
                        showToast('Bem-vindo, ' + data.usuario.nome + '!', 'success');
                        onLogin(data.usuario, data.token);
                    } else {
                        showToast(data.error || 'Erro ao fazer login', 'error');
                    }
                } catch (err) {
                    showToast('Erro de conex√£o', 'error');
                }
                setLoading(false);
            };
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div className="text-center mb-6">
                            <img 
                                src="https://github.com/Leonardodevcloud/tutts-frontend/blob/main/logoroteirzador.png?raw=true"
                                alt="Logo Roteirizador Tutts"
                                className="w-48 mx-auto mb-2"
                                style={{ background: 'transparent' }}
                            />
                            <h1 className="text-2xl font-bold text-gray-800">Roteirizador Tutts</h1>
                            <p className="text-gray-500 text-sm">Otimize suas rotas de entrega</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                                <input 
                                    type="email" 
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-all"
                                    placeholder="seu@email.com"
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">Senha</label>
                                <input 
                                    type="password" 
                                    value={senha}
                                    onChange={(e) => setSenha(e.target.value)}
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-all"
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                />
                            </div>
                            
                            <button 
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 bg-purple-900 hover:bg-purple-800 text-white font-bold rounded-lg transition-all disabled:opacity-50"
                            >
                                {loading ? 'Entrando...' : 'Entrar'}
                            </button>
                        </form>
                        
                        <div className="mt-6 pt-4 border-t border-gray-200">
                            <p className="text-center text-gray-500 text-sm">
                                N√£o tem acesso? Entre em contato com o administrador.
                            </p>
                        </div>
                        
                        <p className="text-center text-gray-400 text-xs mt-6">
                            ¬© 2025 Tutts - Sistema de Entregas
                        </p>
                    </div>
                </div>
            );
        };
        
        // ==================== COMPONENTE PRINCIPAL DO ROTEIRIZADOR ====================
        const Roteirizador = ({ usuario, token, onLogout, showToast }) => {
            const [enderecos, setEnderecos] = useState([]);
            const [termoBusca, setTermoBusca] = useState('');
            const [sugestoes, setSugestoes] = useState([]);
            const [buscando, setBuscando] = useState(false);
            const [loading, setLoading] = useState(false);
            const [resultado, setResultado] = useState(null);
            const [rotasGeradas, setRotasGeradas] = useState([]);
            const [modoMultiplas, setModoMultiplas] = useState(false);
            const [paradasPorRota, setParadasPorRota] = useState(3);
            const [modoAgrupamento, setModoAgrupamento] = useState('hibrido');
            const [retornarInicio, setRetornarInicio] = useState(false);
            const [mapa, setMapa] = useState(null);
            const [markersLayer, setMarkersLayer] = useState(null);
            const [routeLayer, setRouteLayer] = useState(null);
            const [historico, setHistorico] = useState([]);
            const [mostrarHistorico, setMostrarHistorico] = useState(false);
            const [favoritos, setFavoritos] = useState([]);
            const [partidaPadrao, setPartidaPadrao] = useState(null);
            const [mostrarConfigPartida, setMostrarConfigPartida] = useState(false);
            
            const coresRotas = ['#e11d48', '#2563eb', '#16a34a', '#d97706', '#7c3aed', '#0891b2', '#be185d', '#65a30d'];
            
            // Carregar partida padr√£o do localStorage ao iniciar
            useEffect(() => {
                try {
                    const salvo = localStorage.getItem(`roteirizador_partida_${usuario.id}`);
                    if (salvo) {
                        const partida = JSON.parse(salvo);
                        setPartidaPadrao(partida);
                        setEnderecos([{ ...partida, id: Date.now() }]);
                    }
                } catch(e) {
                    console.error('Erro ao carregar partida padr√£o:', e);
                }
            }, [usuario.id]);
            
            // Salvar partida padr√£o
            const salvarPartidaPadrao = (endereco) => {
                const partida = {
                    endereco: endereco.endereco,
                    latitude: endereco.latitude,
                    longitude: endereco.longitude
                };
                localStorage.setItem(`roteirizador_partida_${usuario.id}`, JSON.stringify(partida));
                setPartidaPadrao(partida);
                showToast('‚úÖ Partida padr√£o salva!', 'success');
                setMostrarConfigPartida(false);
            };
            
            // Remover partida padr√£o
            const removerPartidaPadrao = () => {
                localStorage.removeItem(`roteirizador_partida_${usuario.id}`);
                setPartidaPadrao(null);
                showToast('Partida padr√£o removida', 'info');
                setMostrarConfigPartida(false);
            };
            
            // Inicializar mapa
            useEffect(() => {
                if (typeof L !== 'undefined' && !mapa) {
                    const container = document.getElementById('mapa');
                    if (container) {
                        const mapInstance = L.map('mapa').setView([-16.6869, -49.2648], 12);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                            attribution: '¬© OpenStreetMap' 
                        }).addTo(mapInstance);
                        setMapa(mapInstance);
                        setMarkersLayer(L.layerGroup().addTo(mapInstance));
                    }
                }
            }, []);
            
            // Carregar hist√≥rico e favoritos
            useEffect(() => {
                carregarHistorico();
                carregarFavoritos();
            }, []);
            
            const carregarHistorico = async () => {
                try {
                    const resp = await fetch(`${API_URL}/api/roteirizador/rotas?limite=10`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        setHistorico(data.rotas || []);
                    }
                } catch (err) {
                    console.error('Erro ao carregar hist√≥rico:', err);
                }
            };
            
            const carregarFavoritos = async () => {
                try {
                    const resp = await fetch(`${API_URL}/api/roteirizador/favoritos`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        setFavoritos(data || []);
                    }
                } catch (err) {
                    console.error('Erro ao carregar favoritos:', err);
                }
            };
            
            // Buscar endere√ßo via Google (usando proxy do backend)
            const buscarEndereco = async () => {
                if (!termoBusca || termoBusca.length < 3) {
                    showToast('Digite pelo menos 3 caracteres', 'warning');
                    return;
                }
                
                setBuscando(true);
                try {
                    const resp = await fetch(`${API_URL}/api/geocode/google?endereco=${encodeURIComponent(termoBusca)}`);
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data.results && data.results.length > 0) {
                            setSugestoes(data.results);
                        } else {
                            showToast('Nenhum endere√ßo encontrado', 'warning');
                        }
                    } else {
                        showToast('Erro ao buscar endere√ßo', 'error');
                    }
                } catch (err) {
                    showToast('Erro ao buscar endere√ßo', 'error');
                }
                setBuscando(false);
            };
            
            const adicionarEndereco = (sug) => {
                if (enderecos.length >= 20) {
                    showToast('M√°ximo 20 endere√ßos', 'error');
                    return;
                }
                
                if (enderecos.some(e => e.endereco === sug.endereco)) {
                    showToast('Endere√ßo j√° adicionado', 'warning');
                    return;
                }
                
                setEnderecos([...enderecos, {
                    id: Date.now(),
                    endereco: sug.endereco,
                    latitude: sug.latitude,
                    longitude: sug.longitude
                }]);
                
                setTermoBusca('');
                setSugestoes([]);
                showToast('‚úÖ Adicionado', 'success');
                
                // Salvar como favorito
                fetch(`${API_URL}/api/roteirizador/favoritos`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({
                        endereco: sug.endereco,
                        latitude: sug.latitude,
                        longitude: sug.longitude
                    })
                }).catch(() => {});
            };
            
            const removerEndereco = (id) => {
                setEnderecos(enderecos.filter(e => e.id !== id));
            };
            
            const moverEndereco = (idx, dir) => {
                const lista = [...enderecos];
                const novoIdx = idx + dir;
                if (novoIdx < 0 || novoIdx >= lista.length) return;
                [lista[idx], lista[novoIdx]] = [lista[novoIdx], lista[idx]];
                setEnderecos(lista);
            };
            
            // Atualizar marcadores no mapa
            useEffect(() => {
                if (!mapa || !markersLayer) return;
                
                markersLayer.clearLayers();
                if (routeLayer) {
                    mapa.removeLayer(routeLayer);
                    setRouteLayer(null);
                }
                
                enderecos.forEach((e, idx) => {
                    const icon = L.divIcon({
                        className: '',
                        html: `<div style="background:${idx === 0 ? '#10b981' : '#7c3aed'};color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.3)">${idx === 0 ? 'üö©' : idx}</div>`,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    });
                    L.marker([e.latitude, e.longitude], { icon })
                        .addTo(markersLayer)
                        .bindPopup(`<b>${idx === 0 ? 'PARTIDA' : 'Parada ' + idx}</b><br>${e.endereco.substring(0, 50)}`);
                });
                
                if (enderecos.length > 0) {
                    const bounds = L.latLngBounds(enderecos.map(e => [e.latitude, e.longitude]));
                    mapa.fitBounds(bounds, { padding: [50, 50] });
                }
            }, [enderecos, mapa, markersLayer]);
            
            // Fun√ß√µes de c√°lculo (simplificadas - mesma l√≥gica do app.js)
            const calcularDistancia = (lat1, lon1, lat2, lon2) => {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            };
            
            const calcularAngulo = (partida, ponto) => {
                const dLat = ponto.latitude - partida.latitude;
                const dLon = ponto.longitude - partida.longitude;
                let angulo = Math.atan2(dLon, dLat) * 180 / Math.PI;
                if (angulo < 0) angulo += 360;
                return angulo;
            };
            
            const obterDirecao = (angulo) => {
                if (angulo < 22.5 || angulo >= 337.5) return 'Norte';
                if (angulo < 67.5) return 'Nordeste';
                if (angulo < 112.5) return 'Leste';
                if (angulo < 157.5) return 'Sudeste';
                if (angulo < 202.5) return 'Sul';
                if (angulo < 247.5) return 'Sudoeste';
                if (angulo < 292.5) return 'Oeste';
                return 'Noroeste';
            };
            
            // Otimizar rota via backend (proxy para ORS - evita CORS)
            const otimizarRota = async (pontos) => {
                const vehicle = { 
                    id: 1, 
                    profile: 'driving-car', 
                    start: [pontos[0].longitude, pontos[0].latitude] 
                };
                if (retornarInicio) {
                    vehicle.end = [pontos[0].longitude, pontos[0].latitude];
                }
                
                const resp = await fetch(`${API_URL}/api/roteirizador/otimizar`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        jobs: pontos.slice(1).map((p, i) => ({ 
                            id: i + 1, 
                            location: [p.longitude, p.latitude] 
                        })),
                        vehicles: [vehicle]
                    })
                });
                
                if (!resp.ok) throw new Error('Erro na otimiza√ß√£o');
                return resp.json();
            };
            
            const obterGeometria = async (pontos) => {
                const resp = await fetch(`${API_URL}/api/roteirizador/direcoes`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        coordinates: pontos.map(p => [p.longitude, p.latitude])
                    })
                });
                return resp.ok ? resp.json() : null;
            };
            
            // Roteirizar (rota √∫nica)
            const roteirizar = async () => {
                if (enderecos.length < 2) {
                    showToast('Adicione pelo menos 2 endere√ßos', 'error');
                    return;
                }
                
                setLoading(true);
                setResultado(null);
                setRotasGeradas([]);
                
                try {
                    const otimizacao = await otimizarRota(enderecos);
                    const ordem = [enderecos[0]];
                    
                    if (otimizacao.routes && otimizacao.routes[0]) {
                        otimizacao.routes[0].steps
                            .filter(s => s.type === 'job')
                            .forEach(s => ordem.push(enderecos[s.job]));
                    }
                    
                    if (retornarInicio) {
                        ordem.push({ ...enderecos[0], isRetorno: true });
                    }
                    
                    const geo = await obterGeometria(ordem);
                    let km = 0, min = 0;
                    
                    if (geo?.features?.[0]?.properties?.segments) {
                        geo.features[0].properties.segments.forEach(s => {
                            km += s.distance || 0;
                            min += s.duration || 0;
                        });
                    }
                    
                    setResultado({
                        ordem,
                        km: (km / 1000).toFixed(1),
                        min: Math.round(min / 60),
                        geo
                    });
                    
                    // Atualizar mapa
                    atualizarMapaRota(ordem, geo, '#7c3aed');
                    
                    // Salvar no hist√≥rico
                    salvarHistorico([{ pontos: ordem, distanciaKm: (km/1000).toFixed(1), tempoMin: Math.round(min/60) }], km, min);
                    
                    showToast('Rota otimizada!', 'success');
                } catch (err) {
                    showToast('Erro ao otimizar: ' + err.message, 'error');
                }
                
                setLoading(false);
            };
            
            // Agrupar endere√ßos
            const agruparEnderecos = (partida, pontos, numGrupos) => {
                if (pontos.length <= numGrupos) {
                    return pontos.map(p => [p]);
                }
                
                // Calcular √¢ngulo de cada ponto
                const pontosComAngulo = pontos.map(p => ({
                    ponto: p,
                    angulo: calcularAngulo(partida, p)
                })).sort((a, b) => a.angulo - b.angulo);
                
                // Distribuir em grupos
                const tamanhoBase = Math.floor(pontos.length / numGrupos);
                const extras = pontos.length % numGrupos;
                const grupos = [];
                let idx = 0;
                
                for (let i = 0; i < numGrupos; i++) {
                    const tamanho = tamanhoBase + (i < extras ? 1 : 0);
                    const grupo = [];
                    for (let j = 0; j < tamanho && idx < pontosComAngulo.length; j++) {
                        grupo.push(pontosComAngulo[idx].ponto);
                        idx++;
                    }
                    if (grupo.length > 0) grupos.push(grupo);
                }
                
                return grupos;
            };
            
            // Gerar m√∫ltiplas rotas
            const gerarMultiplasRotas = async () => {
                if (enderecos.length < 3) {
                    showToast('Adicione pelo menos 3 endere√ßos', 'error');
                    return;
                }
                
                setLoading(true);
                setResultado(null);
                setRotasGeradas([]);
                
                try {
                    const partida = enderecos[0];
                    const pontosEntrega = enderecos.slice(1);
                    const numGrupos = Math.ceil(pontosEntrega.length / paradasPorRota);
                    const grupos = agruparEnderecos(partida, pontosEntrega, numGrupos);
                    
                    const rotas = [];
                    let totalKm = 0, totalMin = 0;
                    
                    for (let i = 0; i < grupos.length; i++) {
                        const grupo = grupos[i];
                        showToast(`Otimizando rota ${i+1}/${grupos.length}...`, 'info');
                        
                        try {
                            const pontosRota = [partida, ...grupo];
                            const otimizacao = await otimizarRota(pontosRota);
                            const ordem = [pontosRota[0]];
                            
                            if (otimizacao.routes?.[0]) {
                                otimizacao.routes[0].steps
                                    .filter(s => s.type === 'job')
                                    .forEach(s => ordem.push(pontosRota[s.job]));
                            }
                            
                            if (retornarInicio) {
                                ordem.push({ ...pontosRota[0], isRetorno: true });
                            }
                            
                            const geo = await obterGeometria(ordem);
                            let km = 0, min = 0;
                            
                            if (geo?.features?.[0]?.properties?.segments) {
                                geo.features[0].properties.segments.forEach(s => {
                                    km += s.distance || 0;
                                    min += s.duration || 0;
                                });
                            }
                            
                            const anguloMedio = grupo.reduce((acc, p) => acc + calcularAngulo(partida, p), 0) / grupo.length;
                            
                            rotas.push({
                                id: i + 1,
                                cor: coresRotas[i % coresRotas.length],
                                pontos: ordem,
                                km: (km / 1000).toFixed(1),
                                min: Math.round(min / 60),
                                geo,
                                numParadas: grupo.length,
                                direcao: obterDirecao(anguloMedio)
                            });
                            
                            totalKm += km;
                            totalMin += min;
                        } catch (err) {
                            console.error('Erro na rota', i+1, err);
                        }
                        
                        await new Promise(r => setTimeout(r, 500));
                    }
                    
                    setRotasGeradas(rotas);
                    atualizarMapaMultiplasRotas(rotas);
                    salvarHistorico(rotas, totalKm, totalMin);
                    showToast(`${rotas.length} rotas geradas!`, 'success');
                } catch (err) {
                    showToast('Erro: ' + err.message, 'error');
                }
                
                setLoading(false);
            };
            
            // Atualizar mapa com rota √∫nica
            const atualizarMapaRota = (pontos, geo, cor) => {
                if (!mapa || !markersLayer) return;
                
                markersLayer.clearLayers();
                if (routeLayer) mapa.removeLayer(routeLayer);
                
                pontos.filter(p => !p.isRetorno).forEach((p, idx) => {
                    const icon = L.divIcon({
                        className: '',
                        html: `<div style="background:${idx === 0 ? '#10b981' : cor};color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.3)">${idx === 0 ? 'üö©' : idx}</div>`,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    });
                    L.marker([p.latitude, p.longitude], { icon }).addTo(markersLayer);
                });
                
                if (geo?.features) {
                    const layer = L.geoJSON(geo, { style: { color: cor, weight: 5, opacity: 0.8 } }).addTo(mapa);
                    setRouteLayer(layer);
                }
                
                mapa.fitBounds(L.latLngBounds(pontos.filter(p => !p.isRetorno).map(p => [p.latitude, p.longitude])), { padding: [50, 50] });
            };
            
            // Atualizar mapa com m√∫ltiplas rotas
            const atualizarMapaMultiplasRotas = (rotas) => {
                if (!mapa || !markersLayer) return;
                
                markersLayer.clearLayers();
                if (routeLayer) mapa.removeLayer(routeLayer);
                
                const layerGroup = L.layerGroup();
                const todosPontos = [];
                
                rotas.forEach((rota, rotaIdx) => {
                    rota.pontos.filter(p => !p.isRetorno).forEach((p, idx) => {
                        todosPontos.push([p.latitude, p.longitude]);
                        const isPartida = idx === 0;
                        const icon = L.divIcon({
                            className: '',
                            html: `<div style="background:${isPartida ? '#10b981' : rota.cor};color:#fff;width:${isPartida ? 32 : 26}px;height:${isPartida ? 32 : 26}px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:${isPartida ? 14 : 11}px;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.3)">${isPartida ? 'üö©' : (rotaIdx+1)+'.'+idx}</div>`,
                            iconSize: [isPartida ? 32 : 26, isPartida ? 32 : 26],
                            iconAnchor: [isPartida ? 16 : 13, isPartida ? 16 : 13]
                        });
                        L.marker([p.latitude, p.longitude], { icon }).addTo(layerGroup);
                    });
                    
                    if (rota.geo?.features) {
                        L.geoJSON(rota.geo, { style: { color: rota.cor, weight: 4, opacity: 0.8 } }).addTo(layerGroup);
                    }
                });
                
                layerGroup.addTo(mapa);
                setRouteLayer(layerGroup);
                
                if (todosPontos.length > 0) {
                    mapa.fitBounds(L.latLngBounds(todosPontos), { padding: [50, 50] });
                }
            };
            
            // Salvar no hist√≥rico
            const salvarHistorico = async (rotas, totalKm, totalMin) => {
                try {
                    await fetch(`${API_URL}/api/roteirizador/rotas`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            ponto_partida: enderecos[0],
                            pontos_entrega: enderecos.slice(1),
                            rotas_geradas: rotas,
                            config: { paradasPorRota, modoAgrupamento, retornarInicio },
                            total_km: (totalKm / 1000).toFixed(1),
                            total_min: Math.round(totalMin / 60),
                            num_rotas: rotas.length,
                            num_paradas: enderecos.length - 1
                        })
                    });
                    carregarHistorico();
                } catch (err) {
                    console.error('Erro ao salvar hist√≥rico:', err);
                }
            };
            
            // Abrir no Waze/Maps
            const abrirWaze = (pontos) => {
                const p = pontos.filter(x => !x.isRetorno);
                if (p.length > 0) {
                    window.open(`https://waze.com/ul?ll=${p[p.length-1].latitude},${p[p.length-1].longitude}&navigate=yes`, '_blank');
                }
            };
            
            const abrirMaps = (pontos) => {
                const p = pontos.filter(x => !x.isRetorno);
                if (p.length > 0) {
                    window.open(`https://www.google.com/maps/dir/${p.map(x => `${x.latitude},${x.longitude}`).join('/')}`, '_blank');
                }
            };
            
            const limpar = () => {
                if (partidaPadrao) {
                    setEnderecos([{ ...partidaPadrao, id: Date.now() }]);
                } else {
                    setEnderecos([]);
                }
                setResultado(null);
                setRotasGeradas([]);
                setSugestoes([]);
                setTermoBusca('');
            };
            
            const emojiDirecao = {
                'Norte': '‚¨ÜÔ∏è', 'Nordeste': '‚ÜóÔ∏è', 'Leste': '‚û°Ô∏è', 'Sudeste': '‚ÜòÔ∏è',
                'Sul': '‚¨áÔ∏è', 'Sudoeste': '‚ÜôÔ∏è', 'Oeste': '‚¨ÖÔ∏è', 'Noroeste': '‚ÜñÔ∏è'
            };
            
            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Header */}
                    <header className="bg-purple-900 text-white px-4 py-3 shadow-lg">
                        <div className="max-w-7xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <span className="text-2xl">üó∫Ô∏è</span>
                                <div>
                                    <h1 className="font-bold text-lg">Tutts Roteirizador</h1>
                                    <p className="text-purple-300 text-xs">Ol√°, {usuario.nome}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => setMostrarHistorico(!mostrarHistorico)}
                                    className="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded text-sm"
                                >
                                    üìã Hist√≥rico
                                </button>
                                <button 
                                    onClick={onLogout}
                                    className="px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 rounded text-sm"
                                >
                                    üö™ Sair
                                </button>
                            </div>
                        </div>
                    </header>
                    
                    <div className="max-w-7xl mx-auto p-4">
                        <div className="flex gap-4">
                            {/* Painel lateral */}
                            <div className="w-96 bg-white rounded-xl shadow-lg overflow-hidden flex flex-col" style={{ height: 'calc(100vh - 120px)' }}>
                                {/* Busca */}
                                <div className="p-4 border-b bg-purple-50">
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={termoBusca}
                                            onChange={(e) => setTermoBusca(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && buscarEndereco()}
                                            placeholder="üîç Digite o endere√ßo e pressione Enter"
                                            className="flex-1 px-3 py-2 border border-purple-200 rounded-lg text-sm focus:outline-none focus:border-purple-500"
                                        />
                                        <button
                                            onClick={buscarEndereco}
                                            disabled={buscando}
                                            className="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 disabled:opacity-50"
                                        >
                                            {buscando ? '...' : 'üîç'}
                                        </button>
                                    </div>
                                    
                                    {/* Sugest√µes */}
                                    {sugestoes.length > 0 && (
                                        <div className="mt-2 bg-white border border-purple-200 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                            {sugestoes.map((sug, idx) => (
                                                <div
                                                    key={idx}
                                                    onClick={() => adicionarEndereco(sug)}
                                                    className="px-3 py-2 hover:bg-purple-50 cursor-pointer border-b last:border-b-0 text-sm"
                                                >
                                                    üìç {sug.endereco}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                                {/* Lista de endere√ßos */}
                                <div className="flex-1 overflow-y-auto p-3">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-bold text-gray-600">Rota ({enderecos.length}/20)</span>
                                        {enderecos.length > 0 && (
                                            <button onClick={limpar} className="text-xs text-red-500 hover:text-red-700">Limpar</button>
                                        )}
                                    </div>
                                    
                                    {/* Indicador de partida padr√£o */}
                                    {partidaPadrao && (
                                        <div className="mb-2 px-2 py-1 bg-green-50 border border-green-200 rounded text-xs text-green-700 flex items-center justify-between">
                                            <span>üè† Partida padr√£o configurada</span>
                                            <button onClick={removerPartidaPadrao} className="text-red-500 hover:text-red-700">‚úï</button>
                                        </div>
                                    )}
                                    
                                    {enderecos.length === 0 ? (
                                        <div className="text-center py-8 text-gray-400">
                                            üìç Adicione endere√ßos para criar a rota
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {enderecos.map((end, idx) => (
                                                <div key={end.id} className={`p-2 rounded-lg border ${idx === 0 ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'}`}>
                                                    <div className="flex items-center gap-2">
                                                        <span className={`w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold ${idx === 0 ? 'bg-green-500' : 'bg-purple-600'}`}>
                                                            {idx === 0 ? 'üö©' : idx}
                                                        </span>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="text-xs font-medium text-gray-800 truncate">{end.endereco}</div>
                                                        </div>
                                                        <div className="flex gap-1">
                                                            {idx === 0 && (
                                                                <button 
                                                                    onClick={() => setMostrarConfigPartida(!mostrarConfigPartida)} 
                                                                    className="text-gray-400 hover:text-green-600"
                                                                    title="Configurar partida padr√£o"
                                                                >‚öôÔ∏è</button>
                                                            )}
                                                            {idx > 0 && <button onClick={() => moverEndereco(idx, -1)} className="text-gray-400 hover:text-purple-600">‚ñ≤</button>}
                                                            {idx < enderecos.length - 1 && <button onClick={() => moverEndereco(idx, 1)} className="text-gray-400 hover:text-purple-600">‚ñº</button>}
                                                            <button onClick={() => removerEndereco(end.id)} className="text-gray-400 hover:text-red-600">‚úï</button>
                                                        </div>
                                                    </div>
                                                    {/* Menu de config da partida */}
                                                    {idx === 0 && mostrarConfigPartida && (
                                                        <div className="mt-2 pt-2 border-t border-green-200 flex gap-2">
                                                            <button 
                                                                onClick={() => salvarPartidaPadrao(end)}
                                                                className="flex-1 px-2 py-1 bg-green-500 text-white rounded text-xs font-medium hover:bg-green-600"
                                                            >‚úì Salvar como padr√£o</button>
                                                            {partidaPadrao && (
                                                                <button 
                                                                    onClick={removerPartidaPadrao}
                                                                    className="px-2 py-1 bg-red-100 text-red-600 rounded text-xs hover:bg-red-200"
                                                                >Remover</button>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                                {/* Controles */}
                                <div className="p-3 border-t bg-gray-50">
                                    <label className="flex items-center gap-2 mb-2 cursor-pointer text-sm">
                                        <input type="checkbox" checked={retornarInicio} onChange={(e) => setRetornarInicio(e.target.checked)} className="w-4 h-4" />
                                        <span>‚Ü©Ô∏è Retornar ao in√≠cio</span>
                                    </label>
                                    
                                    <label className="flex items-center gap-2 mb-3 cursor-pointer text-sm">
                                        <input type="checkbox" checked={modoMultiplas} onChange={(e) => setModoMultiplas(e.target.checked)} className="w-4 h-4" />
                                        <span>üöö Dividir em m√∫ltiplas rotas</span>
                                    </label>
                                    
                                    {modoMultiplas && (
                                        <div className="mb-3 p-2 bg-purple-50 rounded-lg">
                                            <div className="text-xs font-bold text-purple-700 mb-2">üì¶ Paradas por rota:</div>
                                            <div className="flex gap-1 flex-wrap">
                                                {[2, 3, 4, 5, 6, 8, 10].map(num => (
                                                    <button
                                                        key={num}
                                                        onClick={() => setParadasPorRota(num)}
                                                        className={`px-3 py-1 rounded text-xs font-medium ${paradasPorRota === num ? 'bg-purple-600 text-white' : 'bg-white text-purple-600 border border-purple-300'}`}
                                                    >
                                                        {num}
                                                    </button>
                                                ))}
                                            </div>
                                            {enderecos.length > 1 && (
                                                <div className="text-xs text-purple-600 mt-2">
                                                    üìä {Math.ceil((enderecos.length - 1) / paradasPorRota)} rota(s)
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    <button
                                        onClick={modoMultiplas ? gerarMultiplasRotas : roteirizar}
                                        disabled={loading || enderecos.length < 2}
                                        className="w-full py-2.5 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-bold text-sm hover:from-purple-700 hover:to-pink-700 disabled:opacity-50"
                                    >
                                        {loading ? '‚è≥ Calculando...' : modoMultiplas ? `üöö Gerar ${Math.ceil((enderecos.length - 1) / paradasPorRota)} Rotas` : 'üöÄ Otimizar Rota'}
                                    </button>
                                </div>
                            </div>
                            
                            {/* Mapa e resultados */}
                            <div className="flex-1 flex flex-col gap-4">
                                <div id="mapa" className="flex-1 rounded-xl shadow-lg" style={{ minHeight: '400px' }}></div>
                                
                                {/* Resultado rota √∫nica */}
                                {resultado && !modoMultiplas && (
                                    <div className="bg-white rounded-lg shadow-lg p-2">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-1.5">
                                                <span className="w-5 h-5 rounded-full flex items-center justify-center text-white text-xs font-bold bg-purple-600">1</span>
                                                <span className="text-xs font-bold">{resultado.ordem.filter(p => !p.isRetorno).length - 1} paradas</span>
                                                <span className="text-xs text-green-600">{resultado.km}km</span>
                                                <span className="text-xs text-blue-600">{resultado.min}min</span>
                                                <button 
                                                    onClick={() => setResultado({...resultado, expandido: !resultado.expandido})}
                                                    className="text-xs text-gray-400 hover:text-purple-600 ml-1"
                                                >{resultado.expandido ? '‚ñ≤' : '‚ñº'}</button>
                                            </div>
                                            <div className="flex gap-1">
                                                <button onClick={() => abrirMaps(resultado.ordem)} className="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">üìç Maps</button>
                                                <button 
                                                    onClick={() => {
                                                        if (partidaPadrao) {
                                                            setEnderecos([{ ...partidaPadrao, id: Date.now() }]);
                                                        } else {
                                                            setEnderecos([]);
                                                        }
                                                        setResultado(null);
                                                        if (markersLayer) markersLayer.clearLayers();
                                                        if (routeLayer && mapa) {
                                                            mapa.removeLayer(routeLayer);
                                                            setRouteLayer(null);
                                                        }
                                                        showToast('üöÄ Rota disparada!', 'success');
                                                    }}
                                                    className="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600"
                                                >üöÄ Disparar</button>
                                            </div>
                                        </div>
                                        {resultado.expandido && (
                                            <div className="mt-2 pt-2 border-t border-gray-200 space-y-1">
                                                {resultado.ordem.filter(p => !p.isRetorno).map((p, idx) => (
                                                    <div key={idx} className="flex items-start gap-2 text-xs">
                                                        <span className={`w-4 h-4 rounded-full flex items-center justify-center text-white text-xs flex-shrink-0 ${idx === 0 ? 'bg-green-500' : 'bg-purple-600'}`}>
                                                            {idx === 0 ? 'üö©' : idx}
                                                        </span>
                                                        <span className="text-gray-600 break-all">{p.endereco}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {/* Resultado m√∫ltiplas rotas */}
                                {rotasGeradas.length > 0 && (
                                    <div className="bg-white rounded-lg shadow-lg p-2 max-h-48 overflow-y-auto">
                                        <div className="flex items-center justify-between mb-2 px-1">
                                            <span className="text-sm font-bold text-gray-700">üöö {rotasGeradas.length} Rotas</span>
                                            <span className="text-xs text-gray-500">
                                                {rotasGeradas.reduce((acc, r) => acc + parseFloat(r.km || 0), 0).toFixed(1)} km total
                                            </span>
                                        </div>
                                        <div className="space-y-1">
                                            {rotasGeradas.map(rota => (
                                                <div key={rota.id} className="p-2 rounded-lg border" style={{ borderColor: rota.cor, background: rota.cor + '08' }}>
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-1.5">
                                                            <span className="w-5 h-5 rounded-full flex items-center justify-center text-white text-xs font-bold" style={{ background: rota.cor }}>{rota.id}</span>
                                                            <span className="text-xs font-bold">{rota.numParadas} paradas</span>
                                                            <span className="text-xs text-gray-400">{emojiDirecao[rota.direcao]}</span>
                                                            <span className="text-xs text-green-600">{rota.km}km</span>
                                                            <span className="text-xs text-blue-600">{rota.min}min</span>
                                                            <button 
                                                                onClick={() => {
                                                                    const novasRotas = rotasGeradas.map(r => 
                                                                        r.id === rota.id ? {...r, expandido: !r.expandido} : r
                                                                    );
                                                                    setRotasGeradas(novasRotas);
                                                                }}
                                                                className="text-xs text-gray-400 hover:text-purple-600 ml-1"
                                                            >{rota.expandido ? '‚ñ≤' : '‚ñº'}</button>
                                                        </div>
                                                        <div className="flex gap-1">
                                                            <button onClick={() => abrirMaps(rota.pontos)} className="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">üìç Maps</button>
                                                            <button 
                                                                onClick={() => {
                                                                    const pontosRota = rota.pontos.filter(p => !p.isRetorno).slice(1);
                                                                    const enderecosRestantes = enderecos.filter(e => 
                                                                        !pontosRota.some(p => p.latitude === e.latitude && p.longitude === e.longitude)
                                                                    );
                                                                    setEnderecos(enderecosRestantes);
                                                                    const novasRotas = rotasGeradas.filter(r => r.id !== rota.id);
                                                                    setRotasGeradas(novasRotas);
                                                                    if (novasRotas.length > 0) {
                                                                        atualizarMapaMultiplasRotas(novasRotas);
                                                                    } else {
                                                                        if (markersLayer) markersLayer.clearLayers();
                                                                        if (routeLayer && mapa) {
                                                                            mapa.removeLayer(routeLayer);
                                                                            setRouteLayer(null);
                                                                        }
                                                                    }
                                                                    showToast(`üöÄ Rota ${rota.id} disparada!`, 'success');
                                                                }}
                                                                className="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600"
                                                            >üöÄ Disparar</button>
                                                        </div>
                                                    </div>
                                                    {rota.expandido && (
                                                        <div className="mt-2 pt-2 border-t space-y-1" style={{ borderColor: rota.cor + '40' }}>
                                                            {rota.pontos.filter(p => !p.isRetorno).map((p, idx) => (
                                                                <div key={idx} className="flex items-start gap-2 text-xs">
                                                                    <span 
                                                                        className="w-4 h-4 rounded-full flex items-center justify-center text-white text-xs flex-shrink-0"
                                                                        style={{ background: idx === 0 ? '#10b981' : rota.cor }}
                                                                    >
                                                                        {idx === 0 ? 'üö©' : idx}
                                                                    </span>
                                                                    <span className="text-gray-600 break-all">{p.endereco}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {/* Modal Hist√≥rico */}
                    {mostrarHistorico && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setMostrarHistorico(false)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="bg-purple-900 text-white px-4 py-3 flex items-center justify-between">
                                    <span className="font-bold">üìã Hist√≥rico de Rotas</span>
                                    <button onClick={() => setMostrarHistorico(false)} className="text-white/70 hover:text-white">‚úï</button>
                                </div>
                                <div className="p-4 overflow-y-auto max-h-[60vh]">
                                    {historico.length === 0 ? (
                                        <p className="text-center text-gray-500 py-8">Nenhuma rota salva ainda</p>
                                    ) : (
                                        <div className="space-y-2">
                                            {historico.map(h => (
                                                <div key={h.id} className="p-3 border rounded-lg hover:bg-gray-50">
                                                    <div className="flex items-center justify-between">
                                                        <div>
                                                            <div className="font-medium text-sm">{h.num_rotas || 1} rota(s) ‚Ä¢ {h.num_paradas} paradas</div>
                                                            <div className="text-xs text-gray-500">{new Date(h.criado_em).toLocaleString('pt-BR')}</div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-sm text-green-600 font-medium">{h.total_km} km</div>
                                                            <div className="text-xs text-blue-600">{h.total_min} min</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // ==================== APP PRINCIPAL ====================
        const App = () => {
            const [usuario, setUsuario] = useState(null);
            const [token, setToken] = useState(null);
            const [toast, setToast] = useState(null);
            const [verificando, setVerificando] = useState(true);
            
            const showToast = (mensagem, tipo = 'info') => {
                setToast({ mensagem, tipo });
            };
            
            // Verificar sess√£o ao carregar
            useEffect(() => {
                const verificarSessao = async () => {
                    const tokenSalvo = localStorage.getItem('roteirizador_token');
                    const usuarioSalvo = localStorage.getItem('roteirizador_usuario');
                    
                    if (tokenSalvo && usuarioSalvo) {
                        try {
                            const resp = await fetch(`${API_URL}/api/roteirizador/verificar`, {
                                headers: { 'Authorization': `Bearer ${tokenSalvo}` }
                            });
                            
                            if (resp.ok) {
                                setToken(tokenSalvo);
                                setUsuario(JSON.parse(usuarioSalvo));
                            } else {
                                localStorage.removeItem('roteirizador_token');
                                localStorage.removeItem('roteirizador_usuario');
                            }
                        } catch (err) {
                            console.error('Erro ao verificar sess√£o:', err);
                        }
                    }
                    setVerificando(false);
                };
                
                verificarSessao();
            }, []);
            
            const handleLogin = (usuario, token) => {
                setUsuario(usuario);
                setToken(token);
            };
            
            const handleLogout = () => {
                localStorage.removeItem('roteirizador_token');
                localStorage.removeItem('roteirizador_usuario');
                setUsuario(null);
                setToken(null);
                showToast('At√© logo!', 'info');
            };
            
            if (verificando) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center">
                        <div className="text-white text-center">
                            <div className="text-4xl mb-4">üó∫Ô∏è</div>
                            <div className="animate-pulse">Carregando...</div>
                        </div>
                    </div>
                );
            }
            
            return (
                <>
                    {toast && <Toast {...toast} onClose={() => setToast(null)} />}
                    
                    {usuario && token ? (
                        <Roteirizador 
                            usuario={usuario} 
                            token={token} 
                            onLogout={handleLogout}
                            showToast={showToast}
                        />
                    ) : (
                        <TelaLogin onLogin={handleLogin} showToast={showToast} />
                    )}
                </>
            );
        };
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
