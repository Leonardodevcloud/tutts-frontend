<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Tutts - Solicita√ß√µes de Ajustes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .toast { animation: slideIn 0.3s ease-out; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_URL = 'https://tutts-backend-production.up.railway.app/api';

    // Toast de notifica√ß√£o
    const Toast = ({ message, type, onClose }) => (
      <div className={`fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-2xl toast ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
      } text-white font-semibold flex items-center gap-3`}>
        <span className="text-2xl">{type === 'success' ? '‚úì' : '‚úó'}</span>
        <span>{message}</span>
      </div>
    );

    // Modal de Imagem Expandida
    const ImageModal = ({ imageUrl, onClose }) => (
      <div 
        className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4"
        onClick={onClose}
      >
        <div className="relative max-w-4xl max-h-screen">
          <button 
            onClick={onClose}
            className="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300"
          >
            ‚úï
          </button>
          <img 
            src={imageUrl} 
            alt="Comprovante expandido" 
            className="max-w-full max-h-screen rounded-lg shadow-2xl"
            onClick={(e) => e.stopPropagation()}
          />
        </div>
      </div>
      </div>
    );

    // üìä COMPONENTE: GR√ÅFICO DE PIZZA
    const PieChart = ({ data, title }) => {
      const total = data.reduce((sum, item) => sum + item.value, 0);
      const colors = ['#7c3aed', '#2563eb', '#059669', '#dc2626', '#ea580c', '#8b5cf6'];
      
      if (total === 0) {
        return (
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-semibold mb-4">{title}</h3>
            <p className="text-gray-500 text-center py-8">Sem dados dispon√≠veis</p>
          </div>
        );
      }

      let currentAngle = 0;
      const slices = data.map((item, index) => {
        const percentage = (item.value / total) * 100;
        const angle = (percentage / 100) * 360;
        const startAngle = currentAngle;
        currentAngle += angle;
        
        const x1 = 100 + 90 * Math.cos((startAngle - 90) * Math.PI / 180);
        const y1 = 100 + 90 * Math.sin((startAngle - 90) * Math.PI / 180);
        const x2 = 100 + 90 * Math.cos((currentAngle - 90) * Math.PI / 180);
        const y2 = 100 + 90 * Math.sin((currentAngle - 90) * Math.PI / 180);
        const largeArc = angle > 180 ? 1 : 0;
        
        return {
          ...item,
          path: `M 100 100 L ${x1} ${y1} A 90 90 0 ${largeArc} 1 ${x2} ${y2} Z`,
          color: colors[index % colors.length],
          percentage: percentage.toFixed(1)
        };
      });

      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-lg font-semibold mb-4">{title}</h3>
          <div className="flex flex-col md:flex-row items-center gap-6">
            <svg viewBox="0 0 200 200" className="w-48 h-48">
              {slices.map((slice, i) => (
                <path key={i} d={slice.path} fill={slice.color} className="hover:opacity-80 transition-opacity cursor-pointer" title={`${slice.label}: ${slice.value}`} />
              ))}
            </svg>
            <div className="flex-1 space-y-2">
              {slices.map((slice, i) => (
                <div key={i} className="flex items-center gap-2">
                  <div className="w-4 h-4 rounded" style={{backgroundColor: slice.color}}></div>
                  <span className="text-sm flex-1">{slice.label}</span>
                  <span className="font-semibold">{slice.value}</span>
                  <span className="text-gray-500 text-sm">({slice.percentage}%)</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // üèÜ COMPONENTE: RANKING DE T√âCNICOS
    const TechRanking = ({ submissions }) => {
      const stats = {};
      submissions.forEach(s => {
        const tech = s.fullName || s.nome_tecnico || 'Desconhecido';
        if (!stats[tech]) stats[tech] = { total: 0, aprovadas: 0, rejeitadas: 0, pendentes: 0 };
        stats[tech].total++;
        if (s.status === 'aprovada') stats[tech].aprovadas++;
        else if (s.status === 'rejeitada') stats[tech].rejeitadas++;
        else stats[tech].pendentes++;
      });

      const ranking = Object.entries(stats)
        .map(([name, data]) => ({
          name,
          ...data,
          aprovacao: data.total > 0 ? ((data.aprovadas / data.total) * 100).toFixed(1) : 0
        }))
        .sort((a, b) => b.total - a.total);

      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-lg font-semibold mb-4">üèÜ Ranking de T√©cnicos</h3>
          {ranking.length === 0 ? (
            <p className="text-gray-500 text-center py-8">Sem dados dispon√≠veis</p>
          ) : (
            <div className="space-y-3">
              {ranking.map((tech, i) => (
                <div key={i} className="flex items-center gap-4 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                  <div className={`text-2xl font-bold w-8 ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : i === 2 ? 'text-orange-600' : 'text-gray-400'}`}>
                    {i + 1}¬∫
                  </div>
                  <div className="flex-1">
                    <p className="font-semibold text-gray-800">{tech.name}</p>
                    <div className="flex gap-4 text-sm text-gray-600 mt-1">
                      <span>Total: <b>{tech.total}</b></span>
                      <span className="text-green-600">‚úì {tech.aprovadas}</span>
                      <span className="text-red-600">‚úó {tech.rejeitadas}</span>
                      <span className="text-yellow-600">‚è≥ {tech.pendentes}</span>
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="text-2xl font-bold text-purple-600">{tech.aprovacao}%</div>
                    <div className="text-xs text-gray-500">aprova√ß√£o</div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    };

    );

    // Gr√°fico de Pizza (Motivos)
    const PieChart = ({ submissions }) => {
      const motivos = {};
      submissions.forEach(s => {
        motivos[s.motivo] = (motivos[s.motivo] || 0) + 1;
      });

      const colors = ['#7c3aed', '#2563eb', '#059669', '#dc2626', '#ea580c', '#8b5cf6'];
      const total = submissions.length;
      const data = Object.entries(motivos).map(([motivo, count], index) => ({
        motivo,
        count,
        percentage: ((count / total) * 100).toFixed(1),
        color: colors[index % colors.length]
      }));

      let currentAngle = 0;

      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h2 className="text-lg font-semibold mb-4">üìä Distribui√ß√£o por Motivo</h2>
          {total === 0 ? (
            <p className="text-gray-500">Nenhuma solicita√ß√£o ainda</p>
          ) : (
            <div className="flex flex-col md:flex-row items-center gap-6">
              <svg viewBox="0 0 200 200" className="w-48 h-48">
                {data.map((item, index) => {
                  const angle = (item.count / total) * 360;
                  const startAngle = currentAngle;
                  currentAngle += angle;

                  const x1 = 100 + 90 * Math.cos((startAngle - 90) * Math.PI / 180);
                  const y1 = 100 + 90 * Math.sin((startAngle - 90) * Math.PI / 180);
                  const x2 = 100 + 90 * Math.cos((startAngle + angle - 90) * Math.PI / 180);
                  const y2 = 100 + 90 * Math.sin((startAngle + angle - 90) * Math.PI / 180);
                  const largeArc = angle > 180 ? 1 : 0;

                  return (
                    <path
                      key={index}
                      d={`M 100 100 L ${x1} ${y1} A 90 90 0 ${largeArc} 1 ${x2} ${y2} Z`}
                      fill={item.color}
                      stroke="white"
                      strokeWidth="2"
                    />
                  );
                })}
                <circle cx="100" cy="100" r="50" fill="white" />
                <text x="100" y="95" textAnchor="middle" className="text-2xl font-bold" fill="#1f2937">
                  {total}
                </text>
                <text x="100" y="110" textAnchor="middle" className="text-xs" fill="#6b7280">
                  Total
                </text>
              </svg>
              <div className="flex-1 space-y-2">
                {data.map((item, index) => (
                  <div key={index} className="flex items-center gap-3">
                    <div 
                      className="w-4 h-4 rounded"
                      style={{ backgroundColor: item.color }}
                    />
                    <div className="flex-1">
                      <p className="text-sm font-medium text-gray-800 truncate">{item.motivo}</p>
                      <p className="text-xs text-gray-500">{item.count} solicita√ß√µes ({item.percentage}%)</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    const App = () => {
      const [view, setView] = useState('login');
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(false);
      const [toast, setToast] = useState(null);
      const [formData, setFormData] = useState({});
      const [submissions, setSubmissions] = useState([]);
      const [users, setUsers] = useState([]);
      const [imageModal, setImageModal] = useState(null);

      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };

      const loadSubmissions = async () => {
        try {
          const query = user.role === 'user' ? `?userId=${user.id}&userCod=${user.cod_profissional}` : '';
          const res = await fetch(`${API_URL}/submissions${query}`);
          const data = await res.json();
          setSubmissions(data.map(s => ({
            ...s,
            ordemServico: s.ordem_servico,
            codProfissional: s.user_cod,
            fullName: s.user_name,
            imagemComprovante: s.imagem_comprovante,
            timestamp: new Date(s.created_at).toLocaleString('pt-BR')
          })));
        } catch (err) {
          console.error('Erro ao carregar:', err);
        }
      };

      const loadUsers = async () => {
        try {
          const res = await fetch(`${API_URL}/users`);
          const data = await res.json();
          setUsers(data.map(u => ({
            codProfissional: u.cod_profissional,
            fullName: u.full_name,
            createdAt: new Date(u.created_at).toLocaleString('pt-BR')
          })));
        } catch (err) {
          console.error('Erro:', err);
        }
      };

      useEffect(() => {
        if (user) {
          loadSubmissions();
          if (user.role === 'admin') loadUsers();
        }
      }, [user]);

      const handleLogin = async () => {
        setLoading(true);
        try {
          const res = await fetch(`${API_URL}/users/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codProfissional: formData.cod, password: formData.password })
          });
          if (!res.ok) throw new Error('Credenciais inv√°lidas');
          const data = await res.json();
          setUser({ ...data, codProfissional: data.cod_profissional, fullName: data.full_name });
          setFormData({});
        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          setLoading(false);
        }
      };

      const handleRegister = async () => {
        setLoading(true);
        try {
          const res = await fetch(`${API_URL}/users/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codProfissional: formData.cod, password: formData.password, fullName: formData.name })
          });
          if (!res.ok) throw new Error('Erro no cadastro');
          showToast('Cadastro realizado! Fa√ßa login.', 'success');
          setView('login');
          setFormData({});
        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          setLoading(false);
        }
      };

      const handleSubmitOS = async () => {
        setLoading(true);
        try {
          await fetch(`${API_URL}/submissions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ordemServico: formData.os,
              motivo: formData.motivo,
              userId: user.id,
              userCod: user.codProfissional,
              userName: user.fullName,
              imagemComprovante: formData.imagem || null,
              coordenadas: formData.coordenadas || null
            })
          });
          showToast('‚úÖ OS enviada com sucesso!', 'success');
          setFormData({});
          loadSubmissions();
        } catch (err) {
          showToast('Erro ao enviar', 'error');
        } finally {
          setLoading(false);
        }
      };

      const handleValidate = async (id, isValid) => {
        try {
          await fetch(`${API_URL}/submissions/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: isValid ? 'aprovada' : 'rejeitada', observacao: formData.obs || '' })
          });
          showToast(isValid ? '‚úÖ Aprovada!' : '‚ùå Rejeitada!', isValid ? 'success' : 'error');
          setFormData({});
          loadSubmissions();
        } catch (err) {
          showToast('Erro', 'error');
        }
      };

      if (!user) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center p-4">
            {toast && <Toast {...toast} />}
            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
              <div className="text-center mb-8">
                <div className="w-32 h-32 mx-auto mb-4 bg-purple-900 rounded-xl p-4 shadow-lg flex items-center justify-center">
                  <div className="text-white text-5xl font-bold">tutts</div>
                </div>
                <h1 className="text-3xl font-bold text-gray-800">Sistema de Solicita√ß√µes</h1>
                <p className="text-gray-600 mt-2">
                  {view === 'login' ? 'Entre com suas credenciais' : 
                   view === 'register' ? 'Cadastre-se' :
                   'Recuperar senha'}
                </p>
              </div>

              {view === 'forgot-password' ? (
                <div className="space-y-4">
                  <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                    <div className="flex">
                      <div className="flex-shrink-0">
                        <svg className="h-5 w-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                          <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                        </svg>
                      </div>
                      <div className="ml-3">
                        <p className="text-sm text-blue-700">
                          <strong>Para recuperar sua senha:</strong><br/>
                          Entre em contato com o administrador informando seu COD Profissional.
                        </p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="bg-gray-50 rounded-lg p-4 space-y-2">
                    <p className="text-sm font-semibold text-gray-700">üìû Contatos:</p>
                    <p className="text-sm text-gray-600">üìß Email: supervisor@tutts.com.br</p>
                    <p className="text-sm text-gray-600">üì± WhatsApp: (71) 93300-1635</p>
                    <p className="text-xs text-gray-500 mt-2">
                      
                    </p>
                  </div>

                  <button 
                    onClick={() => setView('login')} 
                    className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold hover:bg-purple-800"
                  >
                    ‚Üê Voltar para login
                  </button>
                </div>
              ) : view === 'login' ? (
                <div className="space-y-4">
                  <input
                    type="text"
                    placeholder="COD Profissional"
                    value={formData.cod || ''}
                    onChange={e => setFormData({...formData, cod: e.target.value})}
                    className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-900"
                  />
                  <input
                    type="password"
                    placeholder="Senha"
                    value={formData.password || ''}
                    onChange={e => setFormData({...formData, password: e.target.value})}
                    onKeyPress={e => e.key === 'Enter' && handleLogin()}
                    className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-900"
                  />
                  <button
                    onClick={handleLogin}
                    disabled={loading}
                    className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold hover:bg-purple-800 disabled:opacity-50"
                  >
                    {loading ? 'Aguarde...' : 'Entrar'}
                  </button>
                  <button onClick={() => setView('register')} className="w-full text-purple-900 text-sm">
                    N√£o tem conta? Cadastre-se
                  </button>
                  <button 
                    onClick={() => setView('forgot-password')} 
                    className="w-full text-purple-700 text-sm hover:text-purple-900 underline"
                  >
                    Esqueci minha senha
                  </button>
                 
                </div>
              ) : (
                <div className="space-y-4">
                  <input
                    type="text"
                    placeholder="Nome Completo"
                    value={formData.name || ''}
                    onChange={e => setFormData({...formData, name: e.target.value})}
                    className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-900"
                  />
                  <input
                    type="text"
                    placeholder="COD Profissional"
                    value={formData.cod || ''}
                    onChange={e => setFormData({...formData, cod: e.target.value})}
                    className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-900"
                  />
                  <input
                    type="password"
                    placeholder="Senha"
                    value={formData.password || ''}
                    onChange={e => setFormData({...formData, password: e.target.value})}
                    className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-900"
                  />
                  <button
                    onClick={handleRegister}
                    disabled={loading}
                    className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold hover:bg-purple-800 disabled:opacity-50"
                  >
                    {loading ? 'Aguarde...' : 'Criar Conta'}
                  </button>
                  <button onClick={() => setView('login')} className="w-full text-purple-900 text-sm">
                    ‚Üê Voltar para login
                  </button>
                </div>
              )}
            </div>
          </div>
        );
      }

      if (user.role === 'user') {
        return (
          <div className="min-h-screen bg-gray-50">
            {toast && <Toast {...toast} />}
            {imageModal && <ImageModal imageUrl={imageModal} onClose={() => setImageModal(null)} />}
            <nav className="bg-white shadow-sm border-b">
              <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                  <h1 className="text-xl font-bold">Painel do Usu√°rio</h1>
                  <p className="text-sm text-gray-600">{user.fullName}</p>
                </div>
                <button onClick={() => setUser(null)} className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                  Sair
                </button>
              </div>
            </nav>
            
            <div className="max-w-4xl mx-auto p-6">
              <div className="bg-white rounded-xl shadow p-6 mb-6">
                <h2 className="text-lg font-semibold mb-4">Enviar OS</h2>
                <div className="space-y-4">
                  <input
                    type="text"
                    placeholder="N√∫mero da OS"
                    value={formData.os || ''}
                    onChange={e => setFormData({...formData, os: e.target.value})}
                    className="w-full px-4 py-3 border rounded-lg"
                  />
                  <select
                    value={formData.motivo || ''}
                    onChange={e => {
                      const motivo = e.target.value;
                      let coordenadas = '';
                      
                      if (motivo === 'Altera√ß√£o Ponto 1 (Goi√¢nia)') {
                        coordenadas = '-16.64322218214421, -49.3190143453706';
                      } else if (motivo === 'Altera√ß√£o Ponto 1 (Campinas)') {
                        coordenadas = '-22.850067092813358, -47.08310037116422';
                      }
                      
                      setFormData({...formData, motivo, coordenadas});
                    }}
                    className="w-full px-4 py-3 border rounded-lg"
                  >
                    <option value="">Selecione o motivo</option>
                    <option>Altera√ß√£o Ponto 1 (Campinas)</option>
                    <option>Altera√ß√£o Ponto 1 (Goi√¢nia)</option>
                    <option>Ajuste de Retorno</option>
                    <option>Ajuste de Ped√°gio (Campinas e Recife)</option>
                  </select>
                  
                  {/* Coordenadas */}
                  {formData.coordenadas && (
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <p className="text-xs text-blue-700 font-semibold mb-1">üìç COORDENADAS</p>
                          <p className="text-lg font-mono font-bold text-blue-900">{formData.coordenadas}</p>
                        </div>
                        <button
                          onClick={() => {
                            navigator.clipboard.writeText(formData.coordenadas);
                            showToast('üìã Coordenadas copiadas!', 'success');
                          }}
                          className="ml-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
                        >
                          üìã Copiar
                        </button>
                      </div>
                      <a
                        href={`https://www.google.com/maps?q=${formData.coordenadas}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="inline-block mt-2 text-sm text-blue-600 hover:text-blue-800 underline"
                      >
                        üó∫Ô∏è Abrir no Google Maps
                      </a>
                    </div>
                  )}
                  
                  {/* Upload de Imagem */}
                  <div className="border-2 border-dashed border-gray-300 rounded-lg p-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üìé Comprovante (opcional)
                    </label>
                    <input
                      type="file"
                      accept="image/*"
                      onChange={async (e) => {
                        const file = e.target.files[0];
                        if (file) {
                          if (file.size > 5000000) {
                            showToast('Imagem muito grande! Max 5MB', 'error');
                            e.target.value = '';
                            return;
                          }
                          const reader = new FileReader();
                          reader.onload = () => {
                            setFormData({...formData, imagem: reader.result});
                          };
                          reader.readAsDataURL(file);
                        }
                      }}
                      className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-900 hover:file:bg-purple-100"
                    />
                    {formData.imagem && (
                      <div className="mt-3">
                        <img src={formData.imagem} alt="Preview" className="max-h-40 rounded-lg" />
                        <button
                          onClick={() => setFormData({...formData, imagem: null})}
                          className="mt-2 text-sm text-red-600 hover:text-red-800"
                        >
                          ‚úï Remover imagem
                        </button>
                      </div>
                    )}
                  </div>
                  
                  <button
                    onClick={handleSubmitOS}
                    disabled={loading || !formData.os || !formData.motivo}
                    className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold disabled:opacity-50"
                  >
                    Enviar
                  </button>
                </div>
              </div>

              <div className="bg-white rounded-xl shadow p-6">
                <h2 className="text-lg font-semibold mb-4">Minhas Submiss√µes</h2>
                {submissions.length === 0 ? (
                  <p className="text-gray-500">Nenhuma submiss√£o</p>
                ) : (
                  <div className="space-y-3">
                    {submissions.map(s => (
                      <div key={s.id} className="border rounded-lg p-4">
                        <div className="bg-purple-50 p-3 rounded mb-2">
                          <p className="text-xs text-purple-700 uppercase font-semibold">OS</p>
                          <p className="text-xl font-bold text-purple-900">{s.ordemServico}</p>
                        </div>
                        <div className="bg-blue-50 p-3 rounded mb-2">
                          <p className="text-xs text-blue-700 uppercase font-semibold">Motivo</p>
                          <p className="text-sm font-bold text-blue-900">{s.motivo}</p>
                        </div>
                        {s.coordenadas && (
                          <div className="bg-green-50 border border-green-200 p-3 rounded mb-2">
                            <div className="flex items-center justify-between">
                              <div className="flex-1">
                                <p className="text-xs text-green-700 uppercase font-semibold">üìç Coordenadas</p>
                                <p className="text-sm font-mono font-bold text-green-900">{s.coordenadas}</p>
                              </div>
                              <button
                                onClick={() => {
                                  navigator.clipboard.writeText(s.coordenadas);
                                  showToast('üìã Coordenadas copiadas!', 'success');
                                }}
                                className="ml-2 px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                              >
                                üìã
                              </button>
                            </div>
                          </div>
                        )}
                        {s.imagemComprovante && (
                          <div className="mt-2">
                            <p className="text-xs text-gray-600 mb-1">Comprovante:</p>
                            <img 
                              src={s.imagemComprovante} 
                              alt="Comprovante" 
                              className="max-h-40 rounded border cursor-pointer hover:opacity-80 transition"
                              onClick={() => setImageModal(s.imagemComprovante)}
                            />
                            <p className="text-xs text-gray-500 mt-1">üì∑ Clique para expandir</p>
                          </div>
                        )}
                        {s.observacao && (
                          <div className="mt-2 bg-gray-50 p-2 rounded">
                            <p className="text-xs text-gray-600">Observa√ß√£o do admin:</p>
                            <p className="text-sm text-gray-800">{s.observacao}</p>
                          </div>
                        )}
                        <div className="flex justify-between items-center mt-2">
                          <p className="text-xs text-gray-500">{s.timestamp}</p>
                          <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                            s.status === 'aprovada' ? 'bg-green-500 text-white' :
                            s.status === 'rejeitada' ? 'bg-red-500 text-white' :
                            'bg-yellow-500 text-white'
                          }`}>{s.status?.toUpperCase()}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50">
          {toast && <Toast {...toast} />}
          {imageModal && <ImageModal imageUrl={imageModal} onClose={() => setImageModal(null)} />}
          <nav className="bg-purple-900 shadow-lg">
            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
              <h1 className="text-xl font-bold text-white">Painel Admin</h1>
              <button onClick={() => setUser(null)} className="px-4 py-2 text-white hover:bg-purple-800 rounded-lg">
                Sair
              </button>
            </div>
          </nav>
          
          {/* Abas de Navega√ß√£o */}
          <div className="bg-white border-b sticky top-0 z-10 shadow-sm">
          
          {/* ABAS DE NAVEGA√á√ÉO - AGORA COM ESTAT√çSTICAS E CRIAR ADMIN */}
          <div className="bg-white border-b sticky top-0 z-10 shadow-sm">
            <div className="max-w-7xl mx-auto px-4">
              <div className="flex gap-1 overflow-x-auto">
                <button
                  onClick={() => setFormData({...formData, adminTab: 'dashboard'})}
                  className={`px-6 py-3 font-semibold transition whitespace-nowrap ${
                    (!formData.adminTab || formData.adminTab === 'dashboard')
                      ? 'text-purple-900 border-b-2 border-purple-900'
                      : 'text-gray-600 hover:text-gray-900'
                  }`}
                >
                  üìä Dashboard
                </button>
                <button
                  onClick={() => setFormData({...formData, adminTab: 'stats'})}
                  className={`px-6 py-3 font-semibold transition whitespace-nowrap ${
                    formData.adminTab === 'stats'
                      ? 'text-purple-900 border-b-2 border-purple-900'
                      : 'text-gray-600 hover:text-gray-900'
                  }`}
                >
                  üìà Estat√≠sticas
                </button>
                <button
                  onClick={() => setFormData({...formData, adminTab: 'search'})}
                  className={`px-6 py-3 font-semibold transition whitespace-nowrap ${
                    formData.adminTab === 'search'
                      ? 'text-purple-900 border-b-2 border-purple-900'
                      : 'text-gray-600 hover:text-gray-900'
                  }`}
                >
                  üîç Busca Detalhada
                </button>
                <button
                  onClick={() => setFormData({...formData, adminTab: 'users'})}
                  className={`px-6 py-3 font-semibold transition whitespace-nowrap ${
                    formData.adminTab === 'users'
                      ? 'text-purple-900 border-b-2 border-purple-900'
                      : 'text-gray-600 hover:text-gray-900'
                  }`}
                >
                  üë• Gerenciar Usu√°rios
                </button>
                <button
                  onClick={() => setFormData({...formData, adminTab: 'create-admin'})}
                  className={`px-6 py-3 font-semibold transition whitespace-nowrap ${
                    formData.adminTab === 'create-admin'
                      ? 'text-purple-900 border-b-2 border-purple-900'
                      : 'text-gray-600 hover:text-gray-900'
                  }`}
                >
                  ‚ûï Criar Admin
                </button>
              </div>
            </div>
          </div>
          
          <div className="max-w-7xl mx-auto p-6">
            
            {/* ====== ABA: DASHBOARD (ORIGINAL) ====== */}
            {(!formData.adminTab || formData.adminTab === 'dashboard') && (
              <>
            {/* ABA DASHBOARD */}
            {(!formData.adminTab || formData.adminTab === 'dashboard') && (
              <>
                <div className="grid md:grid-cols-4 gap-4 mb-6">
                  <div className="bg-white p-6 rounded-xl shadow">
                    <p className="text-sm text-gray-600">Total</p>
                    <p className="text-3xl font-bold text-purple-900">{submissions.length}</p>
                  </div>
                  <div className="bg-white p-6 rounded-xl shadow">
                    <p className="text-sm text-gray-600">Pendentes</p>
                    <p className="text-3xl font-bold text-yellow-600">{submissions.filter(s => s.status === 'pendente').length}</p>
                  </div>
                  <div className="bg-white p-6 rounded-xl shadow">
                    <p className="text-sm text-gray-600">Aprovadas</p>
                    <p className="text-3xl font-bold text-green-600">{submissions.filter(s => s.status === 'aprovada').length}</p>
                  </div>
                  <div className="bg-white p-6 rounded-xl shadow">
                    <p className="text-sm text-gray-600">Rejeitadas</p>
                    <p className="text-3xl font-bold text-red-600">{submissions.filter(s => s.status === 'rejeitada').length}</p>
                  </div>
                </div>

                <PieChart submissions={submissions} />

                <div className="bg-white rounded-xl shadow p-6 mb-6 mt-6">
                  <h2 className="text-lg font-semibold mb-4">Aguardando Valida√ß√£o</h2>
                  {submissions.filter(s => s.status === 'pendente').length === 0 ? (
                    <p className="text-gray-500">Nenhuma solicita√ß√£o pendente</p>
                  ) : (
                    submissions.filter(s => s.status === 'pendente').map(s => (
                      <div key={s.id} className="border rounded-lg p-4 mb-3">
                        <p className="font-mono text-xl font-bold">OS: {s.ordemServico}</p>
                        <p className="text-sm text-gray-700">{s.fullName}</p>
                        <p className="text-xs text-purple-900 font-semibold">Motivo: {s.motivo}</p>
                        <p className="text-xs text-gray-500 mt-1">{s.timestamp}</p>
                        {s.coordenadas && (
                          <div className="mt-3 bg-green-50 border-2 border-green-200 rounded-lg p-3">
                            <div className="flex items-center justify-between">
                              <div className="flex-1">
                                <p className="text-xs text-green-700 font-semibold mb-1">üìç COORDENADAS</p>
                                <p className="text-base font-mono font-bold text-green-900">{s.coordenadas}</p>
                              </div>
                              <button
                                onClick={() => {
                                  navigator.clipboard.writeText(s.coordenadas);
                                  showToast('üìã Coordenadas copiadas!', 'success');
                                }}
                                className="ml-3 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                              >
                                üìã Copiar
                              </button>
                            </div>
                            <a
                              href={`https://www.google.com/maps?q=${s.coordenadas}`}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="inline-block mt-2 text-sm text-green-700 hover:text-green-900 underline font-semibold"
                            >
                              üó∫Ô∏è Abrir no Google Maps
                            </a>
                          </div>
                        )}
                        {s.imagemComprovante && (
                          <div className="mt-3">
                            <p className="text-xs text-gray-600 mb-1">Comprovante:</p>
                            <img 
                              src={s.imagemComprovante} 
                              alt="Comprovante" 
                              className="max-h-48 rounded border cursor-pointer hover:opacity-80 transition"
                              onClick={() => setImageModal(s.imagemComprovante)}
                            />
                            <p className="text-xs text-gray-500 mt-1">üì∑ Clique para expandir</p>
                          </div>
                        )}
                        <textarea
                          placeholder="Observa√ß√£o (opcional)"
                          value={formData[`obs_${s.id}`] || ''}
                          onChange={e => setFormData({...formData, [`obs_${s.id}`]: e.target.value, obs: e.target.value})}
                          className="w-full px-3 py-2 border rounded-lg mt-2 text-sm"
                          rows="2"
                        />
                        <div className="flex gap-2 mt-2">
                          <button onClick={() => handleValidate(s.id, true)} className="flex-1 bg-green-600 text-white py-2 rounded-lg">
                            ‚úì Aprovar
                          </button>
                          <button onClick={() => handleValidate(s.id, false)} className="flex-1 bg-red-600 text-white py-2 rounded-lg">
                            ‚úó Rejeitar
                          </button>
                        </div>
                      </div>
                    ))
                  )}
                </div>

                <div className="bg-white rounded-xl shadow p-6">
                  <h2 className="text-lg font-semibold mb-4">Hist√≥rico Completo</h2>
                  <div className="mb-4 flex gap-2">
                    <button
                      onClick={() => setFormData({...formData, filterStatus: 'all'})}
                      className={`px-4 py-2 rounded-lg ${(!formData.filterStatus || formData.filterStatus === 'all') ? 'bg-purple-900 text-white' : 'bg-gray-100'}`}
                    >
                      Todas ({submissions.length})
                    </button>
                    <button
                      onClick={() => setFormData({...formData, filterStatus: 'aprovada'})}
                      className={`px-4 py-2 rounded-lg ${formData.filterStatus === 'aprovada' ? 'bg-green-600 text-white' : 'bg-gray-100'}`}
                    >
                      Aprovadas ({submissions.filter(s => s.status === 'aprovada').length})
                    </button>
                    <button
                      onClick={() => setFormData({...formData, filterStatus: 'rejeitada'})}
                      className={`px-4 py-2 rounded-lg ${formData.filterStatus === 'rejeitada' ? 'bg-red-600 text-white' : 'bg-gray-100'}`}
                    >
                      Rejeitadas ({submissions.filter(s => s.status === 'rejeitada').length})
                    </button>
                  </div>
                  
                  <div className="space-y-3 max-h-96 overflow-y-auto">
                    {submissions
                      .filter(s => !formData.filterStatus || formData.filterStatus === 'all' || s.status === formData.filterStatus)
                      .map(s => (
                        <div key={s.id} className={`border rounded-lg p-4 ${
                          s.status === 'aprovada' ? 'bg-green-50 border-green-200' :
                          s.status === 'rejeitada' ? 'bg-red-50 border-red-200' :
                          'bg-gray-50'
                        }`}>
                          <div className="flex justify-between items-start mb-2">
                            <div>
                              <p className="font-mono text-lg font-bold">OS: {s.ordemServico}</p>
                              <p className="text-sm text-gray-700">{s.fullName} ({s.userCod || s.user_cod})</p>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                              s.status === 'aprovada' ? 'bg-green-600 text-white' :
                              s.status === 'rejeitada' ? 'bg-red-600 text-white' :
                              'bg-yellow-600 text-white'
                            }`}>
                              {s.status?.toUpperCase()}
                            </span>
                          </div>
                          <p className="text-sm text-gray-600 mb-1">Motivo: {s.motivo}</p>
                          {s.coordenadas && (
                            <div className="mt-2 bg-green-50 border border-green-200 rounded p-2">
                              <div className="flex items-center justify-between">
                                <div className="flex-1">
                                  <p className="text-xs text-green-700 font-semibold">üìç Coordenadas</p>
                                  <p className="text-sm font-mono text-green-900">{s.coordenadas}</p>
                                </div>
                                <button
                                  onClick={() => {
                                    navigator.clipboard.writeText(s.coordenadas);
                                    showToast('üìã Coordenadas copiadas!', 'success');
                                  }}
                                  className="ml-2 px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                                >
                                  üìã
                                </button>
                              </div>
                            </div>
                          )}
                          {s.imagemComprovante && (
                            <div className="mt-2">
                              <img 
                                src={s.imagemComprovante} 
                                alt="Comprovante" 
                                className="max-h-32 rounded border cursor-pointer hover:opacity-80 transition"
                                onClick={() => setImageModal(s.imagemComprovante)}
                              />
                              <p className="text-xs text-gray-500 mt-1">üì∑ Clique para expandir</p>
                            </div>
                          )}
                          {s.observacao && (
                            <div className="mt-2 bg-white p-2 rounded border">
                              <p className="text-xs text-gray-600">Observa√ß√£o:</p>
                              <p className="text-sm">{s.observacao}</p>
                            </div>
                          )}
                          <p className="text-xs text-gray-500 mt-2">{s.timestamp}</p>
                        </div>
                      ))}
                  </div>
                </div>
              </>
            )}

            {/* ABA BUSCA DETALHADA */}
            {formData.adminTab === 'search' && (
              <div className="bg-white rounded-xl shadow p-6">
                <h2 className="text-lg font-semibold mb-4">üîç Busca Detalhada</h2>
                
                {/* Filtros e Busca */}
                <div className="mb-4 space-y-3">
                  {/* Busca por OS e COD */}
                  <div className="flex gap-2">
                    <div className="flex-1 relative">
                      <input
                        type="text"
                        placeholder="üîç Buscar por OS ou COD do usu√°rio..."
                        value={formData.searchOS || ''}
                        onChange={e => setFormData({...formData, searchOS: e.target.value})}
                        className="w-full px-4 py-2 border rounded-lg pl-10"
                      />
                      <span className="absolute left-3 top-3 text-gray-400">üîç</span>
                    </div>
                    {formData.searchOS && (
                      <button
                        onClick={() => setFormData({...formData, searchOS: ''})}
                        className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                      >
                        ‚úï Limpar
                      </button>
                    )}
                  </div>

                  {/* Filtro por Data */}
                  <div className="flex flex-wrap gap-2">
                    <button
                      onClick={() => setFormData({...formData, dateFilter: 'today'})}
                      className={`px-4 py-2 rounded-lg ${formData.dateFilter === 'today' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}
                    >
                      üìÖ Hoje
                    </button>
                    <button
                      onClick={() => setFormData({...formData, dateFilter: 'week'})}
                      className={`px-4 py-2 rounded-lg ${formData.dateFilter === 'week' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}
                    >
                      üìÖ Esta Semana
                    </button>
                    <button
                      onClick={() => setFormData({...formData, dateFilter: 'month'})}
                      className={`px-4 py-2 rounded-lg ${formData.dateFilter === 'month' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}
                    >
                      üìÖ Este M√™s
                    </button>
                    <button
                      onClick={() => setFormData({...formData, dateFilter: 'all'})}
                      className={`px-4 py-2 rounded-lg ${(!formData.dateFilter || formData.dateFilter === 'all') ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}
                    >
                      üìÖ Todas
                    </button>
                    <button
                      onClick={() => setFormData({...formData, dateFilter: 'custom', showCustomDate: !formData.showCustomDate})}
                      className={`px-4 py-2 rounded-lg ${formData.dateFilter === 'custom' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}
                    >
                      üìÖ Personalizado
                    </button>
                  </div>

                  {/* Data Personalizada */}
                  {formData.showCustomDate && (
                    <div className="flex gap-2 items-center bg-blue-50 p-3 rounded-lg">
                      <span className="text-sm font-semibold">De:</span>
                      <input
                        type="date"
                        value={formData.startDate || ''}
                        onChange={e => setFormData({...formData, startDate: e.target.value, dateFilter: 'custom'})}
                        className="px-3 py-2 border rounded"
                      />
                      <span className="text-sm font-semibold">At√©:</span>
                      <input
                        type="date"
                        value={formData.endDate || ''}
                        onChange={e => setFormData({...formData, endDate: e.target.value, dateFilter: 'custom'})}
                        className="px-3 py-2 border rounded"
                      />
                      <button
                        onClick={() => setFormData({...formData, showCustomDate: false, dateFilter: 'all', startDate: '', endDate: ''})}
                        className="px-3 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200"
                      >
                        ‚úï
                      </button>
                    </div>
                  )}

                  {/* Filtro por Status */}
                  <div className="flex gap-2">
                    <button
                      onClick={() => setFormData({...formData, filterStatusSearch: 'all'})}
                      className={`px-4 py-2 rounded-lg ${(!formData.filterStatusSearch || formData.filterStatusSearch === 'all') ? 'bg-purple-900 text-white' : 'bg-gray-100'}`}
                    >
                      Todas ({submissions.length})
                    </button>
                    <button
                      onClick={() => setFormData({...formData, filterStatusSearch: 'aprovada'})}
                      className={`px-4 py-2 rounded-lg ${formData.filterStatusSearch === 'aprovada' ? 'bg-green-600 text-white' : 'bg-gray-100'}`}
                    >
                      Aprovadas ({submissions.filter(s => s.status === 'aprovada').length})
                    </button>
                    <button
                      onClick={() => setFormData({...formData, filterStatusSearch: 'rejeitada'})}
                      className={`px-4 py-2 rounded-lg ${formData.filterStatusSearch === 'rejeitada' ? 'bg-red-600 text-white' : 'bg-gray-100'}`}
                    >
                      Rejeitadas ({submissions.filter(s => s.status === 'rejeitada').length})
                    </button>
                    <button
                      onClick={() => setFormData({...formData, filterStatusSearch: 'pendente'})}
                      className={`px-4 py-2 rounded-lg ${formData.filterStatusSearch === 'pendente' ? 'bg-yellow-600 text-white' : 'bg-gray-100'}`}
                    >
                      Pendentes ({submissions.filter(s => s.status === 'pendente').length})
                    </button>
                  </div>
                </div>
                
                {/* Contador de Resultados */}
                <div className="mb-3 flex items-center justify-between bg-gray-50 px-4 py-2 rounded-lg">
                  <p className="text-sm text-gray-600">
                    Exibindo <strong className="text-purple-900">
                      {submissions.filter(s => {
                        if (formData.filterStatusSearch && formData.filterStatusSearch !== 'all' && s.status !== formData.filterStatusSearch) return false;
                        if (formData.searchOS && 
                            !s.ordemServico.toLowerCase().includes(formData.searchOS.toLowerCase()) &&
                            !(s.userCod || s.user_cod || '').toLowerCase().includes(formData.searchOS.toLowerCase())) return false;
                        const submissionDate = new Date(s.created_at);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        if (formData.dateFilter === 'today') {
                          const tomorrow = new Date(today);
                          tomorrow.setDate(tomorrow.getDate() + 1);
                          if (submissionDate < today || submissionDate >= tomorrow) return false;
                        } else if (formData.dateFilter === 'week') {
                          const weekAgo = new Date(today);
                          weekAgo.setDate(weekAgo.getDate() - 7);
                          if (submissionDate < weekAgo) return false;
                        } else if (formData.dateFilter === 'month') {
                          const monthAgo = new Date(today);
                          monthAgo.setMonth(monthAgo.getMonth() - 1);
                          if (submissionDate < monthAgo) return false;
                        } else if (formData.dateFilter === 'custom' && formData.startDate && formData.endDate) {
                          const start = new Date(formData.startDate);
                          const end = new Date(formData.endDate);
                          end.setHours(23, 59, 59, 999);
                          if (submissionDate < start || submissionDate > end) return false;
                        }
                        return true;
                      }).length}
                    </strong> de <strong>{submissions.length}</strong> solicita√ß√µes
                  </p>
                  {(formData.searchOS || formData.dateFilter || formData.filterStatusSearch !== 'all') && (
                    <button
                      onClick={() => setFormData({
                        ...formData,
                        searchOS: '',
                        dateFilter: 'all',
                        filterStatusSearch: 'all',
                        showCustomDate: false,
                        startDate: '',
                        endDate: ''
                      })}
                      className="text-sm text-red-600 hover:text-red-800 font-semibold"
                    >
                      üîÑ Limpar todos os filtros
                    </button>
                  )}
                </div>
                
                {/* Resultados */}
                <div className="space-y-3 max-h-96 overflow-y-auto">
                  {submissions
                    .filter(s => {
                      if (formData.filterStatusSearch && formData.filterStatusSearch !== 'all' && s.status !== formData.filterStatusSearch) return false;
                      if (formData.searchOS && 
                          !s.ordemServico.toLowerCase().includes(formData.searchOS.toLowerCase()) &&
                          !(s.userCod || s.user_cod || '').toLowerCase().includes(formData.searchOS.toLowerCase())) return false;
                      const submissionDate = new Date(s.created_at);
                      const today = new Date();
                      today.setHours(0, 0, 0, 0);
                      if (formData.dateFilter === 'today') {
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        if (submissionDate < today || submissionDate >= tomorrow) return false;
                      } else if (formData.dateFilter === 'week') {
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        if (submissionDate < weekAgo) return false;
                      } else if (formData.dateFilter === 'month') {
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        if (submissionDate < monthAgo) return false;
                      } else if (formData.dateFilter === 'custom' && formData.startDate && formData.endDate) {
                        const start = new Date(formData.startDate);
                        const end = new Date(formData.endDate);
                        end.setHours(23, 59, 59, 999);
                        if (submissionDate < start || submissionDate > end) return false;
                      }
                      return true;
                    })
                    .length === 0 ? (
                      <div className="text-center py-12">
                        <div className="text-6xl mb-4">üîç</div>
                        <p className="text-gray-500 text-lg font-semibold">Nenhuma solicita√ß√£o encontrada</p>
                        <p className="text-gray-400 text-sm mt-2">Tente ajustar os filtros ou fazer uma nova busca</p>
                      </div>
                    ) : (
                      submissions
                        .filter(s => {
                          if (formData.filterStatusSearch && formData.filterStatusSearch !== 'all' && s.status !== formData.filterStatusSearch) return false;
                          if (formData.searchOS && 
                              !s.ordemServico.toLowerCase().includes(formData.searchOS.toLowerCase()) &&
                              !(s.userCod || s.user_cod || '').toLowerCase().includes(formData.searchOS.toLowerCase())) return false;
                          const submissionDate = new Date(s.created_at);
                          const today = new Date();

            {/* ====== ABA: ESTAT√çSTICAS (NOVA!) ====== */}
            {formData.adminTab === 'stats' && (
              <div className="space-y-6">
                <div className="bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                  <h2 className="text-2xl font-bold mb-2">üìà Estat√≠sticas e An√°lises</h2>
                  <p className="text-purple-100">Vis√£o completa do desempenho e distribui√ß√£o de solicita√ß√µes</p>
                </div>

                {/* Gr√°ficos */}
                <div className="grid md:grid-cols-2 gap-6">
                  <PieChart 
                    data={(() => {
                      const motivos = {};
                      submissions.forEach(s => {
                        motivos[s.motivo] = (motivos[s.motivo] || 0) + 1;
                      });
                      return Object.entries(motivos).map(([label, value]) => ({ label, value }));
                    })()} 
                    title="üìä Distribui√ß√£o por Motivo"
                  />
                  
                  <PieChart 
                    data={[
                      { label: 'Aprovadas', value: submissions.filter(s => s.status === 'aprovada').length },
                      { label: 'Rejeitadas', value: submissions.filter(s => s.status === 'rejeitada').length },
                      { label: 'Pendentes', value: submissions.filter(s => s.status === 'pendente').length }
                    ]} 
                    title="üìä Distribui√ß√£o por Status"
                  />
                </div>

                {/* Ranking */}
                <TechRanking submissions={submissions} />

                {/* Cards de Estat√≠sticas Adicionais */}
                <div className="grid md:grid-cols-4 gap-4">
                  <div className="bg-white rounded-xl shadow p-6">
                    <p className="text-sm text-gray-600">Taxa de Aprova√ß√£o</p>
                    <p className="text-3xl font-bold text-green-600">
                      {submissions.length > 0 
                        ? ((submissions.filter(s => s.status === 'aprovada').length / submissions.length) * 100).toFixed(1) 
                        : 0}%
                    </p>
                  </div>
                  <div className="bg-white rounded-xl shadow p-6">
                    <p className="text-sm text-gray-600">Taxa de Rejei√ß√£o</p>
                    <p className="text-3xl font-bold text-red-600">
                      {submissions.length > 0 
                        ? ((submissions.filter(s => s.status === 'rejeitada').length / submissions.length) * 100).toFixed(1) 
                        : 0}%
                    </p>
                  </div>
                  <div className="bg-white rounded-xl shadow p-6">
                    <p className="text-sm text-gray-600">M√©dia por T√©cnico</p>
                    <p className="text-3xl font-bold text-purple-600">
                      {users.length > 0 ? (submissions.length / users.length).toFixed(1) : 0}
                    </p>
                  </div>
                  <div className="bg-white rounded-xl shadow p-6">
                    <p className="text-sm text-gray-600">Total de T√©cnicos</p>
                    <p className="text-3xl font-bold text-blue-600">{users.length}</p>
                  </div>
                </div>
              </div>
            )}
                          if (formData.dateFilter === 'today') {
                            const tomorrow = new Date(today);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            if (submissionDate < today || submissionDate >= tomorrow) return false;
                          } else if (formData.dateFilter === 'week') {
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            if (submissionDate < weekAgo) return false;
                          } else if (formData.dateFilter === 'month') {
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            if (submissionDate < monthAgo) return false;
                          } else if (formData.dateFilter === 'custom' && formData.startDate && formData.endDate) {
                            const start = new Date(formData.startDate);
                            const end = new Date(formData.endDate);
                            end.setHours(23, 59, 59, 999);
                            if (submissionDate < start || submissionDate > end) return false;
                          }
                          return true;
                        })
                        .map(s => (
                          <div key={s.id} className={`border rounded-lg p-4 ${
                            s.status === 'aprovada' ? 'bg-green-50 border-green-200' :
                            s.status === 'rejeitada' ? 'bg-red-50 border-red-200' :
                            s.status === 'pendente' ? 'bg-yellow-50 border-yellow-200' :
                            'bg-gray-50'
                          }`}>
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <p className="font-mono text-lg font-bold">OS: {s.ordemServico}</p>
                                <p className="text-sm text-gray-700">{s.fullName} ({s.userCod || s.user_cod})</p>
                              </div>
                              <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                s.status === 'aprovada' ? 'bg-green-600 text-white' :
                                s.status === 'rejeitada' ? 'bg-red-600 text-white' :
                                'bg-yellow-600 text-white'
                              }`}>
                                {s.status?.toUpperCase()}
                              </span>
                            </div>
                            <p className="text-sm text-gray-600 mb-1">Motivo: {s.motivo}</p>
                            {s.coordenadas && (
                              <div className="mt-2 bg-green-50 border border-green-200 rounded p-2">
                                <div className="flex items-center justify-between">
                                  <div className="flex-1">
                                    <p className="text-xs text-green-700 font-semibold">üìç Coordenadas</p>
                                    <p className="text-sm font-mono text-green-900">{s.coordenadas}</p>
                                  </div>
                                  <button
                                    onClick={() => {
                                      navigator.clipboard.writeText(s.coordenadas);
                                      showToast('üìã Coordenadas copiadas!', 'success');
                                    }}
                                    className="ml-2 px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                                  >
                                    üìã
                                  </button>
                                </div>
                              </div>
                            )}
                            {s.imagemComprovante && (
                              <div className="mt-2">
                                <img 
                                  src={s.imagemComprovante} 
                                  alt="Comprovante" 
                                  className="max-h-32 rounded border cursor-pointer hover:opacity-80 transition"
                                  onClick={() => setImageModal(s.imagemComprovante)}
                                />
                                <p className="text-xs text-gray-500 mt-1">üì∑ Clique para expandir</p>
                              </div>
                            )}
                            {s.observacao && (
                              <div className="mt-2 bg-white p-2 rounded border">
                                <p className="text-xs text-gray-600">Observa√ß√£o:</p>
                                <p className="text-sm">{s.observacao}</p>
                              </div>
                            )}
                            <p className="text-xs text-gray-500 mt-2">{s.timestamp}</p>
                          </div>
                        ))
                    )}
                </div>
              </div>
            )}

            {/* ABA GERENCIAR USU√ÅRIOS */}
            {formData.adminTab === 'users' && (
              <div className="bg-white rounded-xl shadow p-6">
                <h2 className="text-lg font-semibold mb-4">üë• Gerenciar Usu√°rios</h2>
                <div className="space-y-3">
                  {users.map(u => (
                    <div key={u.codProfissional} className="border rounded-lg p-4 flex items-center justify-between hover:bg-gray-50 transition">
                      <div className="flex-1">
                        <p className="font-semibold text-gray-800">{u.fullName}</p>
                        <p className="text-sm text-gray-600">COD: {u.codProfissional}</p>
                        <p className="text-xs text-gray-500">Cadastrado em: {u.createdAt}</p>
                      </div>
                      <div className="flex gap-2">
                        <input
                          type="password"

            {/* ====== ABA: CRIAR ADMIN (NOVA!) ====== */}
            {formData.adminTab === 'create-admin' && (
              <div className="max-w-2xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg p-8">
                  <div className="mb-6">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                      <span className="text-3xl">‚ûï</span>
                      Criar Novo Administrador
                    </h2>
                    <p className="text-gray-600 mt-2">Adicione um novo usu√°rio com permiss√µes de administrador</p>
                  </div>

                  <form onSubmit={async (e) => {
                    e.preventDefault();
                    
                    if (!formData.newAdminCod || !formData.newAdminName || !formData.newAdminPassword) {
                      showToast('‚ùå Preencha todos os campos', 'error');
                      return;
                    }

                    if (formData.newAdminPassword.length < 4) {
                      showToast('‚ùå Senha muito curta (m√≠n. 4 caracteres)', 'error');
                      return;
                    }

                    if (formData.newAdminPassword !== formData.newAdminPasswordConfirm) {
                      showToast('‚ùå As senhas n√£o coincidem', 'error');
                      return;
                    }

                    setLoading(true);
                    try {
                      const res = await fetch(`${API_URL}/users/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                          codProfissional: formData.newAdminCod,
                          password: formData.newAdminPassword,
                          fullName: formData.newAdminName,
                          role: 'admin'
                        })
                      });

                      if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || 'Erro ao criar admin');
                      }

                      showToast('‚úÖ Admin criado com sucesso!', 'success');
                      setFormData({
                        ...formData,
                        newAdminCod: '',
                        newAdminName: '',
                        newAdminPassword: '',
                        newAdminPasswordConfirm: ''
                      });
                      loadUsers();
                    } catch (err) {
                      showToast(`‚ùå ${err.message}`, 'error');
                    } finally {
                      setLoading(false);
                    }
                  }} className="space-y-6">
                    
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        C√≥digo Profissional *
                      </label>
                      <input
                        type="text"
                        value={formData.newAdminCod || ''}
                        onChange={(e) => setFormData({...formData, newAdminCod: e.target.value})}
                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none transition"
                        placeholder="Ex: ADM001"
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        Nome Completo *
                      </label>
                      <input
                        type="text"
                        value={formData.newAdminName || ''}
                        onChange={(e) => setFormData({...formData, newAdminName: e.target.value})}
                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none transition"
                        placeholder="Ex: Jo√£o Silva"
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        Senha *
                      </label>
                      <input
                        type="password"
                        value={formData.newAdminPassword || ''}
                        onChange={(e) => setFormData({...formData, newAdminPassword: e.target.value})}
                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none transition"
                        placeholder="M√≠nimo 4 caracteres"
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        Confirmar Senha *
                      </label>
                      <input
                        type="password"
                        value={formData.newAdminPasswordConfirm || ''}
                        onChange={(e) => setFormData({...formData, newAdminPasswordConfirm: e.target.value})}
                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none transition"
                        placeholder="Digite a senha novamente"
                        required
                      />
                    </div>

                    <div className="flex gap-4">
                      <button
                        type="submit"
                        disabled={loading}
                        className="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {loading ? '‚è≥ Criando...' : '‚úÖ Criar Administrador'}
                      </button>
                      <button
                        type="button"
                        onClick={() => setFormData({
                          ...formData,
                          newAdminCod: '',
                          newAdminName: '',
                          newAdminPassword: '',
                          newAdminPasswordConfirm: ''
                        })}
                        className="px-6 py-3 border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 transition"
                      >
                        üîÑ Limpar
                      </button>
                    </div>
                  </form>

                  <div className="mt-8 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                    <p className="text-sm text-blue-800">
                      <b>üí° Dica:</b> O novo administrador poder√° fazer login com o c√≥digo profissional e senha cadastrados.
                    </p>
                  </div>
                </div>
              </div>
            )}
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        if (submissionDate < weekAgo) return false;
                      } else if (formData.dateFilter === 'month') {
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        if (submissionDate < monthAgo) return false;
                      } else if (formData.dateFilter === 'custom' && formData.startDate && formData.endDate) {
                        const start = new Date(formData.startDate);
                        const end = new Date(formData.endDate);
                        end.setHours(23, 59, 59, 999);
                        if (submissionDate < start || submissionDate > end) return false;
                      }
                      return true;
                    })
                    .length === 0 ? (
                      <div className="text-center py-12">
                        <div className="text-6xl mb-4">üîç</div>
                        <p className="text-gray-500 text-lg font-semibold">Nenhuma solicita√ß√£o encontrada</p>
                        <p className="text-gray-400 text-sm mt-2">Tente ajustar os filtros ou fazer uma nova busca</p>
                      </div>
                    ) : (
                      submissions
                        .filter(s => {
                          if (formData.filterStatusSearch && formData.filterStatusSearch !== 'all' && s.status !== formData.filterStatusSearch) return false;
                          if (formData.searchOS && 
                              !s.ordemServico.toLowerCase().includes(formData.searchOS.toLowerCase()) &&
                              !(s.userCod || s.user_cod || '').toLowerCase().includes(formData.searchOS.toLowerCase())) return false;
                          const submissionDate = new Date(s.created_at);
                          const today = new Date();
                          today.setHours(0, 0, 0, 0);
                          if (formData.dateFilter === 'today') {
                            const tomorrow = new Date(today);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            if (submissionDate < today || submissionDate >= tomorrow) return false;
                          } else if (formData.dateFilter === 'week') {
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            if (submissionDate < weekAgo) return false;
                          } else if (formData.dateFilter === 'month') {
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            if (submissionDate < monthAgo) return false;
                          } else if (formData.dateFilter === 'custom' && formData.startDate && formData.endDate) {
                            const start = new Date(formData.startDate);
                            const end = new Date(formData.endDate);
                            end.setHours(23, 59, 59, 999);
                            if (submissionDate < start || submissionDate > end) return false;
                          }
                          return true;
                        })
                        .map(s => (
                          <div key={s.id} className={`border rounded-lg p-4 ${
                            s.status === 'aprovada' ? 'bg-green-50 border-green-200' :
                            s.status === 'rejeitada' ? 'bg-red-50 border-red-200' :
                            s.status === 'pendente' ? 'bg-yellow-50 border-yellow-200' :
                            'bg-gray-50'
                          }`}>
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <p className="font-mono text-lg font-bold">OS: {s.ordemServico}</p>
                                <p className="text-sm text-gray-700">{s.fullName} ({s.userCod || s.user_cod})</p>
                              </div>
                              <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                s.status === 'aprovada' ? 'bg-green-600 text-white' :
                                s.status === 'rejeitada' ? 'bg-red-600 text-white' :
                                'bg-yellow-600 text-white'
                              }`}>
                                {s.status?.toUpperCase()}
                              </span>
                            </div>
                            <p className="text-sm text-gray-600 mb-1">Motivo: {s.motivo}</p>
                            {s.coordenadas && (
                              <div className="mt-2 bg-green-50 border border-green-200 rounded p-2">
                                <div className="flex items-center justify-between">
                                  <div className="flex-1">
                                    <p className="text-xs text-green-700 font-semibold">üìç Coordenadas</p>
                                    <p className="text-sm font-mono text-green-900">{s.coordenadas}</p>
                                  </div>
                                  <button
                                    onClick={() => {
                                      navigator.clipboard.writeText(s.coordenadas);
                                      showToast('üìã Coordenadas copiadas!', 'success');
                                    }}
                                    className="ml-2 px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                                  >
                                    üìã
                                  </button>
                                </div>
                              </div>
                            )}
                            {s.imagemComprovante && (
                              <div className="mt-2">
                                <img 
                                  src={s.imagemComprovante} 
                                  alt="Comprovante" 
                                  className="max-h-32 rounded border cursor-pointer hover:opacity-80 transition"
                                  onClick={() => setImageModal(s.imagemComprovante)}
                                />
                                <p className="text-xs text-gray-500 mt-1">üì∑ Clique para expandir</p>
                              </div>
                            )}
                            {s.observacao && (
                              <div className="mt-2 bg-white p-2 rounded border">
                                <p className="text-xs text-gray-600">Observa√ß√£o:</p>
                                <p className="text-sm">{s.observacao}</p>
                              </div>
                            )}
                            <p className="text-xs text-gray-500 mt-2">{s.timestamp}</p>
                          </div>
                        ))
                    )}
                </div>
              </div>
            )}

            {/* ABA GERENCIAR USU√ÅRIOS */}
            {formData.adminTab === 'users' && (
              <div className="bg-white rounded-xl shadow p-6">
                <h2 className="text-lg font-semibold mb-4">üë• Gerenciar Usu√°rios</h2>
                <div className="space-y-3">
                  {users.map(u => (
                    <div key={u.codProfissional} className="border rounded-lg p-4 flex items-center justify-between hover:bg-gray-50 transition">
                      <div className="flex-1">
                        <p className="font-semibold text-gray-800">{u.fullName}</p>
                        <p className="text-sm text-gray-600">COD: {u.codProfissional}</p>
                        <p className="text-xs text-gray-500">Cadastrado em: {u.createdAt}</p>
                      </div>
                      <div className="flex gap-2">
                        <input
                          type="password"
                          placeholder="Nova senha"
                          value={formData[`newpass_${u.codProfissional}`] || ''}
                          onChange={e => setFormData({...formData, [`newpass_${u.codProfissional}`]: e.target.value})}
                          className="px-3 py-2 border rounded text-sm w-32"
                        />
                        <button
                          onClick={async () => {
                            const newPassword = formData[`newpass_${u.codProfissional}`];
                            if (!newPassword) {
                              showToast('Digite uma nova senha', 'error');
                              return;
                            }
                            if (newPassword.length < 4) {
                              showToast('Senha muito curta (m√≠n. 4 caracteres)', 'error');
                              return;
                            }
                            try {
                              await fetch(`${API_URL}/users/reset-password`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ codProfissional: u.codProfissional, newPassword })
                              });
                              showToast('‚úÖ Senha alterada com sucesso!', 'success');
                              setFormData({...formData, [`newpass_${u.codProfissional}`]: ''});
                            } catch (err) {
                              showToast('Erro ao alterar senha', 'error');
                            }
                          }}
                          className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm font-semibold"
                        >
                          üîë Resetar
                        </button>
                      </div>
                    </div>
                  ))}
                </div>

            {/* ABA ESTAT√çSTICAS */}
            {formData.adminTab === 'stats' && (
              <div className="space-y-6">
                <div className="grid md:grid-cols-2 gap-6">
                  <PieChart 
                    data={[
                      'Instala√ß√£o',
                      'Manuten√ß√£o Preventiva', 
                      'Manuten√ß√£o Corretiva',
                      'Ajuste de Ped√°gio (Campinas e Recife)',
                      'Treinamento',
                      'Outros'
                    ].map(motivo => ({
                      label: motivo,
                      value: submissions.filter(s => s.motivo === motivo).length
                    }))}
                    title="üìä Distribui√ß√£o por Motivo"
                  />
                  <PieChart 
                    data={[
                      { label: '‚úì Aprovadas', value: submissions.filter(s => s.status === 'aprovada').length },
                      { label: '‚úó Rejeitadas', value: submissions.filter(s => s.status === 'rejeitada').length },
                      { label: '‚è≥ Pendentes', value: submissions.filter(s => s.status === 'pendente').length }
                    ]}
                    title="üìà Status das Solicita√ß√µes"
                  />
                </div>
                <TechRanking submissions={submissions} />
              </div>
            )}

            {/* ABA CRIAR ADMIN */}
            {formData.adminTab === 'createadmin' && (
              <div className="bg-white rounded-xl shadow p-6 max-w-2xl mx-auto">
                <h2 className="text-lg font-semibold mb-4">‚ûï Criar Novo Admin</h2>
                <form onSubmit={async (e) => {
                  e.preventDefault();
                  if (formData.newAdminPassword !== formData.newAdminPasswordConfirm) {
                    showToast('As senhas n√£o coincidem!', 'error');
                    return;
                  }
                  if (formData.newAdminPassword.length < 4) {
                    showToast('Senha muito curta (m√≠n. 4 caracteres)', 'error');
                    return;
                  }
                  setLoading(true);
                  try {
                    const res = await fetch(`${API_URL}/users/register`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        codProfissional: formData.newAdminCod,
                        password: formData.newAdminPassword,
                        fullName: formData.newAdminName,
                        role: 'admin'
                      })
                    });
                    if (!res.ok) throw new Error('Erro ao criar admin');
                    showToast('‚úÖ Admin criado com sucesso!', 'success');
                    setFormData({...formData, newAdminCod: '', newAdminPassword: '', newAdminPasswordConfirm: '', newAdminName: ''});
                    loadUsers();
                  } catch (err) {
                    showToast('‚ùå Erro ao criar admin', 'error');
                  } finally {
                    setLoading(false);
                  }
                }} className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">C√≥digo do Profissional *</label>
                    <input
                      type="text"
                      value={formData.newAdminCod || ''}
                      onChange={e => setFormData({...formData, newAdminCod: e.target.value})}
                      className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Nome Completo *</label>
                    <input
                      type="text"
                      value={formData.newAdminName || ''}
                      onChange={e => setFormData({...formData, newAdminName: e.target.value})}
                      className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Senha *</label>
                    <input
                      type="password"
                      value={formData.newAdminPassword || ''}
                      onChange={e => setFormData({...formData, newAdminPassword: e.target.value})}
                      className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Confirmar Senha *</label>
                    <input
                      type="password"
                      value={formData.newAdminPasswordConfirm || ''}
                      onChange={e => setFormData({...formData, newAdminPasswordConfirm: e.target.value})}
                      className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
                      required
                    />
                  </div>
                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold disabled:opacity-50"
                  >
                    {loading ? '‚è≥ Criando...' : '‚úÖ Criar Admin'}
                  </button>
                </form>
              </div>
            )}
              </div>
            )}
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
