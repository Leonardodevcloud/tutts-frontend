<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Tutts - Solicita√ß√µes e Saque Emergencial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .toast { animation: slideIn 0.3s ease-out; }
    .row-green { background-color: #dcfce7 !important; border-left: 4px solid #22c55e !important; }
    .row-red { background-color: #fee2e2 !important; border-left: 4px solid #ef4444 !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_URL = 'https://tutts-backend-production.up.railway.app/api';

    // ========== COMPONENTES UTILIT√ÅRIOS ==========
    const Toast = ({ message, type }) => (
      <div className={`fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-2xl toast ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white font-semibold flex items-center gap-3`}>
        <span className="text-2xl">{type === 'success' ? '‚úì' : '‚úó'}</span>
        <span>{message}</span>
      </div>
    );

    const LoadingOverlay = ({ message = 'Carregando...' }) => (
      <div className="fixed inset-0 bg-black bg-opacity-30 z-50 flex items-center justify-center">
        <div className="bg-white rounded-xl p-6 shadow-2xl flex flex-col items-center gap-3">
          <div className="w-10 h-10 border-4 border-purple-600 border-t-transparent rounded-full animate-spin"></div>
          <p className="text-gray-700 font-semibold">{message}</p>
        </div>
      </div>
    );

    const ImageModal = ({ imageUrl, onClose }) => (
      <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onClick={onClose}>
        <div className="relative max-w-4xl max-h-screen">
          <button onClick={onClose} className="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300">‚úï</button>
          <img src={imageUrl} alt="Expandido" className="max-w-full max-h-screen rounded-lg shadow-2xl" onClick={e => e.stopPropagation()} />
        </div>
      </div>
    );

    // ========== GR√ÅFICO PIE CHART ==========
    const PieChart = ({ data, title }) => {
      const total = data.reduce((sum, item) => sum + item.value, 0);
      if (total === 0) return (
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-lg font-semibold mb-4">{title}</h3>
          <p className="text-gray-500 text-center py-8">Sem dados dispon√≠veis</p>
        </div>
      );

      let currentAngle = 0;
      const slices = data.map((item, index) => {
        const percentage = (item.value / total) * 100;
        const angle = (percentage / 100) * 360;
        const startAngle = currentAngle;
        currentAngle += angle;
        const x1 = 100 + 90 * Math.cos((startAngle - 90) * Math.PI / 180);
        const y1 = 100 + 90 * Math.sin((startAngle - 90) * Math.PI / 180);
        const x2 = 100 + 90 * Math.cos((currentAngle - 90) * Math.PI / 180);
        const y2 = 100 + 90 * Math.sin((currentAngle - 90) * Math.PI / 180);
        const largeArc = angle > 180 ? 1 : 0;
        return { ...item, path: `M 100 100 L ${x1} ${y1} A 90 90 0 ${largeArc} 1 ${x2} ${y2} Z`, percentage: percentage.toFixed(1) };
      });

      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-lg font-semibold mb-4">{title}</h3>
          <div className="flex flex-col md:flex-row items-center gap-6">
            <svg viewBox="0 0 200 200" className="w-48 h-48">
              {slices.map((s, i) => <path key={i} d={s.path} fill={s.color} className="hover:opacity-80 transition-opacity cursor-pointer" />)}
            </svg>
            <div className="flex-1 space-y-2">
              {slices.map((s, i) => (
                <div key={i} className="flex items-center gap-2">
                  <div className="w-4 h-4 rounded" style={{backgroundColor: s.color}}></div>
                  <span className="text-sm flex-1">{s.label}</span>
                  <span className="font-semibold">{s.value}</span>
                  <span className="text-gray-500 text-sm">({s.percentage}%)</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ========== GR√ÅFICO DE MOTIVOS ==========
    const MotivosPieChart = ({ submissions }) => {
      const motivos = {};
      submissions.forEach(s => { motivos[s.motivo] = (motivos[s.motivo] || 0) + 1; });
      const colors = ['#7c3aed', '#2563eb', '#059669', '#dc2626', '#ea580c', '#8b5cf6'];
      const total = submissions.length;
      const data = Object.entries(motivos).map(([motivo, count], index) => ({
        motivo, count, percentage: ((count / total) * 100).toFixed(1), color: colors[index % colors.length]
      }));

      let currentAngle = 0;
      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h2 className="text-lg font-semibold mb-4">üìä Distribui√ß√£o por Motivo</h2>
          {total === 0 ? <p className="text-gray-500">Nenhuma solicita√ß√£o</p> : (
            <div className="flex flex-col md:flex-row items-center gap-6">
              <svg viewBox="0 0 200 200" className="w-48 h-48">
                {data.map((item, index) => {
                  const angle = (item.count / total) * 360;
                  const startAngle = currentAngle;
                  currentAngle += angle;
                  const x1 = 100 + 90 * Math.cos((startAngle - 90) * Math.PI / 180);
                  const y1 = 100 + 90 * Math.sin((startAngle - 90) * Math.PI / 180);
                  const x2 = 100 + 90 * Math.cos((startAngle + angle - 90) * Math.PI / 180);
                  const y2 = 100 + 90 * Math.sin((startAngle + angle - 90) * Math.PI / 180);
                  const largeArc = angle > 180 ? 1 : 0;
                  return <path key={index} d={`M 100 100 L ${x1} ${y1} A 90 90 0 ${largeArc} 1 ${x2} ${y2} Z`} fill={item.color} stroke="white" strokeWidth="2" />;
                })}
                <circle cx="100" cy="100" r="50" fill="white" />
                <text x="100" y="95" textAnchor="middle" className="text-2xl font-bold" fill="#1f2937">{total}</text>
                <text x="100" y="110" textAnchor="middle" className="text-xs" fill="#6b7280">Total</text>
              </svg>
              <div className="flex-1 space-y-2">
                {data.map((item, i) => (
                  <div key={i} className="flex items-center gap-3">
                    <div className="w-4 h-4 rounded" style={{ backgroundColor: item.color }} />
                    <div className="flex-1">
                      <p className="text-sm font-medium text-gray-800 truncate">{item.motivo}</p>
                      <p className="text-xs text-gray-500">{item.count} ({item.percentage}%)</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    // ========== RANKING DE T√âCNICOS ==========
    const TechRanking = ({ submissions }) => {
      const stats = {};
      submissions.forEach(s => {
        const tech = s.fullName || 'Desconhecido';
        if (!stats[tech]) stats[tech] = { total: 0, aprovadas: 0, rejeitadas: 0, pendentes: 0 };
        stats[tech].total++;
        if (s.status === 'aprovada') stats[tech].aprovadas++;
        else if (s.status === 'rejeitada') stats[tech].rejeitadas++;
        else stats[tech].pendentes++;
      });

      const ranking = Object.entries(stats).map(([name, data]) => ({
        name, ...data, aprovacao: data.total > 0 ? ((data.aprovadas / data.total) * 100).toFixed(1) : 0
      })).sort((a, b) => b.total - a.total);

      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-lg font-semibold mb-4">üèÜ Ranking de Profissionais</h3>
          {ranking.length === 0 ? <p className="text-gray-500 text-center py-8">Sem dados</p> : (
            <div className="space-y-3">
              {ranking.map((tech, i) => (
                <div key={i} className="flex items-center gap-4 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                  <div className={`text-2xl font-bold w-8 ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : i === 2 ? 'text-orange-600' : 'text-gray-400'}`}>{i + 1}¬∫</div>
                  <div className="flex-1">
                    <p className="font-semibold text-gray-800">{tech.name}</p>
                    <div className="flex gap-4 text-sm text-gray-600 mt-1">
                      <span>Total: <b>{tech.total}</b></span>
                      <span className="text-green-600">‚úì {tech.aprovadas}</span>
                      <span className="text-red-600">‚úó {tech.rejeitadas}</span>
                      <span className="text-yellow-600">‚è≥ {tech.pendentes}</span>
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="text-2xl font-bold text-purple-600">{tech.aprovacao}%</div>
                    <div className="text-xs text-gray-500">aprova√ß√£o</div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    };

    // ========== COMPONENTE PRINCIPAL ==========
    const App = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(false);
      const [globalLoading, setGlobalLoading] = useState(false);
      const [toast, setToast] = useState(null);
      const [formData, setFormData] = useState({});
      const [imageModal, setImageModal] = useState(null);
      const [lastActivity, setLastActivity] = useState(Date.now());

      // Estados - Solicita√ß√µes
      const [submissions, setSubmissions] = useState([]);
      const [users, setUsers] = useState([]);

      // Estados - Saque Emergencial
      const [termsAccepted, setTermsAccepted] = useState(false);
      const [financialData, setFinancialData] = useState(null);
      const [withdrawals, setWithdrawals] = useState([]);
      const [allWithdrawals, setAllWithdrawals] = useState([]);
      const [gratuities, setGratuities] = useState([]);
      const [userGratuities, setUserGratuities] = useState([]);
      const [restrictedList, setRestrictedList] = useState([]);
      const [dashboardData, setDashboardData] = useState({});

      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };

      // Auto-logout 5 min
      useEffect(() => {
        if (!user) return;
        const TIMEOUT = 5 * 60 * 1000;
        const reset = () => setLastActivity(Date.now());
        const events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];
        events.forEach(e => window.addEventListener(e, reset));
        const check = setInterval(() => {
          if (Date.now() - lastActivity > TIMEOUT) {
            showToast('‚è∞ Sess√£o expirada', 'error');
            setTimeout(() => { setUser(null); setFormData({}); }, 1500);
          }
        }, 30000);
        return () => { events.forEach(e => window.removeEventListener(e, reset)); clearInterval(check); };
      }, [user, lastActivity]);

      // Carregar dados ao logar
      useEffect(() => {
        if (!user) return;
        loadSubmissions();
        if (user.role === 'admin') loadUsers();
        if (user.role === 'user') { checkTerms(); loadUserWithdrawals(); loadUserGratuities(); }
        if (user.role === 'admin_financeiro') { loadAllWithdrawals(); loadAllGratuities(); loadRestricted(); loadDashboard(); }
      }, [user]);

      // ========== FUN√á√ïES DE CARREGAMENTO ==========
      const loadSubmissions = async () => {
        try {
          const query = user.role === 'user' ? `?userId=${user.id}&userCod=${user.cod_profissional}` : '';
          const res = await fetch(`${API_URL}/submissions${query}`);
          const data = await res.json();
          setSubmissions(data.map(s => ({
            ...s, ordemServico: s.ordem_servico, codProfissional: s.user_cod, fullName: s.user_name,
            temImagem: s.tem_imagem, imagemComprovante: null, timestamp: new Date(s.created_at).toLocaleString('pt-BR')
          })));
        } catch (err) { console.error(err); }
      };

      const loadUsers = async () => {
        try {
          const res = await fetch(`${API_URL}/users`);
          const data = await res.json();
          setUsers(data.map(u => ({ codProfissional: u.cod_profissional, fullName: u.full_name, role: u.role, createdAt: new Date(u.created_at).toLocaleString('pt-BR') })));
        } catch (err) { console.error(err); }
      };

      const loadImagem = async (id) => {
        try {
          const res = await fetch(`${API_URL}/submissions/${id}/imagem`);
          const data = await res.json();
          setSubmissions(prev => prev.map(s => s.id === id ? {...s, imagemComprovante: data.imagem} : s));
        } catch (err) { showToast('Erro ao carregar imagem', 'error'); }
      };

      const checkTerms = async () => {
        try {
          const res = await fetch(`${API_URL}/financial/check-terms/${user.cod_profissional}`);
          const data = await res.json();
          setTermsAccepted(data.hasAccepted);
          if (data.hasAccepted) {
            const finRes = await fetch(`${API_URL}/financial/data/${user.cod_profissional}`);
            const finData = await finRes.json();
            setFinancialData(finData.data);
          }
        } catch (err) { console.error(err); }
      };

      const loadUserWithdrawals = async () => {
        try {
          const res = await fetch(`${API_URL}/withdrawals/user/${user.cod_profissional}`);
          setWithdrawals(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadUserGratuities = async () => {
        try {
          const res = await fetch(`${API_URL}/gratuities/user/${user.cod_profissional}`);
          setUserGratuities(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadAllWithdrawals = async () => {
        try {
          const res = await fetch(`${API_URL}/withdrawals`);
          setAllWithdrawals(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadAllGratuities = async () => {
        try {
          const res = await fetch(`${API_URL}/gratuities`);
          setGratuities(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadRestricted = async () => {
        try {
          const res = await fetch(`${API_URL}/restricted`);
          setRestrictedList(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadDashboard = async () => {
        try {
          const res = await fetch(`${API_URL}/withdrawals/dashboard/conciliacao`);
          setDashboardData(await res.json());
        } catch (err) { console.error(err); }
      };

      const refreshAll = async () => {
        setGlobalLoading(true);
        try {
          await loadSubmissions();
          if (user.role === 'admin') await loadUsers();
          if (user.role === 'user') { await loadUserWithdrawals(); await loadUserGratuities(); }
          if (user.role === 'admin_financeiro') { await loadAllWithdrawals(); await loadAllGratuities(); await loadRestricted(); await loadDashboard(); }
          showToast('üîÑ Atualizado!', 'success');
        } catch (err) { showToast('Erro', 'error'); }
        setGlobalLoading(false);
      };

      // ========== FUN√á√ïES DE A√á√ÉO ==========
      const handleLogin = async () => {
        setLoading(true);
        try {
          const res = await fetch(`${API_URL}/users/login`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codProfissional: formData.cod, password: formData.password })
          });
          if (!res.ok) throw new Error('Credenciais inv√°lidas');
          const data = await res.json();
          setUser({ ...data, codProfissional: data.cod_profissional, fullName: data.full_name });
          setFormData({});
        } catch (err) { showToast(err.message, 'error'); }
        setLoading(false);
      };

      const handleRegister = async () => {
        setLoading(true);
        try {
          const res = await fetch(`${API_URL}/users/register`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codProfissional: formData.cod, password: formData.password, fullName: formData.name })
          });
          if (!res.ok) throw new Error('Erro no cadastro');
          showToast('Cadastro realizado!', 'success');
          setFormData({ view: 'login' });
        } catch (err) { showToast(err.message, 'error'); }
        setLoading(false);
      };

      const handleAcceptTerms = async () => {
        setLoading(true);
        try {
          await fetch(`${API_URL}/financial/accept-terms`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: user.codProfissional })
          });
          setTermsAccepted(true);
          showToast('‚úÖ Termos aceitos!', 'success');
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleSaveFinancial = async () => {
        if (!formData.finName || !formData.finCpf || !formData.finPix) { showToast('Preencha todos os campos', 'error'); return; }
        setLoading(true);
        try {
          await fetch(`${API_URL}/financial/data`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: user.codProfissional, fullName: formData.finName, cpf: formData.finCpf, pixKey: formData.finPix })
          });
          setFinancialData({ full_name: formData.finName, cpf: formData.finCpf, pix_key: formData.finPix });
          showToast('‚úÖ Dados salvos!', 'success');
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleRequestWithdrawal = async () => {
        const amount = parseFloat(formData.withdrawAmount);
        if (!amount || amount <= 0) { showToast('Valor inv√°lido', 'error'); return; }
        setLoading(true);
        try {
          await fetch(`${API_URL}/withdrawals`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: user.codProfissional, userName: financialData.full_name, cpf: financialData.cpf, pixKey: financialData.pix_key, requestedAmount: amount })
          });
          showToast('‚úÖ Saque solicitado!', 'success');
          setFormData({ ...formData, withdrawAmount: '' });
          loadUserWithdrawals(); loadUserGratuities();
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleUpdateWithdrawalStatus = async (id, status, rejectReason = null) => {
        try {
          await fetch(`${API_URL}/withdrawals/${id}`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status, adminId: user.id, adminName: user.fullName || 'Admin Financeiro', rejectReason })
          });
          showToast('‚úÖ Status atualizado!', 'success');
          setFormData({...formData, [`reject_${id}`]: '', [`showReject_${id}`]: false});
          loadAllWithdrawals();
        } catch (err) { showToast('Erro', 'error'); }
      };

      const handleStatusChange = (id, newStatus) => {
        if (newStatus === 'rejeitado') {
          setFormData({...formData, [`showReject_${id}`]: true, [`pendingStatus_${id}`]: newStatus});
        } else {
          handleUpdateWithdrawalStatus(id, newStatus);
        }
      };

      const handleDeleteWithdrawal = async (id) => {
        try {
          await fetch(`${API_URL}/withdrawals/${id}`, { method: 'DELETE' });
          showToast('üóëÔ∏è Solicita√ß√£o exclu√≠da!', 'success');
          setFormData({...formData, deleteConfirm: null});
          loadAllWithdrawals();
        } catch (err) { showToast('Erro ao excluir', 'error'); }
      };

      const handleUpdateConciliacao = async (id, field, value) => {
        try {
          await fetch(`${API_URL}/withdrawals/${id}/conciliacao`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [field]: value })
          });
          loadAllWithdrawals(); loadDashboard();
        } catch (err) { showToast('Erro', 'error'); }
      };

      const handleUpdateDebito = async (id, checked) => {
        try {
          await fetch(`${API_URL}/withdrawals/${id}/debito`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ debito: checked, debitoAt: checked ? new Date().toISOString() : null })
          });
          loadAllWithdrawals();
          showToast(checked ? '‚úÖ D√©bito registrado!' : '‚ùå D√©bito removido', 'success');
        } catch (err) { showToast('Erro', 'error'); }
      };

      const handleAddGratuity = async () => {
        if (!formData.gratUserCod || !formData.gratQty || !formData.gratValue) { showToast('Preencha todos', 'error'); return; }
        setLoading(true);
        try {
          await fetch(`${API_URL}/gratuities`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: formData.gratUserCod, quantity: parseInt(formData.gratQty), value: parseFloat(formData.gratValue), reason: formData.gratReason || '' })
          });
          showToast('‚úÖ Gratuidade cadastrada!', 'success');
          setFormData({ ...formData, gratUserCod: '', gratQty: '', gratValue: '', gratReason: '' });
          loadAllGratuities();
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleAddRestriction = async () => {
        if (!formData.restUserCod || !formData.restReason) { showToast('Preencha todos', 'error'); return; }
        setLoading(true);
        try {
          await fetch(`${API_URL}/restricted`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: formData.restUserCod, reason: formData.restReason })
          });
          showToast('‚úÖ Restri√ß√£o cadastrada!', 'success');
          setFormData({ ...formData, restUserCod: '', restReason: '' });
          loadRestricted();
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleRemoveRestriction = async (id) => {
        try {
          await fetch(`${API_URL}/restricted/${id}/remove`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ removedReason: 'Suspensa pelo admin' })
          });
          showToast('‚úÖ Restri√ß√£o removida!', 'success');
          loadRestricted();
        } catch (err) { showToast('Erro', 'error'); }
      };

      // Submiss√µes OS
      const motivosComFoto = ['Ajuste de Retorno', 'Ajuste de Ped√°gio (Campinas e Recife)'];
      
      const compressImage = (file, maxWidth = 800, quality = 0.6) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let w = img.width, h = img.height;
              if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; }
              canvas.width = w; canvas.height = h;
              canvas.getContext('2d').drawImage(img, 0, 0, w, h);
              resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = reject;
            img.src = e.target.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      };

      const handleSubmitOS = async () => {
        setLoading(true);
        try {
          const imgs = formData.imagens?.length > 0 ? formData.imagens.join('|||') : null;
          await fetch(`${API_URL}/submissions`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ordemServico: formData.os, motivo: formData.motivo, userId: user.id, userCod: user.codProfissional, userName: user.fullName, imagemComprovante: imgs, coordenadas: formData.coordenadas || null })
          });
          showToast('‚úÖ OS enviada!', 'success');
          setFormData({});
          loadSubmissions();
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleValidate = async (id, approved) => {
        try {
          setSubmissions(prev => prev.map(s => s.id === id ? {...s, status: approved ? 'aprovada' : 'rejeitada', validated_by_name: user.fullName} : s));
          await fetch(`${API_URL}/submissions/${id}`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: approved ? 'aprovada' : 'rejeitada', observacao: formData[`obs_${id}`] || '', validatedBy: user.id, validatedByName: user.fullName || 'Admin' })
          });
          showToast(approved ? '‚úÖ Aprovada!' : '‚ùå Rejeitada!', approved ? 'success' : 'error');
          const { pendingFilter, adminTab } = formData;
          setFormData({ pendingFilter, adminTab });
          loadSubmissions();
        } catch (err) { showToast('Erro', 'error'); loadSubmissions(); }
      };

      // Helpers
      const calcWithdraw = (amount) => {
        const gratAtiva = userGratuities.find(g => g.status === 'ativa' && g.remaining > 0);
        const hasGrat = !!gratAtiva;
        const maxGratValue = gratAtiva ? parseFloat(gratAtiva.value) : 0;
        const fee = hasGrat ? 0 : amount * 0.045;
        return { fee, final: amount - fee, hasGrat, maxGratValue, gratAtiva };
      };

      const formatCPF = (v) => {
        const n = v.replace(/\D/g, '').slice(0, 11);
        if (n.length <= 3) return n;
        if (n.length <= 6) return `${n.slice(0,3)}.${n.slice(3)}`;
        if (n.length <= 9) return `${n.slice(0,3)}.${n.slice(3,6)}.${n.slice(6)}`;
        return `${n.slice(0,3)}.${n.slice(3,6)}.${n.slice(6,9)}-${n.slice(9)}`;
      };

      const formatMoney = (v) => parseFloat(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

      const statusLabels = {
        'aguardando_aprovacao': '‚è≥ Aguardando',
        'aprovado': '‚úÖ Aprovado',
        'aprovado_gratuidade': '‚úÖ Aprov. c/ Gratuidade',
        'rejeitado': '‚ùå Rejeitado',
        'inativo': '‚ö†Ô∏è Inativo'
      };

      // ========== TELA DE LOGIN ==========
      if (!user) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center p-4">
            {toast && <Toast {...toast} />}
            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
              <div className="text-center mb-8">
                <div className="w-28 h-28 mx-auto mb-4 bg-purple-900 rounded-xl p-4 shadow-lg flex items-center justify-center">
                  <span className="text-white text-4xl font-bold">tutts</span>
                </div>
                <h1 className="text-2xl font-bold text-gray-800">Sistema Tutts</h1>
                <p className="text-gray-500 text-sm">Solicita√ß√µes e Saque Emergencial</p>
              </div>

              {formData.view === 'register' ? (
                <div className="space-y-4">
                  <input type="text" placeholder="Nome Completo" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                  <input type="text" placeholder="C√≥digo Profissional" value={formData.cod || ''} onChange={e => setFormData({...formData, cod: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                  <input type="password" placeholder="Senha" value={formData.password || ''} onChange={e => setFormData({...formData, password: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                  <button onClick={handleRegister} disabled={loading} className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold hover:bg-purple-800 disabled:opacity-50">
                    {loading ? 'Aguarde...' : 'Criar Conta'}
                  </button>
                  <button onClick={() => setFormData({view: 'login'})} className="w-full text-purple-700 text-sm">‚Üê Voltar</button>
                </div>
              ) : formData.view === 'recuperar' ? (
                <div className="space-y-4">
                  <div className="bg-purple-50 border border-purple-200 rounded-lg p-6 text-center">
                    <p className="text-5xl mb-4">üîê</p>
                    <h2 className="text-xl font-bold text-purple-800 mb-2">Esqueceu sua senha?</h2>
                    <p className="text-gray-600 mb-4">Entre em contato com o suporte Tutts para obter uma nova senha.</p>
                    
                    <div className="bg-white rounded-lg p-4 border border-purple-300">
                      <p className="text-sm text-gray-500 mb-1">üìû Contato Suporte</p>
                      <a href="https://wa.me/5571989260372" target="_blank" className="text-2xl font-bold text-green-600 hover:text-green-700">
                        (71) 98926-0372
                      </a>
                      <p className="text-xs text-gray-400 mt-2">Clique para abrir o WhatsApp</p>
                    </div>
                  </div>
                  <button onClick={() => setFormData({view: 'login'})} className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold hover:bg-purple-800">
                    ‚Üê Voltar ao Login
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  <input type="text" placeholder="C√≥digo Profissional" value={formData.cod || ''} onChange={e => setFormData({...formData, cod: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                  <input type="password" placeholder="Senha" value={formData.password || ''} onChange={e => setFormData({...formData, password: e.target.value})} onKeyDown={e => e.key === 'Enter' && handleLogin()} className="w-full px-4 py-3 border rounded-lg" />
                  <button onClick={handleLogin} disabled={loading} className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold hover:bg-purple-800 disabled:opacity-50">
                    {loading ? 'Entrando...' : 'Entrar'}
                  </button>
                  <div className="flex justify-between text-sm">
                    <button onClick={() => setFormData({view: 'register'})} className="text-purple-700 hover:underline">Criar nova conta</button>
                    <button onClick={() => setFormData({view: 'recuperar'})} className="text-gray-500 hover:underline">Esqueci minha senha</button>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // ========== PAINEL DO USU√ÅRIO ==========
      if (user.role === 'user') {
        return (
          <div className="min-h-screen bg-gray-50">
            {toast && <Toast {...toast} />}
            {globalLoading && <LoadingOverlay />}
            {imageModal && <ImageModal imageUrl={imageModal} onClose={() => setImageModal(null)} />}

            <nav className="bg-white shadow-sm border-b">
              <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div><h1 className="text-xl font-bold">Painel do Usu√°rio</h1><p className="text-sm text-gray-600">{user.fullName}</p></div>
                <div className="flex gap-2">
                  <button onClick={refreshAll} className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm font-semibold">üîÑ</button>
                  <button onClick={() => setUser(null)} className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">Sair</button>
                </div>
              </div>
            </nav>

            <div className="bg-white border-b">
              <div className="max-w-7xl mx-auto px-4 flex gap-1">
                <button onClick={() => setFormData({...formData, userTab: 'solicitacoes'})} className={`px-6 py-3 font-semibold ${(!formData.userTab || formData.userTab === 'solicitacoes') ? 'text-purple-900 border-b-2 border-purple-900' : 'text-gray-600'}`}>üìã Solicita√ß√µes</button>
                <button onClick={() => setFormData({...formData, userTab: 'saque'})} className={`px-6 py-3 font-semibold ${formData.userTab === 'saque' ? 'text-green-700 border-b-2 border-green-600' : 'text-gray-600'}`}>üí∞ Saque Emergencial</button>
              </div>
            </div>

            <div className="max-w-4xl mx-auto p-6">
              {/* ABA SOLICITA√á√ïES */}
              {(!formData.userTab || formData.userTab === 'solicitacoes') && (
                <>
                  <div className="bg-white rounded-xl shadow p-6 mb-6">
                    <h2 className="text-lg font-semibold mb-4">üìù Enviar OS</h2>
                    <div className="space-y-4">
                      <input type="text" placeholder="N√∫mero da OS" value={formData.os || ''} onChange={e => setFormData({...formData, os: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                      <select value={formData.motivo || ''} onChange={e => {
                        const m = e.target.value;
                        let coord = '';
                        if (m === 'Altera√ß√£o Ponto 1 (Goi√¢nia)') coord = '-16.64322218214421, -49.3190143453706';
                        if (m === 'Altera√ß√£o Ponto 1 (Campinas)') coord = '-22.850067092813358, -47.08310037116422';
                        setFormData({...formData, motivo: m, coordenadas: coord, imagens: []});
                      }} className="w-full px-4 py-3 border rounded-lg">
                        <option value="">Selecione o motivo</option>
                        <option>Altera√ß√£o Ponto 1 (Campinas)</option>
                        <option>Altera√ß√£o Ponto 1 (Goi√¢nia)</option>
                        <option>Ajuste de Retorno</option>
                        <option>Ajuste de Ped√°gio (Campinas e Recife)</option>
                      </select>

                      {formData.coordenadas && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                          <p className="text-xs text-blue-700 font-semibold">üìç COORDENADAS</p>
                          <p className="font-mono text-blue-900">{formData.coordenadas}</p>
                          <div className="flex gap-2 mt-2">
                            <button onClick={() => { navigator.clipboard.writeText(formData.coordenadas); showToast('Copiado!', 'success'); }} className="text-sm text-blue-600 hover:underline">üìã Copiar</button>
                            <a href={`https://www.google.com/maps?q=${formData.coordenadas}`} target="_blank" className="text-sm text-blue-600 hover:underline">üó∫Ô∏è Ver no Maps</a>
                          </div>
                        </div>
                      )}

                      {motivosComFoto.includes(formData.motivo) && (
                        <div className="border-2 border-dashed border-orange-300 bg-orange-50 rounded-lg p-4">
                          <p className="text-sm font-bold text-orange-800 mb-2">üìé Fotos OBRIGAT√ìRIAS (m√°x. 2)</p>
                          <input type="file" accept="image/*" multiple onChange={async (e) => {
                            const files = Array.from(e.target.files).slice(0, 2);
                            if (!files.length) return;
                            setLoading(true);
                            try {
                              const compressed = [];
                              for (const f of files) { if (f.size <= 10000000) compressed.push(await compressImage(f)); }
                              setFormData({...formData, imagens: [...(formData.imagens || []), ...compressed].slice(0, 2)});
                              showToast('‚úÖ Imagem adicionada!', 'success');
                            } catch { showToast('Erro', 'error'); }
                            setLoading(false);
                            e.target.value = '';
                          }} className="w-full text-sm" />
                          {formData.imagens?.length > 0 && (
                            <div className="mt-3 flex gap-2">
                              {formData.imagens.map((img, i) => (
                                <div key={i} className="relative">
                                  <img src={img} className="h-24 rounded border" />
                                  <button onClick={() => setFormData({...formData, imagens: formData.imagens.filter((_, idx) => idx !== i)})} className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs">‚úï</button>
                                </div>
                              ))}
                            </div>
                          )}
                          <p className="text-xs text-gray-500 mt-2">{formData.imagens?.length || 0}/2 fotos</p>
                        </div>
                      )}

                      <button onClick={handleSubmitOS} disabled={loading || !formData.os || !formData.motivo || (motivosComFoto.includes(formData.motivo) && (!formData.imagens?.length))} className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold disabled:opacity-50">
                        {loading ? '‚è≥ Enviando...' : 'Enviar'}
                      </button>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h2 className="text-lg font-semibold mb-4">üìã Minhas Submiss√µes</h2>
                    {submissions.length === 0 ? <p className="text-gray-500">Nenhuma submiss√£o</p> : (
                      <div className="space-y-3">
                        {submissions.map(s => (
                          <div key={s.id} className="border rounded-lg p-4">
                            <div className="flex justify-between items-start">
                              <div>
                                <p className="font-mono text-lg font-bold">OS: {s.ordemServico}</p>
                                <p className="text-sm text-gray-600">{s.motivo}</p>
                              </div>
                              <span className={`px-3 py-1 rounded-full text-xs font-bold ${s.status === 'aprovada' ? 'bg-green-500 text-white' : s.status === 'rejeitada' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-white'}`}>{s.status?.toUpperCase()}</span>
                            </div>
                            {s.temImagem && !s.imagemComprovante && <button onClick={() => loadImagem(s.id)} className="mt-2 text-sm text-blue-600 hover:underline">üì∑ Ver foto(s)</button>}
                            {s.imagemComprovante && (
                              <div className="mt-2 flex gap-2">
                                {s.imagemComprovante.split('|||').map((img, i) => <img key={i} src={img} className="h-20 rounded cursor-pointer" onClick={() => setImageModal(img)} />)}
                              </div>
                            )}
                            <p className="text-xs text-gray-400 mt-2">{s.timestamp}</p>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </>
              )}

              {/* ABA SAQUE */}
              {formData.userTab === 'saque' && (
                <>
                  {!termsAccepted ? (
                    <div className="bg-white rounded-xl shadow p-6">
                      <h2 className="text-2xl font-bold text-purple-900 mb-4 text-center">üìã Termos de Uso</h2>
                      <div className="bg-gray-50 rounded-lg p-4 mb-6 max-h-80 overflow-y-auto text-sm">
                        <p className="text-gray-700 leading-relaxed">Uma taxa administrativa de 4,5% ser√° aplicada sobre o valor solicitado e deduzida automaticamente na transfer√™ncia. As solicita√ß√µes s√£o processadas de segunda a sexta, das 09:00 √†s 18:00, e aos s√°bados, das 08:00 √†s 12:00. Solicita√ß√µes feitas fora desse hor√°rio ser√£o atendidas no pr√≥ximo dia √∫til. √â sua responsabilidade garantir que as informa√ß√µes fornecidas estejam corretas, pois n√£o nos responsabilizamos por atrasos ou transfer√™ncias erradas causadas por dados incorretos. O dinheiro ser√° transferido em at√© 1 hora ap√≥s a confirma√ß√£o, dentro do hor√°rio de funcionamento.</p>
                      </div>
                      <button onClick={handleAcceptTerms} disabled={loading} className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold disabled:opacity-50">
                        {loading ? 'Aguarde...' : '‚úì Aceitar e Continuar'}
                      </button>
                    </div>
                  ) : !financialData?.full_name ? (
                    <div className="bg-white rounded-xl shadow p-6">
                      <h2 className="text-xl font-bold text-purple-900 mb-4">üí≥ Cadastrar Dados</h2>
                      <div className="space-y-4">
                        <div><label className="block text-sm font-semibold mb-1">C√≥digo</label><input type="text" value={user.codProfissional} disabled className="w-full px-4 py-2 border rounded-lg bg-gray-100" /></div>
                        <div><label className="block text-sm font-semibold mb-1">Nome *</label><input type="text" value={formData.finName || ''} onChange={e => setFormData({...formData, finName: e.target.value})} className="w-full px-4 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-semibold mb-1">CPF *</label><input type="text" value={formData.finCpf || ''} onChange={e => setFormData({...formData, finCpf: formatCPF(e.target.value)})} className="w-full px-4 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-semibold mb-1">Chave PIX *</label><input type="text" value={formData.finPix || ''} onChange={e => setFormData({...formData, finPix: e.target.value})} className="w-full px-4 py-2 border rounded-lg" /></div>
                        <button onClick={handleSaveFinancial} disabled={loading} className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold disabled:opacity-50">{loading ? 'Salvando...' : 'üíæ Salvar'}</button>
                      </div>
                    </div>
                  ) : (
                    <>
                      <div className="bg-white rounded-xl shadow mb-6">
                        <div className="flex border-b overflow-x-auto">
                          <button onClick={() => setFormData({...formData, saqueTab: 'solicitar'})} className={`flex-1 py-3 font-semibold whitespace-nowrap px-2 ${(!formData.saqueTab || formData.saqueTab === 'solicitar') ? 'text-green-700 border-b-2 border-green-600' : 'text-gray-500'}`}>üí∞ Solicitar</button>
                          <button onClick={() => setFormData({...formData, saqueTab: 'gratuidades'})} className={`flex-1 py-3 font-semibold whitespace-nowrap px-2 ${formData.saqueTab === 'gratuidades' ? 'text-pink-700 border-b-2 border-pink-600' : 'text-gray-500'}`}>üéÅ Gratuidades</button>
                          <button onClick={() => setFormData({...formData, saqueTab: 'dados'})} className={`flex-1 py-3 font-semibold whitespace-nowrap px-2 ${formData.saqueTab === 'dados' ? 'text-blue-700 border-b-2 border-blue-600' : 'text-gray-500'}`}>üë§ Dados</button>
                          <button onClick={() => setFormData({...formData, saqueTab: 'dashboard'})} className={`flex-1 py-3 font-semibold whitespace-nowrap px-2 ${formData.saqueTab === 'dashboard' ? 'text-purple-700 border-b-2 border-purple-600' : 'text-gray-500'}`}>üìä Dashboard</button>
                        </div>
                        <div className="p-6">
                          {/* ========== ABA DASHBOARD ========== */}
                          {formData.saqueTab === 'dashboard' && (
                            <>
                              {(() => {
                                const now = new Date();
                                const mesAtual = now.getMonth();
                                const anoAtual = now.getFullYear();
                                
                                // Saques do m√™s atual
                                const saquesMesAtual = withdrawals.filter(w => {
                                  const d = new Date(w.created_at);
                                  return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
                                });
                                
                                // Saques aprovados do m√™s
                                const aprovadosMes = saquesMesAtual.filter(w => w.status === 'aprovado' || w.status === 'aprovado_gratuidade');
                                const totalSacadoMes = aprovadosMes.reduce((acc, w) => acc + parseFloat(w.final_amount || 0), 0);
                                
                                // Gratuidades usadas
                                const gratuidadesUsadas = userGratuities.reduce((acc, g) => acc + (g.quantity - g.remaining), 0);
                                const gratuidadesTotal = userGratuities.reduce((acc, g) => acc + g.quantity, 0);
                                
                                // Hist√≥rico √∫ltimos 6 meses para gr√°fico
                                const ultimos6Meses = [];
                                for (let i = 5; i >= 0; i--) {
                                  const d = new Date(anoAtual, mesAtual - i, 1);
                                  const mes = d.getMonth();
                                  const ano = d.getFullYear();
                                  const saquesMes = withdrawals.filter(w => {
                                    const dw = new Date(w.created_at);
                                    return dw.getMonth() === mes && dw.getFullYear() === ano && (w.status === 'aprovado' || w.status === 'aprovado_gratuidade');
                                  });
                                  const valor = saquesMes.reduce((acc, w) => acc + parseFloat(w.final_amount || 0), 0);
                                  ultimos6Meses.push({
                                    mes: d.toLocaleDateString('pt-BR', { month: 'short' }).replace('.', ''),
                                    valor,
                                    qtd: saquesMes.length
                                  });
                                }
                                const maxValor = Math.max(...ultimos6Meses.map(m => m.valor), 1);
                                
                                // Estat√≠sticas gerais
                                const totalGeral = withdrawals.filter(w => w.status === 'aprovado' || w.status === 'aprovado_gratuidade').reduce((acc, w) => acc + parseFloat(w.final_amount || 0), 0);
                                const mediaSaque = aprovadosMes.length > 0 ? totalSacadoMes / aprovadosMes.length : 0;
                                
                                return (
                                  <div className="space-y-6">
                                    {/* Cards Resumo */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                      <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-4 text-white">
                                        <p className="text-xs opacity-80">üí∞ Sacado este m√™s</p>
                                        <p className="text-2xl font-bold mt-1">{formatMoney(totalSacadoMes)}</p>
                                        <p className="text-xs opacity-70 mt-1">{aprovadosMes.length} saque(s)</p>
                                      </div>
                                      <div className="bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl p-4 text-white">
                                        <p className="text-xs opacity-80">üéÅ Gratuidades</p>
                                        <p className="text-2xl font-bold mt-1">{gratuidadesUsadas}/{gratuidadesTotal}</p>
                                        <p className="text-xs opacity-70 mt-1">usadas/total</p>
                                      </div>
                                      <div className="bg-gradient-to-br from-orange-500 to-red-500 rounded-xl p-4 text-white">
                                        <p className="text-xs opacity-80">üìà Total Hist√≥rico</p>
                                        <p className="text-2xl font-bold mt-1">{formatMoney(totalGeral)}</p>
                                        <p className="text-xs opacity-70 mt-1">todos os tempos</p>
                                      </div>
                                    </div>
                                    
                                    {/* Gr√°fico de Barras - √öltimos 6 meses */}
                                    <div className="bg-white border rounded-xl p-4">
                                      <h3 className="font-semibold mb-4">üìä Hist√≥rico de Saques (√öltimos 6 meses)</h3>
                                      <div className="flex items-end justify-between gap-2 h-48">
                                        {ultimos6Meses.map((m, i) => (
                                          <div key={i} className="flex-1 flex flex-col items-center">
                                            <span className="text-xs text-gray-600 mb-1">{formatMoney(m.valor)}</span>
                                            <div 
                                              className="w-full bg-gradient-to-t from-green-500 to-emerald-400 rounded-t-lg transition-all duration-500"
                                              style={{ height: `${Math.max((m.valor / maxValor) * 100, 5)}%`, minHeight: '20px' }}
                                            />
                                            <span className="text-xs font-semibold mt-2 text-gray-700">{m.mes}</span>
                                            <span className="text-xs text-gray-500">{m.qtd} saque(s)</span>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                    
                                    {/* Resumo R√°pido */}
                                    <div className="bg-gray-50 rounded-xl p-4">
                                      <h3 className="font-semibold mb-3">üìã Resumo do M√™s</h3>
                                      <div className="grid grid-cols-2 gap-4 text-sm">
                                        <div className="flex justify-between"><span className="text-gray-600">M√©dia por saque:</span><span className="font-semibold">{formatMoney(mediaSaque)}</span></div>
                                        <div className="flex justify-between"><span className="text-gray-600">Pendentes:</span><span className="font-semibold text-yellow-600">{saquesMesAtual.filter(w => w.status === 'aguardando_aprovacao').length}</span></div>
                                        <div className="flex justify-between"><span className="text-gray-600">Aprovados:</span><span className="font-semibold text-green-600">{aprovadosMes.length}</span></div>
                                        <div className="flex justify-between"><span className="text-gray-600">Rejeitados:</span><span className="font-semibold text-red-600">{saquesMesAtual.filter(w => w.status === 'rejeitado').length}</span></div>
                                      </div>
                                    </div>
                                  </div>
                                );
                              })()}
                            </>
                          )}
                          
                          {/* ========== ABA SOLICITAR ========== */}
                          {(!formData.saqueTab || formData.saqueTab === 'solicitar') && (
                            <>
                              {/* Verifica se tem gratuidade ativa */}
                              {(() => {
                                const gratAtiva = userGratuities.find(g => g.status === 'ativa' && g.remaining > 0);
                                const temGratuidade = !!gratAtiva;
                                const valorMaxGratuidade = gratAtiva ? parseFloat(gratAtiva.value) : 0;
                                const valorDigitado = parseFloat(formData.withdrawAmount) || 0;
                                const valorExcedido = temGratuidade && valorDigitado > valorMaxGratuidade;
                                
                                return (
                                  <div className="space-y-4">
                                    {/* Alerta para quem TEM gratuidade */}
                                    {temGratuidade && (
                                      <div className="bg-green-50 border border-green-300 rounded-lg p-4">
                                        <p className="text-green-800 font-semibold">üéÅ Voc√™ possui gratuidade ativa!</p>
                                        <p className="text-green-700 text-sm mt-1">Valor m√°ximo permitido: <strong>{formatMoney(valorMaxGratuidade)}</strong></p>
                                        <p className="text-green-600 text-xs mt-1">Restam {gratAtiva.remaining} uso(s) desta gratuidade</p>
                                      </div>
                                    )}
                                    
                                    {/* Alerta para quem N√ÉO TEM gratuidade */}
                                    {!temGratuidade && (
                                      <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-4">
                                        <p className="text-yellow-800 font-semibold">‚ö†Ô∏è Aten√ß√£o!</p>
                                        <p className="text-yellow-700 text-sm mt-1">Conforme termo de uso do saque emergencial, ser√° cobrado um valor de <strong>4,5%</strong> na solicita√ß√£o.</p>
                                      </div>
                                    )}
                                    
                                    <div>
                                      <label className="block text-sm font-semibold mb-1">Valor {temGratuidade && <span className="text-green-600 text-xs">(m√°x: {formatMoney(valorMaxGratuidade)})</span>}</label>
                                      <input type="number" value={formData.withdrawAmount || ''} onChange={e => setFormData({...formData, withdrawAmount: e.target.value})} className={`w-full px-4 py-3 border rounded-lg text-lg ${valorExcedido ? 'border-red-500 bg-red-50' : ''}`} />
                                      {valorExcedido && (
                                        <p className="text-red-600 text-sm mt-1 font-semibold">‚ùå Valor excede o limite da gratuidade ({formatMoney(valorMaxGratuidade)})</p>
                                      )}
                                    </div>
                                    
                                    {formData.withdrawAmount && parseFloat(formData.withdrawAmount) > 0 && !valorExcedido && (() => {
                                      const c = calcWithdraw(parseFloat(formData.withdrawAmount));
                                      return (
                                        <div className="bg-gray-50 rounded-lg p-4 space-y-2">
                                          <div className="flex justify-between"><span>Solicitado:</span><span className="font-bold">{formatMoney(formData.withdrawAmount)}</span></div>
                                          <div className="flex justify-between"><span>Taxa:</span><span className={c.hasGrat ? 'text-green-600 font-bold' : 'text-red-600'}>{c.hasGrat ? 'ISENTA' : `-${formatMoney(c.fee)}`}</span></div>
                                          <hr /><div className="flex justify-between text-lg"><span className="font-bold">Receber:</span><span className="font-bold text-green-700">{formatMoney(c.final)}</span></div>
                                        </div>
                                      );
                                    })()}
                                    
                                    <button onClick={handleRequestWithdrawal} disabled={loading || !formData.withdrawAmount || valorExcedido} className="w-full bg-green-600 text-white py-3 rounded-lg font-bold disabled:opacity-50">{loading ? '...' : 'üí∏ Solicitar'}</button>
                                  </div>
                                );
                              })()}
                              <h3 className="text-lg font-semibold mt-8 mb-4">üìã Hist√≥rico</h3>
                              {withdrawals.length === 0 ? <p className="text-gray-500">Nenhum saque</p> : (
                                <div className="space-y-3">
                                  {withdrawals.map(w => {
                                    const isDelayed = w.status === 'aguardando_aprovacao' && (Date.now() - new Date(w.created_at)) > 3600000;
                                    
                                    // Mensagens personalizadas para o usu√°rio
                                    const getStatusMessage = () => {
                                      if (isDelayed) return '‚ö†Ô∏è ATRASADO';
                                      if (w.status === 'aprovado' || w.status === 'aprovado_gratuidade') return '‚úÖ Aprovado';
                                      if (w.status === 'rejeitado') return '‚ùå Rejeitado';
                                      if (w.status === 'inativo') return '‚ö†Ô∏è Inativo';
                                      return '‚è≥ Aguardando';
                                    };
                                    
                                    const getStatusDescription = () => {
                                      if (w.status === 'aprovado' || w.status === 'aprovado_gratuidade') 
                                        return 'Saque aprovado, em instantes ser√° feito a transfer√™ncia para o seu banco!';
                                      if (w.status === 'inativo') 
                                        return 'Saque temporariamente inativo por quest√µes t√©cnicas';
                                      if (w.status === 'rejeitado' && w.reject_reason) 
                                        return `Motivo: ${w.reject_reason}`;
                                      return null;
                                    };
                                    
                                    const statusDesc = getStatusDescription();
                                    
                                    return (
                                      <div key={w.id} className={`border rounded-lg p-4 ${isDelayed ? 'border-red-400 bg-red-50' : w.status?.includes('aprovado') ? 'border-green-400 bg-green-50' : w.status === 'rejeitado' ? 'border-red-300 bg-red-50' : w.status === 'inativo' ? 'border-orange-300 bg-orange-50' : ''}`}>
                                        <div className="flex justify-between">
                                          <div><p className="font-bold">{formatMoney(w.requested_amount)}</p><p className="text-sm text-gray-600">Receber: {formatMoney(w.final_amount)}</p></div>
                                          <span className={`px-3 py-1 rounded-full text-xs font-bold h-fit ${w.status?.includes('aprovado') ? 'bg-green-500 text-white' : w.status === 'rejeitado' ? 'bg-red-500 text-white' : w.status === 'inativo' ? 'bg-orange-500 text-white' : 'bg-yellow-500 text-white'}`}>{getStatusMessage()}</span>
                                        </div>
                                        {statusDesc && <p className={`text-sm mt-2 font-semibold ${w.status?.includes('aprovado') ? 'text-green-700' : w.status === 'rejeitado' ? 'text-red-600' : 'text-orange-600'}`}>{statusDesc}</p>}
                                        {isDelayed && <p className="text-red-600 text-sm mt-2 font-semibold">Entre em contato com o suporte</p>}
                                        <p className="text-xs text-gray-400 mt-2">{new Date(w.created_at).toLocaleString('pt-BR')}</p>
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </>
                          )}
                          {formData.saqueTab === 'dados' && (
                            <div className="space-y-4">
                              <div><label className="block text-sm font-semibold mb-1">Nome</label><input type="text" value={formData.finName ?? financialData?.full_name ?? ''} onChange={e => setFormData({...formData, finName: e.target.value})} className="w-full px-4 py-2 border rounded-lg" /></div>
                              <div><label className="block text-sm font-semibold mb-1">CPF</label><input type="text" value={formData.finCpf ?? financialData?.cpf ?? ''} onChange={e => setFormData({...formData, finCpf: formatCPF(e.target.value)})} className="w-full px-4 py-2 border rounded-lg" /></div>
                              <div><label className="block text-sm font-semibold mb-1">PIX</label><input type="text" value={formData.finPix ?? financialData?.pix_key ?? ''} onChange={e => setFormData({...formData, finPix: e.target.value})} className="w-full px-4 py-2 border rounded-lg" /></div>
                              <button onClick={handleSaveFinancial} disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold disabled:opacity-50">{loading ? '...' : 'üíæ Atualizar'}</button>
                            </div>
                          )}
                          {formData.saqueTab === 'gratuidades' && (
                            <>
                              <h3 className="font-semibold mb-4">üéÅ Minhas Gratuidades</h3>
                              {userGratuities.length === 0 ? <p className="text-gray-500">Nenhuma</p> : (
                                <div className="space-y-3">
                                  {userGratuities.map(g => (
                                    <div key={g.id} className={`border rounded-lg p-4 ${g.status === 'ativa' ? 'border-green-300 bg-green-50' : 'bg-gray-50'}`}>
                                      <div className="flex justify-between">
                                        <div><p className="font-bold">{g.remaining}/{g.quantity} restantes</p><p className="text-sm text-gray-600">Valor: {formatMoney(g.value)}</p></div>
                                        <span className={`px-3 py-1 rounded-full text-xs font-bold h-fit ${g.status === 'ativa' ? 'bg-green-500 text-white' : 'bg-gray-400 text-white'}`}>{g.status}</span>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </>
                          )}
                        </div>
                      </div>
                    </>
                  )}
                </>
              )}
            </div>
          </div>
        );
      }

      // ========== PAINEL ADMIN FINANCEIRO ==========
      if (user.role === 'admin_financeiro') {
        return (
          <div className="min-h-screen bg-gray-50">
            {toast && <Toast {...toast} />}
            {globalLoading && <LoadingOverlay />}

            <nav className="bg-green-800 shadow-lg">
              <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 className="text-xl font-bold text-white">üí∞ Painel Financeiro</h1>
                <div className="flex gap-2">
                  <button onClick={refreshAll} className="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 text-sm font-semibold">üîÑ</button>
                  <button onClick={() => setUser(null)} className="px-4 py-2 text-white hover:bg-green-700 rounded-lg">Sair</button>
                </div>
              </div>
            </nav>

            {/* Modal de confirma√ß√£o de exclus√£o */}
            {formData.deleteConfirm && (
              <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full">
                  <h3 className="text-xl font-bold text-red-600 mb-4">‚ö†Ô∏è Confirmar Exclus√£o</h3>
                  <p className="text-gray-700 mb-2">Tem certeza que deseja excluir esta solicita√ß√£o?</p>
                  <div className="bg-gray-50 rounded-lg p-4 mb-4">
                    <p className="text-sm"><strong>Profissional:</strong> {formData.deleteConfirm.user_name}</p>
                    <p className="text-sm"><strong>C√≥digo:</strong> {formData.deleteConfirm.user_cod}</p>
                    <p className="text-sm"><strong>Valor:</strong> {formatMoney(formData.deleteConfirm.requested_amount)}</p>
                    <p className="text-sm"><strong>Data:</strong> {new Date(formData.deleteConfirm.created_at).toLocaleString('pt-BR')}</p>
                  </div>
                  <p className="text-red-600 text-sm mb-4 font-semibold">Esta a√ß√£o n√£o pode ser desfeita!</p>
                  <div className="flex gap-3">
                    <button onClick={() => setFormData({...formData, deleteConfirm: null})} className="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">Cancelar</button>
                    <button onClick={() => handleDeleteWithdrawal(formData.deleteConfirm.id)} className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">üóëÔ∏è Excluir</button>
                  </div>
                </div>
              </div>
            )}

            <div className="bg-white border-b sticky top-0 z-10">
              <div className="max-w-7xl mx-auto px-4 flex gap-1 overflow-x-auto">
                {['solicitacoes', 'validacao', 'conciliacao', 'resumo', 'gratuidades', 'restritos', 'relatorios'].map(tab => (
                  <button key={tab} onClick={() => setFormData({...formData, finTab: tab})} className={`px-4 py-3 font-semibold whitespace-nowrap ${(formData.finTab || 'solicitacoes') === tab ? 'text-green-700 border-b-2 border-green-600' : 'text-gray-600'}`}>
                    {tab === 'solicitacoes' && 'üìã Solicita√ß√µes'}
                    {tab === 'validacao' && 'üìä Valida√ß√£o Di√°ria'}
                    {tab === 'conciliacao' && '‚úÖ Concilia√ß√£o'}
                    {tab === 'resumo' && 'üîç Resumo'}
                    {tab === 'gratuidades' && 'üéÅ Gratuidades'}
                    {tab === 'restritos' && 'üö´ Restritos'}
                    {tab === 'relatorios' && 'üìà Relat√≥rios'}
                  </button>
                ))}
              </div>
            </div>

            <div className="max-w-7xl mx-auto p-6">
              {(!formData.finTab || formData.finTab === 'solicitacoes') && (
                <>
                  {/* Cards de estat√≠sticas */}
                  <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div className="bg-white rounded-xl shadow p-4">
                      <p className="text-sm text-gray-600">Total</p>
                      <p className="text-2xl font-bold text-purple-600">{allWithdrawals.length}</p>
                    </div>
                    <div className="bg-white rounded-xl shadow p-4">
                      <p className="text-sm text-gray-600">Aguardando</p>
                      <p className="text-2xl font-bold text-yellow-600">{allWithdrawals.filter(w => w.status === 'aguardando_aprovacao').length}</p>
                    </div>
                    <div className="bg-white rounded-xl shadow p-4">
                      <p className="text-sm text-gray-600">Aprovadas</p>
                      <p className="text-2xl font-bold text-green-600">{allWithdrawals.filter(w => w.status === 'aprovado').length}</p>
                    </div>
                    <div className="bg-white rounded-xl shadow p-4">
                      <p className="text-sm text-gray-600">Aprov. Gratuidade</p>
                      <p className="text-2xl font-bold text-emerald-600">{allWithdrawals.filter(w => w.status === 'aprovado_gratuidade').length}</p>
                    </div>
                    <div className="bg-white rounded-xl shadow p-4">
                      <p className="text-sm text-gray-600">Rejeitadas</p>
                      <p className="text-2xl font-bold text-red-600">{allWithdrawals.filter(w => w.status === 'rejeitado').length}</p>
                    </div>
                  </div>

                  {/* Alerta de Saques Atrasados */}
                  {(() => {
                    const saquesAtrasados = allWithdrawals.filter(w => {
                      if (w.status !== 'aguardando_aprovacao') return false;
                      const horasSolicitacao = (Date.now() - new Date(w.created_at).getTime()) / (1000 * 60 * 60);
                      return horasSolicitacao >= 1;
                    });
                    
                    if (saquesAtrasados.length === 0) return null;
                    
                    return (
                      <div className="bg-red-50 border-2 border-red-400 rounded-xl p-4 mb-6 animate-pulse">
                        <div className="flex items-center gap-3">
                          <span className="text-3xl">üö®</span>
                          <div className="flex-1">
                            <p className="text-red-800 font-bold text-lg">ATEN√á√ÉO: {saquesAtrasados.length} saque(s) aguardando h√° mais de 1 hora!</p>
                            <p className="text-red-600 text-sm mt-1">Profissionais aguardando: {saquesAtrasados.map(w => w.user_name || w.user_cod).join(', ')}</p>
                          </div>
                          <button 
                            onClick={() => setFormData({...formData, filterStatus: 'atrasados'})} 
                            className="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 whitespace-nowrap"
                          >
                            üëÄ Ver Atrasados
                          </button>
                        </div>
                      </div>
                    );
                  })()}

                  <div className="bg-white rounded-xl shadow overflow-hidden">
                    {/* Bot√µes de filtro */}
                    <div className="p-4 border-b">
                      <div className="flex flex-wrap gap-2">
                        <button onClick={() => setFormData({...formData, filterStatus: ''})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${!formData.filterStatus ? 'bg-purple-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                          üìã Todas ({allWithdrawals.length})
                        </button>
                        <button onClick={() => setFormData({...formData, filterStatus: 'atrasados'})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${formData.filterStatus === 'atrasados' ? 'bg-red-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                          üö® Atrasados ({allWithdrawals.filter(w => w.status === 'aguardando_aprovacao' && (Date.now() - new Date(w.created_at).getTime()) >= 3600000).length})
                        </button>
                        <button onClick={() => setFormData({...formData, filterStatus: 'aguardando_aprovacao'})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${formData.filterStatus === 'aguardando_aprovacao' ? 'bg-yellow-500 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                          ‚è≥ Aguardando ({allWithdrawals.filter(w => w.status === 'aguardando_aprovacao').length})
                        </button>
                        <button onClick={() => setFormData({...formData, filterStatus: 'aprovado'})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${formData.filterStatus === 'aprovado' ? 'bg-green-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                          ‚úÖ Aprovadas ({allWithdrawals.filter(w => w.status === 'aprovado').length})
                        </button>
                        <button onClick={() => setFormData({...formData, filterStatus: 'aprovado_gratuidade'})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${formData.filterStatus === 'aprovado_gratuidade' ? 'bg-emerald-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                          üéÅ Aprov. Gratuidade ({allWithdrawals.filter(w => w.status === 'aprovado_gratuidade').length})
                        </button>
                        <button onClick={() => setFormData({...formData, filterStatus: 'rejeitado'})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${formData.filterStatus === 'rejeitado' ? 'bg-red-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                          ‚ùå Rejeitadas ({allWithdrawals.filter(w => w.status === 'rejeitado').length})
                        </button>
                        <button onClick={() => setFormData({...formData, filterStatus: 'inativo'})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${formData.filterStatus === 'inativo' ? 'bg-orange-500 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                          ‚ö†Ô∏è Inativo ({allWithdrawals.filter(w => w.status === 'inativo').length})
                        </button>
                      </div>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left">Data</th><th className="px-4 py-3 text-left">Nome</th><th className="px-4 py-3 text-left">CPF</th><th className="px-4 py-3 text-left">C√≥digo</th><th className="px-4 py-3 text-right">Solicitado</th><th className="px-4 py-3 text-center">D√©bito</th><th className="px-4 py-3 text-right">Valor Profissional</th><th className="px-4 py-3 text-left">PIX</th><th className="px-4 py-3 text-center">Status</th><th className="px-4 py-3 text-left">Alterado por</th><th className="px-4 py-3 text-center">A√ß√µes</th></tr></thead>
                      <tbody>
                        {allWithdrawals.filter(w => {
                          if (!formData.filterStatus) return true;
                          if (formData.filterStatus === 'atrasados') {
                            return w.status === 'aguardando_aprovacao' && (Date.now() - new Date(w.created_at).getTime()) >= 3600000;
                          }
                          return w.status === formData.filterStatus;
                        }).map(w => {
                          const isAtrasado = w.status === 'aguardando_aprovacao' && (Date.now() - new Date(w.created_at).getTime()) >= 3600000;
                          const tempoEspera = Math.floor((Date.now() - new Date(w.created_at).getTime()) / (1000 * 60));
                          const horasEspera = Math.floor(tempoEspera / 60);
                          const minutosEspera = tempoEspera % 60;
                          
                          return (
                          <tr key={w.id} className={`border-t hover:bg-gray-50 ${isAtrasado ? 'bg-red-50 border-l-4 border-l-red-500' : ''} ${w.has_gratuity ? 'row-green' : ''} ${w.is_restricted ? 'row-red' : ''}`}>
                            <td className="px-4 py-3 whitespace-nowrap">
                              {new Date(w.created_at).toLocaleString('pt-BR')}
                              {isAtrasado && <p className="text-red-600 text-xs font-bold mt-1">‚è∞ H√° {horasEspera}h{minutosEspera}min</p>}
                            </td>
                            <td className="px-4 py-3">{w.user_name}</td>
                            <td className="px-4 py-3">{w.cpf}</td>
                            <td className="px-4 py-3 font-mono">{w.user_cod}</td>
                            <td className="px-4 py-3 text-right font-semibold">{formatMoney(w.requested_amount)}</td>
                            <td className="px-4 py-3 text-center">
                              <div className="flex flex-col items-center">
                                <input type="checkbox" checked={w.debito || false} onChange={e => handleUpdateDebito(w.id, e.target.checked)} className="w-5 h-5" />
                                {w.debito && w.debito_at && <span className="text-xs text-gray-500 mt-1">{new Date(w.debito_at).toLocaleString('pt-BR')}</span>}
                              </div>
                            </td>
                            <td className="px-4 py-3 text-right">{formatMoney(w.final_amount)}</td>
                            <td className="px-4 py-3 text-xs max-w-[150px] truncate">{w.pix_key}</td>
                            <td className="px-4 py-3">
                              <select value={formData[`showReject_${w.id}`] ? 'rejeitado' : w.status} onChange={e => handleStatusChange(w.id, e.target.value)} className="px-2 py-1 border rounded text-xs w-full">
                                <option value="aguardando_aprovacao">‚è≥ Aguardando</option>
                                <option value="aprovado">‚úÖ Aprovado</option>
                                <option value="aprovado_gratuidade">‚úÖ c/ Gratuidade</option>
                                <option value="rejeitado">‚ùå Rejeitado</option>
                                <option value="inativo">‚ö†Ô∏è Inativo</option>
                              </select>
                              {formData[`showReject_${w.id}`] && (
                                <div className="mt-2 space-y-2">
                                  <input type="text" placeholder="Motivo da rejei√ß√£o..." value={formData[`reject_${w.id}`] || ''} onChange={e => setFormData({...formData, [`reject_${w.id}`]: e.target.value})} className="w-full px-2 py-1 border rounded text-xs" />
                                  <div className="flex gap-1">
                                    <button onClick={() => { if (!formData[`reject_${w.id}`]) { showToast('Informe o motivo', 'error'); return; } handleUpdateWithdrawalStatus(w.id, 'rejeitado', formData[`reject_${w.id}`]); }} className="flex-1 px-2 py-1 bg-red-600 text-white rounded text-xs">Confirmar</button>
                                    <button onClick={() => setFormData({...formData, [`showReject_${w.id}`]: false})} className="px-2 py-1 bg-gray-400 text-white rounded text-xs">‚úï</button>
                                  </div>
                                </div>
                              )}
                              {w.reject_reason && w.status === 'rejeitado' && <p className="text-xs text-red-600 mt-1">Motivo: {w.reject_reason}</p>}
                            </td>
                            <td className="px-4 py-3 text-xs text-purple-700 font-semibold">{w.admin_name || '-'}</td>
                            <td className="px-4 py-3 text-center">
                              <button onClick={() => setFormData({...formData, deleteConfirm: w})} className="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700" title="Excluir">üóëÔ∏è</button>
                            </td>
                          </tr>
                        );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
                </>
              )}

              {formData.finTab === 'validacao' && (
                <>
                  {/* Filtros */}
                  <div className="bg-white rounded-xl shadow p-4 mb-6">
                    <div className="flex flex-wrap gap-4 items-end">
                      {/* Tipo de filtro */}
                      <div>
                        <label className="block text-sm font-semibold mb-1">Filtrar por</label>
                        <select value={formData.validacaoTipo || 'solicitacao'} onChange={e => setFormData({...formData, validacaoTipo: e.target.value})} className="px-4 py-2 border rounded-lg">
                          <option value="solicitacao">üìÖ Data da Solicita√ß√£o</option>
                          <option value="debito">üí≥ Data do D√©bito</option>
                        </select>
                      </div>
                      
                      {/* Data in√≠cio */}
                      <div>
                        <label className="block text-sm font-semibold mb-1">Data In√≠cio</label>
                        <input type="date" value={formData.validacaoDataInicio || ''} onChange={e => setFormData({...formData, validacaoDataInicio: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      </div>
                      
                      {/* Data fim */}
                      <div>
                        <label className="block text-sm font-semibold mb-1">Data Fim</label>
                        <input type="date" value={formData.validacaoDataFim || ''} onChange={e => setFormData({...formData, validacaoDataFim: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      </div>
                      
                      {/* Bot√µes */}
                      <button onClick={() => {
                        const hoje = new Date().toISOString().split('T')[0];
                        setFormData({...formData, validacaoDataInicio: hoje, validacaoDataFim: hoje});
                      }} className="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">
                        üìÜ Hoje
                      </button>
                      <button onClick={() => setFormData({...formData, validacaoDataInicio: '', validacaoDataFim: ''})} className="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                        üîÑ Limpar
                      </button>
                    </div>
                  </div>

                  {/* M√©tricas */}
                  {(() => {
                    const tipoFiltro = formData.validacaoTipo || 'solicitacao';
                    const dataInicio = formData.validacaoDataInicio;
                    const dataFim = formData.validacaoDataFim;
                    
                    const filtrados = allWithdrawals.filter(w => {
                      if (!dataInicio && !dataFim) return true;
                      
                      let dataRef;
                      if (tipoFiltro === 'solicitacao') {
                        dataRef = new Date(w.created_at).toISOString().split('T')[0];
                      } else {
                        if (!w.debito_at) return false;
                        dataRef = new Date(w.debito_at).toISOString().split('T')[0];
                      }
                      
                      if (dataInicio && dataFim) {
                        return dataRef >= dataInicio && dataRef <= dataFim;
                      } else if (dataInicio) {
                        return dataRef >= dataInicio;
                      } else if (dataFim) {
                        return dataRef <= dataFim;
                      }
                      return true;
                    });
                    
                    const totalRecebidas = filtrados.length;
                    const rejeitadas = filtrados.filter(w => w.status === 'rejeitado').length;
                    const aprovadasTotal = filtrados.filter(w => w.status === 'aprovado' || w.status === 'aprovado_gratuidade').length;
                    const aprovadasSemGrat = filtrados.filter(w => w.status === 'aprovado').length;
                    const aprovadasComGrat = filtrados.filter(w => w.status === 'aprovado_gratuidade').length;
                    
                    // Lucro com saque: 4.5% do valor solicitado das aprovadas SEM gratuidade
                    const valorAprovadoSemGrat = filtrados.filter(w => w.status === 'aprovado').reduce((acc, w) => acc + parseFloat(w.requested_amount || 0), 0);
                    const lucroComSaque = valorAprovadoSemGrat * 0.045;
                    
                    // Deixou de arrecadar: 4.5% do valor solicitado das aprovadas COM gratuidade
                    const valorAprovadoComGrat = filtrados.filter(w => w.status === 'aprovado_gratuidade').reduce((acc, w) => acc + parseFloat(w.requested_amount || 0), 0);
                    const deixouArrecadar = valorAprovadoComGrat * 0.045;
                    
                    // Valor total das aprova√ß√µes (com + sem gratuidade)
                    const valorTotalAprovado = valorAprovadoSemGrat + valorAprovadoComGrat;
                    
                    return (
                      <>
                        {/* Per√≠odo selecionado */}
                        <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                          <p className="text-blue-800 font-semibold">
                            {tipoFiltro === 'solicitacao' ? 'üìÖ Filtrando por Data da Solicita√ß√£o' : 'üí≥ Filtrando por Data do D√©bito'}
                            {dataInicio && dataFim && dataInicio === dataFim && ` - ${new Date(dataInicio + 'T12:00:00').toLocaleDateString('pt-BR')}`}
                            {dataInicio && dataFim && dataInicio !== dataFim && ` - ${new Date(dataInicio + 'T12:00:00').toLocaleDateString('pt-BR')} at√© ${new Date(dataFim + 'T12:00:00').toLocaleDateString('pt-BR')}`}
                            {!dataInicio && !dataFim && ' - Todos os per√≠odos'}
                          </p>
                        </div>

                        {/* Cards de m√©tricas - Linha 1 */}
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-4">
                          <div className="bg-white rounded-xl shadow p-4 border-l-4 border-gray-500">
                            <p className="text-sm text-gray-600">üì• Total Recebidas</p>
                            <p className="text-3xl font-bold text-gray-700">{totalRecebidas}</p>
                          </div>
                          <div className="bg-white rounded-xl shadow p-4 border-l-4 border-green-500">
                            <p className="text-sm text-gray-600">‚úÖ Total Aprovadas</p>
                            <p className="text-3xl font-bold text-green-600">{aprovadasTotal}</p>
                          </div>
                          <div className="bg-white rounded-xl shadow p-4 border-l-4 border-blue-500">
                            <p className="text-sm text-gray-600">‚úÖ Sem Gratuidade</p>
                            <p className="text-3xl font-bold text-blue-600">{aprovadasSemGrat}</p>
                          </div>
                          <div className="bg-white rounded-xl shadow p-4 border-l-4 border-purple-500">
                            <p className="text-sm text-gray-600">üéÅ Com Gratuidade</p>
                            <p className="text-3xl font-bold text-purple-600">{aprovadasComGrat}</p>
                          </div>
                          <div className="bg-white rounded-xl shadow p-4 border-l-4 border-red-500">
                            <p className="text-sm text-gray-600">‚ùå Rejeitadas</p>
                            <p className="text-3xl font-bold text-red-600">{rejeitadas}</p>
                          </div>
                        </div>

                        {/* Cards de m√©tricas - Linha 2 (valores) */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div className="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl shadow p-6 text-white">
                            <p className="text-sm opacity-90">üíµ Valor Total Aprovado</p>
                            <p className="text-4xl font-bold mt-2">{formatMoney(valorTotalAprovado)}</p>
                            <p className="text-xs opacity-75 mt-2">Soma de {aprovadasTotal} aprova√ß√µes (com + sem gratuidade)</p>
                          </div>
                          <div className="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl shadow p-6 text-white">
                            <p className="text-sm opacity-90">üí∞ Lucro com Saque (4,5%)</p>
                            <p className="text-4xl font-bold mt-2">{formatMoney(lucroComSaque)}</p>
                            <p className="text-xs opacity-75 mt-2">Baseado em {aprovadasSemGrat} aprova√ß√µes sem gratuidade ({formatMoney(valorAprovadoSemGrat)})</p>
                          </div>
                          <div className="bg-gradient-to-r from-red-500 to-orange-500 rounded-xl shadow p-6 text-white">
                            <p className="text-sm opacity-90">üìâ Deixou de Arrecadar</p>
                            <p className="text-4xl font-bold mt-2">{formatMoney(deixouArrecadar)}</p>
                            <p className="text-xs opacity-75 mt-2">Baseado em {aprovadasComGrat} aprova√ß√µes com gratuidade ({formatMoney(valorAprovadoComGrat)})</p>
                          </div>
                        </div>
                      </>
                    );
                  })()}
                </>
              )}

              {formData.finTab === 'conciliacao' && (
                <>
                  <div className="grid md:grid-cols-5 gap-4 mb-6">
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Aprovados</p><p className="text-2xl font-bold text-green-600">{dashboardData.total_aprovados || 0}</p></div>
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Conciliados</p><p className="text-2xl font-bold text-blue-600">{dashboardData.total_conciliado || 0}</p></div>
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Pend. Conc.</p><p className="text-2xl font-bold text-yellow-600">{dashboardData.pendente_conciliacao || 0}</p></div>
                  </div>
                  <div className="bg-white rounded-xl shadow overflow-hidden">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left">Nome</th><th className="px-4 py-3 text-left">CPF</th><th className="px-4 py-3 text-left">C√≥digo</th><th className="px-4 py-3 text-right">Solicitado</th><th className="px-4 py-3 text-right">Valor Profissional</th><th className="px-4 py-3 text-center">OMIE</th></tr></thead>
                      <tbody>
                        {allWithdrawals.filter(w => w.status?.includes('aprovado')).map(w => (
                          <tr key={w.id} className="border-t hover:bg-gray-50">
                            <td className="px-4 py-3">{w.user_name}</td>
                            <td className="px-4 py-3">{w.cpf}</td>
                            <td className="px-4 py-3 font-mono">{w.user_cod}</td>
                            <td className="px-4 py-3 text-right">{formatMoney(w.requested_amount)}</td>
                            <td className="px-4 py-3 text-right font-semibold">{formatMoney(w.final_amount)}</td>
                            <td className="px-4 py-3 text-center"><input type="checkbox" checked={w.conciliacao_omie} onChange={e => handleUpdateConciliacao(w.id, 'conciliacaoOmie', e.target.checked)} className="w-5 h-5" /></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </>
              )}

              {formData.finTab === 'resumo' && (
                <>
                  {/* Campo de busca */}
                  <div className="bg-white rounded-xl shadow p-4 mb-6">
                    <div className="flex gap-4">
                      <input type="text" placeholder="üîç Buscar por c√≥digo do profissional..." value={formData.searchCod || ''} onChange={e => setFormData({...formData, searchCod: e.target.value})} className="flex-1 px-4 py-2 border rounded-lg" />
                      {formData.searchCod && <button onClick={() => setFormData({...formData, searchCod: ''})} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold">‚úï Limpar</button>}
                    </div>
                  </div>

                  {formData.searchCod && (() => {
                    const filtered = allWithdrawals.filter(w => w.user_cod.toLowerCase().includes(formData.searchCod.toLowerCase()));
                    return (
                      <>
                        {/* Cards de estat√≠sticas do profissional */}
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                          <div className="bg-white rounded-xl shadow p-4">
                            <p className="text-sm text-gray-600">Total</p>
                            <p className="text-2xl font-bold text-purple-600">{filtered.length}</p>
                          </div>
                          <div className="bg-white rounded-xl shadow p-4">
                            <p className="text-sm text-gray-600">Aguardando</p>
                            <p className="text-2xl font-bold text-yellow-600">{filtered.filter(w => w.status === 'aguardando_aprovacao').length}</p>
                          </div>
                          <div className="bg-white rounded-xl shadow p-4">
                            <p className="text-sm text-gray-600">Aprovadas</p>
                            <p className="text-2xl font-bold text-green-600">{filtered.filter(w => w.status === 'aprovado').length}</p>
                          </div>
                          <div className="bg-white rounded-xl shadow p-4">
                            <p className="text-sm text-gray-600">Aprov. Gratuidade</p>
                            <p className="text-2xl font-bold text-emerald-600">{filtered.filter(w => w.status === 'aprovado_gratuidade').length}</p>
                          </div>
                          <div className="bg-white rounded-xl shadow p-4">
                            <p className="text-sm text-gray-600">Rejeitadas</p>
                            <p className="text-2xl font-bold text-red-600">{filtered.filter(w => w.status === 'rejeitado').length}</p>
                          </div>
                        </div>

                        {/* Bot√µes de filtro */}
                        <div className="bg-white rounded-xl shadow overflow-hidden">
                          <div className="p-4 border-b">
                            <div className="flex flex-wrap gap-2">
                              <button onClick={() => setFormData({...formData, resumoFilter: ''})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${!formData.resumoFilter ? 'bg-purple-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                                üìã Todas ({filtered.length})
                              </button>
                              <button onClick={() => setFormData({...formData, resumoFilter: 'aguardando_aprovacao'})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${formData.resumoFilter === 'aguardando_aprovacao' ? 'bg-yellow-500 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                                ‚è≥ Aguardando ({filtered.filter(w => w.status === 'aguardando_aprovacao').length})
                              </button>
                              <button onClick={() => setFormData({...formData, resumoFilter: 'aprovado'})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${formData.resumoFilter === 'aprovado' ? 'bg-green-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                                ‚úÖ Aprovadas ({filtered.filter(w => w.status === 'aprovado').length})
                              </button>
                              <button onClick={() => setFormData({...formData, resumoFilter: 'aprovado_gratuidade'})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${formData.resumoFilter === 'aprovado_gratuidade' ? 'bg-emerald-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                                üéÅ Aprov. Gratuidade ({filtered.filter(w => w.status === 'aprovado_gratuidade').length})
                              </button>
                              <button onClick={() => setFormData({...formData, resumoFilter: 'rejeitado'})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${formData.resumoFilter === 'rejeitado' ? 'bg-red-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                                ‚ùå Rejeitadas ({filtered.filter(w => w.status === 'rejeitado').length})
                              </button>
                              <button onClick={() => setFormData({...formData, resumoFilter: 'inativo'})} className={`px-4 py-2 rounded-lg font-semibold text-sm ${formData.resumoFilter === 'inativo' ? 'bg-orange-500 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                                ‚ö†Ô∏è Inativo ({filtered.filter(w => w.status === 'inativo').length})
                              </button>
                            </div>
                          </div>
                          <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                              <thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left">Data</th><th className="px-4 py-3 text-left">Nome</th><th className="px-4 py-3 text-left">CPF</th><th className="px-4 py-3 text-left">C√≥digo</th><th className="px-4 py-3 text-right">Solicitado</th><th className="px-4 py-3 text-right">Valor Profissional</th><th className="px-4 py-3 text-left">PIX</th><th className="px-4 py-3 text-center">Status</th><th className="px-4 py-3 text-left">Alterado por</th></tr></thead>
                              <tbody>
                                {filtered.filter(w => !formData.resumoFilter || w.status === formData.resumoFilter).map(w => (
                                  <tr key={w.id} className={`border-t hover:bg-gray-50 ${w.has_gratuity ? 'row-green' : ''} ${w.is_restricted ? 'row-red' : ''}`}>
                                    <td className="px-4 py-3 whitespace-nowrap">{new Date(w.created_at).toLocaleString('pt-BR')}</td>
                                    <td className="px-4 py-3">{w.user_name}</td>
                                    <td className="px-4 py-3">{w.cpf}</td>
                                    <td className="px-4 py-3 font-mono">{w.user_cod}</td>
                                    <td className="px-4 py-3 text-right font-semibold">{formatMoney(w.requested_amount)}</td>
                                    <td className="px-4 py-3 text-right">{formatMoney(w.final_amount)}</td>
                                    <td className="px-4 py-3 text-xs max-w-[150px] truncate">{w.pix_key}</td>
                                    <td className="px-4 py-3">
                                      <span className={`px-2 py-1 rounded text-xs font-bold ${w.status === 'aprovado' ? 'bg-green-500 text-white' : w.status === 'aprovado_gratuidade' ? 'bg-emerald-500 text-white' : w.status === 'rejeitado' ? 'bg-red-500 text-white' : w.status === 'inativo' ? 'bg-orange-500 text-white' : 'bg-yellow-500 text-white'}`}>
                                        {w.status === 'aguardando_aprovacao' ? '‚è≥ Aguardando' : w.status === 'aprovado' ? '‚úÖ Aprovado' : w.status === 'aprovado_gratuidade' ? 'üéÅ c/ Gratuidade' : w.status === 'rejeitado' ? '‚ùå Rejeitado' : '‚ö†Ô∏è Inativo'}
                                      </span>
                                      {w.reject_reason && w.status === 'rejeitado' && <p className="text-xs text-red-600 mt-1">Motivo: {w.reject_reason}</p>}
                                    </td>
                                    <td className="px-4 py-3 text-xs text-purple-700 font-semibold">{w.admin_name || '-'}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </>
                    );
                  })()}

                  {!formData.searchCod && (
                    <div className="bg-white rounded-xl shadow p-8 text-center">
                      <p className="text-gray-500 text-lg">üîç Digite o c√≥digo do profissional para ver o resumo</p>
                    </div>
                  )}
                </>
              )}

              {formData.finTab === 'gratuidades' && (
                <div className="space-y-6">
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="text-lg font-semibold mb-4">‚ûï Cadastrar Gratuidade</h3>
                    <div className="grid md:grid-cols-5 gap-4">
                      <input type="text" placeholder="C√≥digo" value={formData.gratUserCod || ''} onChange={e => setFormData({...formData, gratUserCod: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <input type="number" placeholder="Quantidade" value={formData.gratQty || ''} onChange={e => setFormData({...formData, gratQty: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <input type="number" placeholder="Valor (R$)" value={formData.gratValue || ''} onChange={e => setFormData({...formData, gratValue: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <input type="text" placeholder="Motivo" value={formData.gratReason || ''} onChange={e => setFormData({...formData, gratReason: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <button onClick={handleAddGratuity} disabled={loading} className="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold disabled:opacity-50">‚ûï Adicionar</button>
                    </div>
                  </div>
                  <div className="bg-white rounded-xl shadow overflow-hidden">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left">C√≥digo</th><th className="px-4 py-3 text-center">Qtd</th><th className="px-4 py-3 text-center">Rest.</th><th className="px-4 py-3 text-right">Valor</th><th className="px-4 py-3 text-left">Motivo</th><th className="px-4 py-3 text-center">Status</th></tr></thead>
                      <tbody>
                        {gratuities.map(g => (
                          <tr key={g.id} className={`border-t ${g.status === 'ativa' ? 'bg-green-50' : ''}`}>
                            <td className="px-4 py-3 font-mono">{g.user_cod}</td>
                            <td className="px-4 py-3 text-center">{g.quantity}</td>
                            <td className="px-4 py-3 text-center font-bold">{g.remaining}</td>
                            <td className="px-4 py-3 text-right">{formatMoney(g.value)}</td>
                            <td className="px-4 py-3">{g.reason || '-'}</td>
                            <td className="px-4 py-3 text-center"><span className={`px-2 py-1 rounded text-xs font-bold ${g.status === 'ativa' ? 'bg-green-500 text-white' : 'bg-gray-400 text-white'}`}>{g.status}</span></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {formData.finTab === 'restritos' && (
                <div className="space-y-6">
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="text-lg font-semibold mb-4">‚ûï Adicionar Restri√ß√£o</h3>
                    <div className="grid md:grid-cols-3 gap-4">
                      <input type="text" placeholder="C√≥digo" value={formData.restUserCod || ''} onChange={e => setFormData({...formData, restUserCod: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <input type="text" placeholder="Motivo" value={formData.restReason || ''} onChange={e => setFormData({...formData, restReason: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <button onClick={handleAddRestriction} disabled={loading} className="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold disabled:opacity-50">üö´ Adicionar</button>
                    </div>
                  </div>
                  <div className="bg-white rounded-xl shadow overflow-hidden">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left">C√≥digo</th><th className="px-4 py-3 text-left">Motivo</th><th className="px-4 py-3 text-left">Data</th><th className="px-4 py-3 text-center">Status</th><th className="px-4 py-3 text-center">A√ß√£o</th></tr></thead>
                      <tbody>
                        {restrictedList.map(r => (
                          <tr key={r.id} className={`border-t ${r.status === 'ativo' ? 'bg-red-50' : ''}`}>
                            <td className="px-4 py-3 font-mono">{r.user_cod}</td>
                            <td className="px-4 py-3">{r.reason}</td>
                            <td className="px-4 py-3">{new Date(r.created_at).toLocaleDateString('pt-BR')}</td>
                            <td className="px-4 py-3 text-center"><span className={`px-2 py-1 rounded text-xs font-bold ${r.status === 'ativo' ? 'bg-red-500 text-white' : 'bg-gray-400 text-white'}`}>{r.status}</span></td>
                            <td className="px-4 py-3 text-center">{r.status === 'ativo' && <button onClick={() => handleRemoveRestriction(r.id)} className="px-3 py-1 bg-green-600 text-white rounded text-xs">Suspender</button>}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* ========== ABA RELAT√ìRIOS ========== */}
              {formData.finTab === 'relatorios' && (
                <>
                  {(() => {
                    const now = new Date();
                    const mesAtual = now.getMonth();
                    const anoAtual = now.getFullYear();
                    
                    // Per√≠odo selecionado
                    const mesSelecionado = formData.relMes !== undefined ? parseInt(formData.relMes) : mesAtual;
                    const anoSelecionado = formData.relAno !== undefined ? parseInt(formData.relAno) : anoAtual;
                    
                    // Filtrar saques do per√≠odo
                    const saquesDoMes = allWithdrawals.filter(w => {
                      const d = new Date(w.created_at);
                      return d.getMonth() === mesSelecionado && d.getFullYear() === anoSelecionado;
                    });
                    
                    const aprovados = saquesDoMes.filter(w => w.status === 'aprovado' || w.status === 'aprovado_gratuidade');
                    const aprovadosSemGrat = saquesDoMes.filter(w => w.status === 'aprovado');
                    const aprovadosComGrat = saquesDoMes.filter(w => w.status === 'aprovado_gratuidade');
                    const rejeitados = saquesDoMes.filter(w => w.status === 'rejeitado');
                    const pendentes = saquesDoMes.filter(w => w.status === 'aguardando_aprovacao');
                    
                    const totalSolicitado = saquesDoMes.reduce((acc, w) => acc + parseFloat(w.requested_amount || 0), 0);
                    const totalPago = aprovados.reduce((acc, w) => acc + parseFloat(w.final_amount || 0), 0);
                    const lucroTaxas = aprovadosSemGrat.reduce((acc, w) => acc + (parseFloat(w.requested_amount || 0) - parseFloat(w.final_amount || 0)), 0);
                    const deixouArrecadar = aprovadosComGrat.reduce((acc, w) => acc + (parseFloat(w.requested_amount || 0) * 0.045), 0);
                    
                    // Dados por semana
                    const semanas = [
                      { nome: 'Semana 1', dias: [1,7] },
                      { nome: 'Semana 2', dias: [8,14] },
                      { nome: 'Semana 3', dias: [15,21] },
                      { nome: 'Semana 4', dias: [22,31] }
                    ];
                    
                    const dadosSemanas = semanas.map(s => {
                      const saquesSemana = aprovados.filter(w => {
                        const dia = new Date(w.created_at).getDate();
                        return dia >= s.dias[0] && dia <= s.dias[1];
                      });
                      return {
                        nome: s.nome,
                        valor: saquesSemana.reduce((acc, w) => acc + parseFloat(w.final_amount || 0), 0),
                        qtd: saquesSemana.length
                      };
                    });
                    const maxSemana = Math.max(...dadosSemanas.map(s => s.valor), 1);
                    
                    // Comparativo m√™s anterior
                    const mesAnterior = mesSelecionado === 0 ? 11 : mesSelecionado - 1;
                    const anoMesAnterior = mesSelecionado === 0 ? anoSelecionado - 1 : anoSelecionado;
                    const saquesMesAnterior = allWithdrawals.filter(w => {
                      const d = new Date(w.created_at);
                      return d.getMonth() === mesAnterior && d.getFullYear() === anoMesAnterior && (w.status === 'aprovado' || w.status === 'aprovado_gratuidade');
                    });
                    const totalMesAnterior = saquesMesAnterior.reduce((acc, w) => acc + parseFloat(w.final_amount || 0), 0);
                    const variacaoPercent = totalMesAnterior > 0 ? ((totalPago - totalMesAnterior) / totalMesAnterior * 100) : 0;
                    
                    // √öltimos 6 meses para gr√°fico
                    const ultimos6Meses = [];
                    for (let i = 5; i >= 0; i--) {
                      const d = new Date(anoSelecionado, mesSelecionado - i, 1);
                      const mes = d.getMonth();
                      const ano = d.getFullYear();
                      const saquesMes = allWithdrawals.filter(w => {
                        const dw = new Date(w.created_at);
                        return dw.getMonth() === mes && dw.getFullYear() === ano && (w.status === 'aprovado' || w.status === 'aprovado_gratuidade');
                      });
                      const valor = saquesMes.reduce((acc, w) => acc + parseFloat(w.final_amount || 0), 0);
                      ultimos6Meses.push({
                        mes: d.toLocaleDateString('pt-BR', { month: 'short' }).replace('.', ''),
                        valor,
                        qtd: saquesMes.length
                      });
                    }
                    const maxValor6 = Math.max(...ultimos6Meses.map(m => m.valor), 1);
                    
                    const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                    const nomeMes = meses[mesSelecionado];
                    
                    // Fun√ß√£o gerar PDF
                    const gerarPDF = () => {
                      const conteudo = `
                        <html>
                        <head>
                          <title>Relat√≥rio ${nomeMes} ${anoSelecionado}</title>
                          <style>
                            body { font-family: Arial, sans-serif; padding: 40px; font-size: 12px; }
                            h1 { color: #166534; border-bottom: 3px solid #166534; padding-bottom: 10px; }
                            h2 { color: #374151; margin-top: 25px; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; }
                            .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
                            .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
                            .card { background: #f3f4f6; padding: 15px; border-radius: 8px; text-align: center; }
                            .card-value { font-size: 20px; font-weight: bold; color: #166534; }
                            .card-label { font-size: 11px; color: #6b7280; }
                            table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px; }
                            th, td { border: 1px solid #d1d5db; padding: 8px; text-align: left; }
                            th { background: #166534; color: white; }
                            tr:nth-child(even) { background: #f9fafb; }
                            .green { color: #059669; }
                            .red { color: #dc2626; }
                            .footer { margin-top: 30px; text-align: center; color: #9ca3af; font-size: 10px; border-top: 1px solid #e5e7eb; padding-top: 15px; }
                            .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 15px 0; }
                            .stat-box { background: #ecfdf5; padding: 12px; border-radius: 8px; border-left: 4px solid #059669; }
                            .stat-box.red { background: #fef2f2; border-left-color: #dc2626; }
                          </style>
                        </head>
                        <body>
                          <div class="header">
                            <div><h1>üìä Relat√≥rio Financeiro - ${nomeMes} ${anoSelecionado}</h1></div>
                          </div>
                          <p><strong>Gerado em:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                          
                          <h2>üìà Resumo do Per√≠odo</h2>
                          <div class="cards">
                            <div class="card"><div class="card-value">R$ ${totalSolicitado.toFixed(2)}</div><div class="card-label">Total Solicitado</div></div>
                            <div class="card"><div class="card-value">R$ ${totalPago.toFixed(2)}</div><div class="card-label">Total Pago</div></div>
                            <div class="card"><div class="card-value" style="color:#059669">R$ ${lucroTaxas.toFixed(2)}</div><div class="card-label">Lucro (Taxas 4,5%)</div></div>
                            <div class="card"><div class="card-value" style="color:#dc2626">R$ ${deixouArrecadar.toFixed(2)}</div><div class="card-label">Deixou Arrecadar</div></div>
                          </div>
                          
                          <div class="stats-row">
                            <div class="stat-box"><strong>${aprovados.length}</strong> Aprovados</div>
                            <div class="stat-box"><strong>${aprovadosSemGrat.length}</strong> Sem Gratuidade</div>
                            <div class="stat-box"><strong>${aprovadosComGrat.length}</strong> Com Gratuidade</div>
                          </div>
                          <div class="stats-row">
                            <div class="stat-box red"><strong>${rejeitados.length}</strong> Rejeitados</div>
                            <div class="stat-box"><strong>${pendentes.length}</strong> Pendentes</div>
                            <div class="stat-box"><strong>${saquesDoMes.length}</strong> Total Solicita√ß√µes</div>
                          </div>
                          
                          <h2>üìä Comparativo</h2>
                          <p>M√™s anterior: <strong>R$ ${totalMesAnterior.toFixed(2)}</strong> | M√™s atual: <strong>R$ ${totalPago.toFixed(2)}</strong> | Varia√ß√£o: <span class="${variacaoPercent >= 0 ? 'green' : 'red'}"><strong>${variacaoPercent >= 0 ? '+' : ''}${variacaoPercent.toFixed(1)}%</strong></span></p>
                          
                          <h2>üìã Detalhamento das Solicita√ß√µes</h2>
                          <table>
                            <thead><tr><th>Data</th><th>Profissional</th><th>C√≥digo</th><th>Solicitado</th><th>Pago</th><th>Status</th></tr></thead>
                            <tbody>
                              ${saquesDoMes.map(w => `
                                <tr>
                                  <td>${new Date(w.created_at).toLocaleDateString('pt-BR')}</td>
                                  <td>${w.user_name || '-'}</td>
                                  <td>${w.user_cod}</td>
                                  <td>R$ ${parseFloat(w.requested_amount).toFixed(2)}</td>
                                  <td>R$ ${parseFloat(w.final_amount).toFixed(2)}</td>
                                  <td>${w.status === 'aprovado' ? '‚úÖ Aprovado' : w.status === 'aprovado_gratuidade' ? 'üéÅ c/ Gratuidade' : w.status === 'rejeitado' ? '‚ùå Rejeitado' : '‚è≥ Pendente'}</td>
                                </tr>
                              `).join('')}
                            </tbody>
                          </table>
                          
                          <div class="footer">
                            <p>Sistema Tutts - Relat√≥rio Financeiro Gerado Automaticamente</p>
                          </div>
                        </body>
                        </html>
                      `;
                      const janela = window.open('', '_blank');
                      janela.document.write(conteudo);
                      janela.document.close();
                      janela.print();
                    };
                    
                    return (
                      <div className="space-y-6">
                        {/* Seletor de Per√≠odo e Bot√µes */}
                        <div className="bg-white rounded-xl shadow p-4">
                          <div className="flex flex-wrap gap-4 items-end">
                            <div>
                              <label className="block text-sm font-semibold mb-1">M√™s</label>
                              <select value={mesSelecionado} onChange={e => setFormData({...formData, relMes: e.target.value})} className="px-4 py-2 border rounded-lg">
                                {meses.map((m, i) => <option key={i} value={i}>{m}</option>)}
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-semibold mb-1">Ano</label>
                              <select value={anoSelecionado} onChange={e => setFormData({...formData, relAno: e.target.value})} className="px-4 py-2 border rounded-lg">
                                {[anoAtual - 1, anoAtual, anoAtual + 1].map(a => <option key={a} value={a}>{a}</option>)}
                              </select>
                            </div>
                            <button onClick={gerarPDF} className="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">
                              üìÑ Gerar PDF
                            </button>
                          </div>
                        </div>
                        
                        {/* Cards Resumo */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                          <div className="bg-white rounded-xl shadow p-4 border-l-4 border-blue-500">
                            <p className="text-xs text-gray-500">üí∞ Total Solicitado</p>
                            <p className="text-2xl font-bold text-blue-600">{formatMoney(totalSolicitado)}</p>
                          </div>
                          <div className="bg-white rounded-xl shadow p-4 border-l-4 border-purple-500">
                            <p className="text-xs text-gray-500">üíµ Total Pago</p>
                            <p className="text-2xl font-bold text-purple-600">{formatMoney(totalPago)}</p>
                          </div>
                          <div className="bg-white rounded-xl shadow p-4 border-l-4 border-green-500">
                            <p className="text-xs text-gray-500">üìà Lucro (Taxas)</p>
                            <p className="text-2xl font-bold text-green-600">{formatMoney(lucroTaxas)}</p>
                          </div>
                          <div className="bg-white rounded-xl shadow p-4 border-l-4 border-red-500">
                            <p className="text-xs text-gray-500">üìâ Deixou Arrecadar</p>
                            <p className="text-2xl font-bold text-red-600">{formatMoney(deixouArrecadar)}</p>
                          </div>
                        </div>
                        
                        {/* Comparativo */}
                        <div className={`rounded-xl p-4 ${variacaoPercent >= 0 ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
                          <h3 className="font-semibold mb-2">üìä Comparativo com M√™s Anterior</h3>
                          <div className="flex items-center gap-6">
                            <div>
                              <p className="text-sm text-gray-600">M√™s anterior: <strong>{formatMoney(totalMesAnterior)}</strong></p>
                              <p className="text-sm text-gray-600">M√™s atual: <strong>{formatMoney(totalPago)}</strong></p>
                            </div>
                            <div className={`text-3xl font-bold ${variacaoPercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                              {variacaoPercent >= 0 ? 'üìà' : 'üìâ'} {variacaoPercent >= 0 ? '+' : ''}{variacaoPercent.toFixed(1)}%
                            </div>
                          </div>
                        </div>
                        
                        {/* Status */}
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                          <div className="bg-green-100 rounded-xl p-4 text-center">
                            <p className="text-3xl font-bold text-green-600">{aprovados.length}</p>
                            <p className="text-xs text-green-700">Aprovados</p>
                          </div>
                          <div className="bg-blue-100 rounded-xl p-4 text-center">
                            <p className="text-3xl font-bold text-blue-600">{aprovadosSemGrat.length}</p>
                            <p className="text-xs text-blue-700">Sem Gratuidade</p>
                          </div>
                          <div className="bg-purple-100 rounded-xl p-4 text-center">
                            <p className="text-3xl font-bold text-purple-600">{aprovadosComGrat.length}</p>
                            <p className="text-xs text-purple-700">Com Gratuidade</p>
                          </div>
                          <div className="bg-red-100 rounded-xl p-4 text-center">
                            <p className="text-3xl font-bold text-red-600">{rejeitados.length}</p>
                            <p className="text-xs text-red-700">Rejeitados</p>
                          </div>
                          <div className="bg-yellow-100 rounded-xl p-4 text-center">
                            <p className="text-3xl font-bold text-yellow-600">{pendentes.length}</p>
                            <p className="text-xs text-yellow-700">Pendentes</p>
                          </div>
                        </div>
                        
                        {/* Gr√°fico Evolu√ß√£o 6 meses */}
                        <div className="bg-white rounded-xl shadow p-4">
                          <h3 className="font-semibold mb-4">üìä Evolu√ß√£o (√öltimos 6 meses)</h3>
                          <div className="flex items-end justify-between gap-2 h-48">
                            {ultimos6Meses.map((m, i) => (
                              <div key={i} className="flex-1 flex flex-col items-center">
                                <span className="text-xs text-gray-600 mb-1">{formatMoney(m.valor)}</span>
                                <div 
                                  className="w-full bg-gradient-to-t from-green-600 to-emerald-400 rounded-t-lg"
                                  style={{ height: `${Math.max((m.valor / maxValor6) * 100, 5)}%`, minHeight: '20px' }}
                                />
                                <span className="text-xs font-semibold mt-2">{m.mes}</span>
                                <span className="text-xs text-gray-500">{m.qtd}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                        
                        {/* Gr√°fico por Semana */}
                        <div className="bg-white rounded-xl shadow p-4">
                          <h3 className="font-semibold mb-4">üìÖ Distribui√ß√£o por Semana ({nomeMes})</h3>
                          <div className="flex items-end justify-between gap-4 h-40">
                            {dadosSemanas.map((s, i) => (
                              <div key={i} className="flex-1 flex flex-col items-center">
                                <span className="text-xs text-gray-600 mb-1">{formatMoney(s.valor)}</span>
                                <div 
                                  className="w-full bg-gradient-to-t from-blue-600 to-indigo-400 rounded-t-lg"
                                  style={{ height: `${Math.max((s.valor / maxSemana) * 100, 5)}%`, minHeight: '20px' }}
                                />
                                <span className="text-xs font-semibold mt-2">{s.nome}</span>
                                <span className="text-xs text-gray-500">{s.qtd} saque(s)</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    );
                  })()}
                </>
              )}
            </div>
          </div>
        );
      }

      // ========== PAINEL ADMIN NORMAL ==========
      return (
        <div className="min-h-screen bg-gray-50">
          {toast && <Toast {...toast} />}
          {globalLoading && <LoadingOverlay />}
          {imageModal && <ImageModal imageUrl={imageModal} onClose={() => setImageModal(null)} />}

          <nav className="bg-purple-900 shadow-lg">
            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
              <h1 className="text-xl font-bold text-white">Painel Admin</h1>
              <div className="flex gap-2">
                <button onClick={refreshAll} className="px-4 py-2 bg-purple-700 text-white rounded-lg hover:bg-purple-600 text-sm font-semibold">üîÑ Atualizar</button>
                <button onClick={() => setUser(null)} className="px-4 py-2 text-white hover:bg-purple-800 rounded-lg">Sair</button>
              </div>
            </div>
          </nav>

          <div className="bg-white border-b sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-4 flex gap-1 overflow-x-auto">
              {['dashboard', 'search', 'ranking', 'relatorios', 'users'].map(tab => (
                <button key={tab} onClick={() => setFormData({...formData, adminTab: tab})} className={`px-6 py-3 font-semibold whitespace-nowrap ${(!formData.adminTab && tab === 'dashboard') || formData.adminTab === tab ? 'text-purple-900 border-b-2 border-purple-900' : 'text-gray-600'}`}>
                  {tab === 'dashboard' && 'üìä Dashboard'}
                  {tab === 'search' && 'üîç Busca Detalhada'}
                  {tab === 'ranking' && 'üèÜ Ranking'}
                  {tab === 'relatorios' && 'üìà Relat√≥rios'}
                  {tab === 'users' && 'üë• Usu√°rios'}
                </button>
              ))}
            </div>
          </div>

          <div className="max-w-7xl mx-auto p-6">
            {/* DASHBOARD */}
            {(!formData.adminTab || formData.adminTab === 'dashboard') && (
              <>
                <div className="grid md:grid-cols-4 gap-4 mb-6">
                  <div className="bg-white p-6 rounded-xl shadow"><p className="text-sm text-gray-600">Total</p><p className="text-3xl font-bold text-purple-900">{submissions.length}</p></div>
                  <div className="bg-white p-6 rounded-xl shadow"><p className="text-sm text-gray-600">Pendentes</p><p className="text-3xl font-bold text-yellow-600">{submissions.filter(s => s.status === 'pendente').length}</p></div>
                  <div className="bg-white p-6 rounded-xl shadow"><p className="text-sm text-gray-600">Aprovadas</p><p className="text-3xl font-bold text-green-600">{submissions.filter(s => s.status === 'aprovada').length}</p></div>
                  <div className="bg-white p-6 rounded-xl shadow"><p className="text-sm text-gray-600">Rejeitadas</p><p className="text-3xl font-bold text-red-600">{submissions.filter(s => s.status === 'rejeitada').length}</p></div>
                </div>

                {/* GR√ÅFICOS */}
                <div className="grid md:grid-cols-2 gap-6 mb-6">
                  <MotivosPieChart submissions={submissions} />
                  <PieChart 
                    data={[
                      { label: '‚úì Aprovadas', value: submissions.filter(s => s.status === 'aprovada').length, color: '#22c55e' },
                      { label: '‚úó Rejeitadas', value: submissions.filter(s => s.status === 'rejeitada').length, color: '#ef4444' },
                      { label: '‚è≥ Pendentes', value: submissions.filter(s => s.status === 'pendente').length, color: '#fbbf24' }
                    ]}
                    title="üìà Status das Solicita√ß√µes"
                  />
                </div>

                {/* VALIDA√á√ÉO PENDENTES */}
                <div className="bg-white rounded-xl shadow p-6">
                  <h2 className="text-lg font-semibold mb-4">Aguardando Valida√ß√£o</h2>
                  <div className="mb-4 flex flex-wrap gap-2">
                    {['all', 'retorno', 'ponto1', 'pedagio'].map(f => (
                      <button key={f} onClick={() => setFormData({...formData, pendingFilter: f})} className={`px-4 py-2 rounded-lg font-semibold ${(formData.pendingFilter || 'all') === f ? 'bg-purple-600 text-white' : 'bg-gray-100'}`}>
                        {f === 'all' && `üìã Todos (${submissions.filter(s => s.status === 'pendente').length})`}
                        {f === 'retorno' && `üîÑ Retorno (${submissions.filter(s => s.status === 'pendente' && s.motivo === 'Ajuste de Retorno').length})`}
                        {f === 'ponto1' && `üìç Ponto 1 (${submissions.filter(s => s.status === 'pendente' && s.motivo?.includes('Ponto 1')).length})`}
                        {f === 'pedagio' && `üõ£Ô∏è Ped√°gio (${submissions.filter(s => s.status === 'pendente' && s.motivo?.includes('Ped√°gio')).length})`}
                      </button>
                    ))}
                  </div>
                  <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {submissions.filter(s => {
                      if (s.status !== 'pendente') return false;
                      if (!formData.pendingFilter || formData.pendingFilter === 'all') return true;
                      if (formData.pendingFilter === 'retorno') return s.motivo === 'Ajuste de Retorno';
                      if (formData.pendingFilter === 'ponto1') return s.motivo?.includes('Ponto 1');
                      if (formData.pendingFilter === 'pedagio') return s.motivo?.includes('Ped√°gio');
                      return true;
                    }).map(s => (
                      <div key={s.id} className="border rounded-lg p-3 text-sm">
                        <p className="font-mono text-lg font-bold">OS: {s.ordemServico}</p>
                        <p className="text-xs text-gray-700">{s.fullName}</p>
                        <p className="text-xs text-purple-900 font-semibold">{s.motivo}</p>
                        {s.coordenadas && (
                          <div className="mt-2 bg-green-50 border border-green-200 rounded p-2">
                            <p className="text-xs font-mono text-green-900">{s.coordenadas}</p>
                            <div className="flex gap-2 mt-1">
                              <button onClick={() => { navigator.clipboard.writeText(s.coordenadas); showToast('Copiado!', 'success'); }} className="text-xs text-green-600">üìã Copiar</button>
                              <a href={`https://www.google.com/maps?q=${s.coordenadas}`} target="_blank" className="text-xs text-green-600">üó∫Ô∏è Maps</a>
                            </div>
                          </div>
                        )}
                        {s.temImagem && (
                          <div className="mt-2">
                            {s.imagemComprovante ? (
                              <>
                                <div className="flex gap-2 flex-wrap">
                                  {s.imagemComprovante.split('|||').map((img, i) => <img key={i} src={img} className="h-20 rounded cursor-pointer" onClick={() => setImageModal(img)} />)}
                                </div>
                                <button onClick={() => setSubmissions(prev => prev.map(sub => sub.id === s.id ? {...sub, imagemComprovante: null} : sub))} className="text-xs text-gray-500">‚ñ≤ Ocultar</button>
                              </>
                            ) : (
                              <button onClick={() => { showToast('üîÑ Carregando...', 'success'); loadImagem(s.id); }} className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">üì∑ Ver foto(s)</button>
                            )}
                          </div>
                        )}
                        <textarea placeholder="Obs (opcional)" value={formData[`obs_${s.id}`] || ''} onChange={e => setFormData({...formData, [`obs_${s.id}`]: e.target.value})} className="w-full px-2 py-1 border rounded mt-2 text-xs" rows="1" />
                        <div className="flex gap-2 mt-2">
                          <button onClick={() => handleValidate(s.id, true)} className="flex-1 bg-green-600 text-white py-1 rounded text-xs font-semibold">‚úì Aprovar</button>
                          <button onClick={() => handleValidate(s.id, false)} className="flex-1 bg-red-600 text-white py-1 rounded text-xs font-semibold">‚úó Rejeitar</button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </>
            )}

            {/* BUSCA DETALHADA */}
            {formData.adminTab === 'search' && (
              <div className="bg-white rounded-xl shadow p-6">
                <div className="flex flex-wrap gap-4 mb-6">
                  <input type="text" placeholder="üîç Buscar por OS ou c√≥digo..." value={formData.searchOS || ''} onChange={e => setFormData({...formData, searchOS: e.target.value})} className="flex-1 px-4 py-2 border rounded-lg" />
                  <select value={formData.statusFilter || ''} onChange={e => setFormData({...formData, statusFilter: e.target.value})} className="px-4 py-2 border rounded-lg">
                    <option value="">Todos status</option>
                    <option value="pendente">Pendente</option>
                    <option value="aprovada">Aprovada</option>
                    <option value="rejeitada">Rejeitada</option>
                  </select>
                  <select value={formData.dateFilter || ''} onChange={e => setFormData({...formData, dateFilter: e.target.value})} className="px-4 py-2 border rounded-lg">
                    <option value="">Todo per√≠odo</option>
                    <option value="today">Hoje</option>
                    <option value="week">Esta semana</option>
                    <option value="month">Este m√™s</option>
                  </select>
                </div>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {submissions.filter(s => {
                    if (formData.searchOS && !s.ordemServico?.toLowerCase().includes(formData.searchOS.toLowerCase()) && !s.codProfissional?.toLowerCase().includes(formData.searchOS.toLowerCase())) return false;
                    if (formData.statusFilter && s.status !== formData.statusFilter) return false;
                    if (formData.dateFilter) {
                      const today = new Date(); today.setHours(0,0,0,0);
                      const subDate = new Date(s.created_at);
                      if (formData.dateFilter === 'today') { const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate()+1); if (subDate < today || subDate >= tomorrow) return false; }
                      else if (formData.dateFilter === 'week') { const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate()-7); if (subDate < weekAgo) return false; }
                      else if (formData.dateFilter === 'month') { const monthAgo = new Date(today); monthAgo.setMonth(monthAgo.getMonth()-1); if (subDate < monthAgo) return false; }
                    }
                    return true;
                  }).map(s => (
                    <div key={s.id} className={`border rounded-lg p-3 text-sm ${s.status === 'aprovada' ? 'bg-green-50' : s.status === 'rejeitada' ? 'bg-red-50' : 'bg-yellow-50'}`}>
                      <div className="flex justify-between items-start mb-1">
                        <div><p className="font-mono font-bold">OS: {s.ordemServico}</p><p className="text-xs text-gray-700">{s.fullName}</p></div>
                        <div className="flex items-center gap-1">
                          <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${s.status === 'aprovada' ? 'bg-green-600 text-white' : s.status === 'rejeitada' ? 'bg-red-600 text-white' : 'bg-yellow-600 text-white'}`}>{s.status?.toUpperCase()}</span>
                          <button onClick={async () => { if (!confirm(`Excluir OS ${s.ordemServico}?`)) return; await fetch(`${API_URL}/submissions/${s.id}`, { method: 'DELETE' }); showToast('üóëÔ∏è Exclu√≠da!', 'success'); loadSubmissions(); }} className="px-1.5 py-0.5 bg-red-600 text-white rounded text-xs">üóëÔ∏è</button>
                        </div>
                      </div>
                      <p className="text-xs text-gray-600">{s.motivo}</p>
                      {s.coordenadas && (
                        <div className="mt-1 bg-green-50 border border-green-200 rounded p-1.5 flex items-center justify-between">
                          <p className="text-xs font-mono text-green-900">{s.coordenadas}</p>
                          <button onClick={() => { navigator.clipboard.writeText(s.coordenadas); showToast('üìã Copiado!', 'success'); }} className="px-1.5 py-0.5 bg-green-600 text-white text-xs rounded">üìã</button>
                        </div>
                      )}
                      {s.temImagem && (
                        <div className="mt-1">
                          {s.imagemComprovante ? (
                            <>
                              <div className="flex gap-1 flex-wrap">{s.imagemComprovante.split('|||').map((img, i) => <img key={i} src={img} className="h-20 rounded cursor-pointer" onClick={() => setImageModal(img)} />)}</div>
                              <button onClick={() => setSubmissions(prev => prev.map(sub => sub.id === s.id ? {...sub, imagemComprovante: null} : sub))} className="text-xs text-gray-500">‚ñ≤ Ocultar</button>
                            </>
                          ) : (
                            <button onClick={() => { showToast('üîÑ Carregando...', 'success'); loadImagem(s.id); }} className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs font-semibold">üì∑ Ver foto(s)</button>
                          )}
                        </div>
                      )}
                      {s.observacao && <div className="mt-1 bg-white p-1 rounded border"><p className="text-xs text-gray-600">Obs: {s.observacao}</p></div>}
                      <div className="flex justify-between items-center mt-1">
                        <p className="text-xs text-gray-400">{s.timestamp}</p>
                        {s.validated_by_name && s.status !== 'pendente' && <p className="text-xs text-purple-600 font-semibold">üë§ {s.validated_by_name}</p>}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* RANKING */}
            {formData.adminTab === 'ranking' && (
              <div className="bg-white rounded-xl shadow p-6">
                <h2 className="text-lg font-semibold mb-4">üèÜ Ranking de Retorno - Aprova√ß√µes</h2>
                <div className="mb-6">
                  <select value={formData.rankingPeriod || 'all'} onChange={e => setFormData({...formData, rankingPeriod: e.target.value})} className="px-4 py-2 border rounded-lg">
                    <option value="all">üìÖ Todos os Tempos</option>
                    <option value="today">üìÖ Hoje</option>
                    <option value="week">üìÖ Esta Semana</option>
                    <option value="month">üìÖ Este M√™s</option>
                  </select>
                </div>
                <div className="space-y-3">
                  {(() => {
                    const today = new Date(); today.setHours(0,0,0,0);
                    const filtered = submissions.filter(s => {
                      if (s.status !== 'aprovada' || s.motivo !== 'Ajuste de Retorno') return false;
                      if (!formData.rankingPeriod || formData.rankingPeriod === 'all') return true;
                      const subDate = new Date(s.created_at);
                      if (formData.rankingPeriod === 'today') { const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate()+1); return subDate >= today && subDate < tomorrow; }
                      if (formData.rankingPeriod === 'week') { const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate()-7); return subDate >= weekAgo; }
                      if (formData.rankingPeriod === 'month') { const monthAgo = new Date(today); monthAgo.setMonth(monthAgo.getMonth()-1); return subDate >= monthAgo; }
                      return true;
                    });
                    const stats = {};
                    filtered.forEach(s => { const n = s.fullName || 'Desconhecido'; stats[n] = (stats[n] || 0) + 1; });
                    const ranking = Object.entries(stats).sort((a, b) => b[1] - a[1]);
                    if (ranking.length === 0) return <p className="text-gray-500 text-center py-8">Sem dados no per√≠odo</p>;
                    return ranking.map(([name, count], i) => (
                      <div key={i} className="flex items-center gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <div className={`text-3xl font-bold w-12 ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : i === 2 ? 'text-orange-600' : 'text-gray-400'}`}>{i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i+1}¬∫`}</div>
                        <div className="flex-1"><p className="font-semibold text-lg text-gray-800">{name}</p></div>
                        <div className="text-right"><p className="text-3xl font-bold text-purple-600">{count}</p><p className="text-xs text-gray-500">aprova√ß√µes</p></div>
                      </div>
                    ));
                  })()}
                </div>
              </div>
            )}

            {/* ESTAT√çSTICAS */}
            {formData.adminTab === 'relatorios' && (() => {
              // C√°lculos para o relat√≥rio
              const mesAtual = formData.relMes !== undefined ? parseInt(formData.relMes) : new Date().getMonth();
              const anoAtual = formData.relAno !== undefined ? parseInt(formData.relAno) : new Date().getFullYear();
              
              const submissoesMes = submissions.filter(s => {
                const d = new Date(s.created_at);
                return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
              });
              
              const aprovadas = submissoesMes.filter(s => s.status === 'aprovada');
              const rejeitadas = submissoesMes.filter(s => s.status === 'rejeitada');
              const pendentes = submissoesMes.filter(s => s.status === 'pendente');
              
              const taxaAprovacao = submissoesMes.length > 0 ? ((aprovadas.length / submissoesMes.length) * 100).toFixed(1) : 0;
              const taxaRejeicao = submissoesMes.length > 0 ? ((rejeitadas.length / submissoesMes.length) * 100).toFixed(1) : 0;
              
              // Por motivo
              const porMotivo = {};
              submissoesMes.forEach(s => {
                const motivo = s.motivo || 'Outros';
                if (!porMotivo[motivo]) porMotivo[motivo] = { total: 0, aprovadas: 0, rejeitadas: 0, pendentes: 0 };
                porMotivo[motivo].total++;
                if (s.status === 'aprovada') porMotivo[motivo].aprovadas++;
                if (s.status === 'rejeitada') porMotivo[motivo].rejeitadas++;
                if (s.status === 'pendente') porMotivo[motivo].pendentes++;
              });
              
              // Por profissional
              const porTecnico = {};
              submissoesMes.forEach(s => {
                const tec = s.user_name || s.cod_profissional || 'Desconhecido';
                if (!porTecnico[tec]) porTecnico[tec] = { total: 0, aprovadas: 0, rejeitadas: 0, cod: s.cod_profissional };
                porTecnico[tec].total++;
                if (s.status === 'aprovada') porTecnico[tec].aprovadas++;
                if (s.status === 'rejeitada') porTecnico[tec].rejeitadas++;
              });
              
              // Top 5 profissionais
              const topTecnicos = Object.entries(porTecnico)
                .map(([nome, dados]) => ({ nome, ...dados, taxa: dados.total > 0 ? ((dados.aprovadas / dados.total) * 100).toFixed(0) : 0 }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
              
              // Por semana
              const porSemana = [
                { label: 'Semana 1', dias: [1,7], total: 0, aprovadas: 0 },
                { label: 'Semana 2', dias: [8,14], total: 0, aprovadas: 0 },
                { label: 'Semana 3', dias: [15,21], total: 0, aprovadas: 0 },
                { label: 'Semana 4', dias: [22,31], total: 0, aprovadas: 0 }
              ];
              submissoesMes.forEach(s => {
                const dia = new Date(s.created_at).getDate();
                const semana = porSemana.find(sem => dia >= sem.dias[0] && dia <= sem.dias[1]);
                if (semana) {
                  semana.total++;
                  if (s.status === 'aprovada') semana.aprovadas++;
                }
              });
              const maxSemana = Math.max(...porSemana.map(s => s.total), 1);
              
              // √öltimos 6 meses
              const ultimos6Meses = [];
              for (let i = 5; i >= 0; i--) {
                const d = new Date(anoAtual, mesAtual - i, 1);
                const mes = d.getMonth();
                const ano = d.getFullYear();
                const subs = submissions.filter(s => {
                  const sd = new Date(s.created_at);
                  return sd.getMonth() === mes && sd.getFullYear() === ano;
                });
                ultimos6Meses.push({
                  label: d.toLocaleDateString('pt-BR', { month: 'short' }),
                  total: subs.length,
                  aprovadas: subs.filter(s => s.status === 'aprovada').length
                });
              }
              const maxMes = Math.max(...ultimos6Meses.map(m => m.total), 1);
              
              // M√™s anterior para comparativo
              const mesAnteriorData = new Date(anoAtual, mesAtual - 1, 1);
              const submissoesMesAnterior = submissions.filter(s => {
                const d = new Date(s.created_at);
                return d.getMonth() === mesAnteriorData.getMonth() && d.getFullYear() === mesAnteriorData.getFullYear();
              });
              const variacaoTotal = submissoesMesAnterior.length > 0 
                ? (((submissoesMes.length - submissoesMesAnterior.length) / submissoesMesAnterior.length) * 100).toFixed(1) 
                : 0;
              
              const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
              
              // Fun√ß√£o gerar PDF
              const gerarPDF = () => {
                const conteudo = `
                  <html>
                  <head>
                    <title>Relat√≥rio Tutts - ${meses[mesAtual]}/${anoAtual}</title>
                    <style>
                      body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                      h1 { color: #581c87; border-bottom: 2px solid #581c87; padding-bottom: 10px; }
                      h2 { color: #7c3aed; margin-top: 30px; }
                      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
                      .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
                      .card { background: #f3f4f6; padding: 15px; border-radius: 8px; text-align: center; }
                      .card-value { font-size: 28px; font-weight: bold; }
                      .green { color: #16a34a; }
                      .red { color: #dc2626; }
                      .yellow { color: #ca8a04; }
                      .purple { color: #7c3aed; }
                      table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                      th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                      th { background: #f3f4f6; }
                      .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 20px; }
                      .comparativo { background: ${parseFloat(variacaoTotal) >= 0 ? '#dcfce7' : '#fee2e2'}; padding: 15px; border-radius: 8px; margin: 20px 0; }
                    </style>
                  </head>
                  <body>
                    <div class="header">
                      <h1>üìä Relat√≥rio Tutts</h1>
                      <div>
                        <strong>${meses[mesAtual]} / ${anoAtual}</strong><br>
                        <small>Gerado em: ${new Date().toLocaleString('pt-BR')}</small>
                      </div>
                    </div>
                    
                    <h2>üìã Resumo Geral</h2>
                    <div class="cards">
                      <div class="card"><div class="card-value purple">${submissoesMes.length}</div><div>Total</div></div>
                      <div class="card"><div class="card-value green">${aprovadas.length}</div><div>Aprovadas</div></div>
                      <div class="card"><div class="card-value red">${rejeitadas.length}</div><div>Rejeitadas</div></div>
                      <div class="card"><div class="card-value yellow">${pendentes.length}</div><div>Pendentes</div></div>
                    </div>
                    
                    <div class="cards">
                      <div class="card"><div class="card-value green">${taxaAprovacao}%</div><div>Taxa Aprova√ß√£o</div></div>
                      <div class="card"><div class="card-value red">${taxaRejeicao}%</div><div>Taxa Rejei√ß√£o</div></div>
                      <div class="card"><div class="card-value purple">${users.length}</div><div>Profissionais</div></div>
                      <div class="card"><div class="card-value purple">${users.length > 0 ? (submissoesMes.length / users.length).toFixed(1) : 0}</div><div>M√©dia/Profissional</div></div>
                    </div>
                    
                    <div class="comparativo">
                      <strong>üìä Comparativo com M√™s Anterior:</strong> 
                      ${parseFloat(variacaoTotal) >= 0 ? 'üìà' : 'üìâ'} ${parseFloat(variacaoTotal) >= 0 ? '+' : ''}${variacaoTotal}% 
                      (${submissoesMesAnterior.length} ‚Üí ${submissoesMes.length} solicita√ß√µes)
                    </div>
                    
                    <h2>üìÅ Por Motivo</h2>
                    <table>
                      <thead><tr><th>Motivo</th><th>Total</th><th>Aprovadas</th><th>Rejeitadas</th><th>Pendentes</th><th>Taxa</th></tr></thead>
                      <tbody>
                        ${Object.entries(porMotivo).map(([motivo, dados]) => `
                          <tr>
                            <td>${motivo}</td>
                            <td>${dados.total}</td>
                            <td class="green">${dados.aprovadas}</td>
                            <td class="red">${dados.rejeitadas}</td>
                            <td class="yellow">${dados.pendentes}</td>
                            <td>${dados.total > 0 ? ((dados.aprovadas / dados.total) * 100).toFixed(0) : 0}%</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                    
                    <h2>üë∑ Top 10 Profissionais</h2>
                    <table>
                      <thead><tr><th>#</th><th>Profissional</th><th>C√≥digo</th><th>Total</th><th>Aprovadas</th><th>Rejeitadas</th><th>Taxa</th></tr></thead>
                      <tbody>
                        ${topTecnicos.map((t, i) => `
                          <tr>
                            <td>${i + 1}</td>
                            <td>${t.nome}</td>
                            <td>${t.cod || '-'}</td>
                            <td>${t.total}</td>
                            <td class="green">${t.aprovadas}</td>
                            <td class="red">${t.rejeitadas}</td>
                            <td>${t.taxa}%</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                    
                    <h2>üìÖ Por Semana</h2>
                    <table>
                      <thead><tr><th>Semana</th><th>Total</th><th>Aprovadas</th><th>Taxa</th></tr></thead>
                      <tbody>
                        ${porSemana.map(s => `
                          <tr>
                            <td>${s.label} (dias ${s.dias[0]}-${s.dias[1]})</td>
                            <td>${s.total}</td>
                            <td class="green">${s.aprovadas}</td>
                            <td>${s.total > 0 ? ((s.aprovadas / s.total) * 100).toFixed(0) : 0}%</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                    
                    <div class="footer">
                      <strong>Sistema Tutts</strong> - Relat√≥rio Gerado Automaticamente<br>
                      ${new Date().toLocaleString('pt-BR')}
                    </div>
                  </body>
                  </html>
                `;
                const janela = window.open('', '_blank');
                janela.document.write(conteudo);
                janela.document.close();
                janela.print();
              };
              
              return (
                <>
                  {/* Seletor de Per√≠odo */}
                  <div className="bg-white rounded-xl shadow p-4 mb-6 flex flex-wrap items-center gap-4">
                    <div className="flex items-center gap-2">
                      <label className="font-semibold">üìÖ Per√≠odo:</label>
                      <select value={mesAtual} onChange={e => setFormData({...formData, relMes: e.target.value})} className="px-3 py-2 border rounded-lg">
                        {meses.map((m, i) => <option key={i} value={i}>{m}</option>)}
                      </select>
                      <select value={anoAtual} onChange={e => setFormData({...formData, relAno: e.target.value})} className="px-3 py-2 border rounded-lg">
                        {[2024, 2025, 2026].map(a => <option key={a} value={a}>{a}</option>)}
                      </select>
                    </div>
                    <button onClick={gerarPDF} className="ml-auto px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 flex items-center gap-2">
                      üìÑ Gerar PDF
                    </button>
                  </div>
                  
                  {/* Cards Principais */}
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div className="bg-white rounded-xl shadow p-4 border-l-4 border-purple-500">
                      <p className="text-xs text-gray-500">üìã Total Solicita√ß√µes</p>
                      <p className="text-3xl font-bold text-purple-600">{submissoesMes.length}</p>
                    </div>
                    <div className="bg-white rounded-xl shadow p-4 border-l-4 border-green-500">
                      <p className="text-xs text-gray-500">‚úÖ Aprovadas</p>
                      <p className="text-3xl font-bold text-green-600">{aprovadas.length}</p>
                    </div>
                    <div className="bg-white rounded-xl shadow p-4 border-l-4 border-red-500">
                      <p className="text-xs text-gray-500">‚ùå Rejeitadas</p>
                      <p className="text-3xl font-bold text-red-600">{rejeitadas.length}</p>
                    </div>
                    <div className="bg-white rounded-xl shadow p-4 border-l-4 border-yellow-500">
                      <p className="text-xs text-gray-500">‚è≥ Pendentes</p>
                      <p className="text-3xl font-bold text-yellow-600">{pendentes.length}</p>
                    </div>
                  </div>
                  
                  {/* Cards de Taxas */}
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div className="bg-green-50 rounded-xl p-4 text-center border border-green-200">
                      <p className="text-3xl font-bold text-green-600">{taxaAprovacao}%</p>
                      <p className="text-xs text-green-700">Taxa de Aprova√ß√£o</p>
                    </div>
                    <div className="bg-red-50 rounded-xl p-4 text-center border border-red-200">
                      <p className="text-3xl font-bold text-red-600">{taxaRejeicao}%</p>
                      <p className="text-xs text-red-700">Taxa de Rejei√ß√£o</p>
                    </div>
                    <div className="bg-purple-50 rounded-xl p-4 text-center border border-purple-200">
                      <p className="text-3xl font-bold text-purple-600">{users.length}</p>
                      <p className="text-xs text-purple-700">Total Profissionais</p>
                    </div>
                    <div className="bg-blue-50 rounded-xl p-4 text-center border border-blue-200">
                      <p className="text-3xl font-bold text-blue-600">{users.length > 0 ? (submissoesMes.length / users.length).toFixed(1) : 0}</p>
                      <p className="text-xs text-blue-700">M√©dia por Profissional</p>
                    </div>
                  </div>
                  
                  {/* Comparativo */}
                  <div className={`rounded-xl p-4 mb-6 ${parseFloat(variacaoTotal) >= 0 ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
                    <h3 className="font-semibold mb-2">üìä Comparativo com M√™s Anterior</h3>
                    <div className="flex items-center gap-6">
                      <div>
                        <p className="text-sm text-gray-600">M√™s anterior: <strong>{submissoesMesAnterior.length}</strong> solicita√ß√µes</p>
                        <p className="text-sm text-gray-600">M√™s atual: <strong>{submissoesMes.length}</strong> solicita√ß√µes</p>
                      </div>
                      <div className={`text-3xl font-bold ${parseFloat(variacaoTotal) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                        {parseFloat(variacaoTotal) >= 0 ? 'üìà' : 'üìâ'} {parseFloat(variacaoTotal) >= 0 ? '+' : ''}{variacaoTotal}%
                      </div>
                    </div>
                  </div>
                  
                  {/* Gr√°ficos */}
                  <div className="grid md:grid-cols-2 gap-6 mb-6">
                    {/* Evolu√ß√£o 6 meses */}
                    <div className="bg-white rounded-xl shadow p-6">
                      <h3 className="font-semibold mb-4">üìà Evolu√ß√£o (√öltimos 6 meses)</h3>
                      <div className="flex items-end justify-between h-40 gap-2">
                        {ultimos6Meses.map((m, i) => (
                          <div key={i} className="flex-1 flex flex-col items-center">
                            <div className="w-full bg-gray-100 rounded-t relative" style={{height: `${(m.total / maxMes) * 100}%`, minHeight: '20px'}}>
                              <div className="absolute inset-0 bg-gradient-to-t from-purple-600 to-purple-400 rounded-t"></div>
                            </div>
                            <p className="text-xs font-bold mt-1">{m.total}</p>
                            <p className="text-xs text-gray-500">{m.label}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                    
                    {/* Por Semana */}
                    <div className="bg-white rounded-xl shadow p-6">
                      <h3 className="font-semibold mb-4">üìÖ Por Semana ({meses[mesAtual]})</h3>
                      <div className="flex items-end justify-between h-40 gap-2">
                        {porSemana.map((s, i) => (
                          <div key={i} className="flex-1 flex flex-col items-center">
                            <div className="w-full bg-gray-100 rounded-t relative" style={{height: `${(s.total / maxSemana) * 100}%`, minHeight: '20px'}}>
                              <div className="absolute inset-0 bg-gradient-to-t from-blue-600 to-blue-400 rounded-t"></div>
                            </div>
                            <p className="text-xs font-bold mt-1">{s.total}</p>
                            <p className="text-xs text-gray-500">Sem {i+1}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                  
                  {/* Por Motivo */}
                  <div className="bg-white rounded-xl shadow p-6 mb-6">
                    <h3 className="font-semibold mb-4">üìÅ Por Motivo</h3>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left">Motivo</th>
                            <th className="px-4 py-3 text-center">Total</th>
                            <th className="px-4 py-3 text-center">‚úÖ Aprovadas</th>
                            <th className="px-4 py-3 text-center">‚ùå Rejeitadas</th>
                            <th className="px-4 py-3 text-center">‚è≥ Pendentes</th>
                            <th className="px-4 py-3 text-center">Taxa</th>
                          </tr>
                        </thead>
                        <tbody>
                          {Object.entries(porMotivo).sort((a,b) => b[1].total - a[1].total).map(([motivo, dados]) => (
                            <tr key={motivo} className="border-t hover:bg-gray-50">
                              <td className="px-4 py-3 font-semibold">{motivo}</td>
                              <td className="px-4 py-3 text-center font-bold">{dados.total}</td>
                              <td className="px-4 py-3 text-center text-green-600 font-semibold">{dados.aprovadas}</td>
                              <td className="px-4 py-3 text-center text-red-600 font-semibold">{dados.rejeitadas}</td>
                              <td className="px-4 py-3 text-center text-yellow-600 font-semibold">{dados.pendentes}</td>
                              <td className="px-4 py-3 text-center">
                                <span className={`px-2 py-1 rounded text-xs font-bold ${dados.total > 0 && (dados.aprovadas / dados.total) >= 0.7 ? 'bg-green-100 text-green-700' : dados.total > 0 && (dados.aprovadas / dados.total) >= 0.4 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                                  {dados.total > 0 ? ((dados.aprovadas / dados.total) * 100).toFixed(0) : 0}%
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                  
                  {/* Top 10 Profissionais */}
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-semibold mb-4">üë∑ Top 10 Profissionais do M√™s</h3>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-center">#</th>
                            <th className="px-4 py-3 text-left">Profissional</th>
                            <th className="px-4 py-3 text-left">C√≥digo</th>
                            <th className="px-4 py-3 text-center">Total</th>
                            <th className="px-4 py-3 text-center">‚úÖ</th>
                            <th className="px-4 py-3 text-center">‚ùå</th>
                            <th className="px-4 py-3 text-center">Taxa</th>
                          </tr>
                        </thead>
                        <tbody>
                          {topTecnicos.map((t, i) => (
                            <tr key={i} className={`border-t hover:bg-gray-50 ${i < 3 ? 'bg-yellow-50' : ''}`}>
                              <td className="px-4 py-3 text-center">
                                {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}
                              </td>
                              <td className="px-4 py-3 font-semibold">{t.nome}</td>
                              <td className="px-4 py-3 font-mono text-gray-600">{t.cod || '-'}</td>
                              <td className="px-4 py-3 text-center font-bold">{t.total}</td>
                              <td className="px-4 py-3 text-center text-green-600 font-semibold">{t.aprovadas}</td>
                              <td className="px-4 py-3 text-center text-red-600 font-semibold">{t.rejeitadas}</td>
                              <td className="px-4 py-3 text-center">
                                <span className={`px-2 py-1 rounded text-xs font-bold ${parseInt(t.taxa) >= 70 ? 'bg-green-100 text-green-700' : parseInt(t.taxa) >= 40 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                                  {t.taxa}%
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </>
              );
            })()}

            {/* USU√ÅRIOS */}
            {formData.adminTab === 'users' && (
              <div className="bg-white rounded-xl shadow p-6">
                <h2 className="text-lg font-semibold mb-4">üë• Gerenciar Usu√°rios</h2>
                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                  <h3 className="font-semibold mb-3">‚ûï Criar Usu√°rio</h3>
                  <div className="space-y-4">
                    <div className="grid md:grid-cols-2 gap-4">
                      <div><label className="block text-sm font-semibold mb-1">Nome</label><input type="text" value={formData.newName || ''} onChange={e => setFormData({...formData, newName: e.target.value})} className="w-full px-3 py-2 border rounded" /></div>
                      <div><label className="block text-sm font-semibold mb-1">C√≥digo</label><input type="text" value={formData.newCod || ''} onChange={e => setFormData({...formData, newCod: e.target.value})} className="w-full px-3 py-2 border rounded" /></div>
                    </div>
                    <div className="grid md:grid-cols-2 gap-4">
                      <div><label className="block text-sm font-semibold mb-1">Senha</label><input type="password" value={formData.newPass || ''} onChange={e => setFormData({...formData, newPass: e.target.value})} className="w-full px-3 py-2 border rounded" /></div>
                      <div><label className="block text-sm font-semibold mb-1">Tipo</label><select value={formData.newRole || 'user'} onChange={e => setFormData({...formData, newRole: e.target.value})} className="w-full px-3 py-2 border rounded bg-white"><option value="user">üë§ Usu√°rio</option><option value="admin">üëë Admin</option><option value="admin_financeiro">üí∞ Admin Financeiro</option></select></div>
                    </div>
                    <button onClick={async () => {
                      if (!formData.newName || !formData.newCod || !formData.newPass) { showToast('Preencha todos', 'error'); return; }
                      setLoading(true);
                      try {
                        await fetch(`${API_URL}/users/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fullName: formData.newName, codProfissional: formData.newCod, password: formData.newPass, role: formData.newRole || 'user' }) });
                        showToast('‚úÖ Criado!', 'success');
                        setFormData({...formData, newName: '', newCod: '', newPass: '', newRole: 'user'});
                        loadUsers();
                      } catch { showToast('Erro', 'error'); }
                      setLoading(false);
                    }} className="w-full px-6 py-2 bg-purple-600 text-white rounded font-semibold">‚ûï Criar Usu√°rio</button>
                  </div>
                </div>
                <h3 className="font-semibold mb-3">üìã Usu√°rios Cadastrados ({users.length})</h3>
                <div className="space-y-2">
                  {users.map(u => (
                    <div key={u.codProfissional} className="border rounded-lg p-4 flex items-center justify-between hover:bg-gray-50">
                      <div className="flex-1"><p className="font-semibold">{u.fullName}</p><p className="text-sm text-gray-600">COD: {u.codProfissional} ‚Ä¢ {u.role}</p><p className="text-xs text-gray-400">{u.createdAt}</p></div>
                      <div className="flex gap-2 items-center">
                        <input type="password" placeholder="Nova senha" value={formData[`newpass_${u.codProfissional}`] || ''} onChange={e => setFormData({...formData, [`newpass_${u.codProfissional}`]: e.target.value})} className="px-3 py-2 border rounded text-sm w-32" />
                        <button onClick={async () => {
                          const pw = formData[`newpass_${u.codProfissional}`];
                          if (!pw || pw.length < 4) { showToast('Senha muito curta', 'error'); return; }
                          await fetch(`${API_URL}/users/reset-password`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ codProfissional: u.codProfissional, newPassword: pw }) });
                          showToast('‚úÖ Senha alterada!', 'success');
                          setFormData({...formData, [`newpass_${u.codProfissional}`]: ''});
                        }} className="px-4 py-2 bg-purple-600 text-white rounded text-sm font-semibold">üîë Resetar</button>
                        <button onClick={async () => {
                          if (!confirm(`Excluir ${u.fullName}?`)) return;
                          await fetch(`${API_URL}/users/${u.codProfissional}`, { method: 'DELETE' });
                          showToast('üóëÔ∏è Exclu√≠do!', 'success');
                          loadUsers();
                        }} className="px-4 py-2 bg-red-600 text-white rounded text-sm font-semibold">üóëÔ∏è</button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
