<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Tutts - Solicita√ß√µes e Saque Emergencial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .toast { animation: slideIn 0.3s ease-out; }
    .row-green { background-color: #dcfce7 !important; border-left: 4px solid #22c55e !important; }
    .row-red { background-color: #fee2e2 !important; border-left: 4px solid #ef4444 !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_URL = 'https://tutts-backend-production.up.railway.app/api';

    // ========== COMPONENTES UTILIT√ÅRIOS ==========
    const Toast = ({ message, type }) => (
      <div className={`fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-2xl toast ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white font-semibold flex items-center gap-3`}>
        <span className="text-2xl">{type === 'success' ? '‚úì' : '‚úó'}</span>
        <span>{message}</span>
      </div>
    );

    const LoadingOverlay = ({ message = 'Carregando...' }) => (
      <div className="fixed inset-0 bg-black bg-opacity-30 z-50 flex items-center justify-center">
        <div className="bg-white rounded-xl p-6 shadow-2xl flex flex-col items-center gap-3">
          <div className="w-10 h-10 border-4 border-purple-600 border-t-transparent rounded-full animate-spin"></div>
          <p className="text-gray-700 font-semibold">{message}</p>
        </div>
      </div>
    );

    const ImageModal = ({ imageUrl, onClose }) => (
      <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onClick={onClose}>
        <div className="relative max-w-4xl max-h-screen">
          <button onClick={onClose} className="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300">‚úï</button>
          <img src={imageUrl} alt="Expandido" className="max-w-full max-h-screen rounded-lg shadow-2xl" onClick={e => e.stopPropagation()} />
        </div>
      </div>
    );

    // ========== GR√ÅFICO PIE CHART ==========
    const PieChart = ({ data, title }) => {
      const total = data.reduce((sum, item) => sum + item.value, 0);
      if (total === 0) return (
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-lg font-semibold mb-4">{title}</h3>
          <p className="text-gray-500 text-center py-8">Sem dados dispon√≠veis</p>
        </div>
      );

      let currentAngle = 0;
      const slices = data.map((item, index) => {
        const percentage = (item.value / total) * 100;
        const angle = (percentage / 100) * 360;
        const startAngle = currentAngle;
        currentAngle += angle;
        const x1 = 100 + 90 * Math.cos((startAngle - 90) * Math.PI / 180);
        const y1 = 100 + 90 * Math.sin((startAngle - 90) * Math.PI / 180);
        const x2 = 100 + 90 * Math.cos((currentAngle - 90) * Math.PI / 180);
        const y2 = 100 + 90 * Math.sin((currentAngle - 90) * Math.PI / 180);
        const largeArc = angle > 180 ? 1 : 0;
        return { ...item, path: `M 100 100 L ${x1} ${y1} A 90 90 0 ${largeArc} 1 ${x2} ${y2} Z`, percentage: percentage.toFixed(1) };
      });

      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-lg font-semibold mb-4">{title}</h3>
          <div className="flex flex-col md:flex-row items-center gap-6">
            <svg viewBox="0 0 200 200" className="w-48 h-48">
              {slices.map((s, i) => <path key={i} d={s.path} fill={s.color} className="hover:opacity-80 transition-opacity cursor-pointer" />)}
            </svg>
            <div className="flex-1 space-y-2">
              {slices.map((s, i) => (
                <div key={i} className="flex items-center gap-2">
                  <div className="w-4 h-4 rounded" style={{backgroundColor: s.color}}></div>
                  <span className="text-sm flex-1">{s.label}</span>
                  <span className="font-semibold">{s.value}</span>
                  <span className="text-gray-500 text-sm">({s.percentage}%)</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ========== GR√ÅFICO DE MOTIVOS ==========
    const MotivosPieChart = ({ submissions }) => {
      const motivos = {};
      submissions.forEach(s => { motivos[s.motivo] = (motivos[s.motivo] || 0) + 1; });
      const colors = ['#7c3aed', '#2563eb', '#059669', '#dc2626', '#ea580c', '#8b5cf6'];
      const total = submissions.length;
      const data = Object.entries(motivos).map(([motivo, count], index) => ({
        motivo, count, percentage: ((count / total) * 100).toFixed(1), color: colors[index % colors.length]
      }));

      let currentAngle = 0;
      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h2 className="text-lg font-semibold mb-4">üìä Distribui√ß√£o por Motivo</h2>
          {total === 0 ? <p className="text-gray-500">Nenhuma solicita√ß√£o</p> : (
            <div className="flex flex-col md:flex-row items-center gap-6">
              <svg viewBox="0 0 200 200" className="w-48 h-48">
                {data.map((item, index) => {
                  const angle = (item.count / total) * 360;
                  const startAngle = currentAngle;
                  currentAngle += angle;
                  const x1 = 100 + 90 * Math.cos((startAngle - 90) * Math.PI / 180);
                  const y1 = 100 + 90 * Math.sin((startAngle - 90) * Math.PI / 180);
                  const x2 = 100 + 90 * Math.cos((startAngle + angle - 90) * Math.PI / 180);
                  const y2 = 100 + 90 * Math.sin((startAngle + angle - 90) * Math.PI / 180);
                  const largeArc = angle > 180 ? 1 : 0;
                  return <path key={index} d={`M 100 100 L ${x1} ${y1} A 90 90 0 ${largeArc} 1 ${x2} ${y2} Z`} fill={item.color} stroke="white" strokeWidth="2" />;
                })}
                <circle cx="100" cy="100" r="50" fill="white" />
                <text x="100" y="95" textAnchor="middle" className="text-2xl font-bold" fill="#1f2937">{total}</text>
                <text x="100" y="110" textAnchor="middle" className="text-xs" fill="#6b7280">Total</text>
              </svg>
              <div className="flex-1 space-y-2">
                {data.map((item, i) => (
                  <div key={i} className="flex items-center gap-3">
                    <div className="w-4 h-4 rounded" style={{ backgroundColor: item.color }} />
                    <div className="flex-1">
                      <p className="text-sm font-medium text-gray-800 truncate">{item.motivo}</p>
                      <p className="text-xs text-gray-500">{item.count} ({item.percentage}%)</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    // ========== RANKING DE T√âCNICOS ==========
    const TechRanking = ({ submissions }) => {
      const stats = {};
      submissions.forEach(s => {
        const tech = s.fullName || 'Desconhecido';
        if (!stats[tech]) stats[tech] = { total: 0, aprovadas: 0, rejeitadas: 0, pendentes: 0 };
        stats[tech].total++;
        if (s.status === 'aprovada') stats[tech].aprovadas++;
        else if (s.status === 'rejeitada') stats[tech].rejeitadas++;
        else stats[tech].pendentes++;
      });

      const ranking = Object.entries(stats).map(([name, data]) => ({
        name, ...data, aprovacao: data.total > 0 ? ((data.aprovadas / data.total) * 100).toFixed(1) : 0
      })).sort((a, b) => b.total - a.total);

      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-lg font-semibold mb-4">üèÜ Ranking de T√©cnicos</h3>
          {ranking.length === 0 ? <p className="text-gray-500 text-center py-8">Sem dados</p> : (
            <div className="space-y-3">
              {ranking.map((tech, i) => (
                <div key={i} className="flex items-center gap-4 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                  <div className={`text-2xl font-bold w-8 ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : i === 2 ? 'text-orange-600' : 'text-gray-400'}`}>{i + 1}¬∫</div>
                  <div className="flex-1">
                    <p className="font-semibold text-gray-800">{tech.name}</p>
                    <div className="flex gap-4 text-sm text-gray-600 mt-1">
                      <span>Total: <b>{tech.total}</b></span>
                      <span className="text-green-600">‚úì {tech.aprovadas}</span>
                      <span className="text-red-600">‚úó {tech.rejeitadas}</span>
                      <span className="text-yellow-600">‚è≥ {tech.pendentes}</span>
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="text-2xl font-bold text-purple-600">{tech.aprovacao}%</div>
                    <div className="text-xs text-gray-500">aprova√ß√£o</div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    };

    // ========== COMPONENTE PRINCIPAL ==========
    const App = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(false);
      const [globalLoading, setGlobalLoading] = useState(false);
      const [toast, setToast] = useState(null);
      const [formData, setFormData] = useState({});
      const [imageModal, setImageModal] = useState(null);
      const [lastActivity, setLastActivity] = useState(Date.now());

      // Estados - Solicita√ß√µes
      const [submissions, setSubmissions] = useState([]);
      const [users, setUsers] = useState([]);

      // Estados - Saque Emergencial
      const [termsAccepted, setTermsAccepted] = useState(false);
      const [financialData, setFinancialData] = useState(null);
      const [withdrawals, setWithdrawals] = useState([]);
      const [allWithdrawals, setAllWithdrawals] = useState([]);
      const [gratuities, setGratuities] = useState([]);
      const [userGratuities, setUserGratuities] = useState([]);
      const [restrictedList, setRestrictedList] = useState([]);
      const [dashboardData, setDashboardData] = useState({});

      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };

      // Auto-logout 5 min
      useEffect(() => {
        if (!user) return;
        const TIMEOUT = 5 * 60 * 1000;
        const reset = () => setLastActivity(Date.now());
        const events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];
        events.forEach(e => window.addEventListener(e, reset));
        const check = setInterval(() => {
          if (Date.now() - lastActivity > TIMEOUT) {
            showToast('‚è∞ Sess√£o expirada', 'error');
            setTimeout(() => { setUser(null); setFormData({}); }, 1500);
          }
        }, 30000);
        return () => { events.forEach(e => window.removeEventListener(e, reset)); clearInterval(check); };
      }, [user, lastActivity]);

      // Carregar dados ao logar
      useEffect(() => {
        if (!user) return;
        loadSubmissions();
        if (user.role === 'admin') loadUsers();
        if (user.role === 'user') { checkTerms(); loadUserWithdrawals(); loadUserGratuities(); }
        if (user.role === 'admin_financeiro') { loadAllWithdrawals(); loadAllGratuities(); loadRestricted(); loadDashboard(); }
      }, [user]);

      // ========== FUN√á√ïES DE CARREGAMENTO ==========
      const loadSubmissions = async () => {
        try {
          const query = user.role === 'user' ? `?userId=${user.id}&userCod=${user.cod_profissional}` : '';
          const res = await fetch(`${API_URL}/submissions${query}`);
          const data = await res.json();
          setSubmissions(data.map(s => ({
            ...s, ordemServico: s.ordem_servico, codProfissional: s.user_cod, fullName: s.user_name,
            temImagem: s.tem_imagem, imagemComprovante: null, timestamp: new Date(s.created_at).toLocaleString('pt-BR')
          })));
        } catch (err) { console.error(err); }
      };

      const loadUsers = async () => {
        try {
          const res = await fetch(`${API_URL}/users`);
          const data = await res.json();
          setUsers(data.map(u => ({ codProfissional: u.cod_profissional, fullName: u.full_name, role: u.role, createdAt: new Date(u.created_at).toLocaleString('pt-BR') })));
        } catch (err) { console.error(err); }
      };

      const loadImagem = async (id) => {
        try {
          const res = await fetch(`${API_URL}/submissions/${id}/imagem`);
          const data = await res.json();
          setSubmissions(prev => prev.map(s => s.id === id ? {...s, imagemComprovante: data.imagem} : s));
        } catch (err) { showToast('Erro ao carregar imagem', 'error'); }
      };

      const checkTerms = async () => {
        try {
          const res = await fetch(`${API_URL}/financial/check-terms/${user.cod_profissional}`);
          const data = await res.json();
          setTermsAccepted(data.hasAccepted);
          if (data.hasAccepted) {
            const finRes = await fetch(`${API_URL}/financial/data/${user.cod_profissional}`);
            const finData = await finRes.json();
            setFinancialData(finData.data);
          }
        } catch (err) { console.error(err); }
      };

      const loadUserWithdrawals = async () => {
        try {
          const res = await fetch(`${API_URL}/withdrawals/user/${user.cod_profissional}`);
          setWithdrawals(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadUserGratuities = async () => {
        try {
          const res = await fetch(`${API_URL}/gratuities/user/${user.cod_profissional}`);
          setUserGratuities(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadAllWithdrawals = async () => {
        try {
          const res = await fetch(`${API_URL}/withdrawals`);
          setAllWithdrawals(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadAllGratuities = async () => {
        try {
          const res = await fetch(`${API_URL}/gratuities`);
          setGratuities(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadRestricted = async () => {
        try {
          const res = await fetch(`${API_URL}/restricted`);
          setRestrictedList(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadDashboard = async () => {
        try {
          const res = await fetch(`${API_URL}/withdrawals/dashboard/conciliacao`);
          setDashboardData(await res.json());
        } catch (err) { console.error(err); }
      };

      const refreshAll = async () => {
        setGlobalLoading(true);
        try {
          await loadSubmissions();
          if (user.role === 'admin') await loadUsers();
          if (user.role === 'user') { await loadUserWithdrawals(); await loadUserGratuities(); }
          if (user.role === 'admin_financeiro') { await loadAllWithdrawals(); await loadAllGratuities(); await loadRestricted(); await loadDashboard(); }
          showToast('üîÑ Atualizado!', 'success');
        } catch (err) { showToast('Erro', 'error'); }
        setGlobalLoading(false);
      };

      // ========== FUN√á√ïES DE A√á√ÉO ==========
      const handleLogin = async () => {
        setLoading(true);
        try {
          const res = await fetch(`${API_URL}/users/login`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codProfissional: formData.cod, password: formData.password })
          });
          if (!res.ok) throw new Error('Credenciais inv√°lidas');
          const data = await res.json();
          setUser({ ...data, codProfissional: data.cod_profissional, fullName: data.full_name });
          setFormData({});
        } catch (err) { showToast(err.message, 'error'); }
        setLoading(false);
      };

      const handleRegister = async () => {
        setLoading(true);
        try {
          const res = await fetch(`${API_URL}/users/register`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codProfissional: formData.cod, password: formData.password, fullName: formData.name })
          });
          if (!res.ok) throw new Error('Erro no cadastro');
          showToast('Cadastro realizado!', 'success');
          setFormData({ view: 'login' });
        } catch (err) { showToast(err.message, 'error'); }
        setLoading(false);
      };

      const handleAcceptTerms = async () => {
        setLoading(true);
        try {
          await fetch(`${API_URL}/financial/accept-terms`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: user.codProfissional })
          });
          setTermsAccepted(true);
          showToast('‚úÖ Termos aceitos!', 'success');
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleSaveFinancial = async () => {
        if (!formData.finName || !formData.finCpf || !formData.finPix) { showToast('Preencha todos os campos', 'error'); return; }
        setLoading(true);
        try {
          await fetch(`${API_URL}/financial/data`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: user.codProfissional, fullName: formData.finName, cpf: formData.finCpf, pixKey: formData.finPix })
          });
          setFinancialData({ full_name: formData.finName, cpf: formData.finCpf, pix_key: formData.finPix });
          showToast('‚úÖ Dados salvos!', 'success');
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleRequestWithdrawal = async () => {
        const amount = parseFloat(formData.withdrawAmount);
        if (!amount || amount <= 0) { showToast('Valor inv√°lido', 'error'); return; }
        setLoading(true);
        try {
          await fetch(`${API_URL}/withdrawals`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: user.codProfissional, userName: financialData.full_name, cpf: financialData.cpf, pixKey: financialData.pix_key, requestedAmount: amount })
          });
          showToast('‚úÖ Saque solicitado!', 'success');
          setFormData({ ...formData, withdrawAmount: '' });
          loadUserWithdrawals(); loadUserGratuities();
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleUpdateWithdrawalStatus = async (id, status) => {
        try {
          await fetch(`${API_URL}/withdrawals/${id}`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status, adminId: user.id, adminName: user.fullName || 'Admin Financeiro' })
          });
          showToast('‚úÖ Status atualizado!', 'success');
          loadAllWithdrawals();
        } catch (err) { showToast('Erro', 'error'); }
      };

      const handleUpdateConciliacao = async (id, field, value) => {
        try {
          await fetch(`${API_URL}/withdrawals/${id}/conciliacao`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [field]: value })
          });
          loadAllWithdrawals(); loadDashboard();
        } catch (err) { showToast('Erro', 'error'); }
      };

      const handleAddGratuity = async () => {
        if (!formData.gratUserCod || !formData.gratQty || !formData.gratValue) { showToast('Preencha todos', 'error'); return; }
        setLoading(true);
        try {
          await fetch(`${API_URL}/gratuities`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: formData.gratUserCod, quantity: parseInt(formData.gratQty), value: parseFloat(formData.gratValue), reason: formData.gratReason || '' })
          });
          showToast('‚úÖ Gratuidade cadastrada!', 'success');
          setFormData({ ...formData, gratUserCod: '', gratQty: '', gratValue: '', gratReason: '' });
          loadAllGratuities();
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleAddRestriction = async () => {
        if (!formData.restUserCod || !formData.restReason) { showToast('Preencha todos', 'error'); return; }
        setLoading(true);
        try {
          await fetch(`${API_URL}/restricted`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: formData.restUserCod, reason: formData.restReason })
          });
          showToast('‚úÖ Restri√ß√£o cadastrada!', 'success');
          setFormData({ ...formData, restUserCod: '', restReason: '' });
          loadRestricted();
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleRemoveRestriction = async (id) => {
        try {
          await fetch(`${API_URL}/restricted/${id}/remove`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ removedReason: 'Suspensa pelo admin' })
          });
          showToast('‚úÖ Restri√ß√£o removida!', 'success');
          loadRestricted();
        } catch (err) { showToast('Erro', 'error'); }
      };

      // Submiss√µes OS
      const motivosComFoto = ['Ajuste de Retorno', 'Ajuste de Ped√°gio (Campinas e Recife)'];
      
      const compressImage = (file, maxWidth = 800, quality = 0.6) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let w = img.width, h = img.height;
              if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; }
              canvas.width = w; canvas.height = h;
              canvas.getContext('2d').drawImage(img, 0, 0, w, h);
              resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = reject;
            img.src = e.target.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      };

      const handleSubmitOS = async () => {
        setLoading(true);
        try {
          const imgs = formData.imagens?.length > 0 ? formData.imagens.join('|||') : null;
          await fetch(`${API_URL}/submissions`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ordemServico: formData.os, motivo: formData.motivo, userId: user.id, userCod: user.codProfissional, userName: user.fullName, imagemComprovante: imgs, coordenadas: formData.coordenadas || null })
          });
          showToast('‚úÖ OS enviada!', 'success');
          setFormData({});
          loadSubmissions();
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleValidate = async (id, approved) => {
        try {
          setSubmissions(prev => prev.map(s => s.id === id ? {...s, status: approved ? 'aprovada' : 'rejeitada', validated_by_name: user.fullName} : s));
          await fetch(`${API_URL}/submissions/${id}`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: approved ? 'aprovada' : 'rejeitada', observacao: formData[`obs_${id}`] || '', validatedBy: user.id, validatedByName: user.fullName || 'Admin' })
          });
          showToast(approved ? '‚úÖ Aprovada!' : '‚ùå Rejeitada!', approved ? 'success' : 'error');
          const { pendingFilter, adminTab } = formData;
          setFormData({ pendingFilter, adminTab });
          loadSubmissions();
        } catch (err) { showToast('Erro', 'error'); loadSubmissions(); }
      };

      // Helpers
      const calcWithdraw = (amount) => {
        const hasGrat = userGratuities.some(g => g.status === 'ativa' && g.remaining > 0);
        const fee = hasGrat ? 0 : amount * 0.045;
        return { fee, final: amount - fee, hasGrat };
      };

      const formatCPF = (v) => {
        const n = v.replace(/\D/g, '').slice(0, 11);
        if (n.length <= 3) return n;
        if (n.length <= 6) return `${n.slice(0,3)}.${n.slice(3)}`;
        if (n.length <= 9) return `${n.slice(0,3)}.${n.slice(3,6)}.${n.slice(6)}`;
        return `${n.slice(0,3)}.${n.slice(3,6)}.${n.slice(6,9)}-${n.slice(9)}`;
      };

      const formatMoney = (v) => parseFloat(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

      const statusLabels = {
        'aguardando_aprovacao': '‚è≥ Aguardando',
        'aprovado': '‚úÖ Aprovado',
        'aprovado_gratuidade': '‚úÖ Aprov. c/ Gratuidade',
        'rejeitado': '‚ùå Rejeitado',
        'inativo': '‚ö†Ô∏è Inativo'
      };

      // ========== TELA DE LOGIN ==========
      if (!user) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center p-4">
            {toast && <Toast {...toast} />}
            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
              <div className="text-center mb-8">
                <div className="w-28 h-28 mx-auto mb-4 bg-purple-900 rounded-xl p-4 shadow-lg flex items-center justify-center">
                  <span className="text-white text-4xl font-bold">tutts</span>
                </div>
                <h1 className="text-2xl font-bold text-gray-800">Sistema Tutts</h1>
                <p className="text-gray-500 text-sm">Solicita√ß√µes e Saque Emergencial</p>
              </div>

              {formData.view === 'register' ? (
                <div className="space-y-4">
                  <input type="text" placeholder="Nome Completo" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                  <input type="text" placeholder="C√≥digo Profissional" value={formData.cod || ''} onChange={e => setFormData({...formData, cod: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                  <input type="password" placeholder="Senha" value={formData.password || ''} onChange={e => setFormData({...formData, password: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                  <button onClick={handleRegister} disabled={loading} className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold hover:bg-purple-800 disabled:opacity-50">
                    {loading ? 'Aguarde...' : 'Criar Conta'}
                  </button>
                  <button onClick={() => setFormData({view: 'login'})} className="w-full text-purple-700 text-sm">‚Üê Voltar</button>
                </div>
              ) : (
                <div className="space-y-4">
                  <input type="text" placeholder="C√≥digo Profissional" value={formData.cod || ''} onChange={e => setFormData({...formData, cod: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                  <input type="password" placeholder="Senha" value={formData.password || ''} onChange={e => setFormData({...formData, password: e.target.value})} onKeyDown={e => e.key === 'Enter' && handleLogin()} className="w-full px-4 py-3 border rounded-lg" />
                  <button onClick={handleLogin} disabled={loading} className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold hover:bg-purple-800 disabled:opacity-50">
                    {loading ? 'Entrando...' : 'Entrar'}
                  </button>
                  <button onClick={() => setFormData({view: 'register'})} className="w-full text-purple-700 text-sm">Criar nova conta</button>
                </div>
              )}
            </div>
          </div>
        );
      }

      // ========== PAINEL DO USU√ÅRIO ==========
      if (user.role === 'user') {
        return (
          <div className="min-h-screen bg-gray-50">
            {toast && <Toast {...toast} />}
            {globalLoading && <LoadingOverlay />}
            {imageModal && <ImageModal imageUrl={imageModal} onClose={() => setImageModal(null)} />}

            <nav className="bg-white shadow-sm border-b">
              <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div><h1 className="text-xl font-bold">Painel do Usu√°rio</h1><p className="text-sm text-gray-600">{user.fullName}</p></div>
                <div className="flex gap-2">
                  <button onClick={refreshAll} className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm font-semibold">üîÑ</button>
                  <button onClick={() => setUser(null)} className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">Sair</button>
                </div>
              </div>
            </nav>

            <div className="bg-white border-b">
              <div className="max-w-7xl mx-auto px-4 flex gap-1">
                <button onClick={() => setFormData({...formData, userTab: 'solicitacoes'})} className={`px-6 py-3 font-semibold ${(!formData.userTab || formData.userTab === 'solicitacoes') ? 'text-purple-900 border-b-2 border-purple-900' : 'text-gray-600'}`}>üìã Solicita√ß√µes</button>
                <button onClick={() => setFormData({...formData, userTab: 'saque'})} className={`px-6 py-3 font-semibold ${formData.userTab === 'saque' ? 'text-green-700 border-b-2 border-green-600' : 'text-gray-600'}`}>üí∞ Saque Emergencial</button>
              </div>
            </div>

            <div className="max-w-4xl mx-auto p-6">
              {/* ABA SOLICITA√á√ïES */}
              {(!formData.userTab || formData.userTab === 'solicitacoes') && (
                <>
                  <div className="bg-white rounded-xl shadow p-6 mb-6">
                    <h2 className="text-lg font-semibold mb-4">üìù Enviar OS</h2>
                    <div className="space-y-4">
                      <input type="text" placeholder="N√∫mero da OS" value={formData.os || ''} onChange={e => setFormData({...formData, os: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                      <select value={formData.motivo || ''} onChange={e => {
                        const m = e.target.value;
                        let coord = '';
                        if (m === 'Altera√ß√£o Ponto 1 (Goi√¢nia)') coord = '-16.64322218214421, -49.3190143453706';
                        if (m === 'Altera√ß√£o Ponto 1 (Campinas)') coord = '-22.850067092813358, -47.08310037116422';
                        setFormData({...formData, motivo: m, coordenadas: coord, imagens: []});
                      }} className="w-full px-4 py-3 border rounded-lg">
                        <option value="">Selecione o motivo</option>
                        <option>Altera√ß√£o Ponto 1 (Campinas)</option>
                        <option>Altera√ß√£o Ponto 1 (Goi√¢nia)</option>
                        <option>Ajuste de Retorno</option>
                        <option>Ajuste de Ped√°gio (Campinas e Recife)</option>
                      </select>

                      {formData.coordenadas && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                          <p className="text-xs text-blue-700 font-semibold">üìç COORDENADAS</p>
                          <p className="font-mono text-blue-900">{formData.coordenadas}</p>
                          <div className="flex gap-2 mt-2">
                            <button onClick={() => { navigator.clipboard.writeText(formData.coordenadas); showToast('Copiado!', 'success'); }} className="text-sm text-blue-600 hover:underline">üìã Copiar</button>
                            <a href={`https://www.google.com/maps?q=${formData.coordenadas}`} target="_blank" className="text-sm text-blue-600 hover:underline">üó∫Ô∏è Ver no Maps</a>
                          </div>
                        </div>
                      )}

                      {motivosComFoto.includes(formData.motivo) && (
                        <div className="border-2 border-dashed border-orange-300 bg-orange-50 rounded-lg p-4">
                          <p className="text-sm font-bold text-orange-800 mb-2">üìé Fotos OBRIGAT√ìRIAS (m√°x. 2)</p>
                          <input type="file" accept="image/*" multiple onChange={async (e) => {
                            const files = Array.from(e.target.files).slice(0, 2);
                            if (!files.length) return;
                            setLoading(true);
                            try {
                              const compressed = [];
                              for (const f of files) { if (f.size <= 10000000) compressed.push(await compressImage(f)); }
                              setFormData({...formData, imagens: [...(formData.imagens || []), ...compressed].slice(0, 2)});
                              showToast('‚úÖ Imagem adicionada!', 'success');
                            } catch { showToast('Erro', 'error'); }
                            setLoading(false);
                            e.target.value = '';
                          }} className="w-full text-sm" />
                          {formData.imagens?.length > 0 && (
                            <div className="mt-3 flex gap-2">
                              {formData.imagens.map((img, i) => (
                                <div key={i} className="relative">
                                  <img src={img} className="h-24 rounded border" />
                                  <button onClick={() => setFormData({...formData, imagens: formData.imagens.filter((_, idx) => idx !== i)})} className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs">‚úï</button>
                                </div>
                              ))}
                            </div>
                          )}
                          <p className="text-xs text-gray-500 mt-2">{formData.imagens?.length || 0}/2 fotos</p>
                        </div>
                      )}

                      <button onClick={handleSubmitOS} disabled={loading || !formData.os || !formData.motivo || (motivosComFoto.includes(formData.motivo) && (!formData.imagens?.length))} className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold disabled:opacity-50">
                        {loading ? '‚è≥ Enviando...' : 'Enviar'}
                      </button>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h2 className="text-lg font-semibold mb-4">üìã Minhas Submiss√µes</h2>
                    {submissions.length === 0 ? <p className="text-gray-500">Nenhuma submiss√£o</p> : (
                      <div className="space-y-3">
                        {submissions.map(s => (
                          <div key={s.id} className="border rounded-lg p-4">
                            <div className="flex justify-between items-start">
                              <div>
                                <p className="font-mono text-lg font-bold">OS: {s.ordemServico}</p>
                                <p className="text-sm text-gray-600">{s.motivo}</p>
                              </div>
                              <span className={`px-3 py-1 rounded-full text-xs font-bold ${s.status === 'aprovada' ? 'bg-green-500 text-white' : s.status === 'rejeitada' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-white'}`}>{s.status?.toUpperCase()}</span>
                            </div>
                            {s.temImagem && !s.imagemComprovante && <button onClick={() => loadImagem(s.id)} className="mt-2 text-sm text-blue-600 hover:underline">üì∑ Ver foto(s)</button>}
                            {s.imagemComprovante && (
                              <div className="mt-2 flex gap-2">
                                {s.imagemComprovante.split('|||').map((img, i) => <img key={i} src={img} className="h-20 rounded cursor-pointer" onClick={() => setImageModal(img)} />)}
                              </div>
                            )}
                            <p className="text-xs text-gray-400 mt-2">{s.timestamp}</p>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </>
              )}

              {/* ABA SAQUE */}
              {formData.userTab === 'saque' && (
                <>
                  {!termsAccepted ? (
                    <div className="bg-white rounded-xl shadow p-6">
                      <h2 className="text-2xl font-bold text-purple-900 mb-4 text-center">üìã Termos de Uso</h2>
                      <div className="bg-gray-50 rounded-lg p-4 mb-6 max-h-80 overflow-y-auto text-sm">
                        <p className="text-gray-700 leading-relaxed">Uma taxa administrativa de 4,5% ser√° aplicada sobre o valor solicitado e deduzida automaticamente na transfer√™ncia. As solicita√ß√µes s√£o processadas de segunda a sexta, das 09:00 √†s 18:00, e aos s√°bados, das 08:00 √†s 12:00. Solicita√ß√µes feitas fora desse hor√°rio ser√£o atendidas no pr√≥ximo dia √∫til. √â sua responsabilidade garantir que as informa√ß√µes fornecidas estejam corretas, pois n√£o nos responsabilizamos por atrasos ou transfer√™ncias erradas causadas por dados incorretos. O dinheiro ser√° transferido em at√© 1 hora ap√≥s a confirma√ß√£o, dentro do hor√°rio de funcionamento.</p>
                      </div>
                      <button onClick={handleAcceptTerms} disabled={loading} className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold disabled:opacity-50">
                        {loading ? 'Aguarde...' : '‚úì Aceitar e Continuar'}
                      </button>
                    </div>
                  ) : !financialData?.full_name ? (
                    <div className="bg-white rounded-xl shadow p-6">
                      <h2 className="text-xl font-bold text-purple-900 mb-4">üí≥ Cadastrar Dados</h2>
                      <div className="space-y-4">
                        <div><label className="block text-sm font-semibold mb-1">C√≥digo</label><input type="text" value={user.codProfissional} disabled className="w-full px-4 py-2 border rounded-lg bg-gray-100" /></div>
                        <div><label className="block text-sm font-semibold mb-1">Nome *</label><input type="text" value={formData.finName || ''} onChange={e => setFormData({...formData, finName: e.target.value})} className="w-full px-4 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-semibold mb-1">CPF *</label><input type="text" value={formData.finCpf || ''} onChange={e => setFormData({...formData, finCpf: formatCPF(e.target.value)})} className="w-full px-4 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-semibold mb-1">Chave PIX *</label><input type="text" value={formData.finPix || ''} onChange={e => setFormData({...formData, finPix: e.target.value})} className="w-full px-4 py-2 border rounded-lg" /></div>
                        <button onClick={handleSaveFinancial} disabled={loading} className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold disabled:opacity-50">{loading ? 'Salvando...' : 'üíæ Salvar'}</button>
                      </div>
                    </div>
                  ) : (
                    <>
                      <div className="bg-white rounded-xl shadow mb-6">
                        <div className="flex border-b">
                          <button onClick={() => setFormData({...formData, saqueTab: 'solicitar'})} className={`flex-1 py-3 font-semibold ${(!formData.saqueTab || formData.saqueTab === 'solicitar') ? 'text-green-700 border-b-2 border-green-600' : 'text-gray-500'}`}>üí∞ Solicitar</button>
                          <button onClick={() => setFormData({...formData, saqueTab: 'dados'})} className={`flex-1 py-3 font-semibold ${formData.saqueTab === 'dados' ? 'text-blue-700 border-b-2 border-blue-600' : 'text-gray-500'}`}>üë§ Dados</button>
                          <button onClick={() => setFormData({...formData, saqueTab: 'gratuidades'})} className={`flex-1 py-3 font-semibold ${formData.saqueTab === 'gratuidades' ? 'text-purple-700 border-b-2 border-purple-600' : 'text-gray-500'}`}>üéÅ Gratuidades</button>
                        </div>
                        <div className="p-6">
                          {(!formData.saqueTab || formData.saqueTab === 'solicitar') && (
                            <>
                              <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-6">
                                <p className="text-sm text-yellow-800">‚ö†Ô∏è Taxa de 4,5%. {userGratuities.some(g => g.status === 'ativa' && g.remaining > 0) && <span className="text-green-700 font-bold">‚úÖ Gratuidade ativa - ISENTO!</span>}</p>
                              </div>
                              <div className="space-y-4">
                                <div><label className="block text-sm font-semibold mb-1">Valor</label><input type="number" value={formData.withdrawAmount || ''} onChange={e => setFormData({...formData, withdrawAmount: e.target.value})} className="w-full px-4 py-3 border rounded-lg text-lg" /></div>
                                {formData.withdrawAmount && parseFloat(formData.withdrawAmount) > 0 && (() => {
                                  const c = calcWithdraw(parseFloat(formData.withdrawAmount));
                                  return (
                                    <div className="bg-gray-50 rounded-lg p-4 space-y-2">
                                      <div className="flex justify-between"><span>Solicitado:</span><span className="font-bold">{formatMoney(formData.withdrawAmount)}</span></div>
                                      <div className="flex justify-between"><span>Taxa:</span><span className={c.hasGrat ? 'text-green-600 font-bold' : 'text-red-600'}>{c.hasGrat ? 'ISENTA' : `-${formatMoney(c.fee)}`}</span></div>
                                      <hr /><div className="flex justify-between text-lg"><span className="font-bold">Receber:</span><span className="font-bold text-green-700">{formatMoney(c.final)}</span></div>
                                    </div>
                                  );
                                })()}
                                <button onClick={handleRequestWithdrawal} disabled={loading || !formData.withdrawAmount} className="w-full bg-green-600 text-white py-3 rounded-lg font-bold disabled:opacity-50">{loading ? '...' : 'üí∏ Solicitar'}</button>
                              </div>
                              <h3 className="text-lg font-semibold mt-8 mb-4">üìã Hist√≥rico</h3>
                              {withdrawals.length === 0 ? <p className="text-gray-500">Nenhum saque</p> : (
                                <div className="space-y-3">
                                  {withdrawals.map(w => {
                                    const isDelayed = w.status === 'aguardando_aprovacao' && (Date.now() - new Date(w.created_at)) > 3600000;
                                    return (
                                      <div key={w.id} className={`border rounded-lg p-4 ${isDelayed ? 'border-red-400 bg-red-50' : ''}`}>
                                        <div className="flex justify-between">
                                          <div><p className="font-bold">{formatMoney(w.requested_amount)}</p><p className="text-sm text-gray-600">Receber: {formatMoney(w.final_amount)}</p></div>
                                          <span className={`px-3 py-1 rounded-full text-xs font-bold h-fit ${w.status?.includes('aprovado') ? 'bg-green-500 text-white' : w.status === 'rejeitado' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-white'}`}>{isDelayed ? '‚ö†Ô∏è ATRASADO' : statusLabels[w.status] || w.status}</span>
                                        </div>
                                        {isDelayed && <p className="text-red-600 text-sm mt-2 font-semibold">Entre em contato com o suporte</p>}
                                        <p className="text-xs text-gray-400 mt-2">{new Date(w.created_at).toLocaleString('pt-BR')}</p>
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </>
                          )}
                          {formData.saqueTab === 'dados' && (
                            <div className="space-y-4">
                              <div><label className="block text-sm font-semibold mb-1">Nome</label><input type="text" value={formData.finName ?? financialData?.full_name ?? ''} onChange={e => setFormData({...formData, finName: e.target.value})} className="w-full px-4 py-2 border rounded-lg" /></div>
                              <div><label className="block text-sm font-semibold mb-1">CPF</label><input type="text" value={formData.finCpf ?? financialData?.cpf ?? ''} onChange={e => setFormData({...formData, finCpf: formatCPF(e.target.value)})} className="w-full px-4 py-2 border rounded-lg" /></div>
                              <div><label className="block text-sm font-semibold mb-1">PIX</label><input type="text" value={formData.finPix ?? financialData?.pix_key ?? ''} onChange={e => setFormData({...formData, finPix: e.target.value})} className="w-full px-4 py-2 border rounded-lg" /></div>
                              <button onClick={handleSaveFinancial} disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold disabled:opacity-50">{loading ? '...' : 'üíæ Atualizar'}</button>
                            </div>
                          )}
                          {formData.saqueTab === 'gratuidades' && (
                            <>
                              <h3 className="font-semibold mb-4">üéÅ Minhas Gratuidades</h3>
                              {userGratuities.length === 0 ? <p className="text-gray-500">Nenhuma</p> : (
                                <div className="space-y-3">
                                  {userGratuities.map(g => (
                                    <div key={g.id} className={`border rounded-lg p-4 ${g.status === 'ativa' ? 'border-green-300 bg-green-50' : 'bg-gray-50'}`}>
                                      <div className="flex justify-between">
                                        <div><p className="font-bold">{g.remaining}/{g.quantity} restantes</p><p className="text-sm text-gray-600">Valor: {formatMoney(g.value)}</p></div>
                                        <span className={`px-3 py-1 rounded-full text-xs font-bold h-fit ${g.status === 'ativa' ? 'bg-green-500 text-white' : 'bg-gray-400 text-white'}`}>{g.status}</span>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </>
                          )}
                        </div>
                      </div>
                    </>
                  )}
                </>
              )}
            </div>
          </div>
        );
      }

      // ========== PAINEL ADMIN FINANCEIRO ==========
      if (user.role === 'admin_financeiro') {
        return (
          <div className="min-h-screen bg-gray-50">
            {toast && <Toast {...toast} />}
            {globalLoading && <LoadingOverlay />}

            <nav className="bg-green-800 shadow-lg">
              <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 className="text-xl font-bold text-white">üí∞ Painel Financeiro</h1>
                <div className="flex gap-2">
                  <button onClick={refreshAll} className="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 text-sm font-semibold">üîÑ</button>
                  <button onClick={() => setUser(null)} className="px-4 py-2 text-white hover:bg-green-700 rounded-lg">Sair</button>
                </div>
              </div>
            </nav>

            <div className="bg-white border-b sticky top-0 z-10">
              <div className="max-w-7xl mx-auto px-4 flex gap-1 overflow-x-auto">
                {['solicitacoes', 'conciliacao', 'resumo', 'gratuidades', 'restritos'].map(tab => (
                  <button key={tab} onClick={() => setFormData({...formData, finTab: tab})} className={`px-4 py-3 font-semibold whitespace-nowrap ${(formData.finTab || 'solicitacoes') === tab ? 'text-green-700 border-b-2 border-green-600' : 'text-gray-600'}`}>
                    {tab === 'solicitacoes' && 'üìã Solicita√ß√µes'}
                    {tab === 'conciliacao' && '‚úÖ Concilia√ß√£o'}
                    {tab === 'resumo' && 'üîç Resumo'}
                    {tab === 'gratuidades' && 'üéÅ Gratuidades'}
                    {tab === 'restritos' && 'üö´ Restritos'}
                  </button>
                ))}
              </div>
            </div>

            <div className="max-w-7xl mx-auto p-6">
              {(!formData.finTab || formData.finTab === 'solicitacoes') && (
                <div className="bg-white rounded-xl shadow overflow-hidden">
                  <div className="p-4 border-b flex justify-between items-center">
                    <h2 className="text-lg font-semibold">üìã Solicita√ß√µes</h2>
                    <select value={formData.filterStatus || ''} onChange={e => setFormData({...formData, filterStatus: e.target.value})} className="px-3 py-2 border rounded-lg">
                      <option value="">Todos</option>
                      <option value="aguardando_aprovacao">Aguardando</option>
                      <option value="aprovado">Aprovados</option>
                      <option value="rejeitado">Rejeitados</option>
                    </select>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left">Data</th><th className="px-4 py-3 text-left">Nome</th><th className="px-4 py-3 text-left">CPF</th><th className="px-4 py-3 text-left">C√≥digo</th><th className="px-4 py-3 text-right">Solicitado</th><th className="px-4 py-3 text-right">Debitado</th><th className="px-4 py-3 text-left">PIX</th><th className="px-4 py-3 text-center">Status</th><th className="px-4 py-3 text-left">Alterado por</th></tr></thead>
                      <tbody>
                        {allWithdrawals.filter(w => !formData.filterStatus || w.status === formData.filterStatus).map(w => (
                          <tr key={w.id} className={`border-t hover:bg-gray-50 ${w.has_gratuity ? 'row-green' : ''} ${w.is_restricted ? 'row-red' : ''}`}>
                            <td className="px-4 py-3 whitespace-nowrap">{new Date(w.created_at).toLocaleString('pt-BR')}</td>
                            <td className="px-4 py-3">{w.user_name}</td>
                            <td className="px-4 py-3">{w.cpf}</td>
                            <td className="px-4 py-3 font-mono">{w.user_cod}</td>
                            <td className="px-4 py-3 text-right font-semibold">{formatMoney(w.requested_amount)}</td>
                            <td className="px-4 py-3 text-right">{formatMoney(w.final_amount)}</td>
                            <td className="px-4 py-3 text-xs max-w-[150px] truncate">{w.pix_key}</td>
                            <td className="px-4 py-3"><select value={w.status} onChange={e => handleUpdateWithdrawalStatus(w.id, e.target.value)} className="px-2 py-1 border rounded text-xs"><option value="aguardando_aprovacao">‚è≥ Aguardando</option><option value="aprovado">‚úÖ Aprovado</option><option value="aprovado_gratuidade">‚úÖ c/ Gratuidade</option><option value="rejeitado">‚ùå Rejeitado</option><option value="inativo">‚ö†Ô∏è Inativo</option></select></td>
                            <td className="px-4 py-3 text-xs text-purple-700 font-semibold">{w.admin_name || '-'}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {formData.finTab === 'conciliacao' && (
                <>
                  <div className="grid md:grid-cols-5 gap-4 mb-6">
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Aprovados</p><p className="text-2xl font-bold text-green-600">{dashboardData.total_aprovados || 0}</p></div>
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Conciliados</p><p className="text-2xl font-bold text-blue-600">{dashboardData.total_conciliado || 0}</p></div>
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Pend. Conc.</p><p className="text-2xl font-bold text-yellow-600">{dashboardData.pendente_conciliacao || 0}</p></div>
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Debitados</p><p className="text-2xl font-bold text-purple-600">{dashboardData.total_debitado || 0}</p></div>
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Pend. D√©b.</p><p className="text-2xl font-bold text-orange-600">{dashboardData.pendente_debito || 0}</p></div>
                  </div>
                  <div className="bg-white rounded-xl shadow overflow-hidden">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left">Nome</th><th className="px-4 py-3 text-left">CPF</th><th className="px-4 py-3 text-left">C√≥digo</th><th className="px-4 py-3 text-right">Solicitado</th><th className="px-4 py-3 text-right">Debitado</th><th className="px-4 py-3 text-center">OMIE</th><th className="px-4 py-3 text-center">D√©bito</th></tr></thead>
                      <tbody>
                        {allWithdrawals.filter(w => w.status?.includes('aprovado')).map(w => (
                          <tr key={w.id} className="border-t hover:bg-gray-50">
                            <td className="px-4 py-3">{w.user_name}</td>
                            <td className="px-4 py-3">{w.cpf}</td>
                            <td className="px-4 py-3 font-mono">{w.user_cod}</td>
                            <td className="px-4 py-3 text-right">{formatMoney(w.requested_amount)}</td>
                            <td className="px-4 py-3 text-right font-semibold">{formatMoney(w.final_amount)}</td>
                            <td className="px-4 py-3 text-center"><input type="checkbox" checked={w.conciliacao_omie} onChange={e => handleUpdateConciliacao(w.id, 'conciliacaoOmie', e.target.checked)} className="w-5 h-5" /></td>
                            <td className="px-4 py-3 text-center"><input type="checkbox" checked={w.debito} onChange={e => handleUpdateConciliacao(w.id, 'debito', e.target.checked)} className="w-5 h-5" /></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </>
              )}

              {formData.finTab === 'resumo' && (
                <div className="bg-white rounded-xl shadow p-6">
                  <div className="flex gap-4 mb-6">
                    <input type="text" placeholder="C√≥digo do profissional" value={formData.searchCod || ''} onChange={e => setFormData({...formData, searchCod: e.target.value})} className="flex-1 px-4 py-2 border rounded-lg" />
                    <button className="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold">üîç Buscar</button>
                  </div>
                  {formData.searchCod && (
                    <div className="space-y-3">
                      {allWithdrawals.filter(w => w.user_cod.toLowerCase().includes(formData.searchCod.toLowerCase())).map(w => (
                        <div key={w.id} className="border rounded-lg p-4 flex justify-between items-center">
                          <div><p className="font-bold">{formatMoney(w.requested_amount)} ‚Üí {formatMoney(w.final_amount)}</p><p className="text-sm text-gray-600">{w.user_name}</p><p className="text-xs text-gray-400">{new Date(w.created_at).toLocaleString('pt-BR')}</p></div>
                          <span className={`px-3 py-1 rounded-full text-xs font-bold ${w.status?.includes('aprovado') ? 'bg-green-500 text-white' : w.status === 'rejeitado' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-white'}`}>{statusLabels[w.status]}</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {formData.finTab === 'gratuidades' && (
                <div className="space-y-6">
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="text-lg font-semibold mb-4">‚ûï Cadastrar Gratuidade</h3>
                    <div className="grid md:grid-cols-5 gap-4">
                      <input type="text" placeholder="C√≥digo" value={formData.gratUserCod || ''} onChange={e => setFormData({...formData, gratUserCod: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <input type="number" placeholder="Quantidade" value={formData.gratQty || ''} onChange={e => setFormData({...formData, gratQty: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <input type="number" placeholder="Valor (R$)" value={formData.gratValue || ''} onChange={e => setFormData({...formData, gratValue: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <input type="text" placeholder="Motivo" value={formData.gratReason || ''} onChange={e => setFormData({...formData, gratReason: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <button onClick={handleAddGratuity} disabled={loading} className="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold disabled:opacity-50">‚ûï Adicionar</button>
                    </div>
                  </div>
                  <div className="bg-white rounded-xl shadow overflow-hidden">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left">C√≥digo</th><th className="px-4 py-3 text-center">Qtd</th><th className="px-4 py-3 text-center">Rest.</th><th className="px-4 py-3 text-right">Valor</th><th className="px-4 py-3 text-left">Motivo</th><th className="px-4 py-3 text-center">Status</th></tr></thead>
                      <tbody>
                        {gratuities.map(g => (
                          <tr key={g.id} className={`border-t ${g.status === 'ativa' ? 'bg-green-50' : ''}`}>
                            <td className="px-4 py-3 font-mono">{g.user_cod}</td>
                            <td className="px-4 py-3 text-center">{g.quantity}</td>
                            <td className="px-4 py-3 text-center font-bold">{g.remaining}</td>
                            <td className="px-4 py-3 text-right">{formatMoney(g.value)}</td>
                            <td className="px-4 py-3">{g.reason || '-'}</td>
                            <td className="px-4 py-3 text-center"><span className={`px-2 py-1 rounded text-xs font-bold ${g.status === 'ativa' ? 'bg-green-500 text-white' : 'bg-gray-400 text-white'}`}>{g.status}</span></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {formData.finTab === 'restritos' && (
                <div className="space-y-6">
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="text-lg font-semibold mb-4">‚ûï Adicionar Restri√ß√£o</h3>
                    <div className="grid md:grid-cols-3 gap-4">
                      <input type="text" placeholder="C√≥digo" value={formData.restUserCod || ''} onChange={e => setFormData({...formData, restUserCod: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <input type="text" placeholder="Motivo" value={formData.restReason || ''} onChange={e => setFormData({...formData, restReason: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <button onClick={handleAddRestriction} disabled={loading} className="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold disabled:opacity-50">üö´ Adicionar</button>
                    </div>
                  </div>
                  <div className="bg-white rounded-xl shadow overflow-hidden">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left">C√≥digo</th><th className="px-4 py-3 text-left">Motivo</th><th className="px-4 py-3 text-left">Data</th><th className="px-4 py-3 text-center">Status</th><th className="px-4 py-3 text-center">A√ß√£o</th></tr></thead>
                      <tbody>
                        {restrictedList.map(r => (
                          <tr key={r.id} className={`border-t ${r.status === 'ativo' ? 'bg-red-50' : ''}`}>
                            <td className="px-4 py-3 font-mono">{r.user_cod}</td>
                            <td className="px-4 py-3">{r.reason}</td>
                            <td className="px-4 py-3">{new Date(r.created_at).toLocaleDateString('pt-BR')}</td>
                            <td className="px-4 py-3 text-center"><span className={`px-2 py-1 rounded text-xs font-bold ${r.status === 'ativo' ? 'bg-red-500 text-white' : 'bg-gray-400 text-white'}`}>{r.status}</span></td>
                            <td className="px-4 py-3 text-center">{r.status === 'ativo' && <button onClick={() => handleRemoveRestriction(r.id)} className="px-3 py-1 bg-green-600 text-white rounded text-xs">Suspender</button>}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // ========== PAINEL ADMIN NORMAL ==========
      return (
        <div className="min-h-screen bg-gray-50">
          {toast && <Toast {...toast} />}
          {globalLoading && <LoadingOverlay />}
          {imageModal && <ImageModal imageUrl={imageModal} onClose={() => setImageModal(null)} />}

          <nav className="bg-purple-900 shadow-lg">
            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
              <h1 className="text-xl font-bold text-white">Painel Admin</h1>
              <div className="flex gap-2">
                <button onClick={refreshAll} className="px-4 py-2 bg-purple-700 text-white rounded-lg hover:bg-purple-600 text-sm font-semibold">üîÑ Atualizar</button>
                <button onClick={() => setUser(null)} className="px-4 py-2 text-white hover:bg-purple-800 rounded-lg">Sair</button>
              </div>
            </div>
          </nav>

          <div className="bg-white border-b sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-4 flex gap-1 overflow-x-auto">
              {['dashboard', 'search', 'ranking', 'stats', 'users'].map(tab => (
                <button key={tab} onClick={() => setFormData({...formData, adminTab: tab})} className={`px-6 py-3 font-semibold whitespace-nowrap ${(!formData.adminTab && tab === 'dashboard') || formData.adminTab === tab ? 'text-purple-900 border-b-2 border-purple-900' : 'text-gray-600'}`}>
                  {tab === 'dashboard' && 'üìä Dashboard'}
                  {tab === 'search' && 'üîç Busca Detalhada'}
                  {tab === 'ranking' && 'üèÜ Ranking'}
                  {tab === 'stats' && 'üìà Estat√≠sticas'}
                  {tab === 'users' && 'üë• Usu√°rios'}
                </button>
              ))}
            </div>
          </div>

          <div className="max-w-7xl mx-auto p-6">
            {/* DASHBOARD */}
            {(!formData.adminTab || formData.adminTab === 'dashboard') && (
              <>
                <div className="grid md:grid-cols-4 gap-4 mb-6">
                  <div className="bg-white p-6 rounded-xl shadow"><p className="text-sm text-gray-600">Total</p><p className="text-3xl font-bold text-purple-900">{submissions.length}</p></div>
                  <div className="bg-white p-6 rounded-xl shadow"><p className="text-sm text-gray-600">Pendentes</p><p className="text-3xl font-bold text-yellow-600">{submissions.filter(s => s.status === 'pendente').length}</p></div>
                  <div className="bg-white p-6 rounded-xl shadow"><p className="text-sm text-gray-600">Aprovadas</p><p className="text-3xl font-bold text-green-600">{submissions.filter(s => s.status === 'aprovada').length}</p></div>
                  <div className="bg-white p-6 rounded-xl shadow"><p className="text-sm text-gray-600">Rejeitadas</p><p className="text-3xl font-bold text-red-600">{submissions.filter(s => s.status === 'rejeitada').length}</p></div>
                </div>

                {/* GR√ÅFICOS */}
                <div className="grid md:grid-cols-2 gap-6 mb-6">
                  <MotivosPieChart submissions={submissions} />
                  <PieChart 
                    data={[
                      { label: '‚úì Aprovadas', value: submissions.filter(s => s.status === 'aprovada').length, color: '#22c55e' },
                      { label: '‚úó Rejeitadas', value: submissions.filter(s => s.status === 'rejeitada').length, color: '#ef4444' },
                      { label: '‚è≥ Pendentes', value: submissions.filter(s => s.status === 'pendente').length, color: '#fbbf24' }
                    ]}
                    title="üìà Status das Solicita√ß√µes"
                  />
                </div>

                {/* VALIDA√á√ÉO PENDENTES */}
                <div className="bg-white rounded-xl shadow p-6">
                  <h2 className="text-lg font-semibold mb-4">Aguardando Valida√ß√£o</h2>
                  <div className="mb-4 flex flex-wrap gap-2">
                    {['all', 'retorno', 'ponto1', 'pedagio'].map(f => (
                      <button key={f} onClick={() => setFormData({...formData, pendingFilter: f})} className={`px-4 py-2 rounded-lg font-semibold ${(formData.pendingFilter || 'all') === f ? 'bg-purple-600 text-white' : 'bg-gray-100'}`}>
                        {f === 'all' && `üìã Todos (${submissions.filter(s => s.status === 'pendente').length})`}
                        {f === 'retorno' && `üîÑ Retorno (${submissions.filter(s => s.status === 'pendente' && s.motivo === 'Ajuste de Retorno').length})`}
                        {f === 'ponto1' && `üìç Ponto 1 (${submissions.filter(s => s.status === 'pendente' && s.motivo?.includes('Ponto 1')).length})`}
                        {f === 'pedagio' && `üõ£Ô∏è Ped√°gio (${submissions.filter(s => s.status === 'pendente' && s.motivo?.includes('Ped√°gio')).length})`}
                      </button>
                    ))}
                  </div>
                  <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {submissions.filter(s => {
                      if (s.status !== 'pendente') return false;
                      if (!formData.pendingFilter || formData.pendingFilter === 'all') return true;
                      if (formData.pendingFilter === 'retorno') return s.motivo === 'Ajuste de Retorno';
                      if (formData.pendingFilter === 'ponto1') return s.motivo?.includes('Ponto 1');
                      if (formData.pendingFilter === 'pedagio') return s.motivo?.includes('Ped√°gio');
                      return true;
                    }).map(s => (
                      <div key={s.id} className="border rounded-lg p-3 text-sm">
                        <p className="font-mono text-lg font-bold">OS: {s.ordemServico}</p>
                        <p className="text-xs text-gray-700">{s.fullName}</p>
                        <p className="text-xs text-purple-900 font-semibold">{s.motivo}</p>
                        {s.coordenadas && (
                          <div className="mt-2 bg-green-50 border border-green-200 rounded p-2">
                            <p className="text-xs font-mono text-green-900">{s.coordenadas}</p>
                            <div className="flex gap-2 mt-1">
                              <button onClick={() => { navigator.clipboard.writeText(s.coordenadas); showToast('Copiado!', 'success'); }} className="text-xs text-green-600">üìã Copiar</button>
                              <a href={`https://www.google.com/maps?q=${s.coordenadas}`} target="_blank" className="text-xs text-green-600">üó∫Ô∏è Maps</a>
                            </div>
                          </div>
                        )}
                        {s.temImagem && (
                          <div className="mt-2">
                            {s.imagemComprovante ? (
                              <>
                                <div className="flex gap-2 flex-wrap">
                                  {s.imagemComprovante.split('|||').map((img, i) => <img key={i} src={img} className="h-20 rounded cursor-pointer" onClick={() => setImageModal(img)} />)}
                                </div>
                                <button onClick={() => setSubmissions(prev => prev.map(sub => sub.id === s.id ? {...sub, imagemComprovante: null} : sub))} className="text-xs text-gray-500">‚ñ≤ Ocultar</button>
                              </>
                            ) : (
                              <button onClick={() => { showToast('üîÑ Carregando...', 'success'); loadImagem(s.id); }} className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">üì∑ Ver foto(s)</button>
                            )}
                          </div>
                        )}
                        <textarea placeholder="Obs (opcional)" value={formData[`obs_${s.id}`] || ''} onChange={e => setFormData({...formData, [`obs_${s.id}`]: e.target.value})} className="w-full px-2 py-1 border rounded mt-2 text-xs" rows="1" />
                        <div className="flex gap-2 mt-2">
                          <button onClick={() => handleValidate(s.id, true)} className="flex-1 bg-green-600 text-white py-1 rounded text-xs font-semibold">‚úì Aprovar</button>
                          <button onClick={() => handleValidate(s.id, false)} className="flex-1 bg-red-600 text-white py-1 rounded text-xs font-semibold">‚úó Rejeitar</button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </>
            )}

            {/* BUSCA DETALHADA */}
            {formData.adminTab === 'search' && (
              <div className="bg-white rounded-xl shadow p-6">
                <div className="flex flex-wrap gap-4 mb-6">
                  <input type="text" placeholder="üîç Buscar por OS ou c√≥digo..." value={formData.searchOS || ''} onChange={e => setFormData({...formData, searchOS: e.target.value})} className="flex-1 px-4 py-2 border rounded-lg" />
                  <select value={formData.statusFilter || ''} onChange={e => setFormData({...formData, statusFilter: e.target.value})} className="px-4 py-2 border rounded-lg">
                    <option value="">Todos status</option>
                    <option value="pendente">Pendente</option>
                    <option value="aprovada">Aprovada</option>
                    <option value="rejeitada">Rejeitada</option>
                  </select>
                  <select value={formData.dateFilter || ''} onChange={e => setFormData({...formData, dateFilter: e.target.value})} className="px-4 py-2 border rounded-lg">
                    <option value="">Todo per√≠odo</option>
                    <option value="today">Hoje</option>
                    <option value="week">Esta semana</option>
                    <option value="month">Este m√™s</option>
                  </select>
                </div>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {submissions.filter(s => {
                    if (formData.searchOS && !s.ordemServico?.toLowerCase().includes(formData.searchOS.toLowerCase()) && !s.codProfissional?.toLowerCase().includes(formData.searchOS.toLowerCase())) return false;
                    if (formData.statusFilter && s.status !== formData.statusFilter) return false;
                    if (formData.dateFilter) {
                      const today = new Date(); today.setHours(0,0,0,0);
                      const subDate = new Date(s.created_at);
                      if (formData.dateFilter === 'today') { const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate()+1); if (subDate < today || subDate >= tomorrow) return false; }
                      else if (formData.dateFilter === 'week') { const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate()-7); if (subDate < weekAgo) return false; }
                      else if (formData.dateFilter === 'month') { const monthAgo = new Date(today); monthAgo.setMonth(monthAgo.getMonth()-1); if (subDate < monthAgo) return false; }
                    }
                    return true;
                  }).map(s => (
                    <div key={s.id} className={`border rounded-lg p-3 text-sm ${s.status === 'aprovada' ? 'bg-green-50' : s.status === 'rejeitada' ? 'bg-red-50' : 'bg-yellow-50'}`}>
                      <div className="flex justify-between items-start mb-1">
                        <div><p className="font-mono font-bold">OS: {s.ordemServico}</p><p className="text-xs text-gray-700">{s.fullName}</p></div>
                        <div className="flex items-center gap-1">
                          <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${s.status === 'aprovada' ? 'bg-green-600 text-white' : s.status === 'rejeitada' ? 'bg-red-600 text-white' : 'bg-yellow-600 text-white'}`}>{s.status?.toUpperCase()}</span>
                          <button onClick={async () => { if (!confirm(`Excluir OS ${s.ordemServico}?`)) return; await fetch(`${API_URL}/submissions/${s.id}`, { method: 'DELETE' }); showToast('üóëÔ∏è Exclu√≠da!', 'success'); loadSubmissions(); }} className="px-1.5 py-0.5 bg-red-600 text-white rounded text-xs">üóëÔ∏è</button>
                        </div>
                      </div>
                      <p className="text-xs text-gray-600">{s.motivo}</p>
                      {s.coordenadas && (
                        <div className="mt-1 bg-green-50 border border-green-200 rounded p-1.5 flex items-center justify-between">
                          <p className="text-xs font-mono text-green-900">{s.coordenadas}</p>
                          <button onClick={() => { navigator.clipboard.writeText(s.coordenadas); showToast('üìã Copiado!', 'success'); }} className="px-1.5 py-0.5 bg-green-600 text-white text-xs rounded">üìã</button>
                        </div>
                      )}
                      {s.temImagem && (
                        <div className="mt-1">
                          {s.imagemComprovante ? (
                            <>
                              <div className="flex gap-1 flex-wrap">{s.imagemComprovante.split('|||').map((img, i) => <img key={i} src={img} className="h-20 rounded cursor-pointer" onClick={() => setImageModal(img)} />)}</div>
                              <button onClick={() => setSubmissions(prev => prev.map(sub => sub.id === s.id ? {...sub, imagemComprovante: null} : sub))} className="text-xs text-gray-500">‚ñ≤ Ocultar</button>
                            </>
                          ) : (
                            <button onClick={() => { showToast('üîÑ Carregando...', 'success'); loadImagem(s.id); }} className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs font-semibold">üì∑ Ver foto(s)</button>
                          )}
                        </div>
                      )}
                      {s.observacao && <div className="mt-1 bg-white p-1 rounded border"><p className="text-xs text-gray-600">Obs: {s.observacao}</p></div>}
                      <div className="flex justify-between items-center mt-1">
                        <p className="text-xs text-gray-400">{s.timestamp}</p>
                        {s.validated_by_name && s.status !== 'pendente' && <p className="text-xs text-purple-600 font-semibold">üë§ {s.validated_by_name}</p>}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* RANKING */}
            {formData.adminTab === 'ranking' && (
              <div className="bg-white rounded-xl shadow p-6">
                <h2 className="text-lg font-semibold mb-4">üèÜ Ranking de Retorno - Aprova√ß√µes</h2>
                <div className="mb-6">
                  <select value={formData.rankingPeriod || 'all'} onChange={e => setFormData({...formData, rankingPeriod: e.target.value})} className="px-4 py-2 border rounded-lg">
                    <option value="all">üìÖ Todos os Tempos</option>
                    <option value="today">üìÖ Hoje</option>
                    <option value="week">üìÖ Esta Semana</option>
                    <option value="month">üìÖ Este M√™s</option>
                  </select>
                </div>
                <div className="space-y-3">
                  {(() => {
                    const today = new Date(); today.setHours(0,0,0,0);
                    const filtered = submissions.filter(s => {
                      if (s.status !== 'aprovada' || s.motivo !== 'Ajuste de Retorno') return false;
                      if (!formData.rankingPeriod || formData.rankingPeriod === 'all') return true;
                      const subDate = new Date(s.created_at);
                      if (formData.rankingPeriod === 'today') { const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate()+1); return subDate >= today && subDate < tomorrow; }
                      if (formData.rankingPeriod === 'week') { const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate()-7); return subDate >= weekAgo; }
                      if (formData.rankingPeriod === 'month') { const monthAgo = new Date(today); monthAgo.setMonth(monthAgo.getMonth()-1); return subDate >= monthAgo; }
                      return true;
                    });
                    const stats = {};
                    filtered.forEach(s => { const n = s.fullName || 'Desconhecido'; stats[n] = (stats[n] || 0) + 1; });
                    const ranking = Object.entries(stats).sort((a, b) => b[1] - a[1]);
                    if (ranking.length === 0) return <p className="text-gray-500 text-center py-8">Sem dados no per√≠odo</p>;
                    return ranking.map(([name, count], i) => (
                      <div key={i} className="flex items-center gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <div className={`text-3xl font-bold w-12 ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : i === 2 ? 'text-orange-600' : 'text-gray-400'}`}>{i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i+1}¬∫`}</div>
                        <div className="flex-1"><p className="font-semibold text-lg text-gray-800">{name}</p></div>
                        <div className="text-right"><p className="text-3xl font-bold text-purple-600">{count}</p><p className="text-xs text-gray-500">aprova√ß√µes</p></div>
                      </div>
                    ));
                  })()}
                </div>
              </div>
            )}

            {/* ESTAT√çSTICAS */}
            {formData.adminTab === 'stats' && (
              <div className="space-y-6">
                <div className="grid md:grid-cols-2 gap-6">
                  <TechRanking submissions={submissions} />
                  <div className="space-y-4">
                    <div className="bg-white rounded-xl shadow p-6"><p className="text-sm text-gray-600">Taxa de Aprova√ß√£o</p><p className="text-3xl font-bold text-green-600">{submissions.length > 0 ? ((submissions.filter(s => s.status === 'aprovada').length / submissions.length) * 100).toFixed(1) : 0}%</p></div>
                    <div className="bg-white rounded-xl shadow p-6"><p className="text-sm text-gray-600">Taxa de Rejei√ß√£o</p><p className="text-3xl font-bold text-red-600">{submissions.length > 0 ? ((submissions.filter(s => s.status === 'rejeitada').length / submissions.length) * 100).toFixed(1) : 0}%</p></div>
                    <div className="bg-white rounded-xl shadow p-6"><p className="text-sm text-gray-600">M√©dia por T√©cnico</p><p className="text-3xl font-bold text-purple-600">{users.length > 0 ? (submissions.length / users.length).toFixed(1) : 0}</p></div>
                    <div className="bg-white rounded-xl shadow p-6"><p className="text-sm text-gray-600">Total de T√©cnicos</p><p className="text-3xl font-bold text-blue-600">{users.length}</p></div>
                  </div>
                </div>
              </div>
            )}

            {/* USU√ÅRIOS */}
            {formData.adminTab === 'users' && (
              <div className="bg-white rounded-xl shadow p-6">
                <h2 className="text-lg font-semibold mb-4">üë• Gerenciar Usu√°rios</h2>
                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                  <h3 className="font-semibold mb-3">‚ûï Criar Usu√°rio</h3>
                  <div className="space-y-4">
                    <div className="grid md:grid-cols-2 gap-4">
                      <div><label className="block text-sm font-semibold mb-1">Nome</label><input type="text" value={formData.newName || ''} onChange={e => setFormData({...formData, newName: e.target.value})} className="w-full px-3 py-2 border rounded" /></div>
                      <div><label className="block text-sm font-semibold mb-1">C√≥digo</label><input type="text" value={formData.newCod || ''} onChange={e => setFormData({...formData, newCod: e.target.value})} className="w-full px-3 py-2 border rounded" /></div>
                    </div>
                    <div className="grid md:grid-cols-2 gap-4">
                      <div><label className="block text-sm font-semibold mb-1">Senha</label><input type="password" value={formData.newPass || ''} onChange={e => setFormData({...formData, newPass: e.target.value})} className="w-full px-3 py-2 border rounded" /></div>
                      <div><label className="block text-sm font-semibold mb-1">Tipo</label><select value={formData.newRole || 'user'} onChange={e => setFormData({...formData, newRole: e.target.value})} className="w-full px-3 py-2 border rounded bg-white"><option value="user">üë§ Usu√°rio</option><option value="admin">üëë Admin</option><option value="admin_financeiro">üí∞ Admin Financeiro</option></select></div>
                    </div>
                    <button onClick={async () => {
                      if (!formData.newName || !formData.newCod || !formData.newPass) { showToast('Preencha todos', 'error'); return; }
                      setLoading(true);
                      try {
                        await fetch(`${API_URL}/users/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fullName: formData.newName, codProfissional: formData.newCod, password: formData.newPass, role: formData.newRole || 'user' }) });
                        showToast('‚úÖ Criado!', 'success');
                        setFormData({...formData, newName: '', newCod: '', newPass: '', newRole: 'user'});
                        loadUsers();
                      } catch { showToast('Erro', 'error'); }
                      setLoading(false);
                    }} className="w-full px-6 py-2 bg-purple-600 text-white rounded font-semibold">‚ûï Criar Usu√°rio</button>
                  </div>
                </div>
                <h3 className="font-semibold mb-3">üìã Usu√°rios Cadastrados</h3>
                <div className="space-y-2">
                  {users.map(u => (
                    <div key={u.codProfissional} className="border rounded-lg p-4 flex items-center justify-between hover:bg-gray-50">
                      <div className="flex-1"><p className="font-semibold">{u.fullName}</p><p className="text-sm text-gray-600">COD: {u.codProfissional} ‚Ä¢ {u.role}</p><p className="text-xs text-gray-400">{u.createdAt}</p></div>
                      <div className="flex gap-2 items-center">
                        <input type="password" placeholder="Nova senha" value={formData[`newpass_${u.codProfissional}`] || ''} onChange={e => setFormData({...formData, [`newpass_${u.codProfissional}`]: e.target.value})} className="px-3 py-2 border rounded text-sm w-32" />
                        <button onClick={async () => {
                          const pw = formData[`newpass_${u.codProfissional}`];
                          if (!pw || pw.length < 4) { showToast('Senha muito curta', 'error'); return; }
                          await fetch(`${API_URL}/users/reset-password`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ codProfissional: u.codProfissional, newPassword: pw }) });
                          showToast('‚úÖ Senha alterada!', 'success');
                          setFormData({...formData, [`newpass_${u.codProfissional}`]: ''});
                        }} className="px-4 py-2 bg-purple-600 text-white rounded text-sm font-semibold">üîë Resetar</button>
                        <button onClick={async () => {
                          if (!confirm(`Excluir ${u.fullName}?`)) return;
                          await fetch(`${API_URL}/users/${u.codProfissional}`, { method: 'DELETE' });
                          showToast('üóëÔ∏è Exclu√≠do!', 'success');
                          loadUsers();
                        }} className="px-4 py-2 bg-red-600 text-white rounded text-sm font-semibold">üóëÔ∏è</button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
