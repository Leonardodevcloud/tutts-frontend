<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Tutts v5.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script>
    const { useState, useEffect, createElement: h } = React;
    const API_URL = 'https://tutts-backend-production.up.railway.app/api';

    function App() {
      const [currentUser, setCurrentUser] = useState(null);
      const [page, setPage] = useState('login');
      
      useEffect(() => {
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        if (token && user) {
          const userData = JSON.parse(user);
          setCurrentUser(userData);
          setPage(userData.role === 'admin' ? 'form' : 'list');
        }
      }, []);

      const handleLogin = (user) => {
        setCurrentUser(user);
        setPage(user.role === 'admin' ? 'form' : 'list');
        alert('Bem-vindo, ' + user.username + '!');
      };

      if (!currentUser) {
        return h(LoginPage, { onLogin: handleLogin });
      }

      return h('div', { className: 'min-h-screen bg-gray-100 p-8' },
        h('div', { className: 'max-w-7xl mx-auto' },
          h('div', { className: 'bg-white rounded-lg shadow-lg p-6 mb-6 flex justify-between items-center' },
            h('h1', { className: 'text-3xl font-bold text-violet-600' }, 'Sistema Tutts'),
            h('div', { className: 'flex gap-4 items-center' },
              h('span', { className: 'font-semibold' }, 'UsuÃ¡rio: ' + currentUser.username),
              currentUser.role === 'admin' && h('button', {
                onClick: () => setPage('form'),
                className: 'px-4 py-2 bg-violet-600 text-white rounded hover:bg-violet-700'
              }, 'Nova SolicitaÃ§Ã£o'),
              h('button', {
                onClick: () => setPage('list'),
                className: 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700'
              }, 'Ver Lista'),
              h('button', {
                onClick: () => {
                  localStorage.clear();
                  setCurrentUser(null);
                  setPage('login');
                },
                className: 'px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700'
              }, 'Sair')
            )
          ),
          page === 'form' && h(FormPage),
          page === 'list' && h(ListPage, { currentUser: currentUser })
        )
      );
    }

    function LoginPage({ onLogin }) {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
          const response = await fetch(API_URL + '/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username, password: password })
          });
          const data = await response.json();
          if (response.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            onLogin(data.user);
          } else {
            alert(data.error || 'Erro ao fazer login');
          }
        } catch (error) {
          alert('Erro ao conectar ao servidor');
        } finally {
          setLoading(false);
        }
      };

      return h('div', { className: 'min-h-screen bg-gradient-to-br from-violet-600 to-blue-600 flex items-center justify-center p-4' },
        h('div', { className: 'bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md' },
          h('h1', { className: 'text-4xl font-bold text-center text-violet-600 mb-8' }, 'Sistema Tutts'),
          h('form', { onSubmit: handleSubmit, className: 'space-y-6' },
            h('div', null,
              h('label', { className: 'block text-gray-700 font-semibold mb-2' }, 'UsuÃ¡rio'),
              h('input', {
                type: 'text',
                value: username,
                onChange: (e) => setUsername(e.target.value),
                className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-violet-600 focus:outline-none',
                required: true
              })
            ),
            h('div', null,
              h('label', { className: 'block text-gray-700 font-semibold mb-2' }, 'Senha'),
              h('input', {
                type: 'password',
                value: password,
                onChange: (e) => setPassword(e.target.value),
                className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-violet-600 focus:outline-none',
                required: true
              })
            ),
            h('button', {
              type: 'submit',
              disabled: loading,
              className: 'w-full bg-violet-600 text-white py-3 rounded-lg font-bold hover:bg-violet-700 disabled:opacity-50'
            }, loading ? 'Entrando...' : 'Entrar')
          )
        )
      );
    }

    function FormPage() {
      const [formData, setFormData] = useState({
        nomeTecnico: '',
        nomeCliente: '',
        motivoVisita: '',
        descricao: '',
        imagens: [],
        imagemComprovante: null
      });
      const [loading, setLoading] = useState(false);

      const motivos = [
        'InstalaÃ§Ã£o',
        'ManutenÃ§Ã£o Preventiva',
        'ManutenÃ§Ã£o Corretiva',
        'Ajuste de PedÃ¡gio (Campinas e Recife)',
        'Treinamento',
        'Outros'
      ];

      const compressImage = (file) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              if (width > 1200) {
                height = height * 1200 / width;
                width = 1200;
              } else if (height > 1200) {
                width = width * 1200 / height;
                height = 1200;
              }
              canvas.width = width;
              canvas.height = height;
              canvas.getContext('2d').drawImage(img, 0, 0, width, height);
              resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      };

      const handleImageChange = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 2) {
          alert('MÃ¡ximo de 2 fotos');
          e.target.value = '';
          return;
        }
        const compressed = await Promise.all(files.map(f => compressImage(f)));
        setFormData({ ...formData, imagens: compressed });
      };

      const handleComprovanteChange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          const compressed = await compressImage(file);
          setFormData({ ...formData, imagemComprovante: compressed });
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        const isPedagio = formData.motivoVisita === 'Ajuste de PedÃ¡gio (Campinas e Recife)';
        if (isPedagio && formData.imagens.length === 0) {
          alert('Foto obrigatÃ³ria para Ajuste de PedÃ¡gio!');
          return;
        }
        setLoading(true);
        try {
          const token = localStorage.getItem('token');
          const response = await fetch(API_URL + '/submissions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              nomeTecnico: formData.nomeTecnico,
              nomeCliente: formData.nomeCliente,
              motivoVisita: formData.motivoVisita,
              descricao: formData.descricao,
              imagens: formData.imagens.join(','),
              imagemComprovante: formData.imagemComprovante
            })
          });
          if (response.ok) {
            alert('SolicitaÃ§Ã£o enviada!');
            setFormData({
              nomeTecnico: '',
              nomeCliente: '',
              motivoVisita: '',
              descricao: '',
              imagens: [],
              imagemComprovante: null
            });
          } else {
            alert('Erro ao enviar');
          }
        } catch (error) {
          alert('Erro de conexÃ£o');
        } finally {
          setLoading(false);
        }
      };

      const isPedagio = formData.motivoVisita === 'Ajuste de PedÃ¡gio (Campinas e Recife)';

      return h('div', { className: 'bg-white rounded-lg shadow-lg p-8' },
        h('h2', { className: 'text-2xl font-bold mb-6' }, 'Nova SolicitaÃ§Ã£o'),
        h('form', { onSubmit: handleSubmit, className: 'space-y-6' },
          h('input', {
            type: 'text',
            placeholder: 'Nome do TÃ©cnico *',
            value: formData.nomeTecnico,
            onChange: (e) => setFormData({ ...formData, nomeTecnico: e.target.value }),
            className: 'w-full px-4 py-3 border rounded-lg',
            required: true
          }),
          h('input', {
            type: 'text',
            placeholder: 'Nome do Cliente *',
            value: formData.nomeCliente,
            onChange: (e) => setFormData({ ...formData, nomeCliente: e.target.value }),
            className: 'w-full px-4 py-3 border rounded-lg',
            required: true
          }),
          h('select', {
            value: formData.motivoVisita,
            onChange: (e) => setFormData({ ...formData, motivoVisita: e.target.value }),
            className: 'w-full px-4 py-3 border rounded-lg',
            required: true
          },
            h('option', { value: '' }, 'Selecione o motivo'),
            motivos.map(m => h('option', { key: m, value: m }, m))
          ),
          h('textarea', {
            placeholder: 'DescriÃ§Ã£o *',
            value: formData.descricao,
            onChange: (e) => setFormData({ ...formData, descricao: e.target.value }),
            className: 'w-full px-4 py-3 border rounded-lg',
            rows: 4,
            required: true
          }),
          h('div', null,
            h('label', { className: 'block font-semibold mb-2' },
              'Fotos da OS (mÃ¡x. 2) ',
              isPedagio && h('span', { className: 'text-red-600' }, '* ObrigatÃ³rio para PedÃ¡gio')
            ),
            h('input', {
              type: 'file',
              accept: 'image/*',
              multiple: true,
              onChange: handleImageChange,
              className: 'w-full px-4 py-3 border rounded-lg'
            }),
            formData.imagens.length > 0 && h('div', { className: 'flex gap-4 mt-4' },
              formData.imagens.map((img, i) =>
                h('img', { key: i, src: img, className: 'w-32 h-32 object-cover rounded border' })
              )
            )
          ),
          h('div', null,
            h('label', { className: 'block font-semibold mb-2' }, 'Comprovante (opcional)'),
            h('input', {
              type: 'file',
              accept: 'image/*',
              onChange: handleComprovanteChange,
              className: 'w-full px-4 py-3 border rounded-lg'
            }),
            formData.imagemComprovante && h('img', {
              src: formData.imagemComprovante,
              className: 'w-32 h-32 object-cover rounded border mt-4'
            })
          ),
          h('button', {
            type: 'submit',
            disabled: loading,
            className: 'w-full bg-violet-600 text-white py-3 rounded-lg font-bold hover:bg-violet-700 disabled:opacity-50'
          }, loading ? 'Enviando...' : 'Enviar SolicitaÃ§Ã£o')
        )
      );
    }

    function ListPage({ currentUser }) {
      const [submissions, setSubmissions] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetchSubmissions();
        const interval = setInterval(fetchSubmissions, 300000);
        return () => clearInterval(interval);
      }, []);

      const fetchSubmissions = async () => {
        try {
          const token = localStorage.getItem('token');
          const response = await fetch(API_URL + '/submissions', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (response.ok) {
            const data = await response.json();
            setSubmissions(data);
          }
        } catch (error) {
          console.error('Erro ao carregar');
        } finally {
          setLoading(false);
        }
      };

      const handleDelete = async (id) => {
        if (!confirm('Excluir?')) return;
        try {
          const token = localStorage.getItem('token');
          const response = await fetch(API_URL + '/submissions/' + id, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (response.ok) {
            alert('ExcluÃ­do!');
            fetchSubmissions();
          }
        } catch (error) {
          alert('Erro ao excluir');
        }
      };

      if (loading) return h('div', { className: 'text-center text-2xl mt-20' }, 'Carregando...');

      return h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
        submissions.map(s => {
          const imgs = s.imagens ? (typeof s.imagens === 'string' ? s.imagens.split(',') : s.imagens) : [];
          return h('div', { key: s.id, className: 'bg-white rounded-lg shadow-lg p-6' },
            h('div', { className: 'flex justify-between mb-4' },
              h('div', null,
                h('h3', { className: 'text-xl font-bold' }, s.nome_cliente),
                h('p', { className: 'text-gray-600' }, s.nome_tecnico)
              ),
              currentUser.role === 'admin' && h('button', {
                onClick: () => handleDelete(s.id),
                className: 'text-red-600 font-bold text-xl'
              }, 'ðŸ—‘ï¸')
            ),
            h('p', null, h('b', null, 'Motivo: '), s.motivo),
            h('p', null, h('b', null, 'DescriÃ§Ã£o: '), s.descricao),
            h('p', { className: 'text-gray-500 text-xs mt-2' }, new Date(s.created_at).toLocaleString('pt-BR')),
            imgs.length > 0 && h('div', { className: 'mt-4' },
              h('p', { className: 'font-semibold mb-2' }, 'Fotos:'),
              h('div', { className: 'flex gap-2' },
                imgs.map((img, i) =>
                  h('img', {
                    key: i,
                    src: img.trim(),
                    alt: 'Foto ' + (i + 1),
                    className: 'w-20 h-20 object-cover rounded border cursor-pointer',
                    onClick: () => window.open(img.trim())
                  })
                )
              )
            ),
            s.imagem_comprovante && h('div', { className: 'mt-4' },
              h('p', { className: 'font-semibold mb-2' }, 'Comprovante:'),
              h('img', {
                src: s.imagem_comprovante,
                className: 'w-20 h-20 object-cover rounded border cursor-pointer',
                onClick: () => window.open(s.imagem_comprovante)
              })
            )
          );
        })
      );
    }

    ReactDOM.render(React.createElement(App), document.getElementById('root'));
  </script>
</body>
</html>
