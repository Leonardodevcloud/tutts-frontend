<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Tutts - Solicita√ß√µes e Saque Emergencial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .toast { animation: slideIn 0.3s ease-out; }
    .pulse { animation: pulse 2s infinite; }
    .row-green { background-color: #dcfce7 !important; border-left: 4px solid #22c55e !important; }
    .row-red { background-color: #fee2e2 !important; border-left: 4px solid #ef4444 !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_URL = 'https://tutts-backend-production.up.railway.app/api';

    // ===================== COMPONENTES UTILIT√ÅRIOS =====================
    const Toast = ({ message, type }) => (
      <div className={`fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-2xl toast ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white font-semibold flex items-center gap-3`}>
        <span className="text-2xl">{type === 'success' ? '‚úì' : '‚úó'}</span>
        <span>{message}</span>
      </div>
    );

    const LoadingOverlay = ({ message = 'Carregando...' }) => (
      <div className="fixed inset-0 bg-black bg-opacity-30 z-50 flex items-center justify-center">
        <div className="bg-white rounded-xl p-6 shadow-2xl flex flex-col items-center gap-3">
          <div className="w-10 h-10 border-4 border-purple-600 border-t-transparent rounded-full animate-spin"></div>
          <p className="text-gray-700 font-semibold">{message}</p>
        </div>
      </div>
    );

    const ImageModal = ({ imageUrl, onClose }) => (
      <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onClick={onClose}>
        <div className="relative max-w-4xl max-h-screen">
          <button onClick={onClose} className="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300">‚úï</button>
          <img src={imageUrl} alt="Expandido" className="max-w-full max-h-screen rounded-lg shadow-2xl" onClick={(e) => e.stopPropagation()} />
        </div>
      </div>
    );

    // ===================== COMPONENTE PRINCIPAL =====================
    const App = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(false);
      const [globalLoading, setGlobalLoading] = useState(false);
      const [toast, setToast] = useState(null);
      const [formData, setFormData] = useState({});
      const [imageModal, setImageModal] = useState(null);
      const [lastActivity, setLastActivity] = useState(Date.now());

      // Estados - Solicita√ß√µes
      const [submissions, setSubmissions] = useState([]);
      const [users, setUsers] = useState([]);

      // Estados - Saque Emergencial
      const [termsAccepted, setTermsAccepted] = useState(false);
      const [financialData, setFinancialData] = useState(null);
      const [withdrawals, setWithdrawals] = useState([]);
      const [allWithdrawals, setAllWithdrawals] = useState([]);
      const [gratuities, setGratuities] = useState([]);
      const [userGratuities, setUserGratuities] = useState([]);
      const [restrictedList, setRestrictedList] = useState([]);
      const [dashboardData, setDashboardData] = useState({});

      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };

      // Auto-logout 5 min
      useEffect(() => {
        if (!user) return;
        const TIMEOUT = 5 * 60 * 1000;
        const reset = () => setLastActivity(Date.now());
        const events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart', 'click'];
        events.forEach(e => window.addEventListener(e, reset));
        const check = setInterval(() => {
          if (Date.now() - lastActivity > TIMEOUT) {
            showToast('‚è∞ Sess√£o expirada', 'error');
            setTimeout(() => { setUser(null); setFormData({}); }, 1500);
          }
        }, 30000);
        return () => { events.forEach(e => window.removeEventListener(e, reset)); clearInterval(check); };
      }, [user, lastActivity]);

      // Carregar dados ao logar
      useEffect(() => {
        if (!user) return;
        loadSubmissions();
        if (user.role === 'admin') loadUsers();
        if (user.role === 'user') { checkTerms(); loadUserWithdrawals(); loadUserGratuities(); }
        if (user.role === 'admin_financeiro') { loadAllWithdrawals(); loadAllGratuities(); loadRestricted(); loadDashboard(); }
      }, [user]);

      // ===================== FUN√á√ïES DE CARREGAMENTO =====================
      const loadSubmissions = async () => {
        try {
          const query = user.role === 'user' ? `?userId=${user.id}&userCod=${user.cod_profissional}` : '';
          const res = await fetch(`${API_URL}/submissions${query}`);
          const data = await res.json();
          setSubmissions(data.map(s => ({
            ...s, ordemServico: s.ordem_servico, codProfissional: s.user_cod, fullName: s.user_name,
            temImagem: s.tem_imagem, imagemComprovante: null, timestamp: new Date(s.created_at).toLocaleString('pt-BR')
          })));
        } catch (err) { console.error(err); }
      };

      const loadUsers = async () => {
        try {
          const res = await fetch(`${API_URL}/users`);
          const data = await res.json();
          setUsers(data.map(u => ({ codProfissional: u.cod_profissional, fullName: u.full_name, role: u.role, createdAt: new Date(u.created_at).toLocaleString('pt-BR') })));
        } catch (err) { console.error(err); }
      };

      const loadImagem = async (id) => {
        try {
          const res = await fetch(`${API_URL}/submissions/${id}/imagem`);
          const data = await res.json();
          setSubmissions(prev => prev.map(s => s.id === id ? {...s, imagemComprovante: data.imagem} : s));
        } catch (err) { showToast('Erro ao carregar imagem', 'error'); }
      };

      const checkTerms = async () => {
        try {
          const res = await fetch(`${API_URL}/financial/check-terms/${user.cod_profissional}`);
          const data = await res.json();
          setTermsAccepted(data.hasAccepted);
          if (data.hasAccepted) {
            const finRes = await fetch(`${API_URL}/financial/data/${user.cod_profissional}`);
            const finData = await finRes.json();
            setFinancialData(finData.data);
          }
        } catch (err) { console.error(err); }
      };

      const loadUserWithdrawals = async () => {
        try {
          const res = await fetch(`${API_URL}/withdrawals/user/${user.cod_profissional}`);
          setWithdrawals(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadUserGratuities = async () => {
        try {
          const res = await fetch(`${API_URL}/gratuities/user/${user.cod_profissional}`);
          setUserGratuities(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadAllWithdrawals = async () => {
        try {
          const res = await fetch(`${API_URL}/withdrawals`);
          setAllWithdrawals(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadAllGratuities = async () => {
        try {
          const res = await fetch(`${API_URL}/gratuities`);
          setGratuities(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadRestricted = async () => {
        try {
          const res = await fetch(`${API_URL}/restricted`);
          setRestrictedList(await res.json());
        } catch (err) { console.error(err); }
      };

      const loadDashboard = async () => {
        try {
          const res = await fetch(`${API_URL}/withdrawals/dashboard/conciliacao`);
          setDashboardData(await res.json());
        } catch (err) { console.error(err); }
      };

      const refreshAll = async () => {
        setGlobalLoading(true);
        try {
          await loadSubmissions();
          if (user.role === 'admin') await loadUsers();
          if (user.role === 'user') { await loadUserWithdrawals(); await loadUserGratuities(); }
          if (user.role === 'admin_financeiro') { await loadAllWithdrawals(); await loadAllGratuities(); await loadRestricted(); await loadDashboard(); }
          showToast('üîÑ Atualizado!', 'success');
        } catch (err) { showToast('Erro', 'error'); }
        setGlobalLoading(false);
      };

      // ===================== FUN√á√ïES DE A√á√ÉO =====================
      const handleLogin = async () => {
        setLoading(true);
        try {
          const res = await fetch(`${API_URL}/users/login`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codProfissional: formData.cod, password: formData.password })
          });
          if (!res.ok) throw new Error('Credenciais inv√°lidas');
          const data = await res.json();
          setUser({ ...data, codProfissional: data.cod_profissional, fullName: data.full_name });
          setFormData({});
        } catch (err) { showToast(err.message, 'error'); }
        setLoading(false);
      };

      const handleRegister = async () => {
        setLoading(true);
        try {
          const res = await fetch(`${API_URL}/users/register`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codProfissional: formData.cod, password: formData.password, fullName: formData.name })
          });
          if (!res.ok) throw new Error('Erro no cadastro');
          showToast('Cadastro realizado!', 'success');
          setFormData({ view: 'login' });
        } catch (err) { showToast(err.message, 'error'); }
        setLoading(false);
      };

      const handleAcceptTerms = async () => {
        setLoading(true);
        try {
          await fetch(`${API_URL}/financial/accept-terms`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: user.codProfissional })
          });
          setTermsAccepted(true);
          showToast('‚úÖ Termos aceitos!', 'success');
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleSaveFinancial = async () => {
        if (!formData.finName || !formData.finCpf || !formData.finPix) {
          showToast('Preencha todos os campos', 'error'); return;
        }
        setLoading(true);
        try {
          await fetch(`${API_URL}/financial/data`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: user.codProfissional, fullName: formData.finName, cpf: formData.finCpf, pixKey: formData.finPix })
          });
          setFinancialData({ full_name: formData.finName, cpf: formData.finCpf, pix_key: formData.finPix });
          showToast('‚úÖ Dados salvos!', 'success');
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleRequestWithdrawal = async () => {
        const amount = parseFloat(formData.withdrawAmount);
        if (!amount || amount <= 0) { showToast('Valor inv√°lido', 'error'); return; }
        setLoading(true);
        try {
          await fetch(`${API_URL}/withdrawals`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: user.codProfissional, userName: financialData.full_name, cpf: financialData.cpf, pixKey: financialData.pix_key, requestedAmount: amount })
          });
          showToast('‚úÖ Saque solicitado!', 'success');
          setFormData({ ...formData, withdrawAmount: '' });
          loadUserWithdrawals();
          loadUserGratuities();
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleUpdateWithdrawalStatus = async (id, status) => {
        try {
          await fetch(`${API_URL}/withdrawals/${id}`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status, adminId: user.id, adminName: user.fullName || 'Admin Financeiro' })
          });
          showToast('‚úÖ Status atualizado!', 'success');
          loadAllWithdrawals();
        } catch (err) { showToast('Erro', 'error'); }
      };

      const handleUpdateConciliacao = async (id, field, value) => {
        try {
          await fetch(`${API_URL}/withdrawals/${id}/conciliacao`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [field]: value })
          });
          loadAllWithdrawals();
          loadDashboard();
        } catch (err) { showToast('Erro', 'error'); }
      };

      const handleAddGratuity = async () => {
        if (!formData.gratUserCod || !formData.gratQty || !formData.gratValue) {
          showToast('Preencha todos os campos', 'error'); return;
        }
        setLoading(true);
        try {
          await fetch(`${API_URL}/gratuities`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: formData.gratUserCod, quantity: parseInt(formData.gratQty), value: parseFloat(formData.gratValue), reason: formData.gratReason || '' })
          });
          showToast('‚úÖ Gratuidade cadastrada!', 'success');
          setFormData({ ...formData, gratUserCod: '', gratQty: '', gratValue: '', gratReason: '' });
          loadAllGratuities();
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleAddRestriction = async () => {
        if (!formData.restUserCod || !formData.restReason) {
          showToast('Preencha todos os campos', 'error'); return;
        }
        setLoading(true);
        try {
          await fetch(`${API_URL}/restricted`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userCod: formData.restUserCod, reason: formData.restReason })
          });
          showToast('‚úÖ Restri√ß√£o cadastrada!', 'success');
          setFormData({ ...formData, restUserCod: '', restReason: '' });
          loadRestricted();
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleRemoveRestriction = async (id) => {
        try {
          await fetch(`${API_URL}/restricted/${id}/remove`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ removedReason: 'Suspensa pelo admin' })
          });
          showToast('‚úÖ Restri√ß√£o removida!', 'success');
          loadRestricted();
        } catch (err) { showToast('Erro', 'error'); }
      };

      // Submiss√µes OS
      const motivosComFoto = ['Ajuste de Retorno', 'Ajuste de Ped√°gio (Campinas e Recife)'];
      
      const compressImage = (file, maxWidth = 800, quality = 0.6) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let w = img.width, h = img.height;
              if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; }
              canvas.width = w; canvas.height = h;
              canvas.getContext('2d').drawImage(img, 0, 0, w, h);
              resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = reject;
            img.src = e.target.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      };

      const handleSubmitOS = async () => {
        setLoading(true);
        try {
          const imgs = formData.imagens?.length > 0 ? formData.imagens.join('|||') : null;
          await fetch(`${API_URL}/submissions`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ordemServico: formData.os, motivo: formData.motivo, userId: user.id, userCod: user.codProfissional, userName: user.fullName, imagemComprovante: imgs, coordenadas: formData.coordenadas || null })
          });
          showToast('‚úÖ OS enviada!', 'success');
          setFormData({});
          loadSubmissions();
        } catch (err) { showToast('Erro', 'error'); }
        setLoading(false);
      };

      const handleValidate = async (id, approved) => {
        try {
          await fetch(`${API_URL}/submissions/${id}`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: approved ? 'aprovada' : 'rejeitada', observacao: formData.obs || '', validatedBy: user.id, validatedByName: user.fullName || 'Admin' })
          });
          showToast(approved ? '‚úÖ Aprovada!' : '‚ùå Rejeitada!', approved ? 'success' : 'error');
          setFormData({ ...formData, obs: '' });
          loadSubmissions();
        } catch (err) { showToast('Erro', 'error'); }
      };

      // C√°lculo do saque
      const calcWithdraw = (amount) => {
        const hasGrat = userGratuities.some(g => g.status === 'ativa' && g.remaining > 0);
        const fee = hasGrat ? 0 : amount * 0.045;
        return { fee, final: amount - fee, hasGrat };
      };

      // Formatar CPF
      const formatCPF = (v) => {
        const n = v.replace(/\D/g, '').slice(0, 11);
        if (n.length <= 3) return n;
        if (n.length <= 6) return `${n.slice(0,3)}.${n.slice(3)}`;
        if (n.length <= 9) return `${n.slice(0,3)}.${n.slice(3,6)}.${n.slice(6)}`;
        return `${n.slice(0,3)}.${n.slice(3,6)}.${n.slice(6,9)}-${n.slice(9)}`;
      };

      // Formatar moeda
      const formatMoney = (v) => parseFloat(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

      // Status labels
      const statusLabels = {
        'aguardando_aprovacao': '‚è≥ Aguardando',
        'aprovado': '‚úÖ Aprovado',
        'aprovado_gratuidade': '‚úÖ Aprov. c/ Gratuidade',
        'rejeitado': '‚ùå Rejeitado',
        'inativo': '‚ö†Ô∏è Inativo'
      };

      // ===================== TELA DE LOGIN =====================
      if (!user) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center p-4">
            {toast && <Toast {...toast} />}
            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
              <div className="text-center mb-8">
                <div className="w-28 h-28 mx-auto mb-4 bg-purple-900 rounded-xl p-4 shadow-lg flex items-center justify-center">
                  <span className="text-white text-4xl font-bold">tutts</span>
                </div>
                <h1 className="text-2xl font-bold text-gray-800">Sistema Tutts</h1>
                <p className="text-gray-500 text-sm">Solicita√ß√µes e Saque Emergencial</p>
              </div>

              {formData.view === 'register' ? (
                <div className="space-y-4">
                  <input type="text" placeholder="Nome Completo" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                  <input type="text" placeholder="C√≥digo Profissional" value={formData.cod || ''} onChange={e => setFormData({...formData, cod: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                  <input type="password" placeholder="Senha" value={formData.password || ''} onChange={e => setFormData({...formData, password: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                  <button onClick={handleRegister} disabled={loading} className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold hover:bg-purple-800 disabled:opacity-50">
                    {loading ? 'Aguarde...' : 'Criar Conta'}
                  </button>
                  <button onClick={() => setFormData({view: 'login'})} className="w-full text-purple-700 text-sm">‚Üê Voltar</button>
                </div>
              ) : (
                <div className="space-y-4">
                  <input type="text" placeholder="C√≥digo Profissional" value={formData.cod || ''} onChange={e => setFormData({...formData, cod: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                  <input type="password" placeholder="Senha" value={formData.password || ''} onChange={e => setFormData({...formData, password: e.target.value})} onKeyDown={e => e.key === 'Enter' && handleLogin()} className="w-full px-4 py-3 border rounded-lg" />
                  <button onClick={handleLogin} disabled={loading} className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold hover:bg-purple-800 disabled:opacity-50">
                    {loading ? 'Entrando...' : 'Entrar'}
                  </button>
                  <button onClick={() => setFormData({view: 'register'})} className="w-full text-purple-700 text-sm">Criar nova conta</button>
                </div>
              )}
            </div>
          </div>
        );
      }

      // ===================== PAINEL DO USU√ÅRIO =====================
      if (user.role === 'user') {
        return (
          <div className="min-h-screen bg-gray-50">
            {toast && <Toast {...toast} />}
            {globalLoading && <LoadingOverlay />}
            {imageModal && <ImageModal imageUrl={imageModal} onClose={() => setImageModal(null)} />}

            <nav className="bg-white shadow-sm border-b">
              <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                  <h1 className="text-xl font-bold">Painel do Usu√°rio</h1>
                  <p className="text-sm text-gray-600">{user.fullName}</p>
                </div>
                <div className="flex gap-2">
                  <button onClick={refreshAll} className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm font-semibold">üîÑ Atualizar</button>
                  <button onClick={() => setUser(null)} className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">Sair</button>
                </div>
              </div>
            </nav>

            {/* Abas do Usu√°rio */}
            <div className="bg-white border-b">
              <div className="max-w-7xl mx-auto px-4 flex gap-1">
                <button onClick={() => setFormData({...formData, userTab: 'solicitacoes'})} className={`px-6 py-3 font-semibold ${(!formData.userTab || formData.userTab === 'solicitacoes') ? 'text-purple-900 border-b-2 border-purple-900' : 'text-gray-600'}`}>
                  üìã Central de Solicita√ß√µes
                </button>
                <button onClick={() => setFormData({...formData, userTab: 'saque'})} className={`px-6 py-3 font-semibold ${formData.userTab === 'saque' ? 'text-green-700 border-b-2 border-green-600' : 'text-gray-600'}`}>
                  üí∞ Saque Emergencial
                </button>
              </div>
            </div>

            <div className="max-w-4xl mx-auto p-6">
              {/* ABA: SOLICITA√á√ïES */}
              {(!formData.userTab || formData.userTab === 'solicitacoes') && (
                <>
                  <div className="bg-white rounded-xl shadow p-6 mb-6">
                    <h2 className="text-lg font-semibold mb-4">üìù Enviar OS</h2>
                    <div className="space-y-4">
                      <input type="text" placeholder="N√∫mero da OS" value={formData.os || ''} onChange={e => setFormData({...formData, os: e.target.value})} className="w-full px-4 py-3 border rounded-lg" />
                      <select value={formData.motivo || ''} onChange={e => {
                        const m = e.target.value;
                        let coord = '';
                        if (m === 'Altera√ß√£o Ponto 1 (Goi√¢nia)') coord = '-16.64322218214421, -49.3190143453706';
                        if (m === 'Altera√ß√£o Ponto 1 (Campinas)') coord = '-22.850067092813358, -47.08310037116422';
                        setFormData({...formData, motivo: m, coordenadas: coord, imagens: []});
                      }} className="w-full px-4 py-3 border rounded-lg">
                        <option value="">Selecione o motivo</option>
                        <option>Altera√ß√£o Ponto 1 (Campinas)</option>
                        <option>Altera√ß√£o Ponto 1 (Goi√¢nia)</option>
                        <option>Ajuste de Retorno</option>
                        <option>Ajuste de Ped√°gio (Campinas e Recife)</option>
                      </select>

                      {formData.coordenadas && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                          <p className="text-xs text-blue-700 font-semibold">üìç COORDENADAS</p>
                          <p className="font-mono text-blue-900">{formData.coordenadas}</p>
                          <button onClick={() => { navigator.clipboard.writeText(formData.coordenadas); showToast('Copiado!', 'success'); }} className="mt-2 text-sm text-blue-600 hover:underline">üìã Copiar</button>
                        </div>
                      )}

                      {motivosComFoto.includes(formData.motivo) && (
                        <div className="border-2 border-dashed border-orange-300 bg-orange-50 rounded-lg p-4">
                          <p className="text-sm font-bold text-orange-800 mb-2">üìé Fotos OBRIGAT√ìRIAS (m√°x. 2)</p>
                          <input type="file" accept="image/*" multiple onChange={async (e) => {
                            const files = Array.from(e.target.files).slice(0, 2);
                            if (!files.length) return;
                            setLoading(true);
                            try {
                              const compressed = [];
                              for (const f of files) {
                                if (f.size > 10000000) continue;
                                compressed.push(await compressImage(f));
                              }
                              const curr = formData.imagens || [];
                              setFormData({...formData, imagens: [...curr, ...compressed].slice(0, 2)});
                              showToast('‚úÖ Imagem adicionada!', 'success');
                            } catch { showToast('Erro', 'error'); }
                            setLoading(false);
                            e.target.value = '';
                          }} className="w-full text-sm" />
                          {formData.imagens?.length > 0 && (
                            <div className="mt-3 flex gap-2">
                              {formData.imagens.map((img, i) => (
                                <div key={i} className="relative">
                                  <img src={img} className="h-24 rounded border" />
                                  <button onClick={() => setFormData({...formData, imagens: formData.imagens.filter((_, idx) => idx !== i)})} className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs">‚úï</button>
                                </div>
                              ))}
                            </div>
                          )}
                          <p className="text-xs text-gray-500 mt-2">{formData.imagens?.length || 0}/2 fotos</p>
                        </div>
                      )}

                      <button onClick={handleSubmitOS} disabled={loading || !formData.os || !formData.motivo || (motivosComFoto.includes(formData.motivo) && (!formData.imagens?.length))} className="w-full bg-purple-900 text-white py-3 rounded-lg font-semibold disabled:opacity-50">
                        {loading ? '‚è≥ Enviando...' : 'Enviar'}
                      </button>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h2 className="text-lg font-semibold mb-4">üìã Minhas Submiss√µes</h2>
                    {submissions.length === 0 ? <p className="text-gray-500">Nenhuma submiss√£o</p> : (
                      <div className="space-y-3">
                        {submissions.map(s => (
                          <div key={s.id} className="border rounded-lg p-4">
                            <div className="flex justify-between items-start">
                              <div>
                                <p className="font-mono text-lg font-bold">OS: {s.ordemServico}</p>
                                <p className="text-sm text-gray-600">{s.motivo}</p>
                              </div>
                              <span className={`px-3 py-1 rounded-full text-xs font-bold ${s.status === 'aprovada' ? 'bg-green-500 text-white' : s.status === 'rejeitada' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-white'}`}>
                                {s.status?.toUpperCase()}
                              </span>
                            </div>
                            {s.temImagem && (
                              <button onClick={() => loadImagem(s.id)} className="mt-2 text-sm text-blue-600 hover:underline">üì∑ Ver foto(s)</button>
                            )}
                            {s.imagemComprovante && (
                              <div className="mt-2 flex gap-2">
                                {s.imagemComprovante.split('|||').map((img, i) => (
                                  <img key={i} src={img} className="h-20 rounded cursor-pointer" onClick={() => setImageModal(img)} />
                                ))}
                              </div>
                            )}
                            <p className="text-xs text-gray-400 mt-2">{s.timestamp}</p>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </>
              )}

              {/* ABA: SAQUE EMERGENCIAL */}
              {formData.userTab === 'saque' && (
                <>
                  {/* Termos de Uso */}
                  {!termsAccepted ? (
                    <div className="bg-white rounded-xl shadow p-6">
                      <h2 className="text-2xl font-bold text-purple-900 mb-4 text-center">üìã Termos de Uso - Saque Emergencial</h2>
                      <div className="bg-gray-50 rounded-lg p-4 mb-6 max-h-80 overflow-y-auto text-sm text-gray-700 space-y-3">
                        <p><strong>1. TAXA DE SERVI√áO:</strong> O Saque Emergencial possui taxa de <strong>4,5%</strong> sobre o valor solicitado.</p>
                        <p><strong>2. GRATUIDADES:</strong> Se voc√™ possuir gratuidades ativas, a taxa ser√° automaticamente isentada.</p>
                        <p><strong>3. PRAZO:</strong> Solicita√ß√µes processadas em at√© 1 hora. Ap√≥s esse prazo, entre em contato com o suporte.</p>
                        <p><strong>4. RESPONSABILIDADE:</strong> Mantenha seus dados (PIX, CPF) atualizados.</p>
                        <p><strong>5. RESTRI√á√ïES:</strong> A plataforma pode restringir o acesso em caso de irregularidades.</p>
                      </div>
                      <button onClick={handleAcceptTerms} disabled={loading} className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 disabled:opacity-50">
                        {loading ? 'Aguarde...' : '‚úì Aceitar e Continuar'}
                      </button>
                    </div>
                  ) : !financialData?.full_name ? (
                    /* Cadastro de Dados Financeiros */
                    <div className="bg-white rounded-xl shadow p-6">
                      <h2 className="text-xl font-bold text-purple-900 mb-4">üí≥ Cadastrar Dados Financeiros</h2>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-1">C√≥digo Tutts</label>
                          <input type="text" value={user.codProfissional} disabled className="w-full px-4 py-2 border rounded-lg bg-gray-100" />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-1">Nome Completo *</label>
                          <input type="text" placeholder="Nome como no banco" value={formData.finName || ''} onChange={e => setFormData({...formData, finName: e.target.value})} className="w-full px-4 py-2 border rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-1">CPF *</label>
                          <input type="text" placeholder="000.000.000-00" value={formData.finCpf || ''} onChange={e => setFormData({...formData, finCpf: formatCPF(e.target.value)})} className="w-full px-4 py-2 border rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-1">Chave PIX *</label>
                          <input type="text" placeholder="CPF, Email, Telefone ou Aleat√≥ria" value={formData.finPix || ''} onChange={e => setFormData({...formData, finPix: e.target.value})} className="w-full px-4 py-2 border rounded-lg" />
                        </div>
                        <button onClick={handleSaveFinancial} disabled={loading} className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold disabled:opacity-50">
                          {loading ? 'Salvando...' : 'üíæ Salvar Dados'}
                        </button>
                      </div>
                    </div>
                  ) : (
                    /* Tela Principal de Saque */
                    <>
                      {/* Sub-abas */}
                      <div className="bg-white rounded-xl shadow mb-6">
                        <div className="flex border-b">
                          <button onClick={() => setFormData({...formData, saqueTab: 'solicitar'})} className={`flex-1 py-3 font-semibold ${(!formData.saqueTab || formData.saqueTab === 'solicitar') ? 'text-green-700 border-b-2 border-green-600' : 'text-gray-500'}`}>
                            üí∞ Solicitar Saque
                          </button>
                          <button onClick={() => setFormData({...formData, saqueTab: 'dados'})} className={`flex-1 py-3 font-semibold ${formData.saqueTab === 'dados' ? 'text-blue-700 border-b-2 border-blue-600' : 'text-gray-500'}`}>
                            üë§ Meus Dados
                          </button>
                          <button onClick={() => setFormData({...formData, saqueTab: 'gratuidades'})} className={`flex-1 py-3 font-semibold ${formData.saqueTab === 'gratuidades' ? 'text-purple-700 border-b-2 border-purple-600' : 'text-gray-500'}`}>
                            üéÅ Gratuidades
                          </button>
                        </div>

                        <div className="p-6">
                          {/* Solicitar Saque */}
                          {(!formData.saqueTab || formData.saqueTab === 'solicitar') && (
                            <>
                              <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-6">
                                <p className="text-sm text-yellow-800">
                                  ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Taxa de 4,5% ser√° aplicada. 
                                  {userGratuities.some(g => g.status === 'ativa' && g.remaining > 0) && (
                                    <span className="text-green-700 font-bold"> ‚úÖ Voc√™ tem gratuidade ativa! Taxa ISENTA.</span>
                                  )}
                                </p>
                              </div>

                              <div className="space-y-4">
                                <div>
                                  <label className="block text-sm font-semibold text-gray-700 mb-1">Valor Solicitado</label>
                                  <input type="number" placeholder="0,00" value={formData.withdrawAmount || ''} onChange={e => setFormData({...formData, withdrawAmount: e.target.value})} className="w-full px-4 py-3 border rounded-lg text-lg" />
                                </div>

                                {formData.withdrawAmount && parseFloat(formData.withdrawAmount) > 0 && (() => {
                                  const calc = calcWithdraw(parseFloat(formData.withdrawAmount));
                                  return (
                                    <div className="bg-gray-50 rounded-lg p-4 space-y-2">
                                      <div className="flex justify-between"><span>Valor solicitado:</span><span className="font-bold">{formatMoney(formData.withdrawAmount)}</span></div>
                                      <div className="flex justify-between"><span>Taxa (4,5%):</span><span className={calc.hasGrat ? 'text-green-600 font-bold' : 'text-red-600'}>{calc.hasGrat ? 'ISENTA' : `-${formatMoney(calc.fee)}`}</span></div>
                                      <hr />
                                      <div className="flex justify-between text-lg"><span className="font-bold">Valor a receber:</span><span className="font-bold text-green-700">{formatMoney(calc.final)}</span></div>
                                    </div>
                                  );
                                })()}

                                <button onClick={handleRequestWithdrawal} disabled={loading || !formData.withdrawAmount} className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50">
                                  {loading ? 'Processando...' : 'üí∏ Solicitar Saque'}
                                </button>
                              </div>

                              {/* Hist√≥rico de Saques */}
                              <h3 className="text-lg font-semibold mt-8 mb-4">üìã Hist√≥rico de Saques</h3>
                              {withdrawals.length === 0 ? <p className="text-gray-500">Nenhum saque realizado</p> : (
                                <div className="space-y-3">
                                  {withdrawals.map(w => {
                                    const created = new Date(w.created_at);
                                    const isDelayed = w.status === 'aguardando_aprovacao' && (Date.now() - created) > 3600000;
                                    return (
                                      <div key={w.id} className={`border rounded-lg p-4 ${isDelayed ? 'border-red-400 bg-red-50' : ''}`}>
                                        <div className="flex justify-between items-start">
                                          <div>
                                            <p className="font-bold text-lg">{formatMoney(w.requested_amount)}</p>
                                            <p className="text-sm text-gray-600">Receber: {formatMoney(w.final_amount)} {w.has_gratuity && <span className="text-green-600">(c/ gratuidade)</span>}</p>
                                          </div>
                                          <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                            w.status === 'aprovado' || w.status === 'aprovado_gratuidade' ? 'bg-green-500 text-white' :
                                            w.status === 'rejeitado' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-white'
                                          }`}>
                                            {isDelayed ? '‚ö†Ô∏è ATRASADO' : statusLabels[w.status] || w.status}
                                          </span>
                                        </div>
                                        {isDelayed && <p className="text-red-600 text-sm mt-2 font-semibold">Entre em contato com o suporte financeiro</p>}
                                        <p className="text-xs text-gray-400 mt-2">{created.toLocaleString('pt-BR')}</p>
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </>
                          )}

                          {/* Meus Dados */}
                          {formData.saqueTab === 'dados' && (
                            <div className="space-y-4">
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">Nome</label>
                                <input type="text" value={formData.finName ?? financialData?.full_name ?? ''} onChange={e => setFormData({...formData, finName: e.target.value})} className="w-full px-4 py-2 border rounded-lg" />
                              </div>
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">CPF</label>
                                <input type="text" value={formData.finCpf ?? financialData?.cpf ?? ''} onChange={e => setFormData({...formData, finCpf: formatCPF(e.target.value)})} className="w-full px-4 py-2 border rounded-lg" />
                              </div>
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">Chave PIX</label>
                                <input type="text" value={formData.finPix ?? financialData?.pix_key ?? ''} onChange={e => setFormData({...formData, finPix: e.target.value})} className="w-full px-4 py-2 border rounded-lg" />
                              </div>
                              <button onClick={handleSaveFinancial} disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold disabled:opacity-50">
                                {loading ? 'Salvando...' : 'üíæ Atualizar Dados'}
                              </button>
                            </div>
                          )}

                          {/* Gratuidades */}
                          {formData.saqueTab === 'gratuidades' && (
                            <>
                              <h3 className="font-semibold mb-4">üéÅ Minhas Gratuidades</h3>
                              {userGratuities.length === 0 ? <p className="text-gray-500">Nenhuma gratuidade cadastrada</p> : (
                                <div className="space-y-3">
                                  {userGratuities.map(g => (
                                    <div key={g.id} className={`border rounded-lg p-4 ${g.status === 'ativa' ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-gray-50'}`}>
                                      <div className="flex justify-between">
                                        <div>
                                          <p className="font-bold">{g.remaining}/{g.quantity} restantes</p>
                                          <p className="text-sm text-gray-600">Valor: {formatMoney(g.value)}</p>
                                          {g.reason && <p className="text-xs text-gray-500">Motivo: {g.reason}</p>}
                                        </div>
                                        <span className={`px-3 py-1 rounded-full text-xs font-bold h-fit ${g.status === 'ativa' ? 'bg-green-500 text-white' : 'bg-gray-400 text-white'}`}>
                                          {g.status === 'ativa' ? '‚úÖ Ativa' : '‚ùå Expirada'}
                                        </span>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </>
                          )}
                        </div>
                      </div>
                    </>
                  )}
                </>
              )}
            </div>
          </div>
        );
      }

      // ===================== PAINEL ADMIN FINANCEIRO =====================
      if (user.role === 'admin_financeiro') {
        return (
          <div className="min-h-screen bg-gray-50">
            {toast && <Toast {...toast} />}
            {globalLoading && <LoadingOverlay />}

            <nav className="bg-green-800 shadow-lg">
              <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 className="text-xl font-bold text-white">üí∞ Painel Financeiro</h1>
                <div className="flex gap-2">
                  <button onClick={refreshAll} className="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-600 text-sm font-semibold">üîÑ Atualizar</button>
                  <button onClick={() => setUser(null)} className="px-4 py-2 text-white hover:bg-green-700 rounded-lg">Sair</button>
                </div>
              </div>
            </nav>

            {/* Abas */}
            <div className="bg-white border-b sticky top-0 z-10 shadow-sm">
              <div className="max-w-7xl mx-auto px-4 flex gap-1 overflow-x-auto">
                {['solicitacoes', 'conciliacao', 'resumo', 'gratuidades', 'restritos'].map(tab => (
                  <button key={tab} onClick={() => setFormData({...formData, finTab: tab})} className={`px-4 py-3 font-semibold whitespace-nowrap ${(formData.finTab || 'solicitacoes') === tab ? 'text-green-700 border-b-2 border-green-600' : 'text-gray-600'}`}>
                    {tab === 'solicitacoes' && 'üìã Solicita√ß√µes'}
                    {tab === 'conciliacao' && '‚úÖ Concilia√ß√£o'}
                    {tab === 'resumo' && 'üîç Resumo Individual'}
                    {tab === 'gratuidades' && 'üéÅ Gratuidades'}
                    {tab === 'restritos' && 'üö´ Restritos'}
                  </button>
                ))}
              </div>
            </div>

            <div className="max-w-7xl mx-auto p-6">
              {/* ABA: SOLICITA√á√ïES */}
              {(!formData.finTab || formData.finTab === 'solicitacoes') && (
                <div className="bg-white rounded-xl shadow overflow-hidden">
                  <div className="p-4 border-b flex justify-between items-center">
                    <h2 className="text-lg font-semibold">üìã Solicita√ß√µes de Saque</h2>
                    <select value={formData.filterStatus || ''} onChange={e => setFormData({...formData, filterStatus: e.target.value})} className="px-3 py-2 border rounded-lg">
                      <option value="">Todos os status</option>
                      <option value="aguardando_aprovacao">Aguardando</option>
                      <option value="aprovado">Aprovados</option>
                      <option value="rejeitado">Rejeitados</option>
                    </select>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-3 text-left">Data/Hora</th>
                          <th className="px-4 py-3 text-left">Nome</th>
                          <th className="px-4 py-3 text-left">CPF</th>
                          <th className="px-4 py-3 text-left">C√≥digo</th>
                          <th className="px-4 py-3 text-right">Solicitado</th>
                          <th className="px-4 py-3 text-right">Debitado</th>
                          <th className="px-4 py-3 text-left">PIX</th>
                          <th className="px-4 py-3 text-center">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {allWithdrawals.filter(w => !formData.filterStatus || w.status === formData.filterStatus).map(w => (
                          <tr key={w.id} className={`border-t hover:bg-gray-50 ${w.has_gratuity ? 'row-green' : ''} ${w.is_restricted ? 'row-red' : ''}`}>
                            <td className="px-4 py-3 whitespace-nowrap">{new Date(w.created_at).toLocaleString('pt-BR')}</td>
                            <td className="px-4 py-3">{w.user_name}</td>
                            <td className="px-4 py-3">{w.cpf}</td>
                            <td className="px-4 py-3 font-mono">{w.user_cod}</td>
                            <td className="px-4 py-3 text-right font-semibold">{formatMoney(w.requested_amount)}</td>
                            <td className="px-4 py-3 text-right">{formatMoney(w.final_amount)}</td>
                            <td className="px-4 py-3 text-xs max-w-[150px] truncate" title={w.pix_key}>{w.pix_key}</td>
                            <td className="px-4 py-3">
                              <select value={w.status} onChange={e => handleUpdateWithdrawalStatus(w.id, e.target.value)} className="px-2 py-1 border rounded text-xs">
                                <option value="aguardando_aprovacao">‚è≥ Aguardando</option>
                                <option value="aprovado">‚úÖ Aprovado</option>
                                <option value="aprovado_gratuidade">‚úÖ Aprov. Gratuidade</option>
                                <option value="rejeitado">‚ùå Rejeitado</option>
                                <option value="inativo">‚ö†Ô∏è Inativo</option>
                              </select>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    {allWithdrawals.length === 0 && <p className="text-center py-8 text-gray-500">Nenhuma solicita√ß√£o</p>}
                  </div>
                </div>
              )}

              {/* ABA: CONCILIA√á√ÉO */}
              {formData.finTab === 'conciliacao' && (
                <>
                  <div className="grid md:grid-cols-5 gap-4 mb-6">
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Total Aprovados</p><p className="text-2xl font-bold text-green-600">{dashboardData.total_aprovados || 0}</p></div>
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Conciliados</p><p className="text-2xl font-bold text-blue-600">{dashboardData.total_conciliado || 0}</p></div>
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Pend. Concilia√ß√£o</p><p className="text-2xl font-bold text-yellow-600">{dashboardData.pendente_conciliacao || 0}</p></div>
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Debitados</p><p className="text-2xl font-bold text-purple-600">{dashboardData.total_debitado || 0}</p></div>
                    <div className="bg-white rounded-xl shadow p-4"><p className="text-sm text-gray-600">Pend. D√©bito</p><p className="text-2xl font-bold text-orange-600">{dashboardData.pendente_debito || 0}</p></div>
                  </div>

                  <div className="bg-white rounded-xl shadow overflow-hidden">
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left">Nome</th>
                            <th className="px-4 py-3 text-left">CPF</th>
                            <th className="px-4 py-3 text-left">C√≥digo</th>
                            <th className="px-4 py-3 text-right">Solicitado</th>
                            <th className="px-4 py-3 text-right">Debitado</th>
                            <th className="px-4 py-3 text-center">Concilia√ß√£o OMIE</th>
                            <th className="px-4 py-3 text-center">D√©bito</th>
                          </tr>
                        </thead>
                        <tbody>
                          {allWithdrawals.filter(w => w.status === 'aprovado' || w.status === 'aprovado_gratuidade').map(w => (
                            <tr key={w.id} className="border-t hover:bg-gray-50">
                              <td className="px-4 py-3">{w.user_name}</td>
                              <td className="px-4 py-3">{w.cpf}</td>
                              <td className="px-4 py-3 font-mono">{w.user_cod}</td>
                              <td className="px-4 py-3 text-right">{formatMoney(w.requested_amount)}</td>
                              <td className="px-4 py-3 text-right font-semibold">{formatMoney(w.final_amount)}</td>
                              <td className="px-4 py-3 text-center">
                                <input type="checkbox" checked={w.conciliacao_omie} onChange={e => handleUpdateConciliacao(w.id, 'conciliacaoOmie', e.target.checked)} className="w-5 h-5" />
                              </td>
                              <td className="px-4 py-3 text-center">
                                <input type="checkbox" checked={w.debito} onChange={e => handleUpdateConciliacao(w.id, 'debito', e.target.checked)} className="w-5 h-5" />
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </>
              )}

              {/* ABA: RESUMO INDIVIDUAL */}
              {formData.finTab === 'resumo' && (
                <div className="bg-white rounded-xl shadow p-6">
                  <div className="flex gap-4 mb-6">
                    <input type="text" placeholder="C√≥digo do profissional" value={formData.searchCod || ''} onChange={e => setFormData({...formData, searchCod: e.target.value})} className="flex-1 px-4 py-2 border rounded-lg" />
                    <button onClick={() => setFormData({...formData, searchCod: formData.searchCod})} className="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold">üîç Buscar</button>
                  </div>
                  {formData.searchCod && (
                    <div className="space-y-3">
                      {allWithdrawals.filter(w => w.user_cod.toLowerCase().includes(formData.searchCod.toLowerCase())).map(w => (
                        <div key={w.id} className="border rounded-lg p-4 flex justify-between items-center">
                          <div>
                            <p className="font-bold">{formatMoney(w.requested_amount)} ‚Üí {formatMoney(w.final_amount)}</p>
                            <p className="text-sm text-gray-600">{w.user_name} ‚Ä¢ {w.cpf}</p>
                            <p className="text-xs text-gray-400">{new Date(w.created_at).toLocaleString('pt-BR')}</p>
                          </div>
                          <span className={`px-3 py-1 rounded-full text-xs font-bold ${w.status.includes('aprovado') ? 'bg-green-500 text-white' : w.status === 'rejeitado' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-white'}`}>
                            {statusLabels[w.status] || w.status}
                          </span>
                        </div>
                      ))}
                      {allWithdrawals.filter(w => w.user_cod.toLowerCase().includes(formData.searchCod.toLowerCase())).length === 0 && (
                        <p className="text-gray-500 text-center py-8">Nenhum resultado encontrado</p>
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* ABA: GRATUIDADES */}
              {formData.finTab === 'gratuidades' && (
                <div className="space-y-6">
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="text-lg font-semibold mb-4">‚ûï Cadastrar Gratuidade</h3>
                    <div className="grid md:grid-cols-5 gap-4">
                      <input type="text" placeholder="C√≥digo profissional" value={formData.gratUserCod || ''} onChange={e => setFormData({...formData, gratUserCod: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <input type="number" placeholder="Quantidade" value={formData.gratQty || ''} onChange={e => setFormData({...formData, gratQty: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <input type="number" placeholder="Valor (R$)" value={formData.gratValue || ''} onChange={e => setFormData({...formData, gratValue: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <input type="text" placeholder="Motivo" value={formData.gratReason || ''} onChange={e => setFormData({...formData, gratReason: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <button onClick={handleAddGratuity} disabled={loading} className="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold disabled:opacity-50">
                        {loading ? '...' : '‚ûï Adicionar'}
                      </button>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow overflow-hidden">
                    <div className="p-4 border-b"><h3 className="font-semibold">üìã Gratuidades Cadastradas</h3></div>
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-3 text-left">C√≥digo</th>
                          <th className="px-4 py-3 text-center">Qtd</th>
                          <th className="px-4 py-3 text-center">Restante</th>
                          <th className="px-4 py-3 text-right">Valor</th>
                          <th className="px-4 py-3 text-left">Motivo</th>
                          <th className="px-4 py-3 text-center">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {gratuities.map(g => (
                          <tr key={g.id} className={`border-t ${g.status === 'ativa' ? 'bg-green-50' : 'bg-gray-50'}`}>
                            <td className="px-4 py-3 font-mono">{g.user_cod}</td>
                            <td className="px-4 py-3 text-center">{g.quantity}</td>
                            <td className="px-4 py-3 text-center font-bold">{g.remaining}</td>
                            <td className="px-4 py-3 text-right">{formatMoney(g.value)}</td>
                            <td className="px-4 py-3">{g.reason || '-'}</td>
                            <td className="px-4 py-3 text-center">
                              <span className={`px-2 py-1 rounded text-xs font-bold ${g.status === 'ativa' ? 'bg-green-500 text-white' : 'bg-gray-400 text-white'}`}>
                                {g.status}
                              </span>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* ABA: RESTRITOS */}
              {formData.finTab === 'restritos' && (
                <div className="space-y-6">
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="text-lg font-semibold mb-4">‚ûï Adicionar Restri√ß√£o</h3>
                    <div className="grid md:grid-cols-3 gap-4">
                      <input type="text" placeholder="C√≥digo profissional" value={formData.restUserCod || ''} onChange={e => setFormData({...formData, restUserCod: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <input type="text" placeholder="Motivo da restri√ß√£o" value={formData.restReason || ''} onChange={e => setFormData({...formData, restReason: e.target.value})} className="px-4 py-2 border rounded-lg" />
                      <button onClick={handleAddRestriction} disabled={loading} className="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold disabled:opacity-50">
                        {loading ? '...' : 'üö´ Adicionar Restri√ß√£o'}
                      </button>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow overflow-hidden">
                    <div className="p-4 border-b"><h3 className="font-semibold">üö´ Profissionais Restritos</h3></div>
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-3 text-left">C√≥digo</th>
                          <th className="px-4 py-3 text-left">Motivo</th>
                          <th className="px-4 py-3 text-left">Data</th>
                          <th className="px-4 py-3 text-center">Status</th>
                          <th className="px-4 py-3 text-center">A√ß√£o</th>
                        </tr>
                      </thead>
                      <tbody>
                        {restrictedList.map(r => (
                          <tr key={r.id} className={`border-t ${r.status === 'ativo' ? 'bg-red-50' : 'bg-gray-50'}`}>
                            <td className="px-4 py-3 font-mono">{r.user_cod}</td>
                            <td className="px-4 py-3">{r.reason}</td>
                            <td className="px-4 py-3">{new Date(r.created_at).toLocaleDateString('pt-BR')}</td>
                            <td className="px-4 py-3 text-center">
                              <span className={`px-2 py-1 rounded text-xs font-bold ${r.status === 'ativo' ? 'bg-red-500 text-white' : 'bg-gray-400 text-white'}`}>
                                {r.status}
                              </span>
                            </td>
                            <td className="px-4 py-3 text-center">
                              {r.status === 'ativo' && (
                                <button onClick={() => handleRemoveRestriction(r.id)} className="px-3 py-1 bg-green-600 text-white rounded text-xs font-semibold">
                                  Suspender
                                </button>
                              )}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // ===================== PAINEL ADMIN NORMAL =====================
      // (Mant√©m o c√≥digo existente do admin de solicita√ß√µes)
      return (
        <div className="min-h-screen bg-gray-50">
          {toast && <Toast {...toast} />}
          {globalLoading && <LoadingOverlay />}
          {imageModal && <ImageModal imageUrl={imageModal} onClose={() => setImageModal(null)} />}

          <nav className="bg-purple-900 shadow-lg">
            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
              <h1 className="text-xl font-bold text-white">Painel Admin</h1>
              <div className="flex gap-2">
                <button onClick={refreshAll} className="px-4 py-2 bg-purple-700 text-white rounded-lg hover:bg-purple-600 text-sm font-semibold">üîÑ Atualizar</button>
                <button onClick={() => setUser(null)} className="px-4 py-2 text-white hover:bg-purple-800 rounded-lg">Sair</button>
              </div>
            </div>
          </nav>

          <div className="bg-white border-b sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-4 flex gap-1 overflow-x-auto">
              {['dashboard', 'search', 'users'].map(tab => (
                <button key={tab} onClick={() => setFormData({...formData, adminTab: tab})} className={`px-6 py-3 font-semibold whitespace-nowrap ${(!formData.adminTab || formData.adminTab === 'dashboard') && tab === 'dashboard' ? 'text-purple-900 border-b-2 border-purple-900' : formData.adminTab === tab ? 'text-purple-900 border-b-2 border-purple-900' : 'text-gray-600'}`}>
                  {tab === 'dashboard' && 'üìä Dashboard'}
                  {tab === 'search' && 'üîç Busca'}
                  {tab === 'users' && 'üë• Usu√°rios'}
                </button>
              ))}
            </div>
          </div>

          <div className="max-w-7xl mx-auto p-6">
            {/* DASHBOARD */}
            {(!formData.adminTab || formData.adminTab === 'dashboard') && (
              <>
                <div className="grid md:grid-cols-4 gap-4 mb-6">
                  <div className="bg-white p-6 rounded-xl shadow"><p className="text-sm text-gray-600">Total</p><p className="text-3xl font-bold text-purple-900">{submissions.length}</p></div>
                  <div className="bg-white p-6 rounded-xl shadow"><p className="text-sm text-gray-600">Pendentes</p><p className="text-3xl font-bold text-yellow-600">{submissions.filter(s => s.status === 'pendente').length}</p></div>
                  <div className="bg-white p-6 rounded-xl shadow"><p className="text-sm text-gray-600">Aprovadas</p><p className="text-3xl font-bold text-green-600">{submissions.filter(s => s.status === 'aprovada').length}</p></div>
                  <div className="bg-white p-6 rounded-xl shadow"><p className="text-sm text-gray-600">Rejeitadas</p><p className="text-3xl font-bold text-red-600">{submissions.filter(s => s.status === 'rejeitada').length}</p></div>
                </div>

                <div className="bg-white rounded-xl shadow p-6">
                  <h2 className="text-lg font-semibold mb-4">Aguardando Valida√ß√£o</h2>
                  <div className="flex flex-wrap gap-2 mb-4">
                    {['all', 'retorno', 'ponto1', 'pedagio'].map(f => (
                      <button key={f} onClick={() => setFormData({...formData, pendingFilter: f})} className={`px-4 py-2 rounded-lg font-semibold ${(formData.pendingFilter || 'all') === f ? 'bg-purple-600 text-white' : 'bg-gray-100'}`}>
                        {f === 'all' && `üìã Todos (${submissions.filter(s => s.status === 'pendente').length})`}
                        {f === 'retorno' && `üîÑ Retorno (${submissions.filter(s => s.status === 'pendente' && s.motivo === 'Ajuste de Retorno').length})`}
                        {f === 'ponto1' && `üìç Ponto 1 (${submissions.filter(s => s.status === 'pendente' && s.motivo?.includes('Ponto 1')).length})`}
                        {f === 'pedagio' && `üõ£Ô∏è Ped√°gio (${submissions.filter(s => s.status === 'pendente' && s.motivo?.includes('Ped√°gio')).length})`}
                      </button>
                    ))}
                  </div>
                  <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {submissions.filter(s => {
                      if (s.status !== 'pendente') return false;
                      if (!formData.pendingFilter || formData.pendingFilter === 'all') return true;
                      if (formData.pendingFilter === 'retorno') return s.motivo === 'Ajuste de Retorno';
                      if (formData.pendingFilter === 'ponto1') return s.motivo?.includes('Ponto 1');
                      if (formData.pendingFilter === 'pedagio') return s.motivo?.includes('Ped√°gio');
                      return true;
                    }).map(s => (
                      <div key={s.id} className="border rounded-lg p-3 text-sm">
                        <p className="font-mono text-lg font-bold">OS: {s.ordemServico}</p>
                        <p className="text-xs text-gray-700">{s.fullName}</p>
                        <p className="text-xs text-purple-900 font-semibold">{s.motivo}</p>
                        {s.temImagem && !s.imagemComprovante && (
                          <button onClick={() => loadImagem(s.id)} className="mt-2 text-xs text-blue-600">üì∑ Ver foto</button>
                        )}
                        {s.imagemComprovante && (
                          <div className="mt-2 flex gap-1">
                            {s.imagemComprovante.split('|||').map((img, i) => (
                              <img key={i} src={img} className="h-16 rounded cursor-pointer" onClick={() => setImageModal(img)} />
                            ))}
                          </div>
                        )}
                        <textarea placeholder="Obs (opcional)" value={formData[`obs_${s.id}`] || ''} onChange={e => setFormData({...formData, [`obs_${s.id}`]: e.target.value, obs: e.target.value})} className="w-full px-2 py-1 border rounded mt-2 text-xs" rows="1" />
                        <div className="flex gap-2 mt-2">
                          <button onClick={() => handleValidate(s.id, true)} className="flex-1 bg-green-600 text-white py-1 rounded text-xs font-semibold">‚úì Aprovar</button>
                          <button onClick={() => handleValidate(s.id, false)} className="flex-1 bg-red-600 text-white py-1 rounded text-xs font-semibold">‚úó Rejeitar</button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </>
            )}

            {/* BUSCA */}
            {formData.adminTab === 'search' && (
              <div className="bg-white rounded-xl shadow p-6">
                <input type="text" placeholder="üîç Buscar por OS ou c√≥digo..." value={formData.searchOS || ''} onChange={e => setFormData({...formData, searchOS: e.target.value})} className="w-full px-4 py-2 border rounded-lg mb-4" />
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {submissions.filter(s => !formData.searchOS || s.ordemServico?.toLowerCase().includes(formData.searchOS.toLowerCase()) || s.codProfissional?.toLowerCase().includes(formData.searchOS.toLowerCase())).map(s => (
                    <div key={s.id} className={`border rounded-lg p-3 ${s.status === 'aprovada' ? 'bg-green-50' : s.status === 'rejeitada' ? 'bg-red-50' : 'bg-yellow-50'}`}>
                      <div className="flex justify-between">
                        <p className="font-mono font-bold">OS: {s.ordemServico}</p>
                        <span className={`px-2 py-0.5 rounded text-xs font-bold ${s.status === 'aprovada' ? 'bg-green-500 text-white' : s.status === 'rejeitada' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-white'}`}>{s.status}</span>
                      </div>
                      <p className="text-xs text-gray-600">{s.fullName}</p>
                      <p className="text-xs text-gray-500">{s.motivo}</p>
                      {s.validated_by_name && <p className="text-xs text-purple-600 mt-1">üë§ {s.validated_by_name}</p>}
                      <p className="text-xs text-gray-400 mt-1">{s.timestamp}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* USU√ÅRIOS */}
            {formData.adminTab === 'users' && (
              <div className="bg-white rounded-xl shadow p-6">
                <h2 className="text-lg font-semibold mb-4">üë• Gerenciar Usu√°rios</h2>
                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                  <h3 className="font-semibold mb-3">‚ûï Criar Usu√°rio</h3>
                  <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-3">
                    <input type="text" placeholder="Nome" value={formData.newName || ''} onChange={e => setFormData({...formData, newName: e.target.value})} className="px-3 py-2 border rounded" />
                    <input type="text" placeholder="C√≥digo" value={formData.newCod || ''} onChange={e => setFormData({...formData, newCod: e.target.value})} className="px-3 py-2 border rounded" />
                    <input type="password" placeholder="Senha" value={formData.newPass || ''} onChange={e => setFormData({...formData, newPass: e.target.value})} className="px-3 py-2 border rounded" />
                    <select value={formData.newRole || 'user'} onChange={e => setFormData({...formData, newRole: e.target.value})} className="px-3 py-2 border rounded">
                      <option value="user">üë§ Usu√°rio</option>
                      <option value="admin">üëë Admin</option>
                      <option value="admin_financeiro">üí∞ Admin Financeiro</option>
                    </select>
                  </div>
                  <button onClick={async () => {
                    if (!formData.newName || !formData.newCod || !formData.newPass) { showToast('Preencha todos', 'error'); return; }
                    setLoading(true);
                    try {
                      await fetch(`${API_URL}/users/register`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fullName: formData.newName, codProfissional: formData.newCod, password: formData.newPass, role: formData.newRole || 'user' })
                      });
                      showToast('‚úÖ Criado!', 'success');
                      setFormData({...formData, newName: '', newCod: '', newPass: '', newRole: 'user'});
                      loadUsers();
                    } catch { showToast('Erro', 'error'); }
                    setLoading(false);
                  }} className="mt-3 px-6 py-2 bg-purple-600 text-white rounded font-semibold">‚ûï Criar</button>
                </div>
                <div className="space-y-2">
                  {users.map(u => (
                    <div key={u.codProfissional} className="border rounded-lg p-3 flex justify-between items-center">
                      <div>
                        <p className="font-semibold">{u.fullName}</p>
                        <p className="text-sm text-gray-600">COD: {u.codProfissional} ‚Ä¢ {u.role}</p>
                      </div>
                      <button onClick={async () => {
                        if (!confirm(`Excluir ${u.fullName}?`)) return;
                        await fetch(`${API_URL}/users/${u.codProfissional}`, { method: 'DELETE' });
                        showToast('Exclu√≠do!', 'success');
                        loadUsers();
                      }} className="px-3 py-1 bg-red-600 text-white rounded text-sm">üóëÔ∏è</button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
