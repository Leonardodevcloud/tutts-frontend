<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Tutts</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .toast { animation: slideIn 0.3s ease-out; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_URL = 'https://tutts-backend-production.up.railway.app/api';

    const Toast = ({ message, type }) => (
      <div className={`fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-2xl toast text-white font-semibold flex items-center gap-3 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>
        <span className="text-2xl">{type === 'success' ? '‚úì' : '‚úó'}</span>
        <span>{message}</span>
      </div>
    );

    const ImageModal = ({ imageUrl, onClose }) => (
      <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onClick={onClose}>
        <div className="relative max-w-4xl max-h-screen">
          <button onClick={onClose} className="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300">‚úï</button>
          <img src={imageUrl} alt="Imagem" className="max-w-full max-h-screen rounded-lg shadow-2xl" onClick={(e) => e.stopPropagation()} />
        </div>
      </div>
    );

    function App() {
      const [currentUser, setCurrentUser] = useState(null);
      const [page, setPage] = useState('login');
      const [toast, setToast] = useState(null);
      const [selectedImage, setSelectedImage] = useState(null);

      useEffect(() => {
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        if (token && user) {
          const userData = JSON.parse(user);
          setCurrentUser(userData);
          setPage(userData.role === 'admin' ? 'form' : 'list');
        }
      }, []);

      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };

      const handleLogout = () => {
        localStorage.clear();
        setCurrentUser(null);
        setPage('login');
        showToast('Logout realizado!');
      };

      if (!currentUser) {
        return <LoginPage onLogin={(user) => {
          setCurrentUser(user);
          setPage(user.role === 'admin' ? 'form' : 'list');
          showToast('Bem-vindo, ' + (user.full_name || user.cod_profissional) + '!');
        }} showToast={showToast} />;
      }

      return (
        <>
          {toast && <Toast message={toast.message} type={toast.type} />}
          {selectedImage && <ImageModal imageUrl={selectedImage} onClose={() => setSelectedImage(null)} />}
          
          <div className="min-h-screen bg-gradient-to-br from-violet-50 to-blue-50">
            <nav className="bg-white shadow-lg border-b-4 border-violet-600">
              <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 className="text-3xl font-bold bg-gradient-to-r from-violet-600 to-blue-600 bg-clip-text text-transparent">üéØ Sistema Tutts</h1>
                <div className="flex items-center gap-4">
                  <span className="text-gray-700 font-medium">üë§ {currentUser.full_name || currentUser.cod_profissional}</span>
                  <span className={`px-3 py-1 rounded-full text-sm font-semibold ${currentUser.role === 'admin' ? 'bg-violet-100 text-violet-700' : 'bg-blue-100 text-blue-700'}`}>
                    {currentUser.role === 'admin' ? 'üîë Admin' : 'üëÅÔ∏è Visualizador'}
                  </span>
                  {currentUser.role === 'admin' && (
                    <div className="flex gap-2">
                      <button onClick={() => setPage('form')} className={`px-4 py-2 rounded-lg font-semibold transition-all ${page === 'form' ? 'bg-violet-600 text-white shadow-lg' : 'bg-white text-violet-600 hover:bg-violet-50'}`}>
                        üìù Nova Solicita√ß√£o
                      </button>
                      <button onClick={() => setPage('list')} className={`px-4 py-2 rounded-lg font-semibold transition-all ${page === 'list' ? 'bg-violet-600 text-white shadow-lg' : 'bg-white text-violet-600 hover:bg-violet-50'}`}>
                        üìã Ver Solicita√ß√µes
                      </button>
                      <button onClick={() => setPage('create-admin')} className={`px-4 py-2 rounded-lg font-semibold transition-all ${page === 'create-admin' ? 'bg-violet-600 text-white shadow-lg' : 'bg-white text-violet-600 hover:bg-violet-50'}`}>
                        üë• Criar Admin
                      </button>
                    </div>
                  )}
                  <button onClick={handleLogout} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold shadow-lg">üö™ Sair</button>
                </div>
              </div>
            </nav>

            <div className="max-w-7xl mx-auto px-4 py-8">
              {page === 'form' && <FormPage showToast={showToast} />}
              {page === 'list' && <ListPage currentUser={currentUser} showToast={showToast} onImageClick={setSelectedImage} />}
              {page === 'create-admin' && <CreateAdminPage showToast={showToast} />}
            </div>
          </div>
        </>
      );
    }

    function LoginPage({ onLogin, showToast }) {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
          const response = await fetch(API_URL + '/users/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codProfissional: username, password: password })
          });
          const data = await response.json();
          if (response.ok) {
            localStorage.setItem('token', 'dummy-token');
            localStorage.setItem('user', JSON.stringify(data));
            onLogin(data);
          } else {
            showToast(data.error || 'Erro ao fazer login', 'error');
          }
        } catch (error) {
          showToast('Erro ao conectar ao servidor', 'error');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-violet-600 to-blue-600 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <h1 className="text-4xl font-bold bg-gradient-to-r from-violet-600 to-blue-600 bg-clip-text text-transparent mb-2">üéØ Sistema Tutts</h1>
              <p className="text-gray-600">Solicita√ß√µes de Ajustes</p>
            </div>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-gray-700 font-semibold mb-2">Usu√°rio</label>
                <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-violet-600 focus:outline-none" required />
              </div>
              <div>
                <label className="block text-gray-700 font-semibold mb-2">Senha</label>
                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-violet-600 focus:outline-none" required />
              </div>
              <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-violet-600 to-blue-600 text-white py-3 rounded-lg font-bold hover:shadow-xl disabled:opacity-50">
                {loading ? '‚è≥ Entrando...' : 'üîê Entrar'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    function FormPage({ showToast }) {
      const [formData, setFormData] = useState({
        nomeTecnico: '', nomeCliente: '', motivoVisita: '', descricao: '', imagens: [], imagemComprovante: null
      });
      const [loading, setLoading] = useState(false);
      const [showValidation, setShowValidation] = useState(false);

      const motivos = ['Instala√ß√£o', 'Manuten√ß√£o Preventiva', 'Manuten√ß√£o Corretiva', 'Ajuste de Ped√°gio (Campinas e Recife)', 'Treinamento', 'Outros'];

      const compressImage = (file) => new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width, height = img.height;
            if (width > 1200) { height *= 1200 / width; width = 1200; }
            else if (height > 1200) { width *= 1200 / height; height = 1200; }
            canvas.width = width; canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            let quality = 0.7, compressed = canvas.toDataURL('image/jpeg', quality);
            while (compressed.length > 512000 * 1.37 && quality > 0.1) {
              quality -= 0.1;
              compressed = canvas.toDataURL('image/jpeg', quality);
            }
            resolve(compressed);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });

      const handleImageChange = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 2) { showToast('M√°ximo de 2 fotos', 'error'); e.target.value = ''; return; }
        const compressed = await Promise.all(files.map(f => compressImage(f)));
        setFormData({ ...formData, imagens: compressed });
      };

      const handleComprovanteChange = async (e) => {
        const file = e.target.files[0];
        if (file) setFormData({ ...formData, imagemComprovante: await compressImage(file) });
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setShowValidation(true);
        const isPedagio = formData.motivoVisita === 'Ajuste de Ped√°gio (Campinas e Recife)';
        if (isPedagio && formData.imagens.length === 0) { showToast('Foto obrigat√≥ria para Ajuste de Ped√°gio!', 'error'); return; }
        
        setLoading(true);
        try {
          const token = localStorage.getItem('token');
          const response = await fetch(API_URL + '/submissions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({
              nomeTecnico: formData.nomeTecnico, nomeCliente: formData.nomeCliente,
              motivoVisita: formData.motivoVisita, descricao: formData.descricao,
              imagens: formData.imagens.join(','), imagemComprovante: formData.imagemComprovante
            })
          });
          if (response.ok) {
            showToast('Solicita√ß√£o enviada!');
            setFormData({ nomeTecnico: '', nomeCliente: '', motivoVisita: '', descricao: '', imagens: [], imagemComprovante: null });
            setShowValidation(false);
          } else {
            showToast('Erro ao enviar', 'error');
          }
        } catch (error) {
          showToast('Erro de conex√£o', 'error');
        } finally {
          setLoading(false);
        }
      };

      const isPedagio = formData.motivoVisita === 'Ajuste de Ped√°gio (Campinas e Recife)';

      return (
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <h2 className="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3"><span className="text-4xl">üìù</span>Nova Solicita√ß√£o</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">Nome do T√©cnico *</label>
                  <input type="text" value={formData.nomeTecnico} onChange={(e) => setFormData({...formData, nomeTecnico: e.target.value})} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-violet-600 focus:outline-none" required />
                </div>
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">Nome do Cliente *</label>
                  <input type="text" value={formData.nomeCliente} onChange={(e) => setFormData({...formData, nomeCliente: e.target.value})} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-violet-600 focus:outline-none" required />
                </div>
              </div>
              <div>
                <label className="block text-gray-700 font-semibold mb-2">Motivo *</label>
                <select value={formData.motivoVisita} onChange={(e) => setFormData({...formData, motivoVisita: e.target.value})} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-violet-600 focus:outline-none" required>
                  <option value="">Selecione</option>
                  {motivos.map(m => <option key={m} value={m}>{m}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-gray-700 font-semibold mb-2">Descri√ß√£o *</label>
                <textarea value={formData.descricao} onChange={(e) => setFormData({...formData, descricao: e.target.value})} rows="4" className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-violet-600 focus:outline-none" required />
              </div>
              <div>
                <label className="block text-gray-700 font-semibold mb-2 flex items-center gap-2">
                  üì∏ Fotos (m√°x. 2) {isPedagio && <span className="text-red-600">* Obrigat√≥rio</span>}
                </label>
                <input type="file" accept="image/*" multiple onChange={handleImageChange} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg" />
                {showValidation && isPedagio && formData.imagens.length === 0 && <p className="text-red-600 text-sm mt-2">‚ö†Ô∏è Foto obrigat√≥ria!</p>}
                {formData.imagens.length > 0 && (
                  <div className="flex gap-4 mt-4">
                    {formData.imagens.map((img, i) => (
                      <div key={i} className="relative">
                        <img src={img} className="w-32 h-32 object-cover rounded-lg border-2" />
                        <button type="button" onClick={() => setFormData({...formData, imagens: formData.imagens.filter((_, idx) => idx !== i)})} className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6">‚úï</button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
              <div>
                <label className="block text-gray-700 font-semibold mb-2">üìÑ Comprovante (opcional)</label>
                <input type="file" accept="image/*" onChange={handleComprovanteChange} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg" />
                {formData.imagemComprovante && (
                  <div className="mt-4 relative inline-block">
                    <img src={formData.imagemComprovante} className="w-32 h-32 object-cover rounded-lg border-2" />
                    <button type="button" onClick={() => setFormData({...formData, imagemComprovante: null})} className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6">‚úï</button>
                  </div>
                )}
              </div>
              <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-violet-600 to-blue-600 text-white py-4 rounded-lg font-bold text-lg hover:shadow-xl disabled:opacity-50">
                {loading ? '‚è≥ Enviando...' : '‚úÖ Enviar'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    function ListPage({ currentUser, showToast, onImageClick }) {
      const [submissions, setSubmissions] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedMotivo, setSelectedMotivo] = useState('');

      const motivos = ['Instala√ß√£o', 'Manuten√ß√£o Preventiva', 'Manuten√ß√£o Corretiva', 'Ajuste de Ped√°gio (Campinas e Recife)', 'Treinamento', 'Outros'];

      useEffect(() => {
        fetchSubmissions();
        const interval = setInterval(fetchSubmissions, 300000);
        return () => clearInterval(interval);
      }, []);

      const fetchSubmissions = async () => {
        try {
          const token = localStorage.getItem('token');
          const response = await fetch(API_URL + '/submissions', { headers: { 'Authorization': 'Bearer ' + token } });
          if (response.ok) setSubmissions(await response.json());
        } catch (error) {
          showToast('Erro ao carregar', 'error');
        } finally {
          setLoading(false);
        }
      };

      const handleDelete = async (id) => {
        if (!confirm('Excluir?')) return;
        try {
          const token = localStorage.getItem('token');
          const response = await fetch(API_URL + '/submissions/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
          if (response.ok) { showToast('Exclu√≠do!'); fetchSubmissions(); }
        } catch (error) {
          showToast('Erro', 'error');
        }
      };

      const filtered = selectedMotivo ? submissions.filter(s => s.motivo === selectedMotivo) : submissions;

      if (loading) return <div className="text-center text-2xl mt-20">‚è≥ Carregando...</div>;

      return (
        <div>
          <div className="mb-6 flex gap-4 items-center">
            <label className="text-gray-700 font-semibold">Filtrar:</label>
            <select value={selectedMotivo} onChange={(e) => setSelectedMotivo(e.target.value)} className="px-4 py-2 border-2 border-gray-300 rounded-lg">
              <option value="">Todos</option>
              {motivos.map(m => <option key={m} value={m}>{m}</option>)}
            </select>
            {selectedMotivo && <button onClick={() => setSelectedMotivo('')} className="px-4 py-2 bg-gray-200 rounded-lg">‚úï Limpar</button>}
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {filtered.map(s => {
              const imgs = s.imagens ? (typeof s.imagens === 'string' ? s.imagens.split(',').filter(img => img.trim()) : s.imagens) : [];
              return (
                <div key={s.id} className="bg-white rounded-xl shadow-lg p-6 hover:shadow-2xl transition-all">
                  <div className="flex justify-between mb-4">
                    <div>
                      <h3 className="text-xl font-bold">{s.nome_cliente}</h3>
                      <p className="text-gray-600">üë§ {s.nome_tecnico}</p>
                    </div>
                    {currentUser.role === 'admin' && <button onClick={() => handleDelete(s.id)} className="text-red-600 text-xl">üóëÔ∏è</button>}
                  </div>
                  <p className="text-sm"><b>Motivo:</b> {s.motivo}</p>
                  <p className="text-sm"><b>Descri√ß√£o:</b> {s.descricao}</p>
                  <p className="text-gray-500 text-xs mt-2">{new Date(s.created_at).toLocaleString('pt-BR')}</p>
                  {imgs.length > 0 && (
                    <div className="mt-4">
                      <p className="font-semibold mb-2">üì∏ Fotos:</p>
                      <div className="flex gap-2">
                        {imgs.map((img, i) => <img key={i} src={img.trim()} className="w-20 h-20 object-cover rounded-lg border-2 cursor-pointer hover:scale-110 transition-all" onClick={() => onImageClick(img.trim())} />)}
                      </div>
                    </div>
                  )}
                  {s.imagem_comprovante && (
                    <div className="mt-4">
                      <p className="font-semibold mb-2">üìÑ Comprovante:</p>
                      <img src={s.imagem_comprovante} className="w-20 h-20 object-cover rounded-lg border-2 cursor-pointer hover:scale-110 transition-all" onClick={() => onImageClick(s.imagem_comprovante)} />
                    </div>
                  )}
                </div>
              );
            })}
          </div>
          {filtered.length === 0 && <div className="text-center text-gray-500 text-xl mt-20">üì≠ Nenhuma solicita√ß√£o</div>}
        </div>
      );
    }

    function CreateAdminPage({ showToast }) {
      const [formData, setFormData] = useState({ username: '', password: '', confirmPassword: '' });
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (formData.password !== formData.confirmPassword) { showToast('Senhas n√£o coincidem!', 'error'); return; }
        setLoading(true);
        try {
          const token = localStorage.getItem('token');
          const response = await fetch(API_URL + '/users/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ codProfissional: formData.username, password: formData.password, fullName: formData.username, role: 'admin' })
          });
          if (response.ok) {
            showToast('Admin criado!');
            setFormData({ username: '', password: '', confirmPassword: '' });
          } else {
            showToast('Erro ao criar', 'error');
          }
        } catch (error) {
          showToast('Erro de conex√£o', 'error');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="max-w-2xl mx-auto">
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <h2 className="text-3xl font-bold mb-6 flex items-center gap-3"><span className="text-4xl">üë•</span>Criar Admin</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-gray-700 font-semibold mb-2">Usu√°rio *</label>
                <input type="text" value={formData.username} onChange={(e) => setFormData({...formData, username: e.target.value})} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-violet-600 focus:outline-none" required />
              </div>
              <div>
                <label className="block text-gray-700 font-semibold mb-2">Senha *</label>
                <input type="password" value={formData.password} onChange={(e) => setFormData({...formData, password: e.target.value})} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-violet-600 focus:outline-none" required />
              </div>
              <div>
                <label className="block text-gray-700 font-semibold mb-2">Confirmar Senha *</label>
                <input type="password" value={formData.confirmPassword} onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})} className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-violet-600 focus:outline-none" required />
              </div>
              <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-violet-600 to-blue-600 text-white py-4 rounded-lg font-bold text-lg hover:shadow-xl disabled:opacity-50">
                {loading ? '‚è≥ Criando...' : '‚úÖ Criar Admin'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
